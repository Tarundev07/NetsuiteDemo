<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LeaveUpdateCronService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HR Management</a> &gt; <a href="index.source.html" class="el_package">com.atomicnorth.hrm.tenant.service.scheduler</a> &gt; <span class="el_source">LeaveUpdateCronService.java</span></div><h1>LeaveUpdateCronService.java</h1><pre class="source lang-java linenums">package com.atomicnorth.hrm.tenant.service.scheduler;

import com.atomicnorth.hrm.configuration.multitenant.MultiTenantDataSourceLookup;
import com.atomicnorth.hrm.configuration.multitenant.TenantContextHolder;
import com.atomicnorth.hrm.master.domain.DataSourceConfig;
import com.atomicnorth.hrm.master.domain.TenantJobStatus;
import com.atomicnorth.hrm.master.repository.DataSourceConfigRepository;
import com.atomicnorth.hrm.master.repository.TenantJobStatusRepository;
import com.atomicnorth.hrm.tenant.domain.Employee;
import com.atomicnorth.hrm.tenant.domain.LeaveAllocation;
import com.atomicnorth.hrm.tenant.domain.LeaveAllocationDetails;
import com.atomicnorth.hrm.tenant.domain.branch.LeaveTypes;
import com.atomicnorth.hrm.tenant.domain.leave.LeaveLedgerEntity;
import com.atomicnorth.hrm.tenant.helper.Constant;
import com.atomicnorth.hrm.tenant.repository.EmployeeRepository;
import com.atomicnorth.hrm.tenant.repository.LeaveAllocationRepository;
import com.atomicnorth.hrm.tenant.repository.LeaveTypeRepository;
import com.atomicnorth.hrm.tenant.repository.leave.LeaveAllocationDetailRepository;
import com.atomicnorth.hrm.tenant.repository.leave.LeaveLedgerRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

import javax.transaction.Transactional;
import java.time.Instant;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

@Service
public class LeaveUpdateCronService {

<span class="nc" id="L35">    private static final Logger log = LoggerFactory.getLogger(LeaveUpdateCronService.class);</span>

    private final LeaveTypeRepository leaveTypeRepository;

    private final LeaveAllocationDetailRepository leaveAllocationDetailRepository;

    private final MultiTenantDataSourceLookup multiTenantDataSourceLookup;

    private final DataSourceConfigRepository dataSourceConfigRepository;

    private final LeaveAllocationRepository leaveAllocationRepository;

    private final EmployeeRepository employeeRepository;

    private final LeaveLedgerRepository leaveLedgerRepository;

    private final TenantJobStatusRepository tenantJobStatusRepository;

    public LeaveUpdateCronService(LeaveTypeRepository leaveTypeRepository,
                                  LeaveAllocationDetailRepository leaveAllocationDetailRepository,
                                  MultiTenantDataSourceLookup multiTenantDataSourceLookup,
                                  DataSourceConfigRepository dataSourceConfigRepository,
                                  LeaveAllocationRepository leaveAllocationRepository,
                                  EmployeeRepository employeeRepository,
                                  LeaveLedgerRepository leaveLedgerRepository,
<span class="nc" id="L60">                                  TenantJobStatusRepository tenantJobStatusRepository) {</span>
<span class="nc" id="L61">        this.leaveTypeRepository = leaveTypeRepository;</span>
<span class="nc" id="L62">        this.leaveAllocationDetailRepository = leaveAllocationDetailRepository;</span>
<span class="nc" id="L63">        this.multiTenantDataSourceLookup = multiTenantDataSourceLookup;</span>
<span class="nc" id="L64">        this.dataSourceConfigRepository = dataSourceConfigRepository;</span>
<span class="nc" id="L65">        this.leaveAllocationRepository = leaveAllocationRepository;</span>
<span class="nc" id="L66">        this.employeeRepository = employeeRepository;</span>
<span class="nc" id="L67">        this.leaveLedgerRepository = leaveLedgerRepository;</span>
<span class="nc" id="L68">        this.tenantJobStatusRepository = tenantJobStatusRepository;</span>
<span class="nc" id="L69">    }</span>

    public void runLeaveUpdateJob() {
<span class="nc" id="L72">        List&lt;TenantJobStatus&gt; activeJobs = tenantJobStatusRepository.findByStatus(&quot;Y&quot;);</span>
<span class="nc" id="L73">        List&lt;DataSourceConfig&gt; activeDataSources = activeJobs.stream()</span>
<span class="nc" id="L74">                .map(job -&gt; dataSourceConfigRepository.findById(job.getConfigId()))</span>
<span class="nc" id="L75">                .filter(Optional::isPresent)</span>
<span class="nc" id="L76">                .map(Optional::get)</span>
<span class="nc" id="L77">                .collect(Collectors.toList());</span>
<span class="nc" id="L78">        multiTenantDataSourceLookup.addTenantDataSources(activeDataSources);</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">        for (DataSourceConfig tenantConfig : activeDataSources) {</span>
<span class="nc" id="L80">            String tenantId = tenantConfig.getId();</span>
            try {
<span class="nc" id="L82">                TenantContextHolder.setTenantId(tenantId);</span>
<span class="nc" id="L83">                log.info(&quot;Running leave update job for tenant: {}&quot;, tenantConfig.getName());</span>
<span class="nc" id="L84">                updateLeaveAllocations();</span>

<span class="nc" id="L86">            } catch (Exception e) {</span>
<span class="nc" id="L87">                log.error(&quot;Error updating tenant {}: {}&quot;, tenantConfig.getName(), e.getMessage(), e);</span>
            } finally {
<span class="nc" id="L89">                TenantContextHolder.clear();</span>
            }
<span class="nc" id="L91">        }</span>
<span class="nc" id="L92">    }</span>

    @Transactional
    public void updateLeaveAllocations() {
<span class="nc" id="L96">        System.out.println(&quot;Leave Allocation Update Cron started at: &quot; + LocalDateTime.now());</span>
        try {
<span class="nc" id="L98">            List&lt;LeaveTypes&gt; leaveTypes = leaveTypeRepository.findAll();</span>
<span class="nc" id="L99">            List&lt;Employee&gt; employees = employeeRepository.findByIsActive(Constant.EMPLOYEE_STATUS_ACTIVE);</span>

<span class="nc bnc" id="L101" title="All 2 branches missed.">            for (LeaveTypes leaveType : leaveTypes) {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">                if (!shouldUpdateThisPeriod(leaveType.getEarnedLeaveFrequency())) continue;</span>

<span class="nc bnc" id="L104" title="All 2 branches missed.">                for (Employee e : employees) {</span>
<span class="nc" id="L105">                    Optional&lt;LeaveAllocation&gt; leaveAllocations = leaveAllocationRepository.findByEmpId(e.getEmployeeId());</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                    if (leaveAllocations.isPresent()) {</span>
<span class="nc" id="L107">                        List&lt;LeaveAllocationDetails&gt; leaveAllocationDetails = leaveAllocationDetailRepository.findByLeaveAllocation(leaveAllocations.get());</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                        for (LeaveAllocationDetails details : leaveAllocationDetails) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                            double currentBalance = details.getLeaveBalance() != null ? details.getLeaveBalance() : 0.0;</span>
<span class="nc bnc" id="L110" title="All 4 branches missed.">                            double earnedLeave = (leaveType.getEarnedLeaveAmount() != null &amp;&amp; leaveType.getEarnedLeaveAmount() &gt; 0) ? leaveType.getEarnedLeaveAmount() : 0.0;</span>
<span class="nc" id="L111">                            double newBalance = currentBalance + earnedLeave;</span>
<span class="nc" id="L112">                            details.setLastUpdatedDate(Instant.now());</span>
<span class="nc" id="L113">                            details.setLeaveBalance(newBalance);</span>
<span class="nc" id="L114">                            details.setCreatedBy(&quot;&quot;);</span>
<span class="nc" id="L115">                            details.setLastUpdatedBy(&quot;&quot;);</span>
<span class="nc" id="L116">                            leaveAllocationDetailRepository.save(details);</span>

<span class="nc" id="L118">                            LeaveLedgerEntity ledger = new LeaveLedgerEntity();</span>
<span class="nc" id="L119">                            ledger.setLeaveCode(details.getLeaveCode());</span>
<span class="nc" id="L120">                            ledger.setEmpId(e.getEmployeeId());</span>
<span class="nc" id="L121">                            ledger.setTransactionBalance(earnedLeave);</span>
<span class="nc" id="L122">                            ledger.setTransactionType(Constant.EMPLOYEE_LEAVE_CREDIT);</span>
<span class="nc" id="L123">                            ledger.setRemark(Constant.EMPLOYEE_LEAVE_REMARK);</span>
<span class="nc" id="L124">                            ledger.setCreatedBy(&quot;&quot;);</span>
<span class="nc" id="L125">                            ledger.setLastUpdatedBy(&quot;&quot;);</span>
<span class="nc" id="L126">                            leaveLedgerRepository.save(ledger);</span>
<span class="nc" id="L127">                        }</span>
                    }
<span class="nc" id="L129">                }</span>
<span class="nc" id="L130">            }</span>
<span class="nc" id="L131">        } catch (Exception e) {</span>
<span class="nc" id="L132">            e.printStackTrace();</span>
        } finally {
<span class="nc" id="L134">            TenantContextHolder.clear();</span>
        }
<span class="nc" id="L136">    }</span>
    private boolean shouldUpdateThisPeriod(String frequency) {
<span class="nc" id="L138">        int month = LocalDateTime.now().getMonthValue();</span>
<span class="nc bnc" id="L139" title="All 4 branches missed.">        switch (frequency.toUpperCase()) {</span>
            case &quot;MONTHLY&quot;:
<span class="nc" id="L141">                return true;</span>
            case &quot;QUARTERLY&quot;:
<span class="nc bnc" id="L143" title="All 8 branches missed.">                return (month == 1 || month == 4 || month == 7 || month == 10);</span>
            case &quot;YEARLY&quot;:
<span class="nc bnc" id="L145" title="All 2 branches missed.">                return (month == 1);</span>
            default:
<span class="nc" id="L147">                return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>
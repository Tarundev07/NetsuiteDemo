<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProjectService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HR Management</a> &gt; <a href="index.source.html" class="el_package">com.atomicnorth.hrm.tenant.service.project</a> &gt; <span class="el_source">ProjectService.java</span></div><h1>ProjectService.java</h1><pre class="source lang-java linenums">package com.atomicnorth.hrm.tenant.service.project;

import com.atomicnorth.hrm.exception.ResourceNotFoundException;
import com.atomicnorth.hrm.tenant.domain.Employee;
import com.atomicnorth.hrm.tenant.domain.User;
import com.atomicnorth.hrm.tenant.domain.customers.Customer;
import com.atomicnorth.hrm.tenant.domain.customers.CustomerAccount;
import com.atomicnorth.hrm.tenant.domain.customers.CustomerSite;
import com.atomicnorth.hrm.tenant.domain.holiday.HolidaysCalendar;
import com.atomicnorth.hrm.tenant.domain.holiday.HolidaysCalendarDay;
import com.atomicnorth.hrm.tenant.domain.project.Project;
import com.atomicnorth.hrm.tenant.domain.project.ProjectAllocation;
import com.atomicnorth.hrm.tenant.domain.project.ProjectAllocationHistory;
import com.atomicnorth.hrm.tenant.domain.project.ProjectDocument;
import com.atomicnorth.hrm.tenant.domain.project.ProjectMilestone;
import com.atomicnorth.hrm.tenant.domain.project.ProjectPriceAllocation;
import com.atomicnorth.hrm.tenant.domain.project.ProjectTaskAllocation;
import com.atomicnorth.hrm.tenant.domain.project.ProjectTaskRole;
import com.atomicnorth.hrm.tenant.domain.project.ProjectTaskRoleUser;
import com.atomicnorth.hrm.tenant.domain.project.ProjectTemplate;
import com.atomicnorth.hrm.tenant.domain.project.ProjectTemplateTask;
import com.atomicnorth.hrm.tenant.domain.project.SubTaskStory;
import com.atomicnorth.hrm.tenant.domain.project.TaskStory;
import com.atomicnorth.hrm.tenant.helper.Constant;
import com.atomicnorth.hrm.tenant.helper.SessionHolder;
import com.atomicnorth.hrm.tenant.helper.UserLoginDetail;
import com.atomicnorth.hrm.tenant.repository.EmployeeRepository;
import com.atomicnorth.hrm.tenant.repository.LookupCodeRepository;
import com.atomicnorth.hrm.tenant.repository.UserRepository;
import com.atomicnorth.hrm.tenant.repository.holiday.HolidaysCalendarDayRepository;
import com.atomicnorth.hrm.tenant.repository.holiday.HolidaysCalendarRepository;
import com.atomicnorth.hrm.tenant.repository.project.ProjectAllocationHistoryRepo;
import com.atomicnorth.hrm.tenant.repository.project.ProjectAllocationRepository;
import com.atomicnorth.hrm.tenant.repository.project.ProjectDocumentRepository;
import com.atomicnorth.hrm.tenant.repository.project.ProjectMilestoneRepository;
import com.atomicnorth.hrm.tenant.repository.project.ProjectPriceMappingRepository;
import com.atomicnorth.hrm.tenant.repository.project.ProjectPriceRepository;
import com.atomicnorth.hrm.tenant.repository.project.ProjectRepository;
import com.atomicnorth.hrm.tenant.repository.project.ProjectTaskAllocationRepository;
import com.atomicnorth.hrm.tenant.repository.project.ProjectTaskRoleRepository;
import com.atomicnorth.hrm.tenant.repository.project.ProjectTaskRoleUserRepository;
import com.atomicnorth.hrm.tenant.repository.project.ProjectTemplateRepository;
import com.atomicnorth.hrm.tenant.repository.project.SubTaskStoryRepository;
import com.atomicnorth.hrm.tenant.repository.project.TaskStoryRepository;
import com.atomicnorth.hrm.tenant.service.SequenceGeneratorService;
import com.atomicnorth.hrm.tenant.service.dto.EmployeeProjectAllocationDTO;
import com.atomicnorth.hrm.tenant.service.dto.EmployeeProjectDTO;
import com.atomicnorth.hrm.tenant.service.dto.project.PriceElementDTO;
import com.atomicnorth.hrm.tenant.service.dto.project.ProjectAllocationDTO;
import com.atomicnorth.hrm.tenant.service.dto.project.ProjectDTO;
import com.atomicnorth.hrm.tenant.service.dto.project.ProjectMilestoneDTO;
import com.atomicnorth.hrm.tenant.service.dto.project.ProjectResponse.ProjectDocumentResponseDTO;
import com.atomicnorth.hrm.tenant.service.dto.project.ProjectResponse.ProjectRequestDTO;
import com.atomicnorth.hrm.tenant.service.dto.project.ProjectResponse.ProjectResponseDTO;
import com.atomicnorth.hrm.tenant.service.dto.project.ProjectTemplateDTO;
import com.atomicnorth.hrm.tenant.service.dto.project.ProjectTemplateTaskDTO;
import com.atomicnorth.hrm.tenant.service.dto.project.SubTaskStoryDTO;
import com.atomicnorth.hrm.tenant.service.dto.project.TaskStoryDTO;
import com.atomicnorth.hrm.util.ActivityLog;
import com.atomicnorth.hrm.util.Enum.Active;
import com.atomicnorth.hrm.util.Enum.SequenceType;
import com.atomicnorth.hrm.util.commonClass.PaginatedResponse;
import org.apache.commons.beanutils.BeanUtils;
import org.modelmapper.ModelMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.server.ResponseStatusException;

import javax.persistence.EntityManager;
import javax.persistence.EntityNotFoundException;
import javax.persistence.Tuple;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Expression;
import javax.persistence.criteria.Join;
import javax.persistence.criteria.JoinType;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import javax.servlet.http.HttpServletRequest;
import javax.validation.ValidationException;
import java.lang.reflect.Field;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.sql.Timestamp;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.time.Instant;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.NoSuchElementException;
import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import java.util.TreeSet;
import java.util.stream.Collectors;
import java.util.stream.Stream;


<span class="fc" id="L130">@Service</span>
public class ProjectService {
<span class="nc" id="L132">    private final Logger log = LoggerFactory.getLogger(ProjectService.class);</span>
    private final UserRepository userRepository;
    @Autowired
    ActivityLog activityLog;

    private final ProjectTemplateRepository projectTemplateRepository;
    private final ProjectRepository projectRepository;
    private final ProjectTaskRoleUserRepository projectTaskRoleUserRepository;
    private final ProjectAllocationRepository projectAllocationRepository;
    private final TaskStoryRepository taskStoryRepository;
    private final ProjectPriceRepository projectPriceRepository;
    private final ProjectTaskRoleRepository projectTaskRoleRepository;
    private final ProjectTaskAllocationRepository projectTaskAllocationRepository;
    private final ProjectMilestoneRepository projectMilestoneRepository;
    private final ProjectDocumentRepository projectDocumentRepository;
    private final ProjectPriceMappingRepository projectPriceMappingRepository;
    private final LookupCodeRepository lookupCodeRepository;
    private final HolidaysCalendarRepository holidaysCalendarRepository;
    private final ModelMapper modelMapper;
    private final SubTaskStoryRepository subTaskStoryRepository;
    private final EntityManager entityManager;
    private final EmployeeRepository employeeRepository;
    private final ProjectAllocationHistoryRepo repo;
    private final SequenceGeneratorService sequenceGeneratorService;
    private final HttpServletRequest httpServletRequest;
    private final HolidaysCalendarDayRepository holidaysCalendarDayRepository;

<span class="nc" id="L159">    public ProjectService(UserRepository userRepository, ProjectTemplateRepository projectTemplateRepository, ProjectRepository projectRepository, ProjectTaskRoleUserRepository projectTaskRoleUserRepository, ProjectAllocationRepository projectAllocationRepository, TaskStoryRepository taskStoryRepository, ProjectPriceRepository projectPriceRepository, ProjectTaskRoleRepository projectTaskRoleRepository, ProjectTaskAllocationRepository projectTaskAllocationRepository, ProjectMilestoneRepository projectMilestoneRepository, ProjectDocumentRepository projectDocumentRepository, ProjectPriceMappingRepository projectPriceMappingRepository, LookupCodeRepository lookupCodeRepository, HolidaysCalendarRepository holidaysCalendarRepository, ModelMapper modelMapper, SubTaskStoryRepository subTaskStoryRepository, EntityManager entityManager, EmployeeRepository employeeRepository, ProjectAllocationHistoryRepo repo, SequenceGeneratorService sequenceGeneratorService, HttpServletRequest httpServletRequest, HolidaysCalendarDayRepository holidaysCalendarDayRepository) {</span>
<span class="nc" id="L160">        this.userRepository = userRepository;</span>
<span class="nc" id="L161">        this.projectTemplateRepository = projectTemplateRepository;</span>
<span class="nc" id="L162">        this.projectRepository = projectRepository;</span>
<span class="nc" id="L163">        this.projectTaskRoleUserRepository = projectTaskRoleUserRepository;</span>
<span class="nc" id="L164">        this.projectAllocationRepository = projectAllocationRepository;</span>
<span class="nc" id="L165">        this.taskStoryRepository = taskStoryRepository;</span>
<span class="nc" id="L166">        this.projectPriceRepository = projectPriceRepository;</span>
<span class="nc" id="L167">        this.projectTaskRoleRepository = projectTaskRoleRepository;</span>
<span class="nc" id="L168">        this.projectTaskAllocationRepository = projectTaskAllocationRepository;</span>
<span class="nc" id="L169">        this.projectMilestoneRepository = projectMilestoneRepository;</span>
<span class="nc" id="L170">        this.projectDocumentRepository = projectDocumentRepository;</span>
<span class="nc" id="L171">        this.projectPriceMappingRepository = projectPriceMappingRepository;</span>
<span class="nc" id="L172">        this.lookupCodeRepository = lookupCodeRepository;</span>
<span class="nc" id="L173">        this.holidaysCalendarRepository = holidaysCalendarRepository;</span>
<span class="nc" id="L174">        this.modelMapper = modelMapper;</span>
<span class="nc" id="L175">        this.subTaskStoryRepository = subTaskStoryRepository;</span>
<span class="nc" id="L176">        this.entityManager = entityManager;</span>
<span class="nc" id="L177">        this.employeeRepository = employeeRepository;</span>
<span class="nc" id="L178">        this.repo = repo;</span>
<span class="nc" id="L179">        this.sequenceGeneratorService = sequenceGeneratorService;</span>
<span class="nc" id="L180">        this.httpServletRequest = httpServletRequest;</span>
<span class="nc" id="L181">        this.holidaysCalendarDayRepository = holidaysCalendarDayRepository;</span>
<span class="nc" id="L182">    }</span>

    public Project createProject(ProjectDTO projectDTO) {
<span class="nc" id="L185">        UserLoginDetail userLoginDetail = SessionHolder.getUserLoginDetail();</span>
<span class="nc" id="L186">        Project project = new Project();</span>
<span class="nc" id="L187">        project.setProjectName(projectDTO.getProjectName());</span>
<span class="nc" id="L188">        project.setProjectDesc(projectDTO.getProjectDesc());</span>
<span class="nc" id="L189">        project.setCreationDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>
<span class="nc" id="L190">        project.setProjectOwner(String.valueOf(userLoginDetail.getUsername()));</span>
<span class="nc" id="L191">        project.setProjectType(projectDTO.getProjectType());</span>
<span class="nc" id="L192">        project.setStatus(&quot;Active&quot;);</span>
<span class="nc" id="L193">        project.setScheduledEndDate(projectDTO.getEndDate());</span>
<span class="nc" id="L194">        project.setTimsheetApprover(&quot;Client&quot;);</span>
<span class="nc" id="L195">        project.setProjectLocation(projectDTO.getProjectLocation());</span>
<span class="nc" id="L196">        project.setProjectCategory(projectDTO.getProjectCategory());</span>
<span class="nc" id="L197">        project.setCountryId(projectDTO.getCountryId());</span>
<span class="nc" id="L198">        project.setCurrencyId(projectDTO.getCurrencyId());</span>
<span class="nc" id="L199">        project.setLastUpdatedBy(String.valueOf(userLoginDetail.getUsername()));</span>
<span class="nc" id="L200">        project.setCreatedBy(String.valueOf(userLoginDetail.getUsername()));</span>
<span class="nc" id="L201">        project.setProjectId(&quot;P&quot;);</span>

<span class="nc" id="L203">        Project saveProject = projectRepository.save(project);</span>
<span class="nc" id="L204">        String projectId = &quot;P000&quot; + saveProject.getProjectRfNum();</span>
<span class="nc" id="L205">        Project projectById = projectRepository.findById(saveProject.getProjectRfNum()).get();</span>
<span class="nc" id="L206">        projectById.setProjectId(projectId);</span>
<span class="nc" id="L207">        Project finalSaveProject = projectRepository.save(projectById);</span>
<span class="nc" id="L208">        ProjectTaskRoleUser projectTaskRoleUser = new ProjectTaskRoleUser();</span>
<span class="nc" id="L209">        projectTaskRoleUser.setProjectTaskRoleId(1);</span>
<span class="nc" id="L210">        projectTaskRoleUser.setProjectRfNum(saveProject.getProjectRfNum());</span>
<span class="nc" id="L211">        projectTaskRoleUser.setStartDate(projectDTO.getStartDate());</span>
<span class="nc" id="L212">        projectTaskRoleUser.setEndDate(projectDTO.getEndDate());</span>
<span class="nc" id="L213">        projectTaskRoleUser.setIsActive(&quot;Y&quot;);</span>
<span class="nc" id="L214">        projectTaskRoleUser.setIsDeleted(&quot;N&quot;);</span>
<span class="nc" id="L215">        projectTaskRoleUser.setCilentId(1);</span>
<span class="nc" id="L216">        projectTaskRoleUser.setLastUpdatedBy(String.valueOf(userLoginDetail.getUsername()));</span>
<span class="nc" id="L217">        projectTaskRoleUser.setLastUpdateDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>
<span class="nc" id="L218">        projectTaskRoleUser.setCreatedBy(String.valueOf(userLoginDetail.getUsername()));</span>

<span class="nc" id="L220">        projectTaskRoleUserRepository.save(projectTaskRoleUser);</span>

<span class="nc" id="L222">        ProjectAllocation projectAllocation = new ProjectAllocation();</span>
<span class="nc" id="L223">        projectAllocation.setProjectRfNum(saveProject.getProjectRfNum());</span>
<span class="nc" id="L224">        projectAllocation.setStartDate(projectDTO.getStartDate());</span>
<span class="nc" id="L225">        projectAllocation.setEndDate(projectDTO.getEndDate());</span>
<span class="nc" id="L226">        projectAllocation.setDeputation(&quot;Offshore&quot;);</span>
<span class="nc" id="L227">        projectAllocation.setUnitPricePerHour(Long.valueOf(0));</span>
<span class="nc" id="L228">        projectAllocation.setIsActive(&quot;Y&quot;);</span>
<span class="nc" id="L229">        projectAllocation.setIsDeleted(&quot;N&quot;);</span>
<span class="nc" id="L230">        projectAllocation.setCilentId(1);</span>
<span class="nc" id="L231">        projectAllocation.setEmployeeId(0);</span>
<span class="nc" id="L232">        projectAllocation.setLastUpdatedBy(String.valueOf(userLoginDetail.getUsername()));</span>
<span class="nc" id="L233">        projectAllocation.setLastUpdateDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>
<span class="nc" id="L234">        projectAllocation.setCreatedBy(String.valueOf(userLoginDetail.getUsername()));</span>
<span class="nc" id="L235">        projectAllocation.setCreationDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>

<span class="nc" id="L237">        projectAllocationRepository.save(projectAllocation);</span>

<span class="nc" id="L239">        activityLog.captureUserActivity(String.valueOf(Constant.MODULE_ID_PROJECT), String.valueOf(userLoginDetail.getUsername()), projectId, String.valueOf(Constant.MODULE_ID_PROJECT), &quot;New &quot; + project.getProjectType() + &quot; project &quot; + project.getProjectName() + &quot; added&quot;, String.valueOf(userLoginDetail.getUsername()));</span>
<span class="nc" id="L240">        return finalSaveProject;</span>

    }

    public Page&lt;Map&lt;String, Object&gt;&gt; getAllActiveProjects(Pageable pageable) {
<span class="nc" id="L245">        UserLoginDetail userLoginDetail = SessionHolder.getUserLoginDetail();</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (userLoginDetail.getAuthorities().contains(&quot;1&quot;)) {</span>
<span class="nc" id="L247">            return projectRepository.findByProjectStatus(pageable);</span>
        } else {
<span class="nc" id="L249">            return projectRepository.findByProjectStatusForUser(String.valueOf(userLoginDetail.getUsername()), pageable);</span>
        }
    }

    public Project getActiveProjectDetailsById(String id) {
        try {
<span class="nc" id="L255">            int projectId = Integer.parseInt(id);</span>
<span class="nc" id="L256">            return projectRepository.findById(projectId).orElseThrow(() -&gt; new NoSuchElementException(&quot;Project not found&quot;));</span>
<span class="nc" id="L257">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L258">            throw new IllegalArgumentException(&quot;Invalid project ID: &quot; + id);</span>
        }
    }

    public Project updateProjectById(String id, ProjectDTO projectDTO) {
<span class="nc" id="L263">        Project project = projectRepository.findById(Integer.valueOf(id)).get();</span>
<span class="nc" id="L264">        project.setStatus(projectDTO.getProjectStatus());</span>
<span class="nc" id="L265">        project.setProjectOwner(projectDTO.getProjectOwner());</span>
<span class="nc" id="L266">        project.setProjectType(projectDTO.getProjectType());</span>
<span class="nc" id="L267">        project.setTimsheetApprover(projectDTO.getTimsheetApprover());</span>
<span class="nc" id="L268">        project.setProjectDesc(projectDTO.getProjectDesc());</span>
<span class="nc" id="L269">        project.setScheduledStartDate(projectDTO.getScheduledStartDate());</span>
<span class="nc" id="L270">        project.setScheduledEndDate(projectDTO.getScheduledEndDate());</span>
<span class="nc" id="L271">        project.setActualStartDate(projectDTO.getActualStartDate());</span>
<span class="nc" id="L272">        project.setActualEndDate(projectDTO.getActualEndDate());</span>
<span class="nc" id="L273">        return projectRepository.save(project);</span>

    }

    public TaskStory createTaskStory(String id, TaskStoryDTO taskStoryDTO) {
<span class="nc" id="L278">        String taskId = &quot;&quot;;</span>
<span class="nc" id="L279">        Project project = projectRepository.findByProjectRfNum(Integer.parseInt(id));</span>
<span class="nc" id="L280">        String projectRfNum = project.getProjectId();</span>
<span class="nc" id="L281">        String val = &quot;&quot; + ((int) (Math.random() * 9000) + 1000);</span>
<span class="nc" id="L282">        String taskName = taskStoryDTO.getTaskname();</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (taskName.length() &lt;= 4)</span>
<span class="nc" id="L284">            taskId = projectRfNum.substring(0, 4) + val + taskName;</span>
        else
<span class="nc" id="L286">            taskId = projectRfNum.substring(0, 4) + val + taskName.substring(0, 4);</span>
<span class="nc" id="L287">        TaskStory taskStory = new TaskStory();</span>
<span class="nc" id="L288">        taskStory.setTaskid(taskId);</span>
<span class="nc" id="L289">        taskStory.setProjectid(project.getProjectId());</span>
<span class="nc" id="L290">        taskStory.setProjectRfNum(project.getProjectRfNum());</span>
<span class="nc" id="L291">        taskStory.setTaskstatus(&quot;Active&quot;);</span>
<span class="nc" id="L292">        taskStory.setTaskname(taskName);</span>
<span class="nc" id="L293">        taskStory.setTaskdesc(taskStoryDTO.getTaskdesc());</span>
<span class="nc" id="L294">        taskStory.setTasktype(taskStoryDTO.getTasktype());</span>
<span class="nc" id="L295">        taskStory.setPriceElementId(taskStoryDTO.getPriceElementId());</span>
<span class="nc" id="L296">        taskStory.setCriticality(&quot;Medium&quot;);</span>
<span class="nc" id="L297">        taskStory.setEffortWeekCount(&quot;0&quot;);</span>
<span class="nc" id="L298">        taskStory.setEffortDayCount(&quot;0&quot;);</span>
<span class="nc" id="L299">        taskStory.setEffortHourCount(&quot;0&quot;);</span>
<span class="nc" id="L300">        taskStory.setDeleteflag(&quot;N&quot;);</span>
<span class="nc" id="L301">        taskStory.setBillableflag(&quot;Y&quot;);</span>
<span class="nc" id="L302">        taskStory.setWorkprogress(&quot;0&quot;);</span>
<span class="nc" id="L303">        taskStory.setTaskNatureCode(&quot;PROJECT_TASK&quot;);</span>
<span class="nc" id="L304">        return taskStoryRepository.save(taskStory);</span>
    }

    public ProjectAllocation allocateUsersIntoProject(String projectRfNum, String[] userListPAlloc) {
<span class="nc" id="L308">        List&lt;Integer&gt; allocationIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L309">        SimpleDateFormat sdf2 = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L310">        String startDate = sdf2.format(new Date());</span>
<span class="nc" id="L311">        Calendar cal2 = Calendar.getInstance();</span>
<span class="nc" id="L312">        cal2.add(Calendar.DATE, 30);</span>
<span class="nc" id="L313">        Project project = projectRepository.findById(Integer.valueOf(projectRfNum)).get();</span>
<span class="nc" id="L314">        Date projectEndDate = project.getActualStartDate();</span>
<span class="nc" id="L315">        ProjectAllocation projectAllocation = new ProjectAllocation();</span>
<span class="nc" id="L316">        ProjectTaskRoleUser projectTaskRoleUser = new ProjectTaskRoleUser();</span>
<span class="nc" id="L317">        projectAllocation.setEndDate(projectEndDate);</span>
<span class="nc" id="L318">        projectTaskRoleUser.setEndDate(projectEndDate);</span>
<span class="nc" id="L319">        projectAllocation.setProjectRfNum(Integer.valueOf(projectRfNum));</span>
<span class="nc" id="L320">        projectTaskRoleUser.setProjectRfNum(Integer.valueOf(projectRfNum));</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">        for (String uNameTemp : userListPAlloc) {</span>
<span class="nc" id="L322">            projectAllocation.setProjectAllocationId(null);</span>
<span class="nc" id="L323">            projectAllocation.setEmployeeId(Integer.valueOf(uNameTemp));</span>
<span class="nc" id="L324">            projectAllocation.setDeputation(&quot;Offshore&quot;);</span>
<span class="nc" id="L325">            projectAllocation.setUnitPricePerHour(0L);</span>
<span class="nc" id="L326">            projectAllocation.setIsActive(&quot;Y&quot;);</span>
<span class="nc" id="L327">            projectAllocation.setIsDeleted(&quot;N&quot;);</span>
<span class="nc" id="L328">            projectAllocation.setCilentId(1);</span>
<span class="nc" id="L329">            projectAllocation.setStartDate(new Date());</span>
<span class="nc" id="L330">            projectAllocation.setCreationDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>
<span class="nc" id="L331">            projectAllocation.setLastUpdateDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>
<span class="nc" id="L332">            projectAllocationRepository.save(projectAllocation);</span>
<span class="nc" id="L333">            allocationIds = Collections.singletonList(projectAllocation.getProjectAllocationId() + 1);</span>

<span class="nc" id="L335">            projectTaskRoleUser.setProjectTaskRoleUserId(null);</span>
<span class="nc" id="L336">            projectTaskRoleUser.setUsername(Integer.valueOf(uNameTemp));</span>
<span class="nc" id="L337">            projectTaskRoleUser.setProjectTaskRoleId(1);</span>
<span class="nc" id="L338">            projectTaskRoleUser.setIsActive(&quot;Y&quot;);</span>
<span class="nc" id="L339">            projectTaskRoleUser.setIsDeleted(&quot;N&quot;);</span>
<span class="nc" id="L340">            projectTaskRoleUser.setCilentId(1);</span>
<span class="nc" id="L341">            projectTaskRoleUser.setStartDate(new Date());</span>
<span class="nc" id="L342">            projectTaskRoleUser.setCreationDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>
<span class="nc" id="L343">            projectTaskRoleUser.setLastUpdateDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>
<span class="nc" id="L344">            projectTaskRoleUserRepository.save(projectTaskRoleUser);</span>
        }
<span class="nc" id="L346">        List&lt;Integer&gt; finalAllocationIds = allocationIds;</span>
<span class="nc" id="L347">        Thread t = new Thread() {</span>
            public void run() {
<span class="nc" id="L349">                insertIntoResourcePricingTable(projectRfNum, finalAllocationIds, startDate, projectEndDate);</span>
<span class="nc" id="L350">            }</span>
        };
<span class="nc" id="L352">        t.start();</span>
<span class="nc" id="L353">        return projectAllocation;</span>
    }

    private synchronized void insertIntoResourcePricingTable(String projectRfNum, List&lt;Integer&gt; allocationIds, String startDate, Date projectEndDate) {
<span class="nc" id="L357">        DateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
        try {
<span class="nc bnc" id="L359" title="All 2 branches missed.">            for (Integer id : allocationIds) {</span>
<span class="nc" id="L360">                Date startDateDateObj = sdf.parse(startDate);</span>
<span class="nc" id="L361">                Calendar calStart = Calendar.getInstance();</span>
<span class="nc" id="L362">                calStart.setTime(startDateDateObj);</span>
<span class="nc" id="L363">                Calendar calEnd = Calendar.getInstance();</span>
<span class="nc" id="L364">                calEnd.setTime(projectEndDate);</span>
<span class="nc" id="L365">                projectPriceRepository.deleteByProjectAllocationId(id);</span>
<span class="nc" id="L366">                System.out.println(&quot;calStart&quot; + calStart);</span>
<span class="nc" id="L367">                System.out.println(&quot;calEnd&quot; + calEnd);</span>
<span class="nc" id="L368">                System.out.println(&quot;Compare&quot; + calStart.before(calEnd));</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">                while (calStart.before(calEnd)) {</span>
<span class="nc" id="L370">                    String startDateString = sdf.format(calStart.getTime());</span>
<span class="nc" id="L371">                    calStart.add(Calendar.MONTH, 1);</span>
<span class="nc" id="L372">                    calStart.set(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L373">                    calStart.add(Calendar.DATE, -1);</span>
<span class="nc" id="L374">                    String endDateString = sdf.format(calStart.getTime());</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">                    if (calEnd.before(calStart)) {</span>
<span class="nc" id="L376">                        endDateString = sdf.format(calEnd.getTime());</span>
                    }
<span class="nc" id="L378">                    long diffDays = ((sdf.parse(endDateString).getTime() - sdf.parse(startDateString).getTime()) / (24 * 60 * 60 * 1000)) + 1;</span>

                    // Create and populate ProjectPriceAllocation instance
<span class="nc" id="L381">                    ProjectPriceAllocation projectPriceAllocation = new ProjectPriceAllocation();</span>
<span class="nc" id="L382">                    projectPriceAllocation.setProjectResourcePriceAllocation(null);</span>
<span class="nc" id="L383">                    projectPriceAllocation.setProjectAllocationId(id);</span>
<span class="nc" id="L384">                    projectPriceAllocation.setTotalDays((int) diffDays);</span>
<span class="nc" id="L385">                    projectPriceAllocation.setTotalWorkingDays(0.0);</span>
<span class="nc" id="L386">                    projectPriceAllocation.setUserWorkingDays(0.0);</span>
<span class="nc" id="L387">                    projectPriceAllocation.setOnLeave(0.0);</span>
<span class="nc" id="L388">                    projectPriceAllocation.setAdjustmentDays(0.0);</span>
<span class="nc" id="L389">                    projectPriceAllocation.setBillableDays(0.0);</span>
<span class="nc" id="L390">                    projectPriceAllocation.setProjectRfNum(Integer.valueOf(projectRfNum));</span>
<span class="nc" id="L391">                    projectPriceAllocation.setUsername(Integer.valueOf(projectRfNum));</span>
<span class="nc" id="L392">                    projectPriceAllocation.setIsLocked(&quot;N&quot;);</span>
<span class="nc" id="L393">                    projectPriceAllocation.setClientId(1);</span>

                    // Save the instance
<span class="nc" id="L396">                    projectPriceRepository.save(projectPriceAllocation);</span>

<span class="nc" id="L398">                    calStart.add(Calendar.MONTH, 1);</span>
<span class="nc" id="L399">                    calStart.set(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L400">                }</span>
<span class="nc" id="L401">            }</span>
<span class="nc" id="L402">        } catch (Exception e) {</span>
<span class="nc" id="L403">            e.printStackTrace();</span>
<span class="nc" id="L404">        }</span>
<span class="nc" id="L405">    }</span>

    public List&lt;Map&lt;String, Object&gt;&gt; findAllProjectTaskRole() {
<span class="nc" id="L408">        List&lt;ProjectTaskRole&gt; projectTaskRoleList = projectTaskRoleRepository.findAll().stream()</span>
<span class="nc" id="L409">                .filter(x -&gt; x.getRoleLevel().equals(&quot;Project&quot;)).collect(Collectors.toList());</span>
<span class="nc" id="L410">        return projectTaskRoleList.stream().map(obj -&gt; {</span>
<span class="nc" id="L411">            Map&lt;String, Object&gt; results = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L412">            results.put(&quot;projectTaskRoleId&quot;, obj.getProjectTaskRoleId());</span>
<span class="nc" id="L413">            results.put(&quot;roleLevel&quot;, obj.getRoleLevel());</span>
<span class="nc" id="L414">            results.put(&quot;roleName&quot;, obj.getRoleName());</span>
<span class="nc" id="L415">            results.put(&quot;roleDescription&quot;, obj.getRoleDescription());</span>
<span class="nc" id="L416">            results.put(&quot;isActive&quot;, obj.getIsActive());</span>
<span class="nc" id="L417">            results.put(&quot;isDeleted&quot;, obj.getIsDeleted());</span>
<span class="nc" id="L418">            results.put(&quot;createdDate&quot;, obj.getCreationDate());</span>
<span class="nc" id="L419">            return results;</span>
<span class="nc" id="L420">        }).collect(Collectors.toList());</span>
    }

    public ProjectTaskAllocation allocateUsersIntoTask(String taskRfNum, String[] userListTAlloc) {
<span class="nc" id="L424">        Integer taskNum = Integer.valueOf(taskRfNum);</span>

<span class="nc" id="L426">        TaskStory taskStory = taskStoryRepository.findById(taskNum).get();</span>
<span class="nc" id="L427">        Date endDate = taskStory.getPlannedenddate();</span>
<span class="nc" id="L428">        ProjectTaskAllocation projectTaskAllocation = new ProjectTaskAllocation();</span>
<span class="nc" id="L429">        ProjectTaskRoleUser projectTaskRoleUser = new ProjectTaskRoleUser();</span>

<span class="nc bnc" id="L431" title="All 2 branches missed.">        for (String userName : userListTAlloc) {</span>
<span class="nc" id="L432">            String taskAssignmentName = &quot;TA&quot; + userName + taskRfNum + System.currentTimeMillis();</span>
<span class="nc" id="L433">            projectTaskAllocation.setTaskAllocationId(null);</span>
<span class="nc" id="L434">            projectTaskAllocation.setProjectRfNum(taskStory.getProjectRfNum());</span>
<span class="nc" id="L435">            projectTaskAllocation.setUsername(Integer.valueOf(userName));</span>
<span class="nc" id="L436">            projectTaskAllocation.setTaskAssignmentName(taskAssignmentName);</span>
<span class="nc" id="L437">            projectTaskAllocation.setAllocationPercentage(&quot;100&quot;);</span>
<span class="nc" id="L438">            projectTaskAllocation.setTaskRfNum(Integer.valueOf(taskRfNum));</span>
<span class="nc" id="L439">            projectTaskAllocation.setStartDate(new Date());</span>
<span class="nc" id="L440">            projectTaskAllocation.setEndDate(endDate);</span>
<span class="nc" id="L441">            projectTaskAllocation.setDeputation(&quot;Offshore&quot;);</span>
<span class="nc" id="L442">            projectTaskAllocation.setIsActive(&quot;Y&quot;);</span>
<span class="nc" id="L443">            projectTaskAllocation.setIsDeleted(&quot;N&quot;);</span>
<span class="nc" id="L444">            projectTaskAllocation.setClientId(1);</span>
<span class="nc" id="L445">            projectTaskAllocation.setLastUpdateDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>
<span class="nc" id="L446">            projectTaskAllocation.setCreationDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>

<span class="nc" id="L448">            projectTaskAllocationRepository.save(projectTaskAllocation);</span>

<span class="nc" id="L450">            projectTaskRoleUser.setProjectTaskRoleId(2);</span>
<span class="nc" id="L451">            projectTaskRoleUser.setProjectTaskRoleUserId(null);</span>
<span class="nc" id="L452">            projectTaskRoleUser.setTaskRfNum(Integer.valueOf(taskRfNum));</span>
<span class="nc" id="L453">            projectTaskRoleUser.setUsername(Integer.valueOf(userName));</span>
<span class="nc" id="L454">            projectTaskRoleUser.setStartDate(new Date());</span>
<span class="nc" id="L455">            projectTaskRoleUser.setEndDate(endDate);</span>
<span class="nc" id="L456">            projectTaskRoleUser.setIsActive(&quot;Y&quot;);</span>
<span class="nc" id="L457">            projectTaskRoleUser.setIsDeleted(&quot;N&quot;);</span>
<span class="nc" id="L458">            projectTaskRoleUser.setCilentId(1);</span>
<span class="nc" id="L459">            projectTaskRoleUser.setLastUpdateDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>
<span class="nc" id="L460">            projectTaskRoleUser.setCreationDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>

<span class="nc" id="L462">            projectTaskRoleUserRepository.save(projectTaskRoleUser);</span>
        }

<span class="nc" id="L465">        return projectTaskAllocation;</span>
    }

    @Transactional
    public Map&lt;String, Object&gt; getTaskByProjectId(Integer projectRf, String searchField, String searchKeyword, Pageable pageable) {
<span class="nc" id="L470">        List&lt;Integer&gt; taskIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L471">        Project project = projectRepository.findById(projectRf).orElse(null);</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">        if (project != null) {</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">            if (project.getProjectTemplateId() != null) {</span>
<span class="nc" id="L474">                projectTemplateRepository.findById(project.getProjectTemplateId()).ifPresent(projectTemplate -&gt; taskIds.addAll(projectTemplate.getProjectTemplateTasks().stream().filter(x -&gt; &quot;Y&quot;.equals(x.getIsActive())).map(ProjectTemplateTask::getTaskId).collect(Collectors.toList())));</span>
            }
        }
<span class="nc" id="L477">        List&lt;ProjectTaskAllocation&gt; allocations = projectTaskAllocationRepository.findByProjectRfNum(projectRf);</span>
<span class="nc" id="L478">        taskIds.addAll(allocations.stream().map(ProjectTaskAllocation::getTaskRfNum).collect(Collectors.toList()));</span>

<span class="nc bnc" id="L480" title="All 6 branches missed.">        if (searchKeyword != null &amp;&amp; !searchKeyword.trim().isEmpty() &amp;&amp; searchField != null) {</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">            if (&quot;taskstatus&quot;.equalsIgnoreCase(searchField)) {</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">                if (searchKeyword.trim().toLowerCase().matches(&quot;a|ac|act|activ|active.*&quot;)) {</span>
<span class="nc" id="L483">                    searchKeyword = &quot;A&quot;;</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">                } else if (searchKeyword.trim().toLowerCase().matches(&quot;i|in|ina|inac|inact|inacti|inactive.*&quot;)) {</span>
<span class="nc" id="L485">                    searchKeyword = &quot;I&quot;;</span>
                }
            }
        }
<span class="nc" id="L489">        final String finalSearchField = searchField;</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">        final String finalSearchKeyword = (searchKeyword != null) ? &quot;%&quot; + searchKeyword.toLowerCase() + &quot;%&quot; : null;</span>
<span class="nc" id="L491">        Specification&lt;TaskStory&gt; spec = (root, query, cb) -&gt; {</span>
<span class="nc" id="L492">            List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();</span>
            // Apply fetch only if not a count query
<span class="nc bnc" id="L494" title="All 2 branches missed.">            if (!Long.class.equals(query.getResultType())) {</span>
<span class="nc" id="L495">                root.fetch(&quot;projectMilestone&quot;, JoinType.LEFT);</span>
            }
<span class="nc" id="L497">            Join&lt;Object, Object&gt; milestoneJoin = root.join(&quot;projectMilestone&quot;, JoinType.LEFT); // For filtering</span>
<span class="nc" id="L498">            predicates.add(cb.equal(root.get(&quot;projectRfNum&quot;), projectRf));</span>

<span class="nc" id="L500">            predicates.add(root.get(&quot;taskRfNum&quot;).in(taskIds));</span>

<span class="nc bnc" id="L502" title="All 4 branches missed.">            if (finalSearchField != null &amp;&amp; finalSearchKeyword != null) {</span>
<span class="nc bnc" id="L503" title="All 8 branches missed.">                switch (finalSearchField.toLowerCase()) {</span>
                    case &quot;taskname&quot;:
<span class="nc" id="L505">                        predicates.add(cb.like(cb.lower(root.get(&quot;taskname&quot;)), finalSearchKeyword));</span>
<span class="nc" id="L506">                        break;</span>
                    case &quot;taskdesc&quot;:
<span class="nc" id="L508">                        predicates.add(cb.like(cb.lower(root.get(&quot;taskdesc&quot;)), finalSearchKeyword));</span>
<span class="nc" id="L509">                        break;</span>
                    case &quot;taskstatus&quot;:
<span class="nc" id="L511">                        predicates.add(cb.like(cb.lower(root.get(&quot;taskstatus&quot;)), finalSearchKeyword));</span>
<span class="nc" id="L512">                        break;</span>
                    case &quot;tasktype&quot;:
<span class="nc" id="L514">                        predicates.add(cb.like(cb.lower(root.get(&quot;tasktype&quot;)), finalSearchKeyword));</span>
<span class="nc" id="L515">                        break;</span>
                    case &quot;milestonename&quot;:
<span class="nc" id="L517">                        predicates.add(cb.like(cb.lower(milestoneJoin.get(&quot;milestoneName&quot;)), finalSearchKeyword));</span>
<span class="nc" id="L518">                        break;</span>
                    case &quot;plannedstartdate&quot;:
<span class="nc" id="L520">                        predicates.add(cb.like(cb.lower(cb.function(&quot;DATE_FORMAT&quot;, String.class, root.get(&quot;plannedstartdate&quot;), cb.literal(&quot;%Y-%m-%d&quot;))), finalSearchKeyword));</span>
<span class="nc" id="L521">                        break;</span>
                    case &quot;plannedenddate&quot;:
<span class="nc" id="L523">                        predicates.add(cb.like(cb.lower(cb.function(&quot;DATE_FORMAT&quot;, String.class, root.get(&quot;plannedenddate&quot;), cb.literal(&quot;%Y-%m-%d&quot;))), finalSearchKeyword));</span>
                        break;
                }
            }
<span class="nc" id="L527">            return cb.and(predicates.toArray(new Predicate[0]));</span>
        };
        Page&lt;TaskStory&gt; taskStories;
<span class="nc bnc" id="L530" title="All 6 branches missed.">        if (finalSearchField != null &amp;&amp; finalSearchKeyword != null &amp;&amp; !finalSearchField.trim().isEmpty()) {</span>
<span class="nc" id="L531">            taskStories = taskStoryRepository.findAll(spec, pageable);</span>
        } else {
<span class="nc" id="L533">            taskStories = taskStoryRepository.findByTaskRfNumIn(taskIds, pageable);</span>
        }

<span class="nc" id="L536">        List&lt;TaskStoryDTO&gt; taskStoryDTOList = taskStories.getContent()</span>
<span class="nc" id="L537">                .stream()</span>
<span class="nc" id="L538">                .map(task -&gt; {</span>
<span class="nc" id="L539">                    task.getSubTaskStories().size();</span>
<span class="nc" id="L540">                    return mapToDTOForSave(task);</span>
                })
<span class="nc" id="L542">                .peek(task -&gt; {</span>
<span class="nc" id="L543">                    task.setProjectRfNum(projectRf);</span>
<span class="nc" id="L544">                })</span>
<span class="nc" id="L545">                .collect(Collectors.toList());</span>

<span class="nc" id="L547">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L548">        response.put(&quot;result&quot;, taskStoryDTOList);</span>
<span class="nc" id="L549">        response.put(&quot;currentPage&quot;, taskStories.getNumber() + 1);</span>
<span class="nc" id="L550">        response.put(&quot;totalItems&quot;, taskStories.getTotalElements());</span>
<span class="nc" id="L551">        response.put(&quot;PageSize&quot;, taskStories.getSize());</span>
<span class="nc" id="L552">        response.put(&quot;totalPages&quot;, taskStories.getTotalPages());</span>
<span class="nc" id="L553">        return response;</span>
    }

    public List&lt;Map&lt;String, Object&gt;&gt; getUserByProjectRf(String projectRf) {
<span class="nc" id="L557">        List&lt;Map&lt;String, Object&gt;&gt; map = projectAllocationRepository.findUserByProjectRf(projectRf);</span>
<span class="nc" id="L558">        return map;</span>
    }

    public List&lt;Map&lt;String, Object&gt;&gt; getUserByTaskId(Integer taskId) {
<span class="nc" id="L562">        List&lt;Map&lt;String, Object&gt;&gt; map = projectTaskAllocationRepository.findUserByTaskId(taskId);</span>
<span class="nc" id="L563">        return map;</span>
    }

    public List&lt;Map&lt;String, Object&gt;&gt; fetchAvailableProjectRole(String projectRfNum, String username) {
<span class="nc" id="L567">        List&lt;Map&lt;String, Object&gt;&gt; map = projectTaskRoleRepository.getProjectRole(projectRfNum, username);</span>
<span class="nc" id="L568">        return map;</span>
    }

    public ResponseEntity&lt;String&gt; modifyUsersProjectAssignment(String projectAllocationId, String projectRfNum, String username, String startDate, String endDate, String deputation, String[] userpRole, String resourceUnitPricePerHour) {
        try {
<span class="nc" id="L573">            ProjectAllocation projectAllocation = new ProjectAllocation();</span>
<span class="nc" id="L574">            ProjectTaskRoleUser projectTaskRoleUser = new ProjectTaskRoleUser();</span>
<span class="nc" id="L575">            SimpleDateFormat sdf2 = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L576">            ProjectAllocation projectAllocationData = projectAllocationRepository.findById(Integer.parseInt(projectAllocationId)).orElse(null);</span>

<span class="nc bnc" id="L578" title="All 2 branches missed.">            if (projectAllocationData == null) {</span>
<span class="nc" id="L579">                return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(&quot;Invalid allocation id&quot;);</span>
            }

<span class="nc" id="L582">            projectAllocation.setDeputation(deputation);</span>
<span class="nc" id="L583">            projectAllocation.setStartDate(sdf2.parse(startDate));</span>
<span class="nc" id="L584">            projectAllocation.setEndDate(sdf2.parse(endDate));</span>
<span class="nc" id="L585">            projectAllocation.setProjectAllocationId(Integer.valueOf(projectAllocationId));</span>
<span class="nc" id="L586">            projectAllocation.setRemark(&quot;&quot;);</span>
<span class="nc" id="L587">            projectAllocation.setLastUpdatedBy(&quot;&quot;);</span>
<span class="nc" id="L588">            projectAllocation.setLastUpdateDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>
<span class="nc" id="L589">            projectAllocation.setUnitPricePerHour(Long.valueOf(resourceUnitPricePerHour));</span>
<span class="nc" id="L590">            projectAllocation.setIsActive(&quot;Y&quot;);</span>
<span class="nc" id="L591">            projectAllocation.setIsDeleted(&quot;N&quot;);</span>
<span class="nc" id="L592">            projectAllocation.setCilentId(1);</span>
<span class="nc" id="L593">            projectAllocation.setProjectRfNum(projectAllocationData.getProjectRfNum());</span>
<span class="nc" id="L594">            projectAllocation.setEmployeeId(Integer.valueOf(username));</span>
<span class="nc" id="L595">            projectAllocationRepository.save(projectAllocation);</span>

<span class="nc bnc" id="L597" title="All 4 branches missed.">            if (userpRole != null &amp;&amp; userpRole.length &gt; 0) {</span>
<span class="nc" id="L598">                projectTaskRoleUserRepository.deleteByProjectIdAndUsername(projectRfNum, username);</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">                for (String s : userpRole) {</span>
<span class="nc" id="L600">                    projectTaskRoleUser.setProjectTaskRoleUserId(null);</span>
<span class="nc" id="L601">                    projectTaskRoleUser.setProjectTaskRoleId(Integer.valueOf(s));</span>
<span class="nc" id="L602">                    projectTaskRoleUser.setProjectRfNum(Integer.valueOf(projectRfNum));</span>
<span class="nc" id="L603">                    projectTaskRoleUser.setUsername(Integer.valueOf(username));</span>
<span class="nc" id="L604">                    projectTaskRoleUser.setStartDate(sdf2.parse(startDate));</span>
<span class="nc" id="L605">                    projectTaskRoleUser.setEndDate(sdf2.parse(endDate));</span>
<span class="nc" id="L606">                    projectTaskRoleUserRepository.save(projectTaskRoleUser);</span>
                }
            }

<span class="nc bnc" id="L610" title="All 4 branches missed.">            if (!(startDate.equals(String.valueOf(projectAllocationData.getStartDate())) &amp;&amp; endDate.equals(String.valueOf(projectAllocationData.getEndDate())))) {</span>
<span class="nc" id="L611">                Thread t = new Thread() {</span>
                    public void run() {
                        try {
<span class="nc" id="L614">                            insertIntoResourcePricingTable(projectRfNum, new ArrayList&lt;Integer&gt;(List.of(Integer.valueOf(projectAllocationId))), startDate, sdf2.parse(endDate));</span>
<span class="nc" id="L615">                        } catch (ParseException e) {</span>
<span class="nc" id="L616">                            throw new RuntimeException(e);</span>
<span class="nc" id="L617">                        }</span>
<span class="nc" id="L618">                    }</span>
                };
<span class="nc" id="L620">                t.start();</span>
            }
<span class="nc" id="L622">            return ResponseEntity.ok(&quot;User assignment updated successfully.&quot;);</span>
<span class="nc" id="L623">        } catch (Exception e) {</span>
<span class="nc" id="L624">            e.printStackTrace();</span>
<span class="nc" id="L625">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(e.getMessage());</span>
        }
    }

    public List&lt;Map&lt;String, Object&gt;&gt; getActiveUsersForProject(Integer projectRfNum, Boolean allUserFlag) {
<span class="nc" id="L630">        return projectAllocationRepository.findActiveUsersForProject(projectRfNum);</span>
    }

    @Transactional
    public List&lt;Map&lt;String, Object&gt;&gt; saveProjectAllocationToUser(List&lt;Integer&gt; usernames, Integer projectRfNum, Boolean addRemoveFlag) {
<span class="nc bnc" id="L635" title="All 2 branches missed.">        for (Integer username : usernames) {</span>
<span class="nc" id="L636">            ProjectAllocation projectAllocation = new ProjectAllocation();</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">            if (addRemoveFlag) {</span>
<span class="nc" id="L638">                projectAllocation.setEmployeeId(username);</span>
<span class="nc" id="L639">                projectAllocation.setProjectRfNum(projectRfNum);</span>
<span class="nc" id="L640">                projectAllocation.setDeputation(&quot;Offshore&quot;);</span>
<span class="nc" id="L641">                projectAllocation.setUnitPricePerHour(0L);</span>
<span class="nc" id="L642">                projectAllocation.setIsActive(&quot;Y&quot;);</span>
<span class="nc" id="L643">                projectAllocation.setIsDeleted(&quot;N&quot;);</span>
<span class="nc" id="L644">                projectAllocation.setCilentId(1);</span>
<span class="nc" id="L645">                projectAllocationRepository.save(projectAllocation);</span>
            } else {
                //projectAllocationRepository.deleteByUsernameAndProjectRfNum(username, projectRfNum);
            }

<span class="nc" id="L650">        }</span>
<span class="nc" id="L651">        return projectAllocationRepository.findActiveUsersForProject(projectRfNum);</span>
    }

    @Transactional
    public void deleteProjectTask(String taskRfNum) {
        try {
<span class="nc" id="L657">            taskStoryRepository.deleteProjectTask(taskRfNum);</span>
<span class="nc" id="L658">        } catch (Exception e) {</span>
<span class="nc" id="L659">            throw new RuntimeException(&quot;Error occurred while deleting task.&quot;, e);</span>
<span class="nc" id="L660">        }</span>
<span class="nc" id="L661">    }</span>

    public TaskStory updateTaskById(Integer id, TaskStoryDTO taskStoryDTO) {
<span class="nc" id="L664">        UserLoginDetail userLoginDetail = SessionHolder.getUserLoginDetail();</span>
<span class="nc" id="L665">        TaskStory taskStory = taskStoryRepository.findBytaskRfNum(id);</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">        if (taskStory != null) {</span>
<span class="nc" id="L667">            taskStory.setTasktype(taskStoryDTO.getTasktype());</span>
<span class="nc" id="L668">            taskStory.setTaskdesc(taskStoryDTO.getTaskdesc());</span>
<span class="nc" id="L669">            taskStory.setEffortWeekCount(taskStoryDTO.getEffortWeekCount());</span>
<span class="nc" id="L670">            taskStory.setEffortDayCount(taskStoryDTO.getEffortDayCount());</span>
<span class="nc" id="L671">            taskStory.setEffortHourCount(taskStoryDTO.getEffortHourCount());</span>
<span class="nc" id="L672">            taskStory.setPlannedstartdate(taskStoryDTO.getPlannedstartdate());</span>
<span class="nc" id="L673">            taskStory.setPlannedenddate(taskStoryDTO.getPlannedenddate());</span>
<span class="nc" id="L674">            taskStory.setActualstartdate(taskStoryDTO.getActualstartdate());</span>
<span class="nc" id="L675">            taskStory.setActualenddate(taskStoryDTO.getActualenddate());</span>
<span class="nc" id="L676">            taskStory.setTaskstatus(taskStoryDTO.getTaskstatus());</span>
<span class="nc" id="L677">            taskStory.setLastUpdatedDate(Instant.now());</span>
<span class="nc" id="L678">            taskStory.setLastUpdatedBy(String.valueOf(userLoginDetail.getUsername()));</span>
<span class="nc" id="L679">            taskStory.setCriticality(taskStoryDTO.getCriticality());</span>
<span class="nc" id="L680">            taskStory.setBillableflag(taskStoryDTO.getBillableflag());</span>
<span class="nc" id="L681">            taskStory.setPriceElementId(taskStoryDTO.getPriceElementId());</span>

<span class="nc" id="L683">            return taskStoryRepository.save(taskStory);</span>
        } else {
<span class="nc" id="L685">            throw new EntityNotFoundException(&quot;Task with ID &quot; + id + &quot; not found&quot;);</span>
        }
    }

    @Transactional
    public TaskStoryDTO getTaskById(Integer taskId) {
<span class="nc" id="L691">        return taskStoryRepository.findById(taskId)</span>
<span class="nc" id="L692">                .map(task -&gt; {</span>
<span class="nc" id="L693">                    task.getSubTaskStories().size();</span>
<span class="nc" id="L694">                    return mapToDTOForSave(task);</span>
                })
<span class="nc" id="L696">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Task with ID &quot; + taskId + &quot; not found&quot;));</span>
    }

    public Object addUsersProjectAssignment(String projectRfNum, String username, String startDate, Date endDate, Long unitPricePerHour) throws ParseException {
        try {
<span class="nc" id="L701">            UserLoginDetail userLoginDetail = SessionHolder.getUserLoginDetail();</span>
<span class="nc" id="L702">            SimpleDateFormat dateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L703">            Date projectStartDate = dateFormat.parse(startDate);</span>

<span class="nc" id="L705">            int allocationHistoryCount = projectAllocationRepository.findProjectAllocation(projectRfNum, username, startDate, endDate);</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">            if (allocationHistoryCount == 0) {</span>
<span class="nc" id="L707">                ProjectAllocation projectAllocation = new ProjectAllocation();</span>
<span class="nc" id="L708">                projectAllocation.setProjectRfNum(Integer.valueOf(projectRfNum));</span>
<span class="nc" id="L709">                projectAllocation.setEmployeeId(Integer.valueOf(username));</span>
<span class="nc" id="L710">                projectAllocation.setStartDate(projectStartDate);</span>
<span class="nc" id="L711">                projectAllocation.setEndDate(endDate);</span>
<span class="nc" id="L712">                projectAllocation.setLastUpdatedBy(String.valueOf(userLoginDetail.getUsername()));</span>
<span class="nc" id="L713">                projectAllocation.setCreatedBy(String.valueOf(userLoginDetail.getUsername()));</span>
<span class="nc" id="L714">                projectAllocation.setLastUpdateDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>
<span class="nc" id="L715">                projectAllocation.setUnitPricePerHour(unitPricePerHour);</span>
<span class="nc" id="L716">                projectAllocation.setCreationDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>
<span class="nc" id="L717">                projectAllocation.setDeputation(&quot;Offshore&quot;);</span>
<span class="nc" id="L718">                projectAllocation.setIsActive(&quot;Y&quot;);</span>
<span class="nc" id="L719">                projectAllocation.setIsDeleted(&quot;N&quot;);</span>
<span class="nc" id="L720">                projectAllocation.setCilentId(1);</span>

<span class="nc" id="L722">                ProjectAllocation savedProjectAllocation = projectAllocationRepository.save(projectAllocation);</span>
<span class="nc" id="L723">                List&lt;Integer&gt; param = Collections.singletonList(savedProjectAllocation.getProjectAllocationId());</span>

<span class="nc" id="L725">                Thread t2 = new Thread() {</span>
                    public void run() {
<span class="nc" id="L727">                        insertIntoResourcePricingTable(projectRfNum, param, startDate, endDate);</span>
<span class="nc" id="L728">                    }</span>
                };
<span class="nc" id="L730">                t2.start();</span>
<span class="nc" id="L731">                return &quot;Assignment added successfully.&quot;;</span>
            } else {
<span class="nc" id="L733">                return &quot;Entered date range already exists. Please change allocation dates.&quot;;</span>
            }
<span class="nc" id="L735">        } catch (Exception e) {</span>
<span class="nc" id="L736">            e.printStackTrace();</span>
<span class="nc" id="L737">            return e.getMessage();</span>
        }
    }

    @Transactional
    public String removeUsersProjectAssignment(Integer projectAllocationId) {
        try {
<span class="nc" id="L744">            UserLoginDetail userLoginDetail = SessionHolder.getUserLoginDetail();</span>
<span class="nc" id="L745">            ProjectAllocation projectAllocation = projectAllocationRepository.findById(projectAllocationId).get();</span>
<span class="nc" id="L746">            projectAllocation.setIsDeleted(&quot;Y&quot;);</span>
<span class="nc" id="L747">            projectAllocation.setLastUpdatedBy(String.valueOf(userLoginDetail.getUsername()));</span>
<span class="nc" id="L748">            projectAllocation.setLastUpdateDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>
<span class="nc" id="L749">            projectAllocation.setProjectAllocationId(projectAllocationId);</span>
<span class="nc" id="L750">            projectAllocationRepository.save(projectAllocation);</span>
<span class="nc" id="L751">            projectPriceRepository.deleteByProjectAllocationId(projectAllocationId);</span>
<span class="nc" id="L752">            return &quot;Assignment removed successfully&quot;;</span>
<span class="nc" id="L753">        } catch (Exception e) {</span>
<span class="nc" id="L754">            e.printStackTrace();</span>
<span class="nc" id="L755">            return e.getMessage();</span>
        }
    }

    public List&lt;Map&lt;String, Object&gt;&gt; getProjectDetails(String id) {
<span class="nc" id="L760">        List&lt;Map&lt;String, Object&gt;&gt; obj = projectRepository.findProjectDetails(id);</span>
<span class="nc" id="L761">        return obj;</span>
    }

    @Transactional
    public String uploadProjectScannedDocument(Integer id,
                                               MultipartFile doc,
                                               String projectRfNum,
                                               String docType,
                                               String docName,
                                               String docNumber,
                                               String remark,
                                               HttpServletRequest request) {
        try {
<span class="nc bnc" id="L774" title="All 4 branches missed.">            if (doc == null || doc.isEmpty()) {</span>
<span class="nc" id="L775">                return &quot;Error: Uploaded document is missing or empty. Please select a valid file.&quot;;</span>
            }

<span class="nc" id="L778">            String originalFileName = doc.getOriginalFilename();</span>
<span class="nc bnc" id="L779" title="All 4 branches missed.">            if (originalFileName == null || !originalFileName.contains(&quot;.&quot;)) {</span>
<span class="nc" id="L780">                return &quot;Error: The uploaded file has an invalid name or no extension.&quot;;</span>
            }

<span class="nc" id="L783">            String extension = originalFileName.substring(originalFileName.lastIndexOf('.') + 1).toLowerCase();</span>
<span class="nc" id="L784">            List&lt;String&gt; allowedExtensions = Arrays.asList(&quot;pdf&quot;, &quot;doc&quot;, &quot;jpeg&quot;, &quot;jpg&quot;, &quot;png&quot;, &quot;rtf&quot;, &quot;txt&quot;, &quot;docx&quot;);</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">            if (!allowedExtensions.contains(extension)) {</span>
<span class="nc" id="L786">                return &quot;Error: Unsupported file type. Allowed formats: pdf, doc, jpeg, jpg, png, rtf, txt, docx.&quot;;</span>
            }

<span class="nc bnc" id="L789" title="All 4 branches missed.">            if (projectRfNum == null || projectRfNum.trim().isEmpty()) {</span>
<span class="nc" id="L790">                return &quot;Error: Project Reference Number is required and cannot be empty.&quot;;</span>
            }

<span class="nc" id="L793">            List&lt;ProjectDocument&gt; existingDocs = projectDocumentRepository.findByProjectRfNum(projectRfNum);</span>
<span class="nc" id="L794">            UserLoginDetail loginUser = SessionHolder.getUserLoginDetail();</span>

<span class="nc" id="L796">            LocalDate today = LocalDate.now();</span>
<span class="nc" id="L797">            String timestamp = String.valueOf(System.currentTimeMillis());</span>
<span class="nc" id="L798">            String renamedFileName = projectRfNum + &quot;_&quot; + timestamp + &quot;.&quot; + extension;</span>

<span class="nc" id="L800">            Path baseAssetsPath = Paths.get(&quot;src/main/resources/assets&quot;);</span>
<span class="nc" id="L801">            Path scannedDocsBasePath = baseAssetsPath.resolve(&quot;projectScannedDocuments&quot;);</span>

<span class="nc" id="L803">            String relativeFolderPath = projectRfNum + &quot;/&quot; +</span>
<span class="nc" id="L804">                    today.getYear() + &quot;/&quot; +</span>
<span class="nc" id="L805">                    String.format(&quot;%02d&quot;, today.getMonthValue()) + &quot;/&quot; +</span>
<span class="nc" id="L806">                    String.format(&quot;%02d&quot;, today.getDayOfMonth());</span>

<span class="nc" id="L808">            Path folderPath = scannedDocsBasePath.resolve(relativeFolderPath);</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">            if (!Files.exists(folderPath)) {</span>
<span class="nc" id="L810">                Files.createDirectories(folderPath);</span>
            }

<span class="nc" id="L813">            Path filePath = folderPath.resolve(renamedFileName);</span>
<span class="nc" id="L814">            Files.copy(doc.getInputStream(), filePath, StandardCopyOption.REPLACE_EXISTING);</span>

<span class="nc" id="L816">            String serverDocPath = &quot;projectScannedDocuments/&quot; + relativeFolderPath + &quot;/&quot; + renamedFileName;</span>

<span class="nc bnc" id="L818" title="All 2 branches missed.">            if (id != null) {</span>
<span class="nc" id="L819">                Optional&lt;ProjectDocument&gt; optionalDoc = projectDocumentRepository.findById(id);</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">                if (optionalDoc.isEmpty()) {</span>
<span class="nc" id="L821">                    return &quot;Error: No document found with the provided ID.&quot;;</span>
                }

<span class="nc" id="L824">                ProjectDocument projectDocument = optionalDoc.get();</span>
<span class="nc" id="L825">                projectDocument.setLastUpdatedBy(String.valueOf(loginUser.getUsername()));</span>
<span class="nc" id="L826">                projectDocument.setLastUpdateDate(LocalDateTime.now());</span>
<span class="nc" id="L827">                projectDocument.setProjectRfNum(projectRfNum);</span>
<span class="nc" id="L828">                projectDocument.setDocName(docName);</span>
<span class="nc" id="L829">                projectDocument.setDocNumber(docNumber);</span>
<span class="nc" id="L830">                projectDocument.setRemark(remark);</span>
<span class="nc" id="L831">                projectDocument.setDocType(extension);</span>
<span class="nc" id="L832">                projectDocument.setServerDocName(serverDocPath);</span>

<span class="nc" id="L834">                projectDocumentRepository.save(projectDocument);</span>
<span class="nc" id="L835">            } else {</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">                for (ProjectDocument existingDoc : existingDocs) {</span>
<span class="nc bnc" id="L837" title="All 4 branches missed.">                    if (docName != null &amp;&amp; docName.equalsIgnoreCase(existingDoc.getDocName())) {</span>
<span class="nc" id="L838">                        return &quot;Error: Document name already exists. Please use a different name.&quot;;</span>
                    }
<span class="nc bnc" id="L840" title="All 4 branches missed.">                    if (docNumber != null &amp;&amp; docNumber.equalsIgnoreCase(existingDoc.getDocNumber())) {</span>
<span class="nc" id="L841">                        return &quot;Error: Document number already exists. Please use a different number.&quot;;</span>
                    }
<span class="nc" id="L843">                }</span>

<span class="nc" id="L845">                ProjectDocument projectDocument = new ProjectDocument();</span>
<span class="nc" id="L846">                projectDocument.setIsActive(&quot;Y&quot;);</span>
<span class="nc" id="L847">                projectDocument.setIsDeleted(&quot;N&quot;);</span>
<span class="nc" id="L848">                projectDocument.setCreatedBy(String.valueOf(loginUser.getUsername()));</span>
<span class="nc" id="L849">                projectDocument.setCreationDate(LocalDateTime.now());</span>
<span class="nc" id="L850">                projectDocument.setProjectRfNum(projectRfNum);</span>
<span class="nc" id="L851">                projectDocument.setDocName(docName);</span>
<span class="nc" id="L852">                projectDocument.setDocNumber(docNumber);</span>
<span class="nc" id="L853">                projectDocument.setRemark(remark);</span>
<span class="nc" id="L854">                projectDocument.setDocType(extension);</span>
<span class="nc" id="L855">                projectDocument.setServerDocName(serverDocPath);</span>

<span class="nc" id="L857">                projectDocumentRepository.save(projectDocument);</span>
            }

<span class="nc" id="L860">            String baseUrl = request.getScheme() + &quot;://&quot; + request.getServerName() +</span>
<span class="nc bnc" id="L861" title="All 4 branches missed.">                    ((request.getServerPort() == 80 || request.getServerPort() == 443) ? &quot;&quot; : &quot;:&quot; + request.getServerPort()) +</span>
<span class="nc" id="L862">                    request.getContextPath();</span>

<span class="nc" id="L864">            String encodedPath = URLEncoder.encode(serverDocPath, StandardCharsets.UTF_8);</span>
<span class="nc" id="L865">            return baseUrl + &quot;/api/project/download/&quot; + encodedPath;</span>

<span class="nc" id="L867">        } catch (Exception e) {</span>
<span class="nc" id="L868">            log.error(&quot;Exception in uploadProjectScannedDocument&quot;, e);</span>
<span class="nc" id="L869">            return &quot;Error: Failed to upload or update the document due to a server error.&quot;;</span>
        }
    }


    public PaginatedResponse&lt;ProjectDocumentResponseDTO&gt; getAllProjectDocuments(
            int pageNumber, int pageSize, String sortBy, String sortDir,
            String searchColumn, String searchValue) {

        // Validate sorting direction
<span class="nc" id="L879">        Sort.Direction direction = Sort.Direction.fromString(sortDir);</span>
<span class="nc" id="L880">        Pageable pageable = PageRequest.of(pageNumber - 1, pageSize, direction, sortBy);</span>

        // Fetch paginated data
<span class="nc" id="L883">        Page&lt;ProjectDocument&gt; projectDocPage = projectDocumentRepository.findAll(pageable);</span>

        // Base URL for downloads
<span class="nc" id="L886">        String baseUrl = httpServletRequest.getScheme() + &quot;://&quot; + httpServletRequest.getServerName() +</span>
<span class="nc bnc" id="L887" title="All 4 branches missed.">                ((httpServletRequest.getServerPort() == 80 || httpServletRequest.getServerPort() == 443) ? &quot;&quot; : &quot;:&quot; + httpServletRequest.getServerPort()) +</span>
<span class="nc" id="L888">                httpServletRequest.getContextPath();</span>

        // Convert to DTOs
<span class="nc" id="L891">        List&lt;ProjectDocumentResponseDTO&gt; mappedDocs = projectDocPage.getContent().stream()</span>
<span class="nc" id="L892">                .map(doc -&gt; {</span>
<span class="nc" id="L893">                    ProjectDocumentResponseDTO dto = modelMapper.map(doc, ProjectDocumentResponseDTO.class);</span>

                    // Ensure serverDocName doesn't include &quot;projectScannedDocuments/&quot;
<span class="nc" id="L896">                    String serverPath = doc.getServerDocName();</span>
<span class="nc bnc" id="L897" title="All 4 branches missed.">                    if (serverPath != null &amp;&amp; serverPath.startsWith(&quot;projectScannedDocuments/&quot;)) {</span>
<span class="nc" id="L898">                        serverPath = serverPath.replaceFirst(&quot;projectScannedDocuments/&quot;, &quot;&quot;);</span>
                    }

<span class="nc bnc" id="L901" title="All 4 branches missed.">                    if (serverPath != null &amp;&amp; !serverPath.isEmpty()) {</span>
<span class="nc" id="L902">                        dto.setDownloadUrl(baseUrl + &quot;/api/project/download/&quot; + serverPath);</span>
                    }

<span class="nc" id="L905">                    return dto;</span>
                })
<span class="nc" id="L907">                .filter(dto -&gt; {</span>
                    // Search filtering (case-insensitive)
<span class="nc bnc" id="L909" title="All 6 branches missed.">                    if (searchColumn == null || searchValue == null || searchValue.isEmpty()) return true;</span>
<span class="nc" id="L910">                    String lowerSearchValue = searchValue.toLowerCase();</span>

<span class="nc bnc" id="L912" title="All 5 branches missed.">                    switch (searchColumn) {</span>
                        case &quot;projectRfNum&quot;:
<span class="nc bnc" id="L914" title="All 4 branches missed.">                            return dto.getProjectRfNum() != null &amp;&amp; dto.getProjectRfNum().toLowerCase().contains(lowerSearchValue);</span>
                        case &quot;docName&quot;:
<span class="nc bnc" id="L916" title="All 4 branches missed.">                            return dto.getDocName() != null &amp;&amp; dto.getDocName().toLowerCase().contains(lowerSearchValue);</span>
                        case &quot;docType&quot;:
<span class="nc bnc" id="L918" title="All 4 branches missed.">                            return dto.getDocType() != null &amp;&amp; dto.getDocType().toLowerCase().contains(lowerSearchValue);</span>
                        case &quot;remark&quot;:
<span class="nc bnc" id="L920" title="All 4 branches missed.">                            return dto.getRemark() != null &amp;&amp; dto.getRemark().toLowerCase().contains(lowerSearchValue);</span>
                        default:
<span class="nc" id="L922">                            return false;</span>
                    }
                })
<span class="nc" id="L925">                .collect(Collectors.toList());</span>

        // Manual pagination after filtering
<span class="nc" id="L928">        int totalFiltered = mappedDocs.size();</span>
<span class="nc" id="L929">        int start = Math.min((pageNumber - 1) * pageSize, totalFiltered);</span>
<span class="nc" id="L930">        int end = Math.min(start + pageSize, totalFiltered);</span>
<span class="nc" id="L931">        List&lt;ProjectDocumentResponseDTO&gt; paginatedList = mappedDocs.subList(start, end);</span>

        // Build response
<span class="nc" id="L934">        PaginatedResponse&lt;ProjectDocumentResponseDTO&gt; response = new PaginatedResponse&lt;&gt;();</span>
<span class="nc" id="L935">        response.setPaginationData(paginatedList);</span>
<span class="nc" id="L936">        response.setTotalPages((int) Math.ceil((double) totalFiltered / pageSize));</span>
<span class="nc" id="L937">        response.setTotalElements(totalFiltered);</span>
<span class="nc" id="L938">        response.setPageSize(pageSize);</span>
<span class="nc" id="L939">        response.setCurrentPage(pageNumber);</span>

<span class="nc" id="L941">        return response;</span>
    }


    public Map&lt;String, Object&gt; getDocumentsByProjectRfNumWithPagination(String projectRfNum,
                                                                        int page,
                                                                        int size,
                                                                        String searchColumn,
                                                                        String searchValue,
                                                                        String sortBy,
                                                                        String sortDir) {

<span class="nc" id="L953">        List&lt;ProjectDocument&gt; documentList = projectDocumentRepository.findByProjectRfNum(projectRfNum);</span>

        // Convert to DTO
<span class="nc" id="L956">        String baseUrl = httpServletRequest.getScheme() + &quot;://&quot; + httpServletRequest.getServerName() +</span>
<span class="nc bnc" id="L957" title="All 4 branches missed.">                ((httpServletRequest.getServerPort() == 80 || httpServletRequest.getServerPort() == 443) ? &quot;&quot; : &quot;:&quot; + httpServletRequest.getServerPort()) +</span>
<span class="nc" id="L958">                httpServletRequest.getContextPath();</span>

<span class="nc" id="L960">        List&lt;ProjectDocumentResponseDTO&gt; dtoList = documentList.stream()</span>
<span class="nc" id="L961">                .map(doc -&gt; {</span>
<span class="nc" id="L962">                    ProjectDocumentResponseDTO dto = modelMapper.map(doc, ProjectDocumentResponseDTO.class);</span>
<span class="nc" id="L963">                    String serverPath = doc.getServerDocName();</span>

<span class="nc bnc" id="L965" title="All 4 branches missed.">                    if (serverPath != null &amp;&amp; !serverPath.isEmpty()) {</span>
<span class="nc bnc" id="L966" title="All 2 branches missed.">                        if (serverPath.startsWith(&quot;projectScannedDocuments/&quot;)) {</span>
<span class="nc" id="L967">                            serverPath = serverPath.replaceFirst(&quot;projectScannedDocuments/&quot;, &quot;&quot;);</span>
                        }
<span class="nc" id="L969">                        dto.setDownloadUrl(baseUrl + &quot;/api/project/download/&quot; + serverPath);</span>
                    }

<span class="nc" id="L972">                    return dto;</span>
                })
<span class="nc" id="L974">                .collect(Collectors.toList());</span>

        // Search filter
<span class="nc bnc" id="L977" title="All 4 branches missed.">        if (searchColumn != null &amp;&amp; searchValue != null) {</span>
<span class="nc" id="L978">            dtoList = dtoList.stream()</span>
<span class="nc" id="L979">                    .filter(dto -&gt; {</span>
                        try {
<span class="nc" id="L981">                            String fieldValue = Optional.ofNullable(</span>
<span class="nc" id="L982">                                    BeanUtils.getProperty(dto, searchColumn)).orElse(&quot;&quot;);</span>
<span class="nc" id="L983">                            return fieldValue.toLowerCase().contains(searchValue.toLowerCase());</span>
<span class="nc" id="L984">                        } catch (Exception e) {</span>
<span class="nc" id="L985">                            return false;</span>
                        }
                    })
<span class="nc" id="L988">                    .collect(Collectors.toList());</span>
        }

        // Proper sort logic (handle numeric fields like `id`)
        Comparator&lt;ProjectDocumentResponseDTO&gt; comparator;

<span class="nc bnc" id="L994" title="All 3 branches missed.">        switch (sortBy) {</span>
            case &quot;id&quot;:
<span class="nc" id="L996">                comparator = Comparator.comparing(ProjectDocumentResponseDTO::getId);</span>
<span class="nc" id="L997">                break;</span>
            case &quot;creationDate&quot;:
<span class="nc" id="L999">                comparator = Comparator.comparing(ProjectDocumentResponseDTO::getCreationDate);</span>
<span class="nc" id="L1000">                break;</span>
            default:
<span class="nc" id="L1002">                comparator = Comparator.comparing(dto -&gt; {</span>
                    try {
<span class="nc" id="L1004">                        return Optional.ofNullable(BeanUtils.getProperty(dto, sortBy)).orElse(&quot;&quot;);</span>
<span class="nc" id="L1005">                    } catch (Exception e) {</span>
<span class="nc" id="L1006">                        return &quot;&quot;;</span>
                    }
                });
        }

<span class="nc bnc" id="L1011" title="All 2 branches missed.">        if (&quot;desc&quot;.equalsIgnoreCase(sortDir)) {</span>
<span class="nc" id="L1012">            comparator = comparator.reversed();</span>
        }

<span class="nc" id="L1015">        dtoList.sort(comparator);</span>

        // Pagination
<span class="nc" id="L1018">        int totalElements = dtoList.size();</span>
<span class="nc" id="L1019">        int totalPages = (int) Math.ceil((double) totalElements / size);</span>
<span class="nc" id="L1020">        int fromIndex = (page - 1) * size;</span>
<span class="nc" id="L1021">        int toIndex = Math.min(fromIndex + size, totalElements);</span>

<span class="nc bnc" id="L1023" title="All 2 branches missed.">        List&lt;ProjectDocumentResponseDTO&gt; paginatedList = fromIndex &gt;= totalElements</span>
<span class="nc" id="L1024">                ? Collections.emptyList()</span>
<span class="nc" id="L1025">                : dtoList.subList(fromIndex, toIndex);</span>

<span class="nc" id="L1027">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1028">        response.put(&quot;result&quot;, paginatedList);</span>
<span class="nc" id="L1029">        response.put(&quot;totalElements&quot;, totalElements);</span>
<span class="nc" id="L1030">        response.put(&quot;totalPages&quot;, totalPages);</span>
<span class="nc" id="L1031">        response.put(&quot;pageSize&quot;, size);</span>
<span class="nc" id="L1032">        response.put(&quot;currentPage&quot;, page);</span>

<span class="nc" id="L1034">        return response;</span>
    }


    public Map&lt;String, Object&gt; documentFetchByIdAndProjectRfNo(String projectRfNum,
                                                               Integer id,
                                                               int page,
                                                               int size,
                                                               String searchColumn,
                                                               String searchValue,
                                                               String sortBy,
                                                               String sortDir) {

<span class="nc" id="L1047">        List&lt;ProjectDocument&gt; documentList = projectDocumentRepository.findByProjectRfNum(projectRfNum);</span>

        // Convert to DTOs
<span class="nc" id="L1050">        String baseUrl = httpServletRequest.getScheme() + &quot;://&quot; + httpServletRequest.getServerName() +</span>
<span class="nc bnc" id="L1051" title="All 4 branches missed.">                ((httpServletRequest.getServerPort() == 80 || httpServletRequest.getServerPort() == 443) ? &quot;&quot; : &quot;:&quot; + httpServletRequest.getServerPort()) +</span>
<span class="nc" id="L1052">                httpServletRequest.getContextPath();</span>

<span class="nc" id="L1054">        List&lt;ProjectDocumentResponseDTO&gt; dtoList = documentList.stream()</span>
<span class="nc" id="L1055">                .map(doc -&gt; {</span>
<span class="nc" id="L1056">                    ProjectDocumentResponseDTO dto = modelMapper.map(doc, ProjectDocumentResponseDTO.class);</span>
<span class="nc" id="L1057">                    String serverPath = doc.getServerDocName();</span>

<span class="nc bnc" id="L1059" title="All 4 branches missed.">                    if (serverPath != null &amp;&amp; !serverPath.isEmpty()) {</span>
<span class="nc bnc" id="L1060" title="All 2 branches missed.">                        if (serverPath.startsWith(&quot;projectScannedDocuments/&quot;)) {</span>
<span class="nc" id="L1061">                            serverPath = serverPath.replaceFirst(&quot;projectScannedDocuments/&quot;, &quot;&quot;);</span>
                        }
<span class="nc" id="L1063">                        dto.setDownloadUrl(baseUrl + &quot;/api/project/download/&quot; + serverPath);</span>
                    }

<span class="nc" id="L1066">                    return dto;</span>
                })
<span class="nc" id="L1068">                .collect(Collectors.toList());</span>

        //  Filter by id if provided
<span class="nc bnc" id="L1071" title="All 2 branches missed.">        if (id != null) {</span>
<span class="nc" id="L1072">            dtoList = dtoList.stream()</span>
<span class="nc" id="L1073">                    .filter(dto -&gt; Objects.equals(dto.getId(), id))</span>
<span class="nc" id="L1074">                    .collect(Collectors.toList());</span>
        }

        //  Search filter
<span class="nc bnc" id="L1078" title="All 4 branches missed.">        if (searchColumn != null &amp;&amp; searchValue != null) {</span>
<span class="nc" id="L1079">            dtoList = dtoList.stream()</span>
<span class="nc" id="L1080">                    .filter(dto -&gt; {</span>
                        try {
<span class="nc" id="L1082">                            String fieldValue = Optional.ofNullable(</span>
<span class="nc" id="L1083">                                    BeanUtils.getProperty(dto, searchColumn)).orElse(&quot;&quot;);</span>
<span class="nc" id="L1084">                            return fieldValue.toLowerCase().contains(searchValue.toLowerCase());</span>
<span class="nc" id="L1085">                        } catch (Exception e) {</span>
<span class="nc" id="L1086">                            return false;</span>
                        }
                    })
<span class="nc" id="L1089">                    .collect(Collectors.toList());</span>
        }

        //  Sorting
<span class="nc" id="L1093">        Comparator&lt;ProjectDocumentResponseDTO&gt; comparator = Comparator.comparing(dto -&gt; {</span>
            try {
<span class="nc" id="L1095">                return Optional.ofNullable(BeanUtils.getProperty(dto, sortBy)).orElse(&quot;&quot;);</span>
<span class="nc" id="L1096">            } catch (Exception e) {</span>
<span class="nc" id="L1097">                return &quot;&quot;;</span>
            }
        });

<span class="nc bnc" id="L1101" title="All 2 branches missed.">        if (&quot;desc&quot;.equalsIgnoreCase(sortDir)) {</span>
<span class="nc" id="L1102">            comparator = comparator.reversed();</span>
        }

<span class="nc" id="L1105">        dtoList.sort(comparator);</span>

        //  Pagination (1-based)
<span class="nc" id="L1108">        int totalElements = dtoList.size();</span>
<span class="nc" id="L1109">        int totalPages = (int) Math.ceil((double) totalElements / size);</span>
<span class="nc" id="L1110">        int fromIndex = (page - 1) * size;</span>
<span class="nc" id="L1111">        int toIndex = Math.min(fromIndex + size, totalElements);</span>

<span class="nc bnc" id="L1113" title="All 2 branches missed.">        List&lt;ProjectDocumentResponseDTO&gt; paginatedList = fromIndex &gt;= totalElements</span>
<span class="nc" id="L1114">                ? Collections.emptyList()</span>
<span class="nc" id="L1115">                : dtoList.subList(fromIndex, toIndex);</span>

        //  Response format
<span class="nc" id="L1118">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1119">        response.put(&quot;result&quot;, paginatedList);</span>
<span class="nc" id="L1120">        response.put(&quot;totalElements&quot;, totalElements);</span>
<span class="nc" id="L1121">        response.put(&quot;totalPages&quot;, totalPages);</span>
<span class="nc" id="L1122">        response.put(&quot;pageSize&quot;, size);</span>
<span class="nc" id="L1123">        response.put(&quot;currentPage&quot;, page);</span>

<span class="nc" id="L1125">        return response;</span>
    }

    public List&lt;Map&lt;String, Object&gt;&gt; getProjectDocumentDetails(String id) {
<span class="nc" id="L1129">        return projectDocumentRepository.findProjectDocumentDetails(id);</span>
    }

    public List&lt;Map&lt;String, Object&gt;&gt; getProjectPriceDetails(String id) {
<span class="nc" id="L1133">        List&lt;Map&lt;String, Object&gt;&gt; mappedPricingListFinal = new ArrayList&lt;&gt;();</span>
        try {
<span class="nc" id="L1135">            List&lt;Map&lt;String, Object&gt;&gt; mappedPricingList = projectPriceRepository.findProjectPriceDetails(id);</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">            if (mappedPricingList != null) {</span>
<span class="nc bnc" id="L1137" title="All 2 branches missed.">                for (Map&lt;String, Object&gt; m : mappedPricingList) {</span>
<span class="nc" id="L1138">                    String priceGroupId = (String) m.get(&quot;PRICE_GROUP_ID&quot;);</span>
<span class="nc" id="L1139">                    String totalPrice = fetchProjectPricing(priceGroupId, id);</span>
<span class="nc" id="L1140">                    String totalTime = fetchProjectTimeCost(priceGroupId, id);</span>

                    // Create a new Map to hold modified entries
<span class="nc" id="L1143">                    Map&lt;String, Object&gt; modifiedMap = new HashMap&lt;&gt;(m);</span>
<span class="nc" id="L1144">                    modifiedMap.put(&quot;TOTAL_PRICE&quot;, totalPrice);</span>
<span class="nc" id="L1145">                    modifiedMap.put(&quot;TOTAL_TIME&quot;, totalTime);</span>

<span class="nc" id="L1147">                    mappedPricingListFinal.add(modifiedMap);</span>
<span class="nc" id="L1148">                }</span>
<span class="nc" id="L1149">                return mappedPricingListFinal;</span>
            }
<span class="nc" id="L1151">        } catch (Exception e) {</span>
<span class="nc" id="L1152">            e.printStackTrace();</span>
<span class="nc" id="L1153">        }</span>
<span class="nc" id="L1154">        return null;</span>
    }

    public String fetchProjectPricing(String priceGroupId, String id) {
<span class="nc" id="L1158">        return projectPriceMappingRepository.findProjectPricing(priceGroupId, id);</span>

    }

    public String fetchProjectTimeCost(String priceGroupId, String id) {
<span class="nc" id="L1163">        return projectPriceMappingRepository.findProjectTimeCost(priceGroupId, id);</span>

    }

    public ResponseEntity&lt;String&gt; modifyUsersTaskAssignment(String taskAssignmentName, String taskAllocationPercentage, String taskAllocationId, String taskRfNum, String username, String startDate, String endDate, String deputation, String[] userTRole) {
        try {
            // ProjectTaskAllocation projectTaskAllocation = new ProjectTaskAllocation();
<span class="nc" id="L1170">            UserLoginDetail userLoginDetail = SessionHolder.getUserLoginDetail();</span>
<span class="nc" id="L1171">            ProjectTaskRoleUser projectTaskRoleUser = new ProjectTaskRoleUser();</span>
<span class="nc" id="L1172">            SimpleDateFormat sdf2 = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L1173">            ProjectTaskAllocation projectTaskAllocation = projectTaskAllocationRepository.findById(Integer.parseInt(taskAllocationId)).orElse(null);</span>

<span class="nc bnc" id="L1175" title="All 2 branches missed.">            if (projectTaskAllocation == null) {</span>
<span class="nc" id="L1176">                return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(&quot;Invalid allocation id&quot;);</span>
            }

<span class="nc" id="L1179">            projectTaskAllocation.setTaskAllocationId(Integer.valueOf(taskAllocationId));</span>
<span class="nc" id="L1180">            projectTaskAllocation.setDeputation(deputation);</span>
<span class="nc" id="L1181">            projectTaskAllocation.setStartDate(sdf2.parse(startDate));</span>
<span class="nc" id="L1182">            projectTaskAllocation.setEndDate(sdf2.parse(endDate));</span>
<span class="nc" id="L1183">            projectTaskAllocation.setRemark(&quot;&quot;);</span>
<span class="nc" id="L1184">            projectTaskAllocation.setLastUpdatedBy(String.valueOf(userLoginDetail.getUsername()));</span>
<span class="nc" id="L1185">            projectTaskAllocation.setLastUpdateDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>
<span class="nc" id="L1186">            projectTaskAllocation.setTaskAssignmentName(taskAssignmentName);</span>
<span class="nc" id="L1187">            projectTaskAllocation.setIsActive(&quot;Y&quot;);</span>
<span class="nc" id="L1188">            projectTaskAllocation.setIsDeleted(&quot;N&quot;);</span>
<span class="nc" id="L1189">            projectTaskAllocation.setUsername(Integer.valueOf(username));</span>
<span class="nc" id="L1190">            projectTaskAllocationRepository.save(projectTaskAllocation);</span>

<span class="nc bnc" id="L1192" title="All 4 branches missed.">            if (userTRole != null &amp;&amp; userTRole.length &gt; 0) {</span>
<span class="nc" id="L1193">                projectTaskRoleUserRepository.deleteByTaskRfNumAndUsername(taskRfNum, username);</span>
<span class="nc bnc" id="L1194" title="All 2 branches missed.">                for (String s : userTRole) {</span>
<span class="nc" id="L1195">                    projectTaskRoleUser.setProjectTaskRoleUserId(null);</span>
<span class="nc" id="L1196">                    projectTaskRoleUser.setProjectTaskRoleId(Integer.valueOf(s));</span>
<span class="nc" id="L1197">                    projectTaskRoleUser.setProjectRfNum(Integer.valueOf(taskRfNum));</span>
<span class="nc" id="L1198">                    projectTaskRoleUser.setUsername(Integer.valueOf(username));</span>
<span class="nc" id="L1199">                    projectTaskRoleUser.setStartDate(sdf2.parse(startDate));</span>
<span class="nc" id="L1200">                    projectTaskRoleUser.setEndDate(sdf2.parse(endDate));</span>
<span class="nc" id="L1201">                    projectTaskRoleUserRepository.save(projectTaskRoleUser);</span>
                }
            }
<span class="nc" id="L1204">            return ResponseEntity.ok(&quot;User task updated successfully.&quot;);</span>
<span class="nc" id="L1205">        } catch (Exception e) {</span>
<span class="nc" id="L1206">            e.printStackTrace();</span>
<span class="nc" id="L1207">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(e.getMessage());</span>
        }
    }

    public ResponseEntity&lt;String&gt; addUsersTaskAssignment(String taskAssignmentName, String taskAllocationPercentage, String taskRfNum, String username, String startDate, String endDate) {
        try {
<span class="nc" id="L1213">            SimpleDateFormat sdf = new SimpleDateFormat(&quot;YYYY-MM-DD&quot;);</span>
<span class="nc" id="L1214">            int allocationHistoryCount = projectTaskAllocationRepository.findProjectTaskAllocation(taskRfNum, username, startDate, endDate);</span>
<span class="nc bnc" id="L1215" title="All 2 branches missed.">            if (allocationHistoryCount == 0) {</span>
<span class="nc" id="L1216">                ProjectTaskAllocation projectTaskAllocation = new ProjectTaskAllocation();</span>
<span class="nc" id="L1217">                projectTaskAllocation.setTaskAssignmentName(taskAssignmentName);</span>
<span class="nc" id="L1218">                projectTaskAllocation.setTaskRfNum(Integer.valueOf(taskRfNum));</span>
<span class="nc" id="L1219">                projectTaskAllocation.setUsername(Integer.valueOf(username));</span>
<span class="nc" id="L1220">                projectTaskAllocation.setAllocationPercentage(taskAllocationPercentage);</span>
<span class="nc" id="L1221">                projectTaskAllocation.setStartDate(sdf.parse(startDate));</span>
<span class="nc" id="L1222">                projectTaskAllocation.setEndDate(sdf.parse(endDate));</span>
<span class="nc" id="L1223">                projectTaskAllocationRepository.save(projectTaskAllocation);</span>
<span class="nc" id="L1224">                return ResponseEntity.ok(&quot;Assignment added successfully.&quot;);</span>
            } else {
<span class="nc" id="L1226">                return ResponseEntity.ok(&quot;Entered date range already exist.Please change allocation dates.&quot;);</span>
            }
<span class="nc" id="L1228">        } catch (Exception e) {</span>
<span class="nc" id="L1229">            e.printStackTrace();</span>
<span class="nc" id="L1230">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(e.getMessage());</span>
        }
    }

    public ResponseEntity&lt;String&gt; removeUsersTaskAssignment(String taskAllocationId) {
        try {
<span class="nc" id="L1236">            UserLoginDetail userLoginDetail = SessionHolder.getUserLoginDetail();</span>
<span class="nc" id="L1237">            ProjectTaskAllocation projectTaskAllocation = projectTaskAllocationRepository.findById(Integer.parseInt(taskAllocationId)).orElse(null);</span>

<span class="nc bnc" id="L1239" title="All 2 branches missed.">            assert projectTaskAllocation != null;</span>
<span class="nc" id="L1240">            projectTaskAllocation.setTaskAllocationId(Integer.valueOf(taskAllocationId));</span>
<span class="nc" id="L1241">            projectTaskAllocation.setLastUpdatedBy(String.valueOf(userLoginDetail.getUsername()));</span>
<span class="nc" id="L1242">            projectTaskAllocation.setLastUpdateDate(LocalDateTime.ofInstant(new Date().toInstant(), ZoneId.systemDefault()));</span>
<span class="nc" id="L1243">            projectTaskAllocation.setIsActive(&quot;Y&quot;);</span>
<span class="nc" id="L1244">            projectTaskAllocation.setIsDeleted(&quot;Y&quot;);</span>
<span class="nc" id="L1245">            projectTaskAllocationRepository.save(projectTaskAllocation);</span>
<span class="nc" id="L1246">            return ResponseEntity.ok(&quot;Task assignment removed successfully.&quot;);</span>
<span class="nc" id="L1247">        } catch (Exception e) {</span>
<span class="nc" id="L1248">            e.printStackTrace();</span>
<span class="nc" id="L1249">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(e.getMessage());</span>
        }
    }

    @Transactional
    public TaskStoryDTO saveOrUpdateTaskStory(TaskStoryDTO taskStoryDTO) {
<span class="nc" id="L1255">        UserLoginDetail token = SessionHolder.getUserLoginDetail();</span>
        TaskStory taskStory;
<span class="nc bnc" id="L1257" title="All 2 branches missed.">        if (taskStoryDTO.getTaskRfNum() != null) {</span>
<span class="nc" id="L1258">            taskStory = taskStoryRepository.findById(taskStoryDTO.getTaskRfNum())</span>
<span class="nc" id="L1259">                    .orElseThrow(() -&gt; new IllegalArgumentException(&quot;TaskStory with ID &quot; + taskStoryDTO.getTaskRfNum() + &quot; not found&quot;));</span>
<span class="nc" id="L1260">            String existingTaskId = taskStory.getTaskid();</span>
<span class="nc" id="L1261">            modelMapper.map(taskStoryDTO, taskStory);</span>
<span class="nc" id="L1262">            taskStory.setTaskid(existingTaskId);</span>
<span class="nc" id="L1263">            taskStory.setLastUpdatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L1264">            taskStory.setLastUpdatedDate(Instant.now());</span>
<span class="nc" id="L1265">        } else {</span>
<span class="nc" id="L1266">            taskStory = modelMapper.map(taskStoryDTO, TaskStory.class);</span>
<span class="nc" id="L1267">            taskStory.setTaskid(sequenceGeneratorService.generateSequence(SequenceType.TASK.toString(), null));</span>
<span class="nc" id="L1268">            taskStory.setCreatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L1269">            taskStory.setCreatedDate(Instant.now());</span>
        }

        // Handling sub-task updates
<span class="nc" id="L1273">        handleSubTaskStories(taskStory, taskStoryDTO.getSubTaskStoryDTOList(), token);</span>
<span class="nc" id="L1274">        TaskStory saved = taskStoryRepository.save(taskStory);</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed.">        if (taskStoryDTO.getTaskRfNum() == null) {</span>
<span class="nc" id="L1276">            insertIntoTaskAllocationTbl(saved, taskStoryDTO, token);</span>
        }

<span class="nc" id="L1279">        return modelMapper.map(saved, TaskStoryDTO.class);</span>
    }

    private void insertIntoTaskAllocationTbl(TaskStory taskStory, TaskStoryDTO taskStoryDTO, UserLoginDetail userLoginDetail) {
<span class="nc" id="L1283">        ProjectTaskAllocation projectTaskAllocation = new ProjectTaskAllocation();</span>
<span class="nc" id="L1284">        projectTaskAllocation.setTaskRfNum(taskStory.getTaskRfNum());</span>
<span class="nc" id="L1285">        projectTaskAllocation.setProjectRfNum(taskStoryDTO.getProjectRfNum());</span>
<span class="nc" id="L1286">        projectTaskAllocation.setCreationDate(LocalDateTime.now());</span>
<span class="nc" id="L1287">        projectTaskAllocation.setLastUpdateDate(LocalDateTime.now());</span>
<span class="nc" id="L1288">        projectTaskAllocation.setCreatedBy(String.valueOf(userLoginDetail.getUsername()));</span>
<span class="nc" id="L1289">        projectTaskAllocation.setLastUpdatedBy(String.valueOf(userLoginDetail.getUsername()));</span>
<span class="nc" id="L1290">        projectTaskAllocationRepository.save(projectTaskAllocation);</span>
<span class="nc" id="L1291">    }</span>

    private void handleSubTaskStories(TaskStory taskStory, List&lt;SubTaskStoryDTO&gt; subTaskDTOs, UserLoginDetail token) {
<span class="nc bnc" id="L1294" title="All 2 branches missed.">        if (subTaskDTOs == null) return;</span>

<span class="nc bnc" id="L1296" title="All 2 branches missed.">        if (taskStory.getSubTaskStories() == null) {</span>
<span class="nc" id="L1297">            taskStory.setSubTaskStories(new ArrayList&lt;&gt;());</span>
        }

<span class="nc" id="L1300">        Map&lt;Integer, SubTaskStory&gt; existingSubTasks = taskStory.getSubTaskStories().stream()</span>
<span class="nc" id="L1301">                .collect(Collectors.toMap(SubTaskStory::getSubTaskRfNum, subTask -&gt; subTask));</span>

<span class="nc bnc" id="L1303" title="All 2 branches missed.">        for (SubTaskStoryDTO subTaskDTO : subTaskDTOs) {</span>
<span class="nc bnc" id="L1304" title="All 4 branches missed.">            if (subTaskDTO.getSubTaskRfNum() != null &amp;&amp; existingSubTasks.containsKey(subTaskDTO.getSubTaskRfNum())) {</span>
<span class="nc" id="L1305">                updateSubTaskStory(existingSubTasks.get(subTaskDTO.getSubTaskRfNum()), subTaskDTO, token);</span>
            } else {
<span class="nc" id="L1307">                SubTaskStory newSubTask = mapSubTaskDTOToEntity(subTaskDTO, token);</span>
<span class="nc" id="L1308">                newSubTask.setTaskStory(taskStory);</span>
<span class="nc" id="L1309">                taskStory.getSubTaskStories().add(newSubTask);</span>
            }
<span class="nc" id="L1311">        }</span>
<span class="nc" id="L1312">    }</span>

    private void updateSubTaskStory(SubTaskStory subTask, SubTaskStoryDTO subTaskDTO, UserLoginDetail token) {
<span class="nc" id="L1315">        subTask.setSubTaskId(subTaskDTO.getSubTaskId());</span>
<span class="nc" id="L1316">        subTask.setIsActive(subTaskDTO.getIsActive());</span>
<span class="nc" id="L1317">        subTask.setDeleteFlag(subTaskDTO.getDeleteFlag());</span>
<span class="nc" id="L1318">        subTask.setLastUpdatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L1319">        subTask.setLastUpdatedDate(Instant.now());</span>
<span class="nc" id="L1320">    }</span>

    private SubTaskStory mapSubTaskDTOToEntity(SubTaskStoryDTO subTaskDTO, UserLoginDetail token) {
<span class="nc" id="L1323">        SubTaskStory subTask = new SubTaskStory();</span>
<span class="nc" id="L1324">        subTask.setSubTaskId(subTaskDTO.getSubTaskId());</span>
<span class="nc" id="L1325">        subTask.setIsActive(subTaskDTO.getIsActive());</span>
<span class="nc" id="L1326">        subTask.setCreatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L1327">        subTask.setCreatedDate(Instant.now());</span>
<span class="nc" id="L1328">        subTask.setDeleteFlag(&quot;N&quot;);</span>
<span class="nc" id="L1329">        subTask.setLastUpdatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L1330">        subTask.setLastUpdatedDate(Instant.now());</span>
<span class="nc" id="L1331">        return subTask;</span>
    }

    private TaskStoryDTO mapToDTOForSave(TaskStory taskStory) {
<span class="nc" id="L1335">        TaskStoryDTO dto = new TaskStoryDTO();</span>
<span class="nc" id="L1336">        dto.setTaskRfNum(taskStory.getTaskRfNum());</span>
<span class="nc" id="L1337">        dto.setTaskname(taskStory.getTaskname());</span>
<span class="nc" id="L1338">        dto.setTasktype(taskStory.getTasktype());</span>
<span class="nc" id="L1339">        dto.setTaskdesc(taskStory.getTaskdesc());</span>
<span class="nc" id="L1340">        dto.setCriticality(taskStory.getCriticality());</span>
        //dto.setProjectid(taskStory.getProjectid());
<span class="nc bnc" id="L1342" title="All 2 branches missed.">        if (taskStory.getProjectMilestone() != null) {</span>
<span class="nc" id="L1343">            dto.setMilestoneName(taskStory.getProjectMilestone().getMilestoneName());</span>
        }
<span class="nc" id="L1345">        dto.setProjectMilestoneId(taskStory.getProjectMilestoneId());</span>
        //dto.setProjectRfNum(taskStory.getProjectRfNum());
<span class="nc" id="L1347">        dto.setEffortestimation(taskStory.getEffortestimation());</span>
<span class="nc" id="L1348">        dto.setEffortHourCount(taskStory.getEffortHourCount());</span>
<span class="nc" id="L1349">        dto.setEffortDayCount(taskStory.getEffortDayCount());</span>
<span class="nc" id="L1350">        dto.setWorkprogress(taskStory.getWorkprogress());</span>
<span class="nc" id="L1351">        dto.setEffortWeekCount(taskStory.getEffortWeekCount());</span>
<span class="nc" id="L1352">        dto.setDeleteflag(taskStory.getDeleteflag());</span>
<span class="nc" id="L1353">        dto.setBillableflag(taskStory.getBillableflag());</span>
<span class="nc" id="L1354">        dto.setPriceElementId(taskStory.getPriceElementId());</span>
<span class="nc" id="L1355">        dto.setTaskNatureCode(taskStory.getTaskNatureCode());</span>
<span class="nc" id="L1356">        dto.setEffortestimation(taskStory.getEffortestimation());</span>
<span class="nc" id="L1357">        dto.setPlannedstartdate(taskStory.getPlannedstartdate());</span>
<span class="nc" id="L1358">        dto.setActualstartdate(taskStory.getActualstartdate());</span>
<span class="nc" id="L1359">        dto.setPlannedenddate(taskStory.getPlannedenddate());</span>
<span class="nc" id="L1360">        dto.setActualenddate(taskStory.getActualenddate());</span>
<span class="nc" id="L1361">        dto.setTaskstatus(taskStory.getTaskstatus());</span>
<span class="nc" id="L1362">        dto.setCreatedDate(taskStory.getCreatedDate());</span>
<span class="nc" id="L1363">        dto.setCreatedBy(taskStory.getCreatedBy());</span>
<span class="nc" id="L1364">        dto.setLastUpdatedBy(taskStory.getLastUpdatedBy());</span>
<span class="nc" id="L1365">        dto.setLastUpdatedDate(taskStory.getLastUpdatedDate());</span>

<span class="nc bnc" id="L1367" title="All 2 branches missed.">        if (taskStory.getSubTaskStories() != null) {</span>
<span class="nc" id="L1368">            dto.setSubTaskStoryDTOList(taskStory.getSubTaskStories().stream()</span>
<span class="nc" id="L1369">                    .map(this::mapSubTaskEntityToDTO)</span>
<span class="nc" id="L1370">                    .filter(Objects::nonNull)</span>
<span class="nc" id="L1371">                    .collect(Collectors.toList()));</span>
        }
<span class="nc" id="L1373">        return dto;</span>
    }

    private SubTaskStoryDTO mapSubTaskEntityToDTO(SubTaskStory subTask) {
<span class="nc bnc" id="L1377" title="All 4 branches missed.">        if (subTask.getDeleteFlag() != null &amp;&amp; !&quot;N&quot;.equalsIgnoreCase(subTask.getDeleteFlag())) {</span>
<span class="nc" id="L1378">            return null; // Skip this subtask</span>
        }
<span class="nc" id="L1380">        SubTaskStoryDTO subTaskDTO = new SubTaskStoryDTO();</span>
<span class="nc" id="L1381">        subTaskDTO.setSubTaskRfNum(subTask.getSubTaskRfNum());</span>
<span class="nc" id="L1382">        subTaskDTO.setSubTaskId(subTask.getSubTaskId());</span>
<span class="nc bnc" id="L1383" title="All 2 branches missed.">        if (subTask.getSubTaskId() != null) {</span>
<span class="nc" id="L1384">            Optional&lt;TaskStory&gt; story = taskStoryRepository.findByTaskid(subTask.getSubTaskId());</span>

<span class="nc" id="L1386">            story.ifPresentOrElse(</span>
<span class="nc" id="L1387">                    taskStory -&gt; subTaskDTO.setSubTaskName(taskStory.getTaskname()),</span>
<span class="nc" id="L1388">                    () -&gt; subTaskDTO.setSubTaskName(&quot;Unknown Task name.&quot;)</span>
            );
<span class="nc" id="L1390">        } else {</span>
<span class="nc" id="L1391">            subTaskDTO.setSubTaskName(&quot;Invalid Task ID.&quot;);</span>
        }


<span class="nc" id="L1395">        subTaskDTO.setTaskRfNum(subTask.getTaskStory().getTaskRfNum());</span>
<span class="nc" id="L1396">        subTaskDTO.setIsActive(subTask.getIsActive());</span>
<span class="nc" id="L1397">        subTaskDTO.setDeleteFlag(subTask.getDeleteFlag());</span>
<span class="nc" id="L1398">        return subTaskDTO;</span>
    }

    @Transactional
    public Map&lt;String, Object&gt; getPaginatedTaskStories(String searchField, String searchKeyword, Pageable pageable) {
<span class="nc" id="L1403">        Specification&lt;TaskStory&gt; spec = (root, query, criteriaBuilder) -&gt; {</span>
<span class="nc bnc" id="L1404" title="All 6 branches missed.">            if (searchField != null &amp;&amp; searchKeyword != null &amp;&amp; !searchKeyword.isEmpty()) {</span>
                try {
<span class="nc" id="L1406">                    Field field = TaskStory.class.getDeclaredField(searchField);</span>
<span class="nc" id="L1407">                    Class&lt;?&gt; fieldType = field.getType();</span>

<span class="nc bnc" id="L1409" title="All 2 branches missed.">                    if (&quot;taskstatus&quot;.equals(searchField)) {</span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">                        String statusValue = searchKeyword.trim().toLowerCase().matches(&quot;a|ac|act|activ|active.*&quot;) ? &quot;A&quot; :</span>
<span class="nc bnc" id="L1411" title="All 2 branches missed.">                                searchKeyword.trim().toLowerCase().matches(&quot;i|in|ina|inac|inact|inacti|inactive.*&quot;) ? &quot;I&quot; : null;</span>
<span class="nc bnc" id="L1412" title="All 2 branches missed.">                        if (statusValue != null) {</span>
<span class="nc" id="L1413">                            return criteriaBuilder.equal(root.get(searchField), statusValue);</span>
                        } else {
<span class="nc" id="L1415">                            throw new IllegalArgumentException(&quot;Invalid status value. Use 'active' or 'inactive'.&quot;);</span>
                        }
                    }

<span class="nc bnc" id="L1419" title="All 2 branches missed.">                    if (fieldType.equals(String.class)) {</span>
<span class="nc" id="L1420">                        return criteriaBuilder.like(</span>
<span class="nc" id="L1421">                                criteriaBuilder.lower(root.get(searchField)),</span>
<span class="nc" id="L1422">                                &quot;%&quot; + searchKeyword.toLowerCase() + &quot;%&quot;</span>
                        );
<span class="nc bnc" id="L1424" title="All 4 branches missed.">                    } else if (Number.class.isAssignableFrom(fieldType) || fieldType.equals(int.class)) {</span>
<span class="nc" id="L1425">                        return criteriaBuilder.equal(root.get(searchField), Integer.parseInt(searchKeyword));</span>
<span class="nc bnc" id="L1426" title="All 4 branches missed.">                    } else if (fieldType.equals(Date.class) || fieldType.equals(Instant.class)) {</span>
<span class="nc" id="L1427">                        return criteriaBuilder.equal(root.get(searchField), Integer.parseInt(searchKeyword));</span>
                    }
<span class="nc" id="L1429">                } catch (NoSuchFieldException | SecurityException | NumberFormatException e) {</span>
<span class="nc" id="L1430">                    throw new IllegalArgumentException(&quot;Invalid search column or value type: &quot; + e.getMessage());</span>
<span class="nc" id="L1431">                }</span>
            }
<span class="nc" id="L1433">            return criteriaBuilder.conjunction();</span>
        };

        // Fetch paginated data using Specification
<span class="nc" id="L1437">        Page&lt;TaskStory&gt; taskStoryPage = taskStoryRepository.findAll(spec, pageable);</span>


<span class="nc" id="L1440">        List&lt;TaskStoryDTO&gt; taskStoryDTOList = taskStoryPage.getContent()</span>
<span class="nc" id="L1441">                .stream()</span>
<span class="nc" id="L1442">                .map(this::mapToDTOForSave)</span>
<span class="nc" id="L1443">                .collect(Collectors.toList());</span>

<span class="nc" id="L1445">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1446">        response.put(&quot;result&quot;, taskStoryDTOList);</span>
<span class="nc" id="L1447">        response.put(&quot;currentPage&quot;, taskStoryPage.getNumber() + 1);</span>
<span class="nc" id="L1448">        response.put(&quot;totalItems&quot;, taskStoryPage.getTotalElements());</span>
<span class="nc" id="L1449">        response.put(&quot;PageSize&quot;, taskStoryPage.getSize());</span>
<span class="nc" id="L1450">        response.put(&quot;totalPages&quot;, taskStoryPage.getTotalPages());</span>

<span class="nc" id="L1452">        return response;</span>
    }

    @Transactional
    public void deleteById(Integer id) {
<span class="nc" id="L1457">        TaskStory taskStory = taskStoryRepository.findById(id)</span>
<span class="nc" id="L1458">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Task story with ID &quot; + id + &quot; not found&quot;));</span>
<span class="nc" id="L1459">        taskStory.setDeleteflag(&quot;Y&quot;);</span>
<span class="nc" id="L1460">        taskStory.getSubTaskStories().forEach(approver -&gt; approver.setIsActive(&quot;N&quot;));</span>
<span class="nc" id="L1461">        taskStoryRepository.save(taskStory);</span>
<span class="nc" id="L1462">    }</span>

    @Transactional
    public void deleteSubTaskById(Integer id) {
<span class="nc" id="L1466">        SubTaskStory taskStory = subTaskStoryRepository.findById(id)</span>
<span class="nc" id="L1467">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;SubTask story with ID &quot; + id + &quot; not found&quot;));</span>
        //taskStory.setDeleteFlag(&quot;Y&quot;);
        //subTaskStoryRepository.save(taskStory);
<span class="nc" id="L1470">        subTaskStoryRepository.delete(taskStory);</span>
<span class="nc" id="L1471">    }</span>

    public List&lt;TaskStoryDTO&gt; getTaskSummary() {
<span class="nc" id="L1474">        List&lt;Object[]&gt; results = taskStoryRepository.findTaskSummary();</span>
<span class="nc" id="L1475">        return results.stream().map(obj -&gt; {</span>
<span class="nc" id="L1476">            TaskStoryDTO dto = new TaskStoryDTO();</span>
<span class="nc" id="L1477">            dto.setTaskid(String.valueOf(obj[0]));</span>
<span class="nc" id="L1478">            dto.setTaskname((String) obj[1]);</span>
<span class="nc" id="L1479">            return dto;</span>
<span class="nc" id="L1480">        }).collect(Collectors.toList());</span>
    }

    @Transactional
    public ProjectTemplateDTO saveOrUpdateProjectTemplate(ProjectTemplateDTO dto) {
<span class="nc" id="L1485">        UserLoginDetail token = SessionHolder.getUserLoginDetail();</span>
        ProjectTemplate projectTemplate;

<span class="nc" id="L1488">        Optional&lt;ProjectTemplate&gt; duplicateTemplateName = projectTemplateRepository.findByProjectTemplateName(dto.getProjectTemplateName());</span>
<span class="nc bnc" id="L1489" title="All 2 branches missed.">        if (dto.getTemplateId() != null) {</span>
<span class="nc" id="L1490">            projectTemplate = projectTemplateRepository.findById(dto.getTemplateId()).orElseThrow(() -&gt; new IllegalArgumentException(&quot;ProjectTemplate with ID &quot; + dto.getTemplateId() + &quot; not found&quot;));</span>
<span class="nc bnc" id="L1491" title="All 4 branches missed.">            if (duplicateTemplateName.isPresent() &amp;&amp; !duplicateTemplateName.get().getTemplateId().equals(projectTemplate.getTemplateId())) {</span>
<span class="nc" id="L1492">                throw new IllegalStateException(&quot;Another project template with same name already exists.&quot;);</span>
            }
            // Update existing template
<span class="nc" id="L1495">            updateProjectTemplateFields(projectTemplate, dto, token);</span>
        } else {
<span class="nc bnc" id="L1497" title="All 2 branches missed.">            if (duplicateTemplateName.isPresent())</span>
<span class="nc" id="L1498">                throw new IllegalStateException(&quot;Project template with same name already exists.&quot;);</span>
            // Create a new template
<span class="nc" id="L1500">            projectTemplate = mapToEntity(dto, token);</span>
        }
<span class="nc" id="L1502">        Set&lt;Long&gt; uniqueTaskIds = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1503" title="All 2 branches missed.">        for (ProjectTemplateTaskDTO taskDTO : dto.getProjectTemplateTasks()) {</span>
<span class="nc bnc" id="L1504" title="All 2 branches missed.">            if (!uniqueTaskIds.add(Long.valueOf(taskDTO.getTaskId()))) {</span>
<span class="nc" id="L1505">                throw new ValidationException(&quot;Task with ID &quot; + taskDTO.getTaskId() + &quot; is already added to this project template.&quot;);</span>
            }
<span class="nc" id="L1507">        }</span>
        // Handle associated tasks
<span class="nc" id="L1509">        handleProjectTemplateTasks(projectTemplate, dto.getProjectTemplateTasks(), token);</span>
        // Save and return updated DTO
<span class="nc" id="L1511">        return mapToDTO(entityManager.merge(projectTemplate));</span>
    }

    private void updateProjectTemplateFields(ProjectTemplate projectTemplate, ProjectTemplateDTO dto, UserLoginDetail token) {
<span class="nc" id="L1515">        projectTemplate.setProjectTemplateName(dto.getProjectTemplateName());</span>
<span class="nc" id="L1516">        projectTemplate.setProjectType(dto.getProjectType());</span>
<span class="nc" id="L1517">        projectTemplate.setDescription(dto.getDescription());</span>
<span class="nc" id="L1518">        projectTemplate.setIsActive(dto.getIsActive());</span>
<span class="nc" id="L1519">        projectTemplate.setLastUpdatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L1520">        projectTemplate.setLastUpdatedDate(Instant.now());</span>
<span class="nc" id="L1521">    }</span>

    private ProjectTemplate mapToEntity(ProjectTemplateDTO dto, UserLoginDetail token) {
<span class="nc" id="L1524">        ProjectTemplate projectTemplate = new ProjectTemplate();</span>
<span class="nc" id="L1525">        projectTemplate.setProjectTemplateName(dto.getProjectTemplateName());</span>
<span class="nc" id="L1526">        projectTemplate.setProjectType(dto.getProjectType());</span>
<span class="nc" id="L1527">        projectTemplate.setDescription(dto.getDescription());</span>
<span class="nc" id="L1528">        projectTemplate.setIsActive(dto.getIsActive());</span>
<span class="nc" id="L1529">        projectTemplate.setCreatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L1530">        projectTemplate.setCreatedDate(Instant.now());</span>
<span class="nc" id="L1531">        projectTemplate.setLastUpdatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L1532">        projectTemplate.setLastUpdatedDate(Instant.now());</span>
<span class="nc" id="L1533">        return projectTemplate;</span>
    }

    private void handleProjectTemplateTasks(ProjectTemplate projectTemplate, List&lt;ProjectTemplateTaskDTO&gt; taskDTOs, UserLoginDetail token) {
<span class="nc bnc" id="L1537" title="All 2 branches missed.">        if (taskDTOs != null) {</span>
<span class="nc bnc" id="L1538" title="All 2 branches missed.">            if (projectTemplate.getProjectTemplateTasks() == null) {</span>
<span class="nc" id="L1539">                projectTemplate.setProjectTemplateTasks(new ArrayList&lt;&gt;());</span>
            }

            // Existing tasks in the database, mapped by taskId for quick lookup
<span class="nc" id="L1543">            Map&lt;Integer, ProjectTemplateTask&gt; existingTasksByTaskId = projectTemplate.getProjectTemplateTasks().stream()</span>
<span class="nc" id="L1544">                    .collect(Collectors.toMap(ProjectTemplateTask::getTaskId, t -&gt; t));</span>

            // Tasks that should remain active based on incoming DTOs
<span class="nc" id="L1547">            Set&lt;Integer&gt; taskIdsToKeepActive = taskDTOs.stream()</span>
<span class="nc" id="L1548">                    .map(ProjectTemplateTaskDTO::getTaskId)</span>
<span class="nc" id="L1549">                    .collect(Collectors.toSet());</span>

            // Mark existing tasks as inactive if not in the incoming list
<span class="nc bnc" id="L1552" title="All 2 branches missed.">            for (ProjectTemplateTask existingTask : projectTemplate.getProjectTemplateTasks()) {</span>
<span class="nc bnc" id="L1553" title="All 2 branches missed.">                if (!taskIdsToKeepActive.contains(existingTask.getTaskId())) {</span>
<span class="nc bnc" id="L1554" title="All 2 branches missed.">                    if (&quot;Y&quot;.equals(existingTask.getIsActive())) {</span>
<span class="nc" id="L1555">                        existingTask.setIsActive(&quot;N&quot;);</span>
<span class="nc" id="L1556">                        existingTask.setLastUpdatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L1557">                        existingTask.setLastUpdatedDate(Instant.now());</span>
                    }
                }
<span class="nc" id="L1560">            }</span>

            // Add or reactivate/update tasks based on incoming DTOs
<span class="nc bnc" id="L1563" title="All 2 branches missed.">            for (ProjectTemplateTaskDTO taskDTO : taskDTOs) {</span>
<span class="nc" id="L1564">                ProjectTemplateTask existingTask = existingTasksByTaskId.get(taskDTO.getTaskId());</span>

<span class="nc bnc" id="L1566" title="All 2 branches missed.">                if (existingTask != null) {</span>
                    // Task exists, update it or reactivate if necessary
<span class="nc" id="L1568">                    updateProjectTemplateTask(existingTask, taskDTO, token);</span>
<span class="nc bnc" id="L1569" title="All 2 branches missed.">                    if (&quot;N&quot;.equals(existingTask.getIsActive())) {</span>
<span class="nc" id="L1570">                        existingTask.setIsActive(&quot;Y&quot;);</span>
<span class="nc" id="L1571">                        existingTask.setLastUpdatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L1572">                        existingTask.setLastUpdatedDate(Instant.now());</span>
                    }
                } else {
                    // New task: create and add
<span class="nc" id="L1576">                    ProjectTemplateTask newTask = mapProjectTemplateTaskDTOToEntity(taskDTO, token);</span>
<span class="nc" id="L1577">                    newTask.setProjectTemplate(projectTemplate);</span>
<span class="nc" id="L1578">                    projectTemplate.getProjectTemplateTasks().add(newTask);</span>
                }
<span class="nc" id="L1580">            }</span>
        }
<span class="nc" id="L1582">    }</span>


    private void updateProjectTemplateTask(ProjectTemplateTask task, ProjectTemplateTaskDTO taskDTO, UserLoginDetail token) {
<span class="nc" id="L1586">        task.setTaskId(taskDTO.getTaskId());</span>
<span class="nc" id="L1587">        task.setIsActive(taskDTO.getIsActive());</span>
<span class="nc" id="L1588">        task.setLastUpdatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L1589">        task.setLastUpdatedDate(Instant.now());</span>
<span class="nc" id="L1590">    }</span>

    private ProjectTemplateTask mapProjectTemplateTaskDTOToEntity(ProjectTemplateTaskDTO taskDTO, UserLoginDetail token) {
<span class="nc" id="L1593">        ProjectTemplateTask task = new ProjectTemplateTask();</span>
//        task.setProjectTemplateTaskId(taskDTO.getProjectTemplateTaskId());
<span class="nc" id="L1595">        task.setTaskId(taskDTO.getTaskId());</span>
<span class="nc" id="L1596">        task.setIsActive(taskDTO.getIsActive());</span>
<span class="nc" id="L1597">        task.setCreatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L1598">        task.setCreatedDate(Instant.now());</span>
<span class="nc" id="L1599">        task.setLastUpdatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L1600">        task.setLastUpdatedDate(Instant.now());</span>
<span class="nc" id="L1601">        return task;</span>
    }

    private ProjectTemplateDTO mapToDTO(ProjectTemplate projectTemplate) {
<span class="nc" id="L1605">        ProjectTemplateDTO dto = new ProjectTemplateDTO();</span>
<span class="nc" id="L1606">        dto.setTemplateId(projectTemplate.getTemplateId());</span>
<span class="nc" id="L1607">        dto.setProjectTemplateName(projectTemplate.getProjectTemplateName());</span>
<span class="nc" id="L1608">        dto.setProjectType(projectTemplate.getProjectType());</span>
<span class="nc" id="L1609">        dto.setDescription(projectTemplate.getDescription());</span>
<span class="nc" id="L1610">        dto.setIsActive(projectTemplate.getIsActive());</span>
<span class="nc" id="L1611">        dto.setCreatedBy(projectTemplate.getCreatedBy());</span>
<span class="nc" id="L1612">        dto.setCreatedDate(projectTemplate.getCreatedDate());</span>
<span class="nc" id="L1613">        dto.setLastUpdatedBy(projectTemplate.getLastUpdatedBy());</span>
<span class="nc" id="L1614">        dto.setLastUpdatedDate(projectTemplate.getLastUpdatedDate());</span>
<span class="nc" id="L1615">        List&lt;Integer&gt; taskIds = projectTemplate.getProjectTemplateTasks().stream()</span>
<span class="nc" id="L1616">                .filter(x -&gt; &quot;Y&quot;.equals(x.getIsActive()))</span>
<span class="nc" id="L1617">                .map(ProjectTemplateTask::getTaskId)</span>
<span class="nc" id="L1618">                .filter(Objects::nonNull)</span>
<span class="nc" id="L1619">                .collect(Collectors.toList());</span>
<span class="nc" id="L1620">        List&lt;TaskStory&gt; taskStories = taskStoryRepository.findAllById(taskIds);</span>
<span class="nc" id="L1621">        Map&lt;Integer, String&gt; taskNameMap = taskStories.stream()</span>
<span class="nc" id="L1622">                .collect(Collectors.toMap(TaskStory::getTaskRfNum, TaskStory::getTaskname));</span>
<span class="nc bnc" id="L1623" title="All 2 branches missed.">        if (projectTemplate.getProjectTemplateTasks() != null) {</span>
<span class="nc" id="L1624">            List&lt;ProjectTemplateTaskDTO&gt; taskDTOS = projectTemplate.getProjectTemplateTasks()</span>
<span class="nc" id="L1625">                    .stream()</span>
<span class="nc" id="L1626">                    .filter(task -&gt; &quot;Y&quot;.equals(task.getIsActive()))</span>
<span class="nc" id="L1627">                    .map(task -&gt; {</span>
<span class="nc" id="L1628">                        ProjectTemplateTaskDTO taskDTO = new ProjectTemplateTaskDTO();</span>
<span class="nc" id="L1629">                        taskDTO.setProjectTemplateTaskId(task.getProjectTemplateTaskId());</span>
<span class="nc" id="L1630">                        taskDTO.setTaskId(task.getTaskId());</span>
<span class="nc" id="L1631">                        taskDTO.setIsActive(task.getIsActive());</span>

                        // Set task name from the map (avoid multiple DB calls)
<span class="nc" id="L1634">                        taskDTO.setTaskName(taskNameMap.getOrDefault(task.getTaskId(), &quot;Unknown Task name.&quot;));</span>
<span class="nc" id="L1635">                        taskDTO.setCreatedBy(task.getCreatedBy());</span>
<span class="nc" id="L1636">                        taskDTO.setCreatedDate(task.getCreatedDate());</span>
<span class="nc" id="L1637">                        taskDTO.setLastUpdatedBy(task.getLastUpdatedBy());</span>
<span class="nc" id="L1638">                        taskDTO.setLastUpdatedDate(task.getLastUpdatedDate());</span>
<span class="nc" id="L1639">                        return taskDTO;</span>
<span class="nc" id="L1640">                    }).collect(Collectors.toList());</span>
<span class="nc" id="L1641">            dto.setProjectTemplateTasks(taskDTOS);</span>
        }

<span class="nc" id="L1644">        return dto;</span>
    }

    @Transactional
    public Map&lt;String, Object&gt; getPaginatedProjectTemplates(String searchField, String searchKeyword, Pageable pageable) {
<span class="nc" id="L1649">        Specification&lt;ProjectTemplate&gt; spec = (root, query, criteriaBuilder) -&gt; {</span>
<span class="nc bnc" id="L1650" title="All 6 branches missed.">            if (searchField != null &amp;&amp; searchKeyword != null &amp;&amp; !searchKeyword.isEmpty()) {</span>
                try {
<span class="nc" id="L1652">                    Field field = ProjectTemplate.class.getDeclaredField(searchField);</span>
<span class="nc" id="L1653">                    Class&lt;?&gt; fieldType = field.getType();</span>
<span class="nc bnc" id="L1654" title="All 2 branches missed.">                    if (fieldType.equals(String.class)) {</span>
<span class="nc" id="L1655">                        return criteriaBuilder.like(criteriaBuilder.lower(root.get(searchField)), &quot;%&quot; + searchKeyword.toLowerCase() + &quot;%&quot;);</span>
<span class="nc bnc" id="L1656" title="All 4 branches missed.">                    } else if (Number.class.isAssignableFrom(fieldType) || fieldType.equals(int.class)) {</span>
<span class="nc" id="L1657">                        return criteriaBuilder.equal(root.get(searchField), Integer.parseInt(searchKeyword));</span>
<span class="nc bnc" id="L1658" title="All 4 branches missed.">                    } else if (fieldType.equals(Date.class) || fieldType.equals(Instant.class)) {</span>
<span class="nc" id="L1659">                        return criteriaBuilder.equal(root.get(searchField), Integer.parseInt(searchKeyword));</span>
                    }
<span class="nc" id="L1661">                } catch (NoSuchFieldException | SecurityException | NumberFormatException e) {</span>
<span class="nc" id="L1662">                    throw new IllegalArgumentException(&quot;Invalid search column or value type: &quot; + searchField);</span>
<span class="nc" id="L1663">                }</span>
            }
<span class="nc" id="L1665">            return criteriaBuilder.conjunction();</span>
        };

<span class="nc" id="L1668">        Page&lt;ProjectTemplate&gt; taskStoryPage = projectTemplateRepository.findAll(spec, pageable);</span>

<span class="nc" id="L1670">        List&lt;ProjectTemplateDTO&gt; taskStoryDTOList = taskStoryPage.getContent()</span>
<span class="nc" id="L1671">                .stream()</span>
<span class="nc" id="L1672">                .map(this::mapToDTO)</span>
<span class="nc" id="L1673">                .collect(Collectors.toList());</span>

<span class="nc" id="L1675">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1676">        response.put(&quot;result&quot;, taskStoryDTOList);</span>
<span class="nc" id="L1677">        response.put(&quot;currentPage&quot;, taskStoryPage.getNumber() + 1);</span>
<span class="nc" id="L1678">        response.put(&quot;totalItems&quot;, taskStoryPage.getTotalElements());</span>
<span class="nc" id="L1679">        response.put(&quot;pageSize&quot;, taskStoryPage.getSize());</span>
<span class="nc" id="L1680">        response.put(&quot;totalPages&quot;, taskStoryPage.getTotalPages());</span>

<span class="nc" id="L1682">        return response;</span>
    }

    @Transactional
    public void deleteByTemplateId(Integer id) {
<span class="nc" id="L1687">        ProjectTemplate projectTemplate = projectTemplateRepository.findById(id)</span>
<span class="nc" id="L1688">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Task story with ID &quot; + id + &quot; not found&quot;));</span>
<span class="nc" id="L1689">        projectTemplate.setIsActive(&quot;N&quot;);</span>
<span class="nc" id="L1690">        projectTemplate.getProjectTemplateTasks().forEach(approver -&gt; approver.setIsActive(&quot;N&quot;));</span>
<span class="nc" id="L1691">        projectTemplateRepository.save(projectTemplate);</span>
<span class="nc" id="L1692">    }</span>

    @Transactional
    public ProjectResponseDTO saveOrUpdateProject(ProjectRequestDTO request) {
<span class="nc" id="L1696">        UserLoginDetail user = SessionHolder.getUserLoginDetail();</span>
<span class="nc" id="L1697">        String username = String.valueOf(user.getUsername());</span>

        try {
            Project project;
<span class="nc bnc" id="L1701" title="All 2 branches missed.">            boolean isNewProject = (request.getProjectRfNum() == null);</span>
<span class="nc" id="L1702">            Optional&lt;Project&gt; duplicateProject = projectRepository.findByProjectName(request.getProjectName());</span>
<span class="nc" id="L1703">            Integer existingProjectTemplateId = null;</span>
<span class="nc bnc" id="L1704" title="All 2 branches missed.">            if (!isNewProject) {</span>
<span class="nc" id="L1705">                project = projectRepository.findById(request.getProjectRfNum())</span>
<span class="nc" id="L1706">                        .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Project not found&quot;));</span>
<span class="nc" id="L1707">                existingProjectTemplateId = project.getProjectTemplateId();</span>
<span class="nc bnc" id="L1708" title="All 4 branches missed.">                if (duplicateProject.isPresent() &amp;&amp; !duplicateProject.get().getProjectRfNum().equals(project.getProjectRfNum())) {</span>
<span class="nc" id="L1709">                    throw new IllegalStateException(&quot;Another project with same name already exists.&quot;);</span>
                }
            } else {
<span class="nc bnc" id="L1712" title="All 2 branches missed.">                if (duplicateProject.isPresent())</span>
<span class="nc" id="L1713">                    throw new IllegalStateException(&quot;Project with same name already exists.&quot;);</span>
<span class="nc" id="L1714">                project = new Project();</span>
<span class="nc" id="L1715">                project.setCreatedBy(username);</span>
<span class="nc" id="L1716">                project.setCreationDate(LocalDateTime.now());</span>
            }
<span class="nc" id="L1718">            String existingProjectId = project.getProjectId();</span>

<span class="nc" id="L1720">            modelMapper.map(request, project);</span>
<span class="nc" id="L1721">            project.setProjectId(existingProjectId);</span>
<span class="nc" id="L1722">            project.setProjectOwner(username);</span>
<span class="nc" id="L1723">            project.setLastUpdatedBy(username);</span>
<span class="nc" id="L1724">            project.setLastUpdateDate(LocalDateTime.now());</span>
            // project.setCreationDate();

<span class="nc" id="L1727">            project = projectRepository.save(project);</span>

<span class="nc bnc" id="L1729" title="All 2 branches missed.">            if (isNewProject) {</span>
<span class="nc" id="L1730">                String projectId = generateProjectId(project.getProjectRfNum());</span>
<span class="nc" id="L1731">                project.setProjectId(projectId);</span>
<span class="nc" id="L1732">                projectRepository.save(project);</span>
            }
<span class="nc bnc" id="L1734" title="All 2 branches missed.">            boolean isNewTemplateSelected = request.getProjectTemplateId() != null;</span>
<span class="nc bnc" id="L1735" title="All 4 branches missed.">            if (isNewTemplateSelected &amp;&amp; isNewProject) {</span>
<span class="nc" id="L1736">                manageTaskAllocation(project, request, user, true, false, null);</span>
<span class="nc bnc" id="L1737" title="All 6 branches missed.">            } else if (!isNewProject &amp;&amp; existingProjectTemplateId == null &amp;&amp; isNewTemplateSelected) {</span>
<span class="nc" id="L1738">                manageTaskAllocation(project, request, user, true, false, null);</span>
<span class="nc bnc" id="L1739" title="All 6 branches missed.">            } else if (!isNewProject &amp;&amp; !isNewTemplateSelected &amp;&amp; existingProjectTemplateId != null) {</span>
<span class="nc" id="L1740">                manageTaskAllocation(project, request, user, false, true, existingProjectTemplateId);</span>
<span class="nc bnc" id="L1741" title="All 6 branches missed.">            } else if (!isNewProject &amp;&amp; isNewTemplateSelected &amp;&amp; (!Objects.equals(existingProjectTemplateId, request.getProjectTemplateId()))) {</span>
<span class="nc" id="L1742">                manageTaskAllocation(project, request, user, false, false, existingProjectTemplateId);</span>
            }

<span class="nc" id="L1745">            return modelMapper.map(project, ProjectResponseDTO.class);</span>

<span class="nc" id="L1747">        } catch (EntityNotFoundException ex) {</span>
<span class="nc" id="L1748">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Project not found. Please check the provided Project ID.&quot;);</span>
<span class="nc" id="L1749">        } catch (DataIntegrityViolationException ex) {</span>
<span class="nc" id="L1750">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, extractConstraintViolationMessage(ex));</span>
        }
    }

    private String generateProjectId(Integer primaryKey) {
<span class="nc" id="L1755">        return &quot;P00&quot; + primaryKey;</span>
    }

    private String extractConstraintViolationMessage(DataIntegrityViolationException ex) {
<span class="nc" id="L1759">        String message = ex.getMostSpecificCause().getMessage();</span>

<span class="nc bnc" id="L1761" title="All 2 branches missed.">        if (message.contains(&quot;PROJECT_NAME&quot;)) {</span>
<span class="nc" id="L1762">            return &quot;The project name already exists. Please use a different name.&quot;;</span>
<span class="nc bnc" id="L1763" title="All 2 branches missed.">        } else if (message.contains(&quot;PROJECT_ID&quot;)) {</span>
<span class="nc" id="L1764">            return &quot;A project with this ID already exists. Please check the project details.&quot;;</span>
<span class="nc bnc" id="L1765" title="All 2 branches missed.">        } else if (message.contains(&quot;NOT NULL&quot;)) {</span>
<span class="nc" id="L1766">            return &quot;Some required fields are missing. Please check your input.&quot;;</span>
        } else {
<span class="nc" id="L1768">            return &quot;A database constraint error occurred. Please check your input values.&quot;;</span>
        }
    }

    private void manageTaskAllocation(Project project, ProjectRequestDTO request, UserLoginDetail user, Boolean isNewProject, Boolean isDeleted, Integer existingTemplateId) {
<span class="nc bnc" id="L1773" title="All 2 branches missed.">        if (isNewProject) {</span>
<span class="nc" id="L1774">            insertTaskAllocation(project, request, user);</span>
<span class="nc bnc" id="L1775" title="All 2 branches missed.">        } else if (isDeleted) {</span>
<span class="nc" id="L1776">            deleteTaskAllocation(existingTemplateId);</span>
        } else {
<span class="nc" id="L1778">            deleteTaskAllocation(existingTemplateId);</span>
<span class="nc" id="L1779">            insertTaskAllocation(project, request, user);</span>
        }
<span class="nc" id="L1781">    }</span>

    private void deleteTaskAllocation(Integer existingTemplateId) {
<span class="nc" id="L1784">        Optional&lt;ProjectTemplate&gt; projectTemplate = projectTemplateRepository.findById(existingTemplateId);</span>
<span class="nc bnc" id="L1785" title="All 2 branches missed.">        if (projectTemplate.isPresent()) {</span>
<span class="nc" id="L1786">            List&lt;Integer&gt; taskIds = projectTemplate.get().getProjectTemplateTasks()</span>
<span class="nc" id="L1787">                    .stream().map(ProjectTemplateTask::getTaskId).collect(Collectors.toList());</span>
<span class="nc" id="L1788">            List&lt;Integer&gt; taskAllocationIds = projectTaskAllocationRepository.findByTaskRfNumIn(taskIds)</span>
<span class="nc" id="L1789">                    .stream().map(ProjectTaskAllocation::getTaskAllocationId).collect(Collectors.toList());</span>
<span class="nc" id="L1790">            projectTaskAllocationRepository.deleteAllById(taskAllocationIds);</span>
        }
<span class="nc" id="L1792">    }</span>

    private void insertTaskAllocation(Project project, ProjectRequestDTO request, UserLoginDetail user) {
<span class="nc" id="L1795">        Optional&lt;ProjectTemplate&gt; projectTemplate = projectTemplateRepository.findById(request.getProjectTemplateId());</span>
<span class="nc bnc" id="L1796" title="All 2 branches missed.">        if (projectTemplate.isPresent()) {</span>
<span class="nc" id="L1797">            List&lt;Integer&gt; taskIds = projectTemplate.get().getProjectTemplateTasks()</span>
<span class="nc" id="L1798">                    .stream().filter(task -&gt; &quot;Y&quot;.equals(task.getIsActive())).map(ProjectTemplateTask::getTaskId).collect(Collectors.toList());</span>
<span class="nc" id="L1799">            List&lt;ProjectTaskAllocation&gt; allocations = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1800" title="All 2 branches missed.">            for (Integer taskId : taskIds) {</span>
<span class="nc" id="L1801">                ProjectTaskAllocation projectTaskAllocation = new ProjectTaskAllocation();</span>
<span class="nc" id="L1802">                projectTaskAllocation.setProjectRfNum(project.getProjectRfNum());</span>
<span class="nc" id="L1803">                projectTaskAllocation.setTaskRfNum(taskId);</span>
<span class="nc" id="L1804">                projectTaskAllocation.setCreationDate(LocalDateTime.now());</span>
<span class="nc" id="L1805">                projectTaskAllocation.setLastUpdateDate(LocalDateTime.now());</span>
<span class="nc" id="L1806">                projectTaskAllocation.setCreatedBy(String.valueOf(user.getUsername()));</span>
<span class="nc" id="L1807">                allocations.add(projectTaskAllocation);</span>
<span class="nc" id="L1808">            }</span>
<span class="nc" id="L1809">            projectTaskAllocationRepository.saveAll(allocations);</span>
        }
<span class="nc" id="L1811">    }</span>

    public Map&lt;String, Object&gt; getPaginatedProjects(Pageable pageable, String searchColumn, String searchValue) {
<span class="nc" id="L1814">        Specification&lt;Project&gt; spec = (root, query, criteriaBuilder) -&gt; {</span>
<span class="nc bnc" id="L1815" title="All 6 branches missed.">            if (searchColumn != null &amp;&amp; searchValue != null &amp;&amp; !searchValue.isEmpty()) {</span>

                // Handle search for countryName (fetching corresponding countryId)
<span class="nc bnc" id="L1818" title="All 2 branches missed.">                if (searchColumn.equals(&quot;countryName&quot;)) {</span>
<span class="nc" id="L1819">                    List&lt;Integer&gt; countryIds = lookupCodeRepository.findLookupIdsByName(searchValue);</span>
<span class="nc bnc" id="L1820" title="All 2 branches missed.">                    if (countryIds.isEmpty()) return criteriaBuilder.disjunction();</span>
<span class="nc" id="L1821">                    return root.get(&quot;countryId&quot;).in(countryIds);</span>
                }

                // Handle search for currencyName (fetching corresponding currencyId)
<span class="nc bnc" id="L1825" title="All 2 branches missed.">                if (searchColumn.equals(&quot;currencyName&quot;)) {</span>
<span class="nc" id="L1826">                    List&lt;Integer&gt; currencyIds = lookupCodeRepository.findLookupIdsByName(searchValue);</span>
<span class="nc bnc" id="L1827" title="All 2 branches missed.">                    if (currencyIds.isEmpty()) return criteriaBuilder.disjunction();</span>
<span class="nc" id="L1828">                    return root.get(&quot;currencyId&quot;).in(currencyIds);</span>
                }

<span class="nc bnc" id="L1831" title="All 2 branches missed.">                if (&quot;holidayName&quot;.equals(searchColumn)) {</span>
<span class="nc" id="L1832">                    List&lt;HolidaysCalendar&gt; holidays = holidaysCalendarRepository.findByNameContainingIgnoreCase(searchValue);</span>
<span class="nc" id="L1833">                    List&lt;Integer&gt; holidayIds = holidays.stream().map(HolidaysCalendar::getHolidayCalendarId).collect(Collectors.toList());</span>
<span class="nc bnc" id="L1834" title="All 2 branches missed.">                    return holidayIds.isEmpty() ? criteriaBuilder.disjunction() : root.get(&quot;holidayRfNum&quot;).in(holidayIds);</span>
                }

                // Handle search for projectOwnerName
<span class="nc bnc" id="L1838" title="All 2 branches missed.">                if (searchColumn.equals(&quot;projectOwnerName&quot;)) {</span>
<span class="nc" id="L1839">                    List&lt;User&gt; matchedUsers = userRepository.findByDisplayNameContainingIgnoreCase(searchValue);</span>
<span class="nc" id="L1840">                    List&lt;String&gt; matchingUserIds = matchedUsers.stream().map(user -&gt; String.valueOf(user.getId())).collect(Collectors.toList());</span>
<span class="nc bnc" id="L1841" title="All 2 branches missed.">                    if (matchingUserIds.isEmpty()) {</span>
<span class="nc" id="L1842">                        return criteriaBuilder.disjunction();</span>
                    }
<span class="nc" id="L1844">                    return root.get(&quot;projectOwner&quot;).in(matchingUserIds);</span>
                }

<span class="nc bnc" id="L1847" title="All 2 branches missed.">                if (&quot;status&quot;.equals(searchColumn)) {</span>
<span class="nc bnc" id="L1848" title="All 2 branches missed.">                    String statusValue = searchValue.trim().toLowerCase().matches(&quot;a|ac|act|activ|active.*&quot;) ? &quot;Y&quot; :</span>
<span class="nc bnc" id="L1849" title="All 2 branches missed.">                            searchValue.trim().toLowerCase().matches(&quot;i|in|ina|inac|inact|inacti|inactive.*&quot;) ? &quot;N&quot; : null;</span>
<span class="nc bnc" id="L1850" title="All 2 branches missed.">                    if (statusValue != null) {</span>
<span class="nc" id="L1851">                        return criteriaBuilder.equal(root.get(searchColumn), statusValue);</span>
                    } else {
<span class="nc" id="L1853">                        throw new IllegalArgumentException(&quot;Invalid status value. Use 'active' or 'inactive'.&quot;);</span>
                    }
                }

                // Default: Handle numeric or string search dynamically
                try {
<span class="nc" id="L1859">                    Integer numericValue = Integer.parseInt(searchValue);</span>
<span class="nc" id="L1860">                    return criteriaBuilder.equal(root.get(searchColumn), numericValue);</span>
<span class="nc" id="L1861">                } catch (NumberFormatException e) {</span>
<span class="nc" id="L1862">                    return criteriaBuilder.like(</span>
<span class="nc" id="L1863">                            criteriaBuilder.lower(root.get(searchColumn).as(String.class)),</span>
<span class="nc" id="L1864">                            &quot;%&quot; + searchValue.toLowerCase() + &quot;%&quot;</span>
                    );
                }
            }
<span class="nc" id="L1868">            return criteriaBuilder.conjunction();</span>
        };

<span class="nc" id="L1871">        Pageable actualPageable = pageable;</span>
<span class="nc" id="L1872">        Sort originalSort = pageable.getSort();</span>
<span class="nc bnc" id="L1873" title="All 2 branches missed.">        if (originalSort.stream().anyMatch(order -&gt; &quot;projectOwnerName&quot;.equals(order.getProperty()))) {</span>
<span class="nc" id="L1874">            List&lt;Sort.Order&gt; newOrders = originalSort.stream()</span>
<span class="nc" id="L1875">                    .map(order -&gt; {</span>
<span class="nc bnc" id="L1876" title="All 2 branches missed.">                        if (&quot;projectOwnerName&quot;.equals(order.getProperty())) {</span>
<span class="nc" id="L1877">                            return order.withProperty(&quot;projectOwner&quot;);</span>
                        }
<span class="nc" id="L1879">                        return order;</span>
                    })
<span class="nc" id="L1881">                    .collect(Collectors.toList());</span>
<span class="nc" id="L1882">            actualPageable = PageRequest.of(pageable.getPageNumber(), pageable.getPageSize(), Sort.by(newOrders));</span>
        }

<span class="nc" id="L1885">        Page&lt;Project&gt; projectPage = projectRepository.findAll(spec, actualPageable);</span>

        // Batch fetch lookup values (Country, Currency, Ownership)
<span class="nc" id="L1888">        Set&lt;Integer&gt; countryIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L1889">        Set&lt;Integer&gt; currencyIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L1890">        Set&lt;Long&gt; ownerUserIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L1891">        Set&lt;Integer&gt; holidayIds = new HashSet&lt;&gt;();</span>

<span class="nc" id="L1893">        projectPage.forEach(project -&gt; {</span>
<span class="nc bnc" id="L1894" title="All 2 branches missed.">            if (project.getCountryId() != null) countryIds.add(project.getCountryId());</span>
<span class="nc bnc" id="L1895" title="All 2 branches missed.">            if (project.getCurrencyId() != null) currencyIds.add(project.getCurrencyId());</span>
<span class="nc bnc" id="L1896" title="All 4 branches missed.">            if (project.getProjectOwner() != null &amp;&amp; !project.getProjectOwner().isEmpty()) {</span>
<span class="nc" id="L1897">                ownerUserIds.add(Long.valueOf(project.getProjectOwner()));</span>
            }
<span class="nc bnc" id="L1899" title="All 2 branches missed.">            if (project.getHolidayRfNum() != null) {</span>
<span class="nc" id="L1900">                holidayIds.add(project.getHolidayRfNum().intValue());</span>
            }
<span class="nc" id="L1902">        });</span>


<span class="nc" id="L1905">        Map&lt;Integer, String&gt; countryMap = fetchLookupNames(countryIds);</span>
<span class="nc" id="L1906">        Map&lt;Integer, String&gt; currencyMap = fetchLookupNames(currencyIds);</span>
<span class="nc" id="L1907">        Map&lt;Long, String&gt; ownershipMap = fetchOwnershipNames(ownerUserIds);</span>
<span class="nc" id="L1908">        Map&lt;Integer, String&gt; holidayMap = fetchHolidayNames(holidayIds);</span>

        // Map projects to DTOs


<span class="nc" id="L1913">        List&lt;ProjectResponseDTO&gt; projectDTOList = projectPage.getContent().stream().map(project -&gt; {</span>
<span class="nc" id="L1914">            ProjectResponseDTO dto = modelMapper.map(project, ProjectResponseDTO.class);</span>
<span class="nc" id="L1915">            dto.setCountryName(countryMap.get(project.getCountryId()));</span>
<span class="nc" id="L1916">            dto.setCurrencyName(currencyMap.get(project.getCurrencyId()));</span>
<span class="nc" id="L1917">            dto.setProjectOwnerName(ownershipMap.get(Long.valueOf(project.getProjectOwner())));</span>
<span class="nc bnc" id="L1918" title="All 2 branches missed.">            if (project.getHolidayRfNum() != null) {</span>
<span class="nc" id="L1919">                dto.setHolidayName(holidayMap.get(project.getHolidayRfNum().intValue()));</span>
            }
<span class="nc" id="L1921">            return dto;</span>
<span class="nc" id="L1922">        }).collect(Collectors.toList());</span>


        // Create response
<span class="nc" id="L1926">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1927">        response.put(&quot;result&quot;, projectDTOList);</span>
<span class="nc" id="L1928">        response.put(&quot;currentPage&quot;, projectPage.getNumber() + 1);</span>
<span class="nc" id="L1929">        response.put(&quot;totalItems&quot;, projectPage.getTotalElements());</span>
<span class="nc" id="L1930">        response.put(&quot;totalPages&quot;, projectPage.getTotalPages());</span>

<span class="nc" id="L1932">        return response;</span>
    }


    // Fetch Ownership Names in Batch (Updated for String usernames)
    private Map&lt;Long, String&gt; fetchOwnershipNames(Set&lt;Long&gt; ownerUserIds) {
<span class="nc bnc" id="L1938" title="All 2 branches missed.">        if (ownerUserIds.isEmpty()) return Collections.emptyMap();</span>

<span class="nc" id="L1940">        List&lt;User&gt; results = userRepository.findByIdIn(ownerUserIds);</span>
<span class="nc" id="L1941">        return results.stream().collect(Collectors.toMap(</span>
                User::getId,
                User::getDisplayName
        ));
    }

    private Map&lt;Integer, String&gt; fetchLookupNames(Set&lt;Integer&gt; ids) {
<span class="nc bnc" id="L1948" title="All 2 branches missed.">        if (ids.isEmpty()) return Collections.emptyMap();</span>
<span class="nc" id="L1949">        List&lt;Object[]&gt; results = lookupCodeRepository.findLookupNamesByIds(ids);</span>
<span class="nc" id="L1950">        return results.stream().collect(Collectors.toMap(row -&gt; (Integer) row[0], row -&gt; (String) row[1]));</span>
    }


    private Map&lt;Integer, String&gt; fetchHolidayNames(Set&lt;Integer&gt; ids) {
<span class="nc bnc" id="L1955" title="All 2 branches missed.">        if (ids.isEmpty()) return Collections.emptyMap();</span>
<span class="nc" id="L1956">        return ids.stream()</span>
<span class="nc" id="L1957">                .map(id -&gt; holidaysCalendarRepository.findByHolidayCalendarId(id).orElse(null))</span>
<span class="nc" id="L1958">                .filter(Objects::nonNull)</span>
<span class="nc" id="L1959">                .collect(Collectors.toMap(HolidaysCalendar::getHolidayCalendarId, HolidaysCalendar::getName));</span>
    }


    public ProjectResponseDTO getProjectById(Integer projectId) {
<span class="nc" id="L1964">        Project project = projectRepository.findById(projectId)</span>
<span class="nc" id="L1965">                .orElseThrow(() -&gt; new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Project not found&quot;));</span>

<span class="nc" id="L1967">        return modelMapper.map(project, ProjectResponseDTO.class);</span>
    }

    public List&lt;TaskStory&gt; getAllTasks() {
<span class="nc" id="L1971">        return taskStoryRepository.findAll(); // This works!</span>
    }

    @Transactional
    public ProjectTemplateDTO getProjectTemplateById(Integer id) {
<span class="nc" id="L1976">        ProjectTemplate projectTemplate = projectTemplateRepository.findById(id)</span>
<span class="nc" id="L1977">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Project template with ID &quot; + id + &quot; not found&quot;));</span>
<span class="nc" id="L1978">        return mapToDTO(projectTemplate);</span>
    }

    public List&lt;Map&lt;String, Object&gt;&gt; getNonAssociateEmployees(Integer id) {
<span class="nc" id="L1982">        List&lt;ProjectAllocation&gt; projectAllocations = projectAllocationRepository.findAllByProjectRfNum(id);</span>
<span class="nc" id="L1983">        List&lt;Integer&gt; employeeIds = projectAllocations.stream().map(ProjectAllocation::getEmployeeId).collect(Collectors.toList());</span>
        List&lt;Employee&gt; employees;
<span class="nc bnc" id="L1985" title="All 2 branches missed.">        if (employeeIds.isEmpty()) {</span>
<span class="nc" id="L1986">            employees = employeeRepository.findAll();</span>
        } else {
<span class="nc" id="L1988">            employees = employeeRepository.findByEmployeeIdNotIn(employeeIds);</span>
        }

<span class="nc" id="L1991">        return employees.stream().map(emp -&gt; {</span>
<span class="nc" id="L1992">            Map&lt;String, Object&gt; result = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L1993">            result.put(&quot;employeeId&quot;, emp.getEmployeeId());</span>
<span class="nc" id="L1994">            result.put(&quot;employeeName&quot;, emp.getFirstName() + &quot; &quot; + emp.getLastName());</span>
<span class="nc" id="L1995">            return result;</span>
<span class="nc" id="L1996">        }).collect(Collectors.toList());</span>
    }

    @Transactional
    public List&lt;ProjectAllocation&gt; saveEmployeeInProject(Integer projectId, Integer[] employeeIds) throws ParseException {
<span class="nc" id="L2001">        List&lt;ProjectAllocation&gt; allocations = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2002">        Project project = projectRepository.findByProjectRfNum(projectId);</span>
<span class="nc bnc" id="L2003" title="All 2 branches missed.">        for (Integer employeeId : employeeIds) {</span>
<span class="nc" id="L2004">            ProjectAllocation allocation = new ProjectAllocation();</span>
<span class="nc" id="L2005">            allocation.setProjectRfNum(projectId);</span>
<span class="nc" id="L2006">            allocation.setEmployeeId(employeeId);</span>
<span class="nc" id="L2007">            allocation.setDeputation(&quot;OFFSHORE&quot;);</span>
<span class="nc" id="L2008">            allocation.setIsActive(&quot;Y&quot;);</span>
<span class="nc" id="L2009">            allocation.setIsDeleted(&quot;N&quot;);</span>
<span class="nc" id="L2010">            allocation.setUnitPricePerHour(0L);</span>
<span class="nc" id="L2011">            allocation.setStartDate(new Date());</span>
<span class="nc" id="L2012">            allocation.setEndDate(project.getActualEndDate());</span>
<span class="nc" id="L2013">            allocation.setCreationDate(new Date().toInstant().atZone(ZoneId.systemDefault()).toLocalDateTime());</span>
<span class="nc" id="L2014">            allocations.add(allocation);</span>
        }
<span class="nc" id="L2016">        List&lt;ProjectAllocation&gt; saved = projectAllocationRepository.saveAll(allocations);</span>
<span class="nc" id="L2017">        saved.forEach(this::insertIntoHistoryTable);</span>
<span class="nc" id="L2018">        return saved;</span>
    }

    public static Specification&lt;ProjectAllocation&gt; searchByColumn(String column, String value, Integer projectRfNum) {
<span class="nc" id="L2022">        return (Root&lt;ProjectAllocation&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder criteriaBuilder) -&gt; {</span>
            Predicate searchPredicate;
<span class="nc" id="L2024">            javax.persistence.criteria.Path&lt;?&gt; path = root.get(column);</span>

<span class="nc bnc" id="L2026" title="All 2 branches missed.">            if (path.getJavaType().equals(String.class)) {</span>
<span class="nc" id="L2027">                searchPredicate = criteriaBuilder.like(criteriaBuilder.lower(root.get(column)), &quot;%&quot; + value.toLowerCase() + &quot;%&quot;);</span>
<span class="nc bnc" id="L2028" title="All 2 branches missed.">            } else if (path.getJavaType().equals(Date.class)) {</span>
                try {
<span class="nc" id="L2030">                    Date parsedDate = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).parse(value);</span>
<span class="nc" id="L2031">                    searchPredicate = criteriaBuilder.equal(root.get(column), parsedDate);</span>
<span class="nc" id="L2032">                } catch (ParseException e) {</span>
<span class="nc" id="L2033">                    throw new RuntimeException(&quot;Invalid date format for field: &quot; + column, e);</span>
<span class="nc" id="L2034">                }</span>
            } else {
<span class="nc" id="L2036">                searchPredicate = criteriaBuilder.equal(root.get(column), value);</span>
            }

<span class="nc" id="L2039">            Predicate projectRfNumPredicate = criteriaBuilder.equal(root.get(&quot;projectRfNum&quot;), projectRfNum);</span>

<span class="nc" id="L2041">            return criteriaBuilder.and(searchPredicate, projectRfNumPredicate);</span>
        };
    }

    @Transactional
    public Map&lt;String, Object&gt; getAllProjectAllocation(Pageable pageable, String searchField, String searchKeyword, Integer id) {
        Page&lt;ProjectAllocation&gt; projectAllocations;

<span class="nc bnc" id="L2049" title="All 2 branches missed.">        if (&quot;projectId&quot;.equalsIgnoreCase(searchField)) {</span>
<span class="nc" id="L2050">            projectAllocations = projectAllocationRepository.findByProject_ProjectIdContainingIgnoreCaseAndProjectRfNum(searchKeyword, id, pageable);</span>
<span class="nc bnc" id="L2051" title="All 2 branches missed.">        } else if (&quot;employeeNumber&quot;.equalsIgnoreCase(searchField)) {</span>
<span class="nc" id="L2052">            projectAllocations = projectAllocationRepository.findByEmployee_employeeNumberContainingIgnoreCaseAndProjectRfNum(searchKeyword, id, pageable);</span>
<span class="nc bnc" id="L2053" title="All 2 branches missed.">        } else if (&quot;employeeName&quot;.equalsIgnoreCase(searchField)) {</span>
<span class="nc" id="L2054">            projectAllocations = projectAllocationRepository.findByEmployee_firstNameContainingIgnoreCaseAndProjectRfNum(searchKeyword, id, pageable);</span>
<span class="nc bnc" id="L2055" title="All 8 branches missed.">        } else if (searchField != null &amp;&amp; searchKeyword != null &amp;&amp; !searchKeyword.trim().isEmpty() &amp;&amp; !searchField.trim().isEmpty()) {</span>
<span class="nc" id="L2056">            Specification&lt;ProjectAllocation&gt; spec = searchByColumn(searchField, searchKeyword, id);</span>
<span class="nc" id="L2057">            projectAllocations = projectAllocationRepository.findAll(spec, pageable);</span>
<span class="nc" id="L2058">        } else {</span>
<span class="nc" id="L2059">            projectAllocations = projectAllocationRepository.findByProjectRfNum(id, pageable);</span>
        }

<span class="nc" id="L2062">        List&lt;ProjectAllocationDTO&gt; allocationList = projectAllocations.getContent().stream().map(this::mapToProjectAllocationDTO).collect(Collectors.toList());</span>

<span class="nc" id="L2064">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2065">        response.put(&quot;result&quot;, allocationList);</span>
<span class="nc" id="L2066">        response.put(&quot;currentPage&quot;, pageable.getPageNumber() + 1);</span>
<span class="nc" id="L2067">        response.put(&quot;pageSize&quot;, pageable.getPageSize());</span>
<span class="nc" id="L2068">        response.put(&quot;totalItems&quot;, projectAllocations.getTotalElements());</span>
<span class="nc" id="L2069">        response.put(&quot;totalPages&quot;, projectAllocations.getTotalPages());</span>

<span class="nc" id="L2071">        return response;</span>
    }

    private ProjectAllocationDTO mapToProjectAllocationDTO(ProjectAllocation entity) {
<span class="nc" id="L2075">        ProjectAllocationDTO dto = modelMapper.map(entity, ProjectAllocationDTO.class);</span>
<span class="nc bnc" id="L2076" title="All 2 branches missed.">        dto.setProjectId(entity.getProject() != null ? entity.getProject().getProjectId() : null);</span>
<span class="nc bnc" id="L2077" title="All 2 branches missed.">        dto.setEmployeeNumber(entity.getEmployee() != null ? entity.getEmployee().getEmployeeNumber() : &quot;Unknown&quot;);</span>
<span class="nc bnc" id="L2078" title="All 2 branches missed.">        dto.setEmployeeName(entity.getEmployee() != null ? entity.getEmployee().getFullName() : &quot;Unknown&quot;);</span>
        /*Optional&lt;ProjectTaskRoleUser&gt; byUserName = projectTaskRoleUserRepository.findByUsername(entity.getEmployeeId());
        byUserName.ifPresentOrElse(projectTaskRoleId -&gt; dto.setRoleId(projectTaskRoleId.getProjectTaskRoleId()), null);*/
<span class="nc" id="L2081">        return dto;</span>
    }

    @Transactional
    public List&lt;TaskStoryDTO&gt; getSubTaskByProjectId(Integer projectId) {
<span class="nc" id="L2086">        List&lt;Integer&gt; taskIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2087">        Project project = projectRepository.findById(projectId).orElse(null);</span>
<span class="nc bnc" id="L2088" title="All 2 branches missed.">        if (project != null) {</span>
<span class="nc bnc" id="L2089" title="All 2 branches missed.">            if (project.getProjectTemplateId() != null) {</span>
<span class="nc" id="L2090">                projectTemplateRepository.findById(project.getProjectTemplateId()).ifPresent(projectTemplate -&gt; taskIds.addAll(projectTemplate.getProjectTemplateTasks().stream().filter(x -&gt; &quot;Y&quot;.equals(x.getIsActive())).map(ProjectTemplateTask::getTaskId).collect(Collectors.toList())));</span>
            }
        }
<span class="nc" id="L2093">        List&lt;Integer&gt; projectIds = List.of(projectId, 66);</span>
<span class="nc" id="L2094">        List&lt;ProjectTaskAllocation&gt; allocations = projectTaskAllocationRepository.findByProjectRfNumIn(projectIds);</span>
<span class="nc" id="L2095">        taskIds.addAll(allocations.stream().map(ProjectTaskAllocation::getTaskRfNum).distinct().collect(Collectors.toList()));</span>
<span class="nc" id="L2096">        List&lt;TaskStory&gt; taskStoryList = taskStoryRepository.findAllById(taskIds);</span>
<span class="nc" id="L2097">        return taskStoryList.stream().map(obj -&gt; {</span>
<span class="nc" id="L2098">            TaskStoryDTO dto = new TaskStoryDTO();</span>
<span class="nc" id="L2099">            dto.setTaskRfNum(obj.getTaskRfNum());</span>
<span class="nc" id="L2100">            dto.setTaskid(obj.getTaskid());</span>
<span class="nc" id="L2101">            dto.setTaskname(obj.getTaskname());</span>
<span class="nc bnc" id="L2102" title="All 2 branches missed.">            if (obj.getProjectMilestone() != null) {</span>
<span class="nc" id="L2103">                dto.setMilestoneName(obj.getProjectMilestone().getMilestoneName());</span>
            }
<span class="nc" id="L2105">            dto.setProjectMilestoneId(obj.getProjectMilestoneId());</span>
<span class="nc" id="L2106">            dto.setTaskstatus(obj.getTaskstatus());</span>
<span class="nc" id="L2107">            return dto;</span>
<span class="nc" id="L2108">        }).sorted(Comparator.comparing(TaskStoryDTO::getTaskRfNum).reversed()).collect(Collectors.toList());</span>
    }

    @Transactional
    public ProjectAllocation updateAllocatedEmployee(ProjectAllocationDTO dto) {
<span class="nc" id="L2113">        ProjectAllocation allocation = projectAllocationRepository.findById(dto.getProjectAllocationId())</span>
<span class="nc" id="L2114">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Project not found&quot;));</span>
<span class="nc" id="L2115">        LocalDate existingStartDate = ((java.sql.Date) allocation.getStartDate()).toLocalDate();</span>
<span class="nc" id="L2116">        allocation.setProjectAllocationId(allocation.getProjectAllocationId());</span>
<span class="nc" id="L2117">        allocation.setEmployeeId(dto.getEmployeeId());</span>
<span class="nc" id="L2118">        allocation.setDeputation(dto.getDeputation());</span>
<span class="nc" id="L2119">        allocation.setUnitPricePerHour(dto.getUnitPricePerHour());</span>
<span class="nc" id="L2120">        allocation.setStartDate(dto.getStartDate());</span>
<span class="nc" id="L2121">        allocation.setEndDate(dto.getEndDate());</span>
<span class="nc" id="L2122">        allocation.setAllocationPercentage(dto.getAllocationPercentage());</span>
<span class="nc" id="L2123">        allocation.setClientTimesheet(Active.valueOf(dto.getClientTimesheet()));</span>
<span class="nc" id="L2124">        ProjectAllocation savedProjectAllocation = projectAllocationRepository.save(allocation);</span>

<span class="nc" id="L2126">        List&lt;ProjectAllocationHistory&gt; projectAllocationIds = repo.findByProjectAllocationId(dto.getProjectAllocationId());</span>
<span class="nc bnc" id="L2127" title="All 2 branches missed.">        if (projectAllocationIds.isEmpty()) {</span>
<span class="nc" id="L2128">            insertIntoHistoryTable(savedProjectAllocation);</span>
        } else {
<span class="nc" id="L2130">            LocalDate dtoDate = dto.getStartDate().toInstant().atZone(ZoneId.systemDefault()).toLocalDate();</span>
<span class="nc bnc" id="L2131" title="All 2 branches missed.">            if (!dtoDate.equals(existingStartDate)) {</span>
<span class="nc" id="L2132">                insertIntoHistoryTable(savedProjectAllocation);</span>
            } else {
<span class="nc" id="L2134">                Date date = Date.from(existingStartDate.atStartOfDay(ZoneId.systemDefault()).toInstant());</span>
<span class="nc" id="L2135">                projectAllocationIds.stream()</span>
<span class="nc" id="L2136">                        .filter(x -&gt; x.getStartDate().equals(date))</span>
<span class="nc" id="L2137">                        .findFirst().ifPresent(allocationHistory -&gt; updateIntoHistoryTable(savedProjectAllocation, allocationHistory));</span>
            }
        }
<span class="nc" id="L2140">        return savedProjectAllocation;</span>
    }

    private void insertIntoHistoryTable(ProjectAllocation allocation) {
<span class="nc" id="L2144">        ProjectAllocationHistory history = new ProjectAllocationHistory();</span>
<span class="nc" id="L2145">        history.setProjectAllocationId(allocation.getProjectAllocationId());</span>
<span class="nc" id="L2146">        history.setProjectRfNum(allocation.getProjectRfNum());</span>
<span class="nc" id="L2147">        history.setEmployeeId(allocation.getEmployeeId());</span>
<span class="nc" id="L2148">        history.setDeputation(allocation.getDeputation());</span>
<span class="nc" id="L2149">        history.setUnitPricePerHour(allocation.getUnitPricePerHour());</span>
<span class="nc" id="L2150">        history.setStartDate(allocation.getStartDate());</span>
<span class="nc" id="L2151">        history.setEndDate(allocation.getEndDate());</span>
<span class="nc" id="L2152">        history.setIsActive(allocation.getIsActive());</span>
<span class="nc" id="L2153">        history.setIsDeleted(allocation.getIsDeleted());</span>
<span class="nc" id="L2154">        history.setCreationDate(LocalDateTime.now());</span>
<span class="nc" id="L2155">        history.setAllocationPercentage(allocation.getAllocationPercentage());</span>
<span class="nc" id="L2156">        history.setClientTimesheet(allocation.getClientTimesheet());</span>
<span class="nc" id="L2157">        repo.save(history);</span>
<span class="nc" id="L2158">    }</span>

    private void updateIntoHistoryTable(ProjectAllocation allocation, ProjectAllocationHistory allocationHistory) {
<span class="nc" id="L2161">        ProjectAllocationHistory history = new ProjectAllocationHistory();</span>
<span class="nc" id="L2162">        history.setProjectAllocationHistoryId(allocationHistory.getProjectAllocationHistoryId());</span>
<span class="nc" id="L2163">        history.setProjectAllocationId(allocation.getProjectAllocationId());</span>
<span class="nc" id="L2164">        history.setProjectRfNum(allocation.getProjectRfNum());</span>
<span class="nc" id="L2165">        history.setEmployeeId(allocation.getEmployeeId());</span>
<span class="nc" id="L2166">        history.setDeputation(allocation.getDeputation());</span>
<span class="nc" id="L2167">        history.setUnitPricePerHour(allocation.getUnitPricePerHour());</span>
<span class="nc" id="L2168">        history.setStartDate(allocation.getStartDate());</span>
<span class="nc" id="L2169">        history.setEndDate(allocation.getEndDate());</span>
<span class="nc" id="L2170">        history.setIsActive(allocation.getIsActive());</span>
<span class="nc" id="L2171">        history.setIsDeleted(allocation.getIsDeleted());</span>
<span class="nc" id="L2172">        history.setLastUpdateDate(LocalDateTime.now());</span>
<span class="nc" id="L2173">        history.setAllocationPercentage(allocation.getAllocationPercentage());</span>
<span class="nc" id="L2174">        history.setClientTimesheet(allocation.getClientTimesheet());</span>
<span class="nc" id="L2175">        repo.save(history);</span>
<span class="nc" id="L2176">    }</span>

    @Transactional
    public void deleteProjectAllocationId(Integer projectAllocationId) {
<span class="nc" id="L2180">        boolean existsById = projectAllocationRepository.existsById(projectAllocationId);</span>
<span class="nc bnc" id="L2181" title="All 2 branches missed.">        if (existsById) projectAllocationRepository.deleteById(projectAllocationId);</span>
<span class="nc" id="L2182">        else throw new ResourceNotFoundException(&quot;Invalid project allocation id.&quot;);</span>
<span class="nc" id="L2183">    }</span>

    public List&lt;PriceElementDTO&gt; getAllPriceElements() {
<span class="nc" id="L2186">        List&lt;Object[]&gt; results = projectTemplateRepository.fetchPriceElements();</span>
<span class="nc" id="L2187">        List&lt;PriceElementDTO&gt; priceElements = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L2189" title="All 2 branches missed.">        for (Object[] row : results) {</span>
<span class="nc" id="L2190">            PriceElementDTO dto = new PriceElementDTO();</span>
<span class="nc" id="L2191">            dto.setPriceElementId(((Number) row[0]).longValue());</span>
<span class="nc" id="L2192">            dto.setPriceElementName((String) row[1]);</span>
<span class="nc" id="L2193">            dto.setBasePrice(((Number) row[2]).doubleValue());</span>
<span class="nc" id="L2194">            dto.setBaseTime(((Number) row[3]).intValue());</span>
<span class="nc" id="L2195">            dto.setIsActive((String) row[4]);</span>
<span class="nc" id="L2196">            dto.setIsDeleted((String) row[5]);</span>
<span class="nc" id="L2197">            dto.setLastUpdatedBy((String) row[6]);</span>
<span class="nc" id="L2198">            dto.setLastUpdatedDate((Timestamp) row[7]);</span>
<span class="nc" id="L2199">            dto.setCreatedBy((String) row[8]);</span>
<span class="nc" id="L2200">            dto.setCreatedByUserCode((String) row[9]);</span>
<span class="nc" id="L2201">            dto.setCreationDate((Timestamp) row[10]);</span>
<span class="nc" id="L2202">            dto.setMappedGroupCount(((Number) row[11]).intValue());</span>
<span class="nc" id="L2203">            priceElements.add(dto);</span>
<span class="nc" id="L2204">        }</span>
<span class="nc" id="L2205">        return priceElements;</span>
    }

    public Page&lt;EmployeeProjectDTO&gt; getEmployeeProjectDetails(
            int page, int size,
            String sortBy, String sortDir,
            String searchKeyword, String searchField) {

<span class="nc" id="L2213">        CriteriaBuilder cb = entityManager.getCriteriaBuilder();</span>
<span class="nc" id="L2214">        CriteriaQuery&lt;Tuple&gt; cq = cb.createTupleQuery();</span>
<span class="nc" id="L2215">        Root&lt;Employee&gt; e = cq.from(Employee.class);</span>
<span class="nc" id="L2216">        Join&lt;Employee, ProjectAllocationHistory&gt; pah = e.join(&quot;allocations&quot;, JoinType.LEFT);</span>
<span class="nc" id="L2217">        Join&lt;ProjectAllocationHistory, Project&gt; project = pah.join(&quot;project&quot;, JoinType.LEFT);</span>
<span class="nc" id="L2218">        Join&lt;Project, CustomerSite&gt; site = project.join(&quot;site&quot;, JoinType.LEFT);</span>
<span class="nc" id="L2219">        Join&lt;CustomerSite, CustomerAccount&gt; account = site.join(&quot;customerAccount&quot;, JoinType.LEFT);</span>
<span class="nc" id="L2220">        Join&lt;Employee, Employee&gt; rm = e.join(&quot;reportingManager&quot;, JoinType.LEFT);</span>
<span class="nc" id="L2221">        List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2222">        predicates.add(cb.equal(cb.lower(e.get(&quot;isActive&quot;)), &quot;Y&quot;));</span>
<span class="nc" id="L2223">        predicates.add(cb.or(</span>
<span class="nc" id="L2224">                cb.isNull(pah.get(&quot;endDate&quot;)),</span>
<span class="nc" id="L2225">                cb.greaterThanOrEqualTo(pah.get(&quot;endDate&quot;), cb.currentDate())</span>
        ));
<span class="nc bnc" id="L2227" title="All 4 branches missed.">        if (searchKeyword != null &amp;&amp; !searchKeyword.isBlank()) {</span>
<span class="nc" id="L2228">            String searchPattern = &quot;%&quot; + searchKeyword.toLowerCase() + &quot;%&quot;;</span>
<span class="nc" id="L2229">            Expression&lt;String&gt; empNameExpr = cb.lower(</span>
<span class="nc" id="L2230">                    cb.concat(</span>
<span class="nc" id="L2231">                            cb.concat(</span>
<span class="nc" id="L2232">                                    cb.concat(e.get(&quot;firstName&quot;), &quot; &quot;),</span>
<span class="nc" id="L2233">                                    cb.coalesce(e.get(&quot;middleName&quot;), &quot;&quot;)</span>
                            ),
                            &quot; &quot;
                    )
            );
<span class="nc" id="L2238">            empNameExpr = cb.concat(empNameExpr, e.get(&quot;lastName&quot;));</span>
<span class="nc" id="L2239">            Expression&lt;String&gt; rmNameExpr = cb.lower(</span>
<span class="nc" id="L2240">                    cb.concat(</span>
<span class="nc" id="L2241">                            cb.concat(</span>
<span class="nc" id="L2242">                                    cb.concat(rm.get(&quot;firstName&quot;), &quot; &quot;),</span>
<span class="nc" id="L2243">                                    cb.coalesce(rm.get(&quot;middleName&quot;), &quot;&quot;)</span>
                            ),
                            &quot; &quot;
                    )
            );
<span class="nc" id="L2248">            rmNameExpr = cb.concat(rmNameExpr, rm.get(&quot;lastName&quot;));</span>
<span class="nc bnc" id="L2249" title="All 2 branches missed.">            if (&quot;empName&quot;.equalsIgnoreCase(searchField)) {</span>
<span class="nc" id="L2250">                predicates.add(cb.like(empNameExpr, searchPattern));</span>
<span class="nc bnc" id="L2251" title="All 2 branches missed.">            } else if (&quot;rmName&quot;.equalsIgnoreCase(searchField)) {</span>
<span class="nc" id="L2252">                predicates.add(cb.like(rmNameExpr, searchPattern));</span>
<span class="nc bnc" id="L2253" title="All 2 branches missed.">            } else if (&quot;employmentType&quot;.equalsIgnoreCase(searchField)) {</span>
<span class="nc" id="L2254">                predicates.add(cb.like(cb.lower(e.get(&quot;employeeType&quot;)), searchPattern));</span>
            }
        }
<span class="nc" id="L2257">        cq.multiselect(</span>
<span class="nc" id="L2258">                e.get(&quot;employeeId&quot;).alias(&quot;empId&quot;),</span>
<span class="nc" id="L2259">                e.get(&quot;employeeNumber&quot;).alias(&quot;employeeNumber&quot;),</span>
<span class="nc" id="L2260">                e.get(&quot;firstName&quot;).alias(&quot;firstName&quot;),</span>
<span class="nc" id="L2261">                e.get(&quot;middleName&quot;).alias(&quot;middleName&quot;),</span>
<span class="nc" id="L2262">                e.get(&quot;lastName&quot;).alias(&quot;lastName&quot;),</span>
<span class="nc" id="L2263">                e.get(&quot;employeeType&quot;).alias(&quot;employmentType&quot;),</span>
<span class="nc" id="L2264">                rm.get(&quot;employeeId&quot;).alias(&quot;rmId&quot;),</span>
<span class="nc" id="L2265">                rm.get(&quot;firstName&quot;).alias(&quot;rmFirstName&quot;),</span>
<span class="nc" id="L2266">                rm.get(&quot;middleName&quot;).alias(&quot;rmMiddleName&quot;),</span>
<span class="nc" id="L2267">                rm.get(&quot;lastName&quot;).alias(&quot;rmLastName&quot;),</span>
<span class="nc" id="L2268">                project.get(&quot;projectName&quot;).alias(&quot;projectName&quot;)</span>
<span class="nc" id="L2269">        ).where(cb.and(predicates.toArray(new Predicate[0])));</span>

<span class="nc" id="L2271">        Expression&lt;?&gt; sortExpression = e.get(&quot;employeeId&quot;);</span>
<span class="nc bnc" id="L2272" title="All 2 branches missed.">        if (&quot;employeeNumber&quot;.equalsIgnoreCase(sortBy)) {</span>
<span class="nc" id="L2273">            sortExpression = e.get(&quot;employeeNumber&quot;);</span>
<span class="nc bnc" id="L2274" title="All 2 branches missed.">        } else if (&quot;empName&quot;.equalsIgnoreCase(sortBy)) {</span>
<span class="nc" id="L2275">            Expression&lt;String&gt; empNameExpr = cb.concat(</span>
<span class="nc" id="L2276">                    cb.concat(</span>
<span class="nc" id="L2277">                            cb.concat(e.get(&quot;firstName&quot;), &quot; &quot;),</span>
<span class="nc" id="L2278">                            cb.coalesce(e.get(&quot;middleName&quot;), &quot;&quot;)</span>
                    ),
                    &quot; &quot;
            );
<span class="nc" id="L2282">            sortExpression = cb.concat(empNameExpr, e.get(&quot;lastName&quot;));</span>
<span class="nc bnc" id="L2283" title="All 2 branches missed.">        } else if (&quot;rmName&quot;.equalsIgnoreCase(sortBy)) {</span>
<span class="nc" id="L2284">            Expression&lt;String&gt; rmNameExpr = cb.concat(</span>
<span class="nc" id="L2285">                    cb.concat(</span>
<span class="nc" id="L2286">                            cb.concat(rm.get(&quot;firstName&quot;), &quot; &quot;),</span>
<span class="nc" id="L2287">                            cb.coalesce(rm.get(&quot;middleName&quot;), &quot;&quot;)</span>
                    ),
                    &quot; &quot;
            );
<span class="nc" id="L2291">            sortExpression = cb.concat(rmNameExpr, rm.get(&quot;lastName&quot;));</span>
<span class="nc bnc" id="L2292" title="All 2 branches missed.">        } else if (&quot;employmentType&quot;.equalsIgnoreCase(sortBy)) {</span>
<span class="nc" id="L2293">            sortExpression = e.get(&quot;employeeType&quot;);</span>
        }
<span class="nc bnc" id="L2295" title="All 2 branches missed.">        cq.orderBy(&quot;desc&quot;.equalsIgnoreCase(sortDir) ? cb.desc(sortExpression) : cb.asc(sortExpression));</span>
<span class="nc" id="L2296">        List&lt;Tuple&gt; tuples = entityManager.createQuery(cq).getResultList();</span>

<span class="nc" id="L2298">        Map&lt;Integer, EmployeeProjectDTO&gt; map = new LinkedHashMap&lt;&gt;();</span>
<span class="nc bnc" id="L2299" title="All 2 branches missed.">        for (Tuple t : tuples) {</span>
<span class="nc" id="L2300">            Integer empId = t.get(&quot;empId&quot;, Integer.class);</span>
<span class="nc" id="L2301">            EmployeeProjectDTO dto = map.get(empId);</span>
<span class="nc bnc" id="L2302" title="All 2 branches missed.">            if (dto == null) {</span>
<span class="nc" id="L2303">                dto = new EmployeeProjectDTO();</span>
<span class="nc" id="L2304">                dto.setEmpId(empId);</span>
<span class="nc" id="L2305">                dto.setEmployeeNumber(t.get(&quot;employeeNumber&quot;, String.class));</span>
<span class="nc" id="L2306">                dto.setEmpName(Stream.of(</span>
<span class="nc" id="L2307">                                t.get(&quot;firstName&quot;, String.class),</span>
<span class="nc" id="L2308">                                t.get(&quot;middleName&quot;, String.class),</span>
<span class="nc" id="L2309">                                t.get(&quot;lastName&quot;, String.class))</span>
<span class="nc" id="L2310">                        .filter(Objects::nonNull).collect(Collectors.joining(&quot; &quot;))</span>
                );
<span class="nc" id="L2312">                dto.setEmploymentType(t.get(&quot;employmentType&quot;, String.class));</span>
<span class="nc" id="L2313">                dto.setRmId(t.get(&quot;rmId&quot;, Integer.class));</span>
<span class="nc" id="L2314">                dto.setRmName(Stream.of(</span>
<span class="nc" id="L2315">                                t.get(&quot;rmFirstName&quot;, String.class),</span>
<span class="nc" id="L2316">                                t.get(&quot;rmMiddleName&quot;, String.class),</span>
<span class="nc" id="L2317">                                t.get(&quot;rmLastName&quot;, String.class))</span>
<span class="nc" id="L2318">                        .filter(Objects::nonNull).collect(Collectors.joining(&quot; &quot;))</span>
                );
<span class="nc" id="L2320">                dto.setActiveProjects(new TreeSet&lt;&gt;());</span>
<span class="nc" id="L2321">                map.put(empId, dto);</span>
            }
<span class="nc" id="L2323">            String projectName = t.get(&quot;projectName&quot;, String.class);</span>
<span class="nc bnc" id="L2324" title="All 4 branches missed.">            if (projectName != null &amp;&amp; !&quot;Organization&quot;.equalsIgnoreCase(projectName)) {</span>
<span class="nc" id="L2325">                dto.getActiveProjects().add(projectName);</span>
            }
<span class="nc" id="L2327">        }</span>
<span class="nc" id="L2328">        List&lt;EmployeeProjectDTO&gt; allResults = new ArrayList&lt;&gt;(map.values());</span>
<span class="nc" id="L2329">        int fromIndex = Math.min((page - 1) * size, allResults.size());</span>
<span class="nc" id="L2330">        int toIndex = Math.min(fromIndex + size, allResults.size());</span>
<span class="nc" id="L2331">        List&lt;EmployeeProjectDTO&gt; pagedList = allResults.subList(fromIndex, toIndex);</span>
<span class="nc" id="L2332">        return new PageImpl&lt;&gt;(pagedList, PageRequest.of(page - 1, size), allResults.size());</span>
    }

    public Page&lt;EmployeeProjectAllocationDTO&gt; getProjectAllocationsByEmployeeId(
            Integer employeeId,
            int page, int size,
            String sortBy, String sortDir,
            String searchField, String searchKeyword) {

<span class="nc" id="L2341">        CriteriaBuilder cb = entityManager.getCriteriaBuilder();</span>
<span class="nc" id="L2342">        CriteriaQuery&lt;Tuple&gt; cq = cb.createTupleQuery();</span>
<span class="nc" id="L2343">        Root&lt;ProjectAllocationHistory&gt; pa = cq.from(ProjectAllocationHistory.class);</span>
<span class="nc" id="L2344">        Join&lt;ProjectAllocationHistory, Project&gt; p = pa.join(&quot;project&quot;, JoinType.LEFT);</span>
<span class="nc" id="L2345">        Join&lt;Project, CustomerSite&gt; site = p.join(&quot;site&quot;, JoinType.LEFT);</span>
<span class="nc" id="L2346">        Join&lt;CustomerSite, CustomerAccount&gt; account = site.join(&quot;customerAccount&quot;, JoinType.LEFT);</span>
<span class="nc" id="L2347">        Join&lt;CustomerAccount, Customer&gt; customer = account.join(&quot;customer&quot;, JoinType.LEFT);</span>
<span class="nc" id="L2348">        List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2349">        predicates.add(cb.equal(pa.get(&quot;employee&quot;).get(&quot;employeeId&quot;), employeeId));</span>
<span class="nc" id="L2350">        predicates.add(cb.or(</span>
<span class="nc" id="L2351">                cb.isNull(p.get(&quot;projectName&quot;)),</span>
<span class="nc" id="L2352">                cb.notEqual(cb.lower(p.get(&quot;projectName&quot;)), &quot;organization&quot;)</span>
        ));

<span class="nc bnc" id="L2355" title="All 6 branches missed.">        if (searchKeyword != null &amp;&amp; !searchKeyword.isBlank() &amp;&amp; searchField != null) {</span>
<span class="nc" id="L2356">            Expression&lt;String&gt; searchExpression = null;</span>
<span class="nc bnc" id="L2357" title="All 7 branches missed.">            switch (searchField) {</span>
                case &quot;projectName&quot;:
<span class="nc" id="L2359">                    searchExpression = cb.lower(p.get(&quot;projectName&quot;));</span>
<span class="nc" id="L2360">                    break;</span>
                case &quot;projectRfNum&quot;:
<span class="nc" id="L2362">                    searchExpression = cb.toString(pa.get(&quot;projectRfNum&quot;));</span>
<span class="nc" id="L2363">                    break;</span>
                case &quot;startDate&quot;:
<span class="nc" id="L2365">                    searchExpression = cb.function(&quot;DATE_FORMAT&quot;, String.class, pa.get(&quot;startDate&quot;), cb.literal(&quot;%Y-%m-%d&quot;));</span>
<span class="nc" id="L2366">                    break;</span>
                case &quot;endDate&quot;:
<span class="nc" id="L2368">                    searchExpression = cb.function(&quot;DATE_FORMAT&quot;, String.class, pa.get(&quot;endDate&quot;), cb.literal(&quot;%Y-%m-%d&quot;));</span>
<span class="nc" id="L2369">                    break;</span>
                case &quot;allocationPercentage&quot;:
                    try {
<span class="nc" id="L2372">                        Double val = Double.parseDouble(searchKeyword);</span>
<span class="nc" id="L2373">                        predicates.add(cb.equal(pa.get(&quot;allocationPercentage&quot;), val));</span>
<span class="nc" id="L2374">                    } catch (NumberFormatException ignored) {</span>
<span class="nc" id="L2375">                    }</span>
<span class="nc" id="L2376">                    break;</span>
                case &quot;customerName&quot;:
<span class="nc" id="L2378">                    searchExpression = cb.lower(customer.get(&quot;customerName&quot;));</span>
                    break;
            }
<span class="nc bnc" id="L2381" title="All 2 branches missed.">            if (searchExpression != null) {</span>
<span class="nc" id="L2382">                predicates.add(cb.like(searchExpression, &quot;%&quot; + searchKeyword.toLowerCase() + &quot;%&quot;));</span>
            }
        }
<span class="nc" id="L2385">        cq.multiselect(</span>
<span class="nc" id="L2386">                pa.get(&quot;startDate&quot;).alias(&quot;startDate&quot;),</span>
<span class="nc" id="L2387">                pa.get(&quot;endDate&quot;).alias(&quot;endDate&quot;),</span>
<span class="nc" id="L2388">                pa.get(&quot;projectRfNum&quot;).alias(&quot;projectRfNum&quot;),</span>
<span class="nc" id="L2389">                p.get(&quot;projectName&quot;).alias(&quot;projectName&quot;),</span>
<span class="nc" id="L2390">                pa.get(&quot;allocationPercentage&quot;).alias(&quot;allocationPercentage&quot;),</span>
<span class="nc" id="L2391">                customer.get(&quot;customerName&quot;).alias(&quot;customerName&quot;),</span>
<span class="nc" id="L2392">                cb.selectCase()</span>
<span class="nc" id="L2393">                        .when(cb.or(</span>
<span class="nc" id="L2394">                                cb.isNull(pa.get(&quot;endDate&quot;)),</span>
<span class="nc" id="L2395">                                cb.greaterThanOrEqualTo(pa.get(&quot;endDate&quot;), cb.currentDate())</span>
                        ), &quot;Active&quot;)
<span class="nc" id="L2397">                        .otherwise(&quot;In-Active&quot;)</span>
<span class="nc" id="L2398">                        .alias(&quot;projectStatus&quot;)</span>
<span class="nc" id="L2399">        ).where(cb.and(predicates.toArray(new Predicate[0])));</span>
<span class="nc" id="L2400">        Expression&lt;?&gt; sortExpression = pa.get(&quot;startDate&quot;);</span>
<span class="nc bnc" id="L2401" title="All 2 branches missed.">        if (&quot;endDate&quot;.equalsIgnoreCase(sortBy)) {</span>
<span class="nc" id="L2402">            sortExpression = pa.get(&quot;endDate&quot;);</span>
<span class="nc bnc" id="L2403" title="All 2 branches missed.">        } else if (&quot;projectName&quot;.equalsIgnoreCase(sortBy)) {</span>
<span class="nc" id="L2404">            sortExpression = p.get(&quot;projectName&quot;);</span>
<span class="nc bnc" id="L2405" title="All 2 branches missed.">        } else if (&quot;projectRfNum&quot;.equalsIgnoreCase(sortBy)) {</span>
<span class="nc" id="L2406">            sortExpression = pa.get(&quot;projectRfNum&quot;);</span>
<span class="nc bnc" id="L2407" title="All 2 branches missed.">        } else if (&quot;allocationPercentage&quot;.equalsIgnoreCase(sortBy)) {</span>
<span class="nc" id="L2408">            sortExpression = pa.get(&quot;allocationPercentage&quot;);</span>
<span class="nc bnc" id="L2409" title="All 2 branches missed.">        } else if (&quot;customerName&quot;.equalsIgnoreCase(sortBy)) {</span>
<span class="nc" id="L2410">            sortExpression = customer.get(&quot;customerName&quot;);</span>
<span class="nc bnc" id="L2411" title="All 2 branches missed.">        } else if (&quot;projectStatus&quot;.equalsIgnoreCase(sortBy)) {</span>
<span class="nc" id="L2412">            sortExpression = cb.selectCase()</span>
<span class="nc" id="L2413">                    .when(cb.or(</span>
<span class="nc" id="L2414">                            cb.isNull(pa.get(&quot;endDate&quot;)),</span>
<span class="nc" id="L2415">                            cb.greaterThanOrEqualTo(pa.get(&quot;endDate&quot;), cb.currentDate())</span>
                    ), &quot;Active&quot;)
<span class="nc" id="L2417">                    .otherwise(&quot;In-Active&quot;);</span>
        }
<span class="nc bnc" id="L2419" title="All 2 branches missed.">        cq.orderBy(&quot;desc&quot;.equalsIgnoreCase(sortDir) ? cb.desc(sortExpression) : cb.asc(sortExpression));</span>
<span class="nc" id="L2420">        TypedQuery&lt;Tuple&gt; query = entityManager.createQuery(cq);</span>
<span class="nc" id="L2421">        query.setFirstResult((page - 1) * size);</span>
<span class="nc" id="L2422">        query.setMaxResults(size);</span>
<span class="nc" id="L2423">        List&lt;Tuple&gt; result = query.getResultList();</span>
<span class="nc" id="L2424">        List&lt;EmployeeProjectAllocationDTO&gt; finalList = result.stream().map(t -&gt; {</span>
<span class="nc" id="L2425">            EmployeeProjectAllocationDTO dto = new EmployeeProjectAllocationDTO();</span>
<span class="nc" id="L2426">            dto.setStartDate(formatDate(t.get(&quot;startDate&quot;, Date.class)));</span>
<span class="nc" id="L2427">            dto.setEndDate(formatDate(t.get(&quot;endDate&quot;, Date.class)));</span>
<span class="nc" id="L2428">            dto.setProjectRfNum(t.get(&quot;projectRfNum&quot;, Integer.class));</span>
<span class="nc" id="L2429">            dto.setProjectName(t.get(&quot;projectName&quot;, String.class));</span>
<span class="nc" id="L2430">            dto.setProjectStatus(t.get(&quot;projectStatus&quot;, String.class));</span>
<span class="nc" id="L2431">            dto.setAllocationPercentage(t.get(&quot;allocationPercentage&quot;, Double.class));</span>
<span class="nc" id="L2432">            dto.setCustomerName(t.get(&quot;customerName&quot;, String.class));</span>
<span class="nc" id="L2433">            return dto;</span>
<span class="nc" id="L2434">        }).collect(Collectors.toList());</span>
<span class="nc" id="L2435">        CriteriaQuery&lt;Long&gt; countQuery = cb.createQuery(Long.class);</span>
<span class="nc" id="L2436">        Root&lt;ProjectAllocationHistory&gt; countPa = countQuery.from(ProjectAllocationHistory.class);</span>
<span class="nc" id="L2437">        Join&lt;ProjectAllocationHistory, Project&gt; countP = countPa.join(&quot;project&quot;, JoinType.LEFT);</span>
<span class="nc" id="L2438">        Join&lt;Project, CustomerSite&gt; countSite = countP.join(&quot;site&quot;, JoinType.LEFT);</span>
<span class="nc" id="L2439">        Join&lt;CustomerSite, CustomerAccount&gt; countAccount = countSite.join(&quot;customerAccount&quot;, JoinType.LEFT);</span>
<span class="nc" id="L2440">        Join&lt;CustomerAccount, Customer&gt; countCustomer = countAccount.join(&quot;customer&quot;, JoinType.LEFT);</span>
<span class="nc" id="L2441">        List&lt;Predicate&gt; countPredicates = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2442">        countPredicates.add(cb.equal(countPa.get(&quot;employee&quot;).get(&quot;employeeId&quot;), employeeId));</span>
<span class="nc" id="L2443">        countPredicates.add(cb.or(</span>
<span class="nc" id="L2444">                cb.isNull(countP.get(&quot;projectName&quot;)),</span>
<span class="nc" id="L2445">                cb.notEqual(cb.lower(countP.get(&quot;projectName&quot;)), &quot;organization&quot;)</span>
        ));
<span class="nc bnc" id="L2447" title="All 6 branches missed.">        if (searchKeyword != null &amp;&amp; !searchKeyword.isBlank() &amp;&amp; searchField != null) {</span>
<span class="nc" id="L2448">            Expression&lt;String&gt; countSearchExpression = null;</span>
<span class="nc bnc" id="L2449" title="All 7 branches missed.">            switch (searchField) {</span>
                case &quot;projectName&quot;:
<span class="nc" id="L2451">                    countSearchExpression = cb.lower(countP.get(&quot;projectName&quot;));</span>
<span class="nc" id="L2452">                    break;</span>
                case &quot;projectRfNum&quot;:
<span class="nc" id="L2454">                    countSearchExpression = cb.toString(countPa.get(&quot;projectRfNum&quot;));</span>
<span class="nc" id="L2455">                    break;</span>
                case &quot;startDate&quot;:
<span class="nc" id="L2457">                    countSearchExpression = cb.function(&quot;DATE_FORMAT&quot;, String.class, countPa.get(&quot;startDate&quot;), cb.literal(&quot;%Y-%m-%d&quot;));</span>
<span class="nc" id="L2458">                    break;</span>
                case &quot;endDate&quot;:
<span class="nc" id="L2460">                    countSearchExpression = cb.function(&quot;DATE_FORMAT&quot;, String.class, countPa.get(&quot;endDate&quot;), cb.literal(&quot;%Y-%m-%d&quot;));</span>
<span class="nc" id="L2461">                    break;</span>
                case &quot;allocationPercentage&quot;:
                    try {
<span class="nc" id="L2464">                        Double val = Double.parseDouble(searchKeyword);</span>
<span class="nc" id="L2465">                        countPredicates.add(cb.equal(countPa.get(&quot;allocationPercentage&quot;), val));</span>
<span class="nc" id="L2466">                    } catch (NumberFormatException ignored) {</span>
<span class="nc" id="L2467">                    }</span>
<span class="nc" id="L2468">                    break;</span>
                case &quot;customerName&quot;:
<span class="nc" id="L2470">                    countSearchExpression = cb.lower(countCustomer.get(&quot;customerName&quot;));</span>
                    break;
            }
<span class="nc bnc" id="L2473" title="All 2 branches missed.">            if (countSearchExpression != null) {</span>
<span class="nc" id="L2474">                countPredicates.add(cb.like(countSearchExpression, &quot;%&quot; + searchKeyword.toLowerCase() + &quot;%&quot;));</span>
            }
        }
<span class="nc" id="L2477">        countQuery.select(cb.count(countPa)).where(cb.and(countPredicates.toArray(new Predicate[0])));</span>
<span class="nc" id="L2478">        Long total = entityManager.createQuery(countQuery).getSingleResult();</span>
<span class="nc" id="L2479">        return new PageImpl&lt;&gt;(finalList, PageRequest.of(page - 1, size), total);</span>
    }

    private String formatDate(Date date) {
<span class="nc bnc" id="L2483" title="All 2 branches missed.">        if (date == null) return null;</span>
<span class="nc" id="L2484">        return new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).format(date);</span>
    }

    public List&lt;Map&lt;String, Object&gt;&gt; getProjectDropdownList() {
<span class="nc" id="L2488">        return projectRepository.findAll()</span>
<span class="nc" id="L2489">                .stream()</span>
//                .filter(project -&gt; &quot;Y&quot;.equals(project.getStatus()))
<span class="nc" id="L2491">                .map(project -&gt; {</span>
<span class="nc" id="L2492">                    Map&lt;String, Object&gt; result = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L2493">                    result.put(&quot;projectId&quot;, project.getProjectRfNum());</span>
<span class="nc" id="L2494">                    result.put(&quot;projectName&quot;, project.getProjectName());</span>
<span class="nc" id="L2495">                    result.put(&quot;projectCode&quot;, project.getProjectId());</span>
<span class="nc" id="L2496">                    return result;</span>
<span class="nc" id="L2497">                }).collect(Collectors.toList());</span>
    }

    @Transactional
    public Map&lt;String, Object&gt; getPaginatedMilestonesByProjectRfNum(Integer projectRfNum, Pageable pageable, String searchColumn, String searchValue) {
<span class="nc" id="L2502">        Specification&lt;ProjectMilestone&gt; spec = (root, query, criteriaBuilder) -&gt; {</span>
<span class="nc" id="L2503">            Predicate predicate = criteriaBuilder.equal(root.get(&quot;projectRfNum&quot;), projectRfNum);</span>

<span class="nc bnc" id="L2505" title="All 6 branches missed.">            if (searchColumn != null &amp;&amp; searchValue != null &amp;&amp; !searchValue.isEmpty()) {</span>
                try {
<span class="nc" id="L2507">                    Field field = ProjectMilestone.class.getDeclaredField(searchColumn);</span>
<span class="nc" id="L2508">                    Class&lt;?&gt; fieldType = field.getType();</span>

<span class="nc" id="L2510">                    Predicate searchPredicate = null;</span>

<span class="nc bnc" id="L2512" title="All 2 branches missed.">                    if (fieldType.equals(String.class)) {</span>
<span class="nc" id="L2513">                        searchPredicate = criteriaBuilder.like(</span>
<span class="nc" id="L2514">                                criteriaBuilder.lower(root.get(searchColumn)),</span>
<span class="nc" id="L2515">                                &quot;%&quot; + searchValue.toLowerCase() + &quot;%&quot;</span>
                        );
<span class="nc bnc" id="L2517" title="All 2 branches missed.">                    } else if (Number.class.isAssignableFrom(fieldType) ||</span>
<span class="nc bnc" id="L2518" title="All 6 branches missed.">                            fieldType.equals(int.class) || fieldType.equals(long.class) || fieldType.equals(double.class)) {</span>
<span class="nc" id="L2519">                        searchPredicate = criteriaBuilder.equal(root.get(searchColumn), Integer.parseInt(searchValue));</span>
<span class="nc bnc" id="L2520" title="All 4 branches missed.">                    } else if (fieldType.equals(Boolean.class) || fieldType.equals(boolean.class)) {</span>
<span class="nc" id="L2521">                        searchPredicate = criteriaBuilder.equal(root.get(searchColumn), Boolean.parseBoolean(searchValue));</span>
                    }

<span class="nc bnc" id="L2524" title="All 2 branches missed.">                    if (searchPredicate != null) {</span>
<span class="nc" id="L2525">                        predicate = criteriaBuilder.and(predicate, searchPredicate);</span>
                    }

<span class="nc" id="L2528">                } catch (NoSuchFieldException | NumberFormatException e) {</span>
<span class="nc" id="L2529">                    throw new IllegalArgumentException(&quot;Invalid search field or value type: &quot; + e.getMessage());</span>
<span class="nc" id="L2530">                }</span>
            }

<span class="nc" id="L2533">            return predicate;</span>
        };

<span class="nc" id="L2536">        Page&lt;ProjectMilestone&gt; pageResult = projectMilestoneRepository.findAll(spec, pageable);</span>

<span class="nc" id="L2538">        List&lt;ProjectMilestoneDTO&gt; dtoList = pageResult.getContent().stream()</span>
<span class="nc" id="L2539">                .map(milestone -&gt; {</span>
<span class="nc" id="L2540">                    ProjectMilestoneDTO dto = modelMapper.map(milestone, ProjectMilestoneDTO.class);</span>
<span class="nc" id="L2541">                    User userTable = userRepository.findById(Long.parseLong(milestone.getCreatedBy())).orElse(null);</span>
<span class="nc" id="L2542">                    dto.setCreatedBy(milestone.getCreatedBy());</span>
<span class="nc" id="L2543">                    dto.setCreatedByName(userTable.getDisplayName());</span>
<span class="nc" id="L2544">                    dto.setCreationDate(milestone.getCreatedDate());</span>
<span class="nc" id="L2545">                    dto.setLastUpdatedBy(milestone.getLastUpdatedBy());</span>
<span class="nc" id="L2546">                    dto.setLastUpdateDate(milestone.getLastUpdatedDate());</span>
                    // Add: projectMilestoneTypeName from projectMilestoneTypeId
<span class="nc bnc" id="L2548" title="All 2 branches missed.">                    if (milestone.getProjectMilestoneTypeId() != null) {</span>
<span class="nc" id="L2549">                        String milestoneTypeName = lookupCodeRepository</span>
<span class="nc" id="L2550">                                .findByLookupCodeId(milestone.getProjectMilestoneTypeId())</span>
<span class="nc" id="L2551">                                .orElse(&quot;Unknown Milestone Type&quot;);</span>

<span class="nc" id="L2553">                        dto.setProjectMilestoneTypeName(milestoneTypeName);</span>
<span class="nc" id="L2554">                    } else {</span>
<span class="nc" id="L2555">                        dto.setProjectMilestoneTypeName(&quot;Unknown Milestone Type&quot;);</span>
                    }

<span class="nc" id="L2558">                    return dto;</span>
                })
<span class="nc" id="L2560">                .collect(Collectors.toList());</span>

<span class="nc" id="L2562">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2563">        response.put(&quot;result&quot;, dtoList);</span>
<span class="nc" id="L2564">        response.put(&quot;currentPage&quot;, pageResult.getNumber() + 1);</span>
<span class="nc" id="L2565">        response.put(&quot;totalItems&quot;, pageResult.getTotalElements());</span>
<span class="nc" id="L2566">        response.put(&quot;totalPages&quot;, pageResult.getTotalPages());</span>
<span class="nc" id="L2567">        response.put(&quot;pageSize&quot;, pageResult.getSize());</span>
<span class="nc" id="L2568">        response.put(&quot;projectRfNum&quot;, projectRfNum);</span>

<span class="nc" id="L2570">        return response;</span>
    }

    public Map&lt;String, Object&gt; getProjectMilestonesByProjectRfNum(Integer projectRfNum) {
<span class="nc" id="L2574">        List&lt;Map&lt;String, Object&gt;&gt; resultList = projectMilestoneRepository</span>
<span class="nc" id="L2575">                .findProjectMilestoneByProjectRfNumAndIsActive(projectRfNum, &quot;Y&quot;)</span>
<span class="nc" id="L2576">                .stream()</span>
//                .filter(m -&gt; &quot;Y&quot;.equalsIgnoreCase(m.getIsActive()) &amp;&amp; &quot;N&quot;.equalsIgnoreCase(m.getIsDeleted()))
<span class="nc" id="L2578">                .map(m -&gt; {</span>
<span class="nc" id="L2579">                    Map&lt;String, Object&gt; item = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2580">                    item.put(&quot;projectMilestoneId&quot;, m.getProjectMilestoneId());</span>
<span class="nc" id="L2581">                    item.put(&quot;milestoneName&quot;, m.getMilestoneName());</span>
<span class="nc" id="L2582">                    return item;</span>
                })
<span class="nc" id="L2584">                .collect(Collectors.toList());</span>

<span class="nc" id="L2586">        Map&lt;String, Object&gt; responseData = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2587">        responseData.put(&quot;result&quot;, resultList);</span>
<span class="nc" id="L2588">        return responseData;</span>
    }


    public List&lt;Project&gt; projectLIstLoggedInUser() {
<span class="nc" id="L2593">        UserLoginDetail userLoginDetail = SessionHolder.getUserLoginDetail();</span>
<span class="nc" id="L2594">        List&lt;Integer&gt; projectId = repo.findByEmployeeId(userLoginDetail.getEmpId()).stream().map(ProjectAllocationHistory::getProjectRfNum)</span>
<span class="nc" id="L2595">                .collect(Collectors.toList());</span>
<span class="nc" id="L2596">        return projectRepository.findAllById(projectId).stream()</span>
<span class="nc" id="L2597">                .filter(project -&gt; &quot;Y&quot;.equals(project.getStatus()))</span>
<span class="nc bnc" id="L2598" title="All 4 branches missed.">                .filter(project -&gt; project.getActualEndDate() == null || !project.getActualEndDate().before(new Date()))</span>
<span class="nc" id="L2599">                .collect(Collectors.toList());</span>
    }

    public ProjectMilestone saveOrUpdateProjectMilestone(ProjectMilestoneDTO dto) {
<span class="nc" id="L2603">        UserLoginDetail tokenHolder = SessionHolder.getUserLoginDetail();</span>
        ProjectMilestone milestone;

<span class="nc" id="L2606">        String normalizedInput = dto.getMilestoneName().trim().replaceAll(&quot;\\s+&quot;, &quot; &quot;);</span>
<span class="nc" id="L2607">        Integer rfNum = dto.getProjectRfNum();</span>

<span class="nc" id="L2609">        Optional&lt;ProjectMilestone&gt; existing = projectMilestoneRepository</span>
<span class="nc" id="L2610">                .findByMilestoneNameIgnoreCaseAndProjectRfNum(normalizedInput, rfNum);</span>

<span class="nc bnc" id="L2612" title="All 2 branches missed.">        if (existing.isPresent() &amp;&amp;</span>
<span class="nc bnc" id="L2613" title="All 4 branches missed.">                (dto.getProjectMilestoneId() == null || !existing.get().getProjectMilestoneId().equals(dto.getProjectMilestoneId()))) {</span>
<span class="nc" id="L2614">            throw new IllegalArgumentException(&quot;Milestone '&quot; + dto.getMilestoneName().trim() + &quot;' already exists.&quot;);</span>
        }

<span class="nc bnc" id="L2617" title="All 2 branches missed.">        if (dto.getProjectMilestoneId() != null) {</span>
<span class="nc" id="L2618">            milestone = projectMilestoneRepository.findById(dto.getProjectMilestoneId())</span>
<span class="nc" id="L2619">                    .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Milestone not found&quot;));</span>

<span class="nc" id="L2621">            String createdBy = milestone.getCreatedBy();</span>
<span class="nc" id="L2622">            Instant creationDate = milestone.getCreatedDate();</span>

<span class="nc" id="L2624">            modelMapper.map(dto, milestone);</span>

<span class="nc" id="L2626">            milestone.setCreatedBy(createdBy);</span>
<span class="nc" id="L2627">            milestone.setCreatedDate(creationDate);</span>
<span class="nc" id="L2628">            milestone.setLastUpdatedBy(String.valueOf(tokenHolder.getUsername()));</span>
<span class="nc" id="L2629">            milestone.setLastUpdatedDate(Instant.now());</span>

<span class="nc" id="L2631">        } else {</span>
<span class="nc" id="L2632">            milestone = modelMapper.map(dto, ProjectMilestone.class);</span>

<span class="nc" id="L2634">            milestone.setCreatedBy(String.valueOf(tokenHolder.getUsername()));</span>
<span class="nc" id="L2635">            milestone.setCreatedDate(Instant.now());</span>
        }

<span class="nc" id="L2638">        return projectMilestoneRepository.save(milestone);</span>
    }

    public ProjectMilestoneDTO getProjectMilestoneById(Integer milestoneId) {
<span class="nc" id="L2642">        ProjectMilestone milestone = projectMilestoneRepository.findById(milestoneId)</span>
<span class="nc" id="L2643">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Project milestone not found with ID: &quot; + milestoneId));</span>

<span class="nc" id="L2645">        return modelMapper.map(milestone, ProjectMilestoneDTO.class);</span>
    }

    public void softDeleteProjectMilestone(Integer milestoneId) {
<span class="nc" id="L2649">        UserLoginDetail tokenHolder = SessionHolder.getUserLoginDetail();</span>
<span class="nc" id="L2650">        ProjectMilestone milestone = projectMilestoneRepository.findById(milestoneId)</span>
<span class="nc" id="L2651">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Milestone not found with ID: &quot; + milestoneId));</span>

<span class="nc" id="L2653">        milestone.setIsDeleted(&quot;Y&quot;);</span>
<span class="nc" id="L2654">        milestone.setLastUpdatedBy(String.valueOf(tokenHolder.getUsername()));</span>
<span class="nc" id="L2655">        milestone.setLastUpdatedDate(Instant.now());</span>

<span class="nc" id="L2657">        projectMilestoneRepository.save(milestone);</span>
<span class="nc" id="L2658">    }</span>

    public List&lt;TaskStoryDTO&gt; getTaskByProjectMilestoneId(Integer projectMilestoneId) {
<span class="nc" id="L2661">        List&lt;TaskStory&gt; taskStoryList = taskStoryRepository.findByProjectMilestoneId(projectMilestoneId);</span>
<span class="nc" id="L2662">        return taskStoryList.stream().map(obj -&gt; {</span>
<span class="nc" id="L2663">            TaskStoryDTO dto = new TaskStoryDTO();</span>
<span class="nc" id="L2664">            dto.setTaskRfNum(obj.getTaskRfNum());</span>
<span class="nc" id="L2665">            dto.setProjectRfNum(obj.getProjectRfNum());</span>
<span class="nc" id="L2666">            dto.setTaskid(obj.getTaskid());</span>
<span class="nc" id="L2667">            dto.setTaskname(obj.getTaskname());</span>
<span class="nc" id="L2668">            dto.setTasktype(obj.getTasktype());</span>
<span class="nc" id="L2669">            dto.setTaskdesc(obj.getTaskdesc());</span>
<span class="nc" id="L2670">            dto.setPlannedstartdate(obj.getPlannedstartdate());</span>
<span class="nc" id="L2671">            dto.setPlannedenddate(obj.getPlannedenddate());</span>
<span class="nc" id="L2672">            dto.setActualstartdate(obj.getActualstartdate());</span>
<span class="nc" id="L2673">            dto.setActualenddate(obj.getActualenddate());</span>
<span class="nc" id="L2674">            dto.setTaskstatus(obj.getTaskstatus());</span>
<span class="nc bnc" id="L2675" title="All 2 branches missed.">            if (obj.getProjectMilestone() != null) {</span>
<span class="nc" id="L2676">                dto.setMilestoneName(obj.getProjectMilestone().getMilestoneName());</span>
            }
<span class="nc" id="L2678">            dto.setProjectMilestoneId(obj.getProjectMilestoneId());</span>
<span class="nc" id="L2679">            return dto;</span>
<span class="nc" id="L2680">        }).sorted(Comparator.comparing(TaskStoryDTO::getTaskRfNum).reversed()).collect(Collectors.toList());</span>
    }

    public List&lt;Map&lt;String, Object&gt;&gt; getProjectTemplateDropdownList() {
<span class="nc" id="L2684">        return projectTemplateRepository.findAll()</span>
<span class="nc" id="L2685">                .stream()</span>
<span class="nc" id="L2686">                .filter(project -&gt; &quot;Y&quot;.equals(project.getIsActive()))</span>
<span class="nc" id="L2687">                .sorted(Comparator.comparing(ProjectTemplate::getProjectTemplateName))</span>
<span class="nc" id="L2688">                .map(project -&gt; {</span>
<span class="nc" id="L2689">                    Map&lt;String, Object&gt; result = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L2690">                    result.put(&quot;templateId&quot;, project.getTemplateId());</span>
<span class="nc" id="L2691">                    result.put(&quot;templateName&quot;, project.getProjectTemplateName());</span>
<span class="nc" id="L2692">                    return result;</span>
<span class="nc" id="L2693">                }).collect(Collectors.toList());</span>
    }

    public Map&lt;LocalDate, HolidaysCalendarDay&gt; getHolidayList(Integer empId, Date startDate, Date endDate) {
<span class="nc" id="L2697">        List&lt;ProjectAllocation&gt; allocations = projectAllocationRepository.findByEmployeeIdAndStartDateLessThanEqualAndEndDateGreaterThanEqual(empId, endDate, startDate);</span>
<span class="nc bnc" id="L2698" title="All 2 branches missed.">        if (!allocations.isEmpty()) {</span>
<span class="nc" id="L2699">            Set&lt;Integer&gt; calendarIds = allocations.stream()</span>
<span class="nc" id="L2700">                    .map(allocation -&gt; allocation.getProject().getHolidayRfNum())</span>
<span class="nc" id="L2701">                    .filter(Objects::nonNull)</span>
<span class="nc" id="L2702">                    .collect(Collectors.toSet());</span>
<span class="nc" id="L2703">            return holidaysCalendarDayRepository.findByHolidayCalendarIdIn(calendarIds).stream()</span>
<span class="nc bnc" id="L2704" title="All 2 branches missed.">                    .filter(x -&gt; !&quot;WO&quot;.equals(x.getHolidayType())).collect(Collectors.toMap(</span>
                            HolidaysCalendarDay::getHolidayDate,
<span class="nc" id="L2706">                            x -&gt; x,</span>
<span class="nc" id="L2707">                            (existing, replacement) -&gt; existing</span>
                    ));
        }
<span class="nc" id="L2710">        return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>
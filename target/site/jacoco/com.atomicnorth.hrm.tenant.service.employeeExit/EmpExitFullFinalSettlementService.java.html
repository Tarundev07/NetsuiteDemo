<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmpExitFullFinalSettlementService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HR Management</a> &gt; <a href="index.source.html" class="el_package">com.atomicnorth.hrm.tenant.service.employeeExit</a> &gt; <span class="el_source">EmpExitFullFinalSettlementService.java</span></div><h1>EmpExitFullFinalSettlementService.java</h1><pre class="source lang-java linenums">package com.atomicnorth.hrm.tenant.service.employeeExit;

import com.atomicnorth.hrm.tenant.domain.Employee;
import com.atomicnorth.hrm.tenant.domain.asset.EmpAssetAssignment;
import com.atomicnorth.hrm.tenant.domain.employeeExit.EmpExitFinanceClearanceDetails;
import com.atomicnorth.hrm.tenant.domain.employeeExit.EmpExitFullFinalSettlement;
import com.atomicnorth.hrm.tenant.domain.employeeExit.EmpExitFullFinalSettlementDetails;
import com.atomicnorth.hrm.tenant.domain.employeeExit.EmpExitRequest;
import com.atomicnorth.hrm.tenant.helper.SessionHolder;
import com.atomicnorth.hrm.tenant.repository.EmployeeExit.EmpExitFullFinalSettlementRepository;
import com.atomicnorth.hrm.tenant.repository.EmployeeExit.EmpExitRequestRepository;
import com.atomicnorth.hrm.tenant.repository.EmployeeRepository;
import com.atomicnorth.hrm.tenant.service.dto.employeeExit.EmpExitFullFinalSettlementDTO;
import com.atomicnorth.hrm.tenant.service.dto.employeeExit.EmpExitFullFinalSettlementDetailsDTO;
import com.atomicnorth.hrm.tenant.service.dto.employeeExit.EmployeeAssetClearance;
import com.atomicnorth.hrm.util.FileStorageService;
import lombok.AllArgsConstructor;
import org.modelmapper.ModelMapper;
import org.springframework.core.io.Resource;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import javax.persistence.EntityNotFoundException;
import javax.servlet.http.HttpServletRequest;
import javax.transaction.Transactional;
import java.io.IOException;
import java.lang.reflect.Field;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.time.Instant;
import java.util.*;
import java.util.stream.Collectors;
import java.util.stream.Stream;

@Service
<span class="nc" id="L37">@AllArgsConstructor</span>
public class EmpExitFullFinalSettlementService {

    private final EmpExitFullFinalSettlementRepository settlementRepo;
    private final EmpExitRequestRepository requestRepository;
    private final EmployeeRepository employeeRepository;
    private final FileStorageService fileStorageService;
    private final ModelMapper modelMapper;

    @Transactional
    public void createSettlement(Integer exitRequestId) {
<span class="nc" id="L48">        EmpExitFullFinalSettlement settlement = new EmpExitFullFinalSettlement();</span>
<span class="nc" id="L49">        settlement.setExitRequestId(exitRequestId);</span>
<span class="nc" id="L50">        settlement.setSettlementStatus(&quot;Pending&quot;);</span>
<span class="nc" id="L51">        settlementRepo.save(settlement);</span>
<span class="nc" id="L52">    }</span>

    public boolean existsByExitRequestId(Integer exitRequestId) {
<span class="nc" id="L55">        return settlementRepo.existsByExitRequestId(exitRequestId);</span>
    }

    @Transactional
    public EmpExitFullFinalSettlementDTO getFnFDetails(Integer exitRequestId, HttpServletRequest request) {
<span class="nc" id="L60">        EmpExitFullFinalSettlement settlement = settlementRepo.findByExitRequestId(exitRequestId).orElseThrow(() -&gt; new EntityNotFoundException(&quot;No request found for this exit request.&quot;));</span>
<span class="nc" id="L61">        EmpExitRequest empExitRequest = requestRepository.findById(exitRequestId).orElseThrow(() -&gt; new EntityNotFoundException(&quot;No exit request found.&quot;));</span>
<span class="nc" id="L62">        Employee employee = employeeRepository.findByEmployeeId(empExitRequest.getEmployeeId()).orElseThrow(() -&gt; new EntityNotFoundException(&quot;Employee not found.&quot;));</span>
<span class="nc" id="L63">        String baseUrl = request.getScheme() + &quot;://&quot; + request.getServerName() + &quot;:&quot; + request.getServerPort();</span>

<span class="nc" id="L65">        EmpExitFullFinalSettlementDTO dto = new EmpExitFullFinalSettlementDTO();</span>
<span class="nc" id="L66">        dto.setId(settlement.getId());</span>
<span class="nc" id="L67">        dto.setExitRequestId(exitRequestId);</span>
<span class="nc" id="L68">        dto.setEmployeeId(employee.getEmployeeId());</span>
<span class="nc" id="L69">        dto.setEmployeeName(employee.getFullName() + &quot; (&quot; + employee.getEmployeeNumber() + &quot;)&quot;);</span>
<span class="nc" id="L70">        dto.setExitRequestNumber(empExitRequest.getExitRequestNumber());</span>
<span class="nc" id="L71">        dto.setDepartmentName(employee.getDepartment().getDname());</span>
<span class="nc" id="L72">        dto.setDesignationName(employee.getDesignation().getDesignationName());</span>
<span class="nc" id="L73">        dto.setReportingManager(employee.getReportingManager().getFullName() + &quot; (&quot; + employee.getReportingManager().getEmployeeNumber() + &quot;)&quot;);</span>
<span class="nc" id="L74">        dto.setOverallStatus(empExitRequest.getStatus());</span>
<span class="nc" id="L75">        dto.setLastWorkingDate(empExitRequest.getLastWorkingDate());</span>
<span class="nc" id="L76">        dto.setAssetClearanceStatus(empExitRequest.getAssetClearanceStatus());</span>
<span class="nc" id="L77">        dto.setFinanceClearanceStatus(empExitRequest.getFinanceClearanceStatus());</span>
<span class="nc" id="L78">        dto.setKtHandoverStatus(empExitRequest.getKtHandoverStatus());</span>
<span class="nc" id="L79">        dto.setAdminClearanceStatus(empExitRequest.getAdminClearanceStatus());</span>
<span class="nc" id="L80">        dto.setExitInterviewStatus(empExitRequest.getExitInterviewStatus());</span>
<span class="nc" id="L81">        dto.setNetAmount(settlement.getNetAmount());</span>
<span class="nc bnc" id="L82" title="All 4 branches missed.">        if (settlement.getAttachment() != null &amp;&amp; !settlement.getAttachment().isBlank()) {</span>
<span class="nc" id="L83">            String path = settlement.getAttachment();</span>
<span class="nc" id="L84">            String fileNameWithPrefix = path.substring(Math.max(path.lastIndexOf('/'), path.lastIndexOf('\\')) + 1);</span>
<span class="nc" id="L85">            int firstUnderscore = fileNameWithPrefix.indexOf(&quot;_&quot;);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            String cleanFileName = (firstUnderscore != -1) ? fileNameWithPrefix.substring(firstUnderscore + 1) : fileNameWithPrefix;</span>
<span class="nc" id="L87">            dto.setAttachment(baseUrl + &quot;/api/assignments/download/&quot; + cleanFileName);</span>
        }

<span class="nc" id="L90">        List&lt;EmpExitFullFinalSettlementDetailsDTO&gt; detailsDTOS = settlement.getSettlementDetails().stream().map(s -&gt; {</span>
<span class="nc" id="L91">            EmpExitFullFinalSettlementDetailsDTO detailsDTO = new EmpExitFullFinalSettlementDetailsDTO();</span>
<span class="nc" id="L92">            detailsDTO.setSettlementDetailsId(s.getSettlementDetailsId());</span>
<span class="nc" id="L93">            detailsDTO.setSettlementId(settlement.getId());</span>
<span class="nc" id="L94">            detailsDTO.setItem(s.getItem());</span>
<span class="nc" id="L95">            detailsDTO.setAmount(s.getAmount());</span>
<span class="nc" id="L96">            detailsDTO.setTransactionType(s.getTransactionType());</span>
<span class="nc" id="L97">            detailsDTO.setDate(s.getDate());</span>
<span class="nc" id="L98">            detailsDTO.setRemarks(s.getRemarks());</span>
<span class="nc" id="L99">            return detailsDTO;</span>
<span class="nc" id="L100">        }).collect(Collectors.toList());</span>
<span class="nc" id="L101">        dto.setSettlementDetailsDTOS(detailsDTOS);</span>
<span class="nc" id="L102">        return dto;</span>
    }

    @Transactional
    public EmpExitFullFinalSettlementDTO saveFnFDetails(EmpExitFullFinalSettlementDTO dto, MultipartFile file) {
        EmpExitFullFinalSettlement settlement;
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (dto.getId() != null) {</span>
<span class="nc" id="L109">            settlement = settlementRepo.findById(dto.getId()).orElse(new EmpExitFullFinalSettlement());</span>
        } else {
<span class="nc" id="L111">            settlement = new EmpExitFullFinalSettlement();</span>
        }
<span class="nc" id="L113">        settlement.setExitRequestId(dto.getExitRequestId());</span>
<span class="nc" id="L114">        double netPayable = settlement.getSettlementDetails().stream().map(EmpExitFullFinalSettlementDetails::getAmount)</span>
<span class="nc" id="L115">                .filter(Objects::nonNull).mapToDouble(Double::doubleValue).sum();</span>
<span class="nc" id="L116">        settlement.setNetAmount(netPayable);</span>
<span class="nc bnc" id="L117" title="All 4 branches missed.">        if (file != null &amp;&amp; !file.isEmpty()) {</span>
            String storeFile;
            try {
<span class="nc" id="L120">                storeFile = fileStorageService.storeFile(file, &quot;fnf_settlement&quot;);</span>
<span class="nc" id="L121">            } catch (IOException e) {</span>
<span class="nc" id="L122">                throw new RuntimeException(e);</span>
<span class="nc" id="L123">            }</span>
<span class="nc" id="L124">            settlement.setAttachment(storeFile);</span>
        }

<span class="nc" id="L127">        List&lt;EmpExitFullFinalSettlementDetails&gt; settlementDetails = dto.getSettlementDetailsDTOS().stream().map(s -&gt; {</span>
<span class="nc" id="L128">            EmpExitFullFinalSettlementDetails details = new EmpExitFullFinalSettlementDetails();</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">            if (s.getSettlementDetailsId() != null) {</span>
<span class="nc" id="L130">                details.setSettlementDetailsId(s.getSettlementDetailsId());</span>
            }
<span class="nc" id="L132">            details.setSettlement(settlement);</span>
<span class="nc" id="L133">            details.setItem(s.getItem());</span>
<span class="nc" id="L134">            details.setAmount(s.getAmount());</span>
<span class="nc" id="L135">            details.setDate(s.getDate());</span>
<span class="nc" id="L136">            details.setRemarks(s.getRemarks());</span>
<span class="nc" id="L137">            details.setTransactionType(s.getTransactionType());</span>
<span class="nc" id="L138">            return details;</span>
<span class="nc" id="L139">        }).collect(Collectors.toList());</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (settlement.getSettlementDetails() == null) {</span>
<span class="nc" id="L141">            settlement.setSettlementDetails(new ArrayList&lt;&gt;());</span>
        } else {
<span class="nc" id="L143">            settlement.getSettlementDetails().clear();</span>
        }
<span class="nc" id="L145">        settlement.getSettlementDetails().addAll(settlementDetails);</span>
<span class="nc" id="L146">        EmpExitFullFinalSettlement save = settlementRepo.save(settlement);</span>
<span class="nc" id="L147">        return modelMapper.map(save, EmpExitFullFinalSettlementDTO.class);</span>
    }

    @Transactional
    public EmpExitRequest approveFnFRequest(Integer exitRequestId) {
<span class="nc" id="L152">        EmpExitRequest empExitRequest = requestRepository.findById(exitRequestId).orElseThrow(() -&gt; new EntityNotFoundException(&quot;Request not found.&quot;));</span>
<span class="nc" id="L153">        boolean allApproved = Stream.of(</span>
<span class="nc" id="L154">                empExitRequest.getAssetClearanceStatus(),</span>
<span class="nc" id="L155">                empExitRequest.getFinanceClearanceStatus(),</span>
<span class="nc" id="L156">                empExitRequest.getKtHandoverStatus(),</span>
<span class="nc" id="L157">                empExitRequest.getAdminClearanceStatus(),</span>
<span class="nc" id="L158">                empExitRequest.getExitInterviewStatus()</span>
<span class="nc" id="L159">        ).allMatch(&quot;Approved&quot;::equalsIgnoreCase);</span>

<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (!allApproved) {</span>
<span class="nc" id="L162">            throw new IllegalArgumentException(&quot;Some clearances statuses are still pending/rejected&quot;);</span>
        }
<span class="nc" id="L164">        empExitRequest.setFullFinalStatus(&quot;Approved&quot;);</span>
<span class="nc" id="L165">        empExitRequest.setLastUpdatedBy(String.valueOf(SessionHolder.getUserLoginDetail().getUsername()));</span>
<span class="nc" id="L166">        empExitRequest.setLastUpdatedDate(Instant.now());</span>
<span class="nc" id="L167">        return requestRepository.save(empExitRequest);</span>
    }

    public Map&lt;String, Object&gt; downloadFile(Integer fnfId) throws IOException {
<span class="nc" id="L171">        EmpExitFullFinalSettlement settlement = settlementRepo.findById(fnfId).orElseThrow(() -&gt; new EntityNotFoundException(&quot;No record found for the given input&quot;));</span>
<span class="nc" id="L172">        String filePath = settlement.getAttachment();</span>
<span class="nc bnc" id="L173" title="All 4 branches missed.">        if (filePath == null || filePath.isBlank()) {</span>
<span class="nc" id="L174">            throw new IllegalArgumentException(&quot;No fnf file found for this record&quot;);</span>
        }
<span class="nc" id="L176">        Resource resource = fileStorageService.loadFile(filePath);</span>
<span class="nc bnc" id="L177" title="All 4 branches missed.">        if (!resource.exists() || !resource.isReadable()) {</span>
<span class="nc" id="L178">            throw new IOException(&quot;File not found or not readable: &quot; + filePath);</span>
        }
<span class="nc" id="L180">        String contentType = Files.probeContentType(Paths.get(filePath));</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (contentType == null) {</span>
<span class="nc" id="L182">            contentType = &quot;application/pdf&quot;;</span>
        }
<span class="nc" id="L184">        Map&lt;String, Object&gt; result = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L185">        result.put(&quot;resource&quot;, resource);</span>
<span class="nc" id="L186">        result.put(&quot;contentType&quot;, contentType);</span>
<span class="nc" id="L187">        return result;</span>
    }

    @Transactional
    public Map&lt;String, Object&gt; getAllFnfList(String sortBy, String sortDir, String searchField, String searchKeyword, Pageable pageable) {
<span class="nc" id="L192">        List&lt;EmpExitRequest&gt; empRequest = requestRepository.findAll();</span>

<span class="nc" id="L194">        List&lt;EmpExitFullFinalSettlementDTO&gt; dtoList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">        for (EmpExitRequest row : empRequest) {</span>
<span class="nc" id="L196">            EmpExitFullFinalSettlementDTO fnf = new EmpExitFullFinalSettlementDTO();</span>
<span class="nc" id="L197">            fnf.setExitRequestId(row.getId());</span>
<span class="nc" id="L198">            fnf.setEmployeeId(row.getEmployeeId());</span>
<span class="nc" id="L199">            Employee employee = employeeRepository.findByEmployeeId(row.getEmployeeId()).orElseThrow(() -&gt; new EntityNotFoundException(&quot;Employee not found.&quot;));</span>
<span class="nc" id="L200">            fnf.setExitRequestNumber(row.getExitRequestNumber());</span>
//            fnf.setStatus(row.getAssetClearanceStatus());
<span class="nc" id="L202">            fnf.setLastWorkingDate(row.getLastWorkingDate());</span>
<span class="nc" id="L203">            fnf.setEmployeeName(employee.getFullName()  + &quot; (&quot; + employee.getEmployeeNumber() + &quot;)&quot; );</span>
<span class="nc" id="L204">            fnf.setDepartmentName(employee.getDepartment().getDname());</span>
<span class="nc" id="L205">            dtoList.add(fnf);</span>
<span class="nc" id="L206">        }</span>

<span class="nc bnc" id="L208" title="All 8 branches missed.">        if (searchField != null &amp;&amp; searchKeyword != null &amp;&amp; !searchField.isBlank() &amp;&amp; !searchKeyword.isBlank()) {</span>
<span class="nc" id="L209">            dtoList = dtoList.stream().filter(dto -&gt; {</span>
                try {
<span class="nc" id="L211">                    Field field = EmpExitFullFinalSettlementDTO.class.getDeclaredField(searchField);</span>
<span class="nc" id="L212">                    field.setAccessible(true);</span>
<span class="nc" id="L213">                    Object fieldValue = field.get(dto);</span>
<span class="nc bnc" id="L214" title="All 4 branches missed.">                    return fieldValue != null &amp;&amp; fieldValue.toString().toLowerCase().contains(searchKeyword.toLowerCase());</span>
<span class="nc" id="L215">                } catch (NoSuchFieldException | IllegalAccessException e) {</span>
<span class="nc" id="L216">                    return false;</span>
                }
<span class="nc" id="L218">            }).collect(Collectors.toList());</span>
        }

<span class="nc bnc" id="L221" title="All 4 branches missed.">        if (sortBy != null &amp;&amp; !sortBy.isBlank()) {</span>
            try {
<span class="nc" id="L223">                Comparator&lt;EmpExitFullFinalSettlementDTO&gt; comparator = getEmpExitFullFinalSettlementDTOComparator(sortBy, sortDir);</span>

<span class="nc" id="L225">                dtoList.sort(comparator);</span>

<span class="nc" id="L227">            } catch (NoSuchFieldException e) {</span>
<span class="nc" id="L228">                System.out.println(&quot;Invalid sort field: {&quot; + sortBy + &quot;}&quot;);</span>
<span class="nc" id="L229">            }</span>
        }

<span class="nc" id="L232">        int totalItems = dtoList.size();</span>
<span class="nc" id="L233">        int currentPage = pageable.getPageNumber();</span>
<span class="nc" id="L234">        int pageSize = pageable.getPageSize();</span>
<span class="nc" id="L235">        int totalPages = (int) Math.ceil((double) totalItems / pageSize);</span>

<span class="nc" id="L237">        int startIndex = currentPage * pageSize;</span>
<span class="nc" id="L238">        int endIndex = Math.min(startIndex + pageSize, totalItems);</span>

        List&lt;EmpExitFullFinalSettlementDTO&gt; paginatedResult =
<span class="nc bnc" id="L241" title="All 2 branches missed.">                (startIndex &lt; totalItems) ? dtoList.subList(startIndex, endIndex) : Collections.emptyList();</span>

<span class="nc" id="L243">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L244">        response.put(&quot;result&quot;, paginatedResult);</span>
<span class="nc" id="L245">        response.put(&quot;currentPage&quot;, currentPage + 1);</span>
<span class="nc" id="L246">        response.put(&quot;pageSize&quot;, pageSize);</span>
<span class="nc" id="L247">        response.put(&quot;totalItems&quot;, totalItems);</span>
<span class="nc" id="L248">        response.put(&quot;totalPages&quot;, totalPages);</span>
<span class="nc" id="L249">        return response;</span>
    }

    private static Comparator&lt;EmpExitFullFinalSettlementDTO&gt; getEmpExitFullFinalSettlementDTOComparator(String sortBy, String sortDir) throws NoSuchFieldException {
<span class="nc" id="L253">        Field sortField = EmpExitFullFinalSettlementDTO.class.getDeclaredField(sortBy);</span>
<span class="nc" id="L254">        sortField.setAccessible(true);</span>

<span class="nc" id="L256">        Comparator&lt;EmpExitFullFinalSettlementDTO&gt; comparator = Comparator.comparing(dto -&gt; {</span>
            try {
<span class="nc" id="L258">                Object val = sortField.get(dto);</span>
<span class="nc" id="L259">                return (Comparable&lt;Object&gt;) val;</span>
<span class="nc" id="L260">            } catch (IllegalAccessException e) {</span>
<span class="nc" id="L261">                return null;</span>
            }
<span class="nc" id="L263">        }, Comparator.nullsLast(Comparator.naturalOrder()));</span>

<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (&quot;desc&quot;.equalsIgnoreCase(sortDir)) {</span>
<span class="nc" id="L266">            comparator = comparator.reversed();</span>
        }
<span class="nc" id="L268">        return comparator;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>
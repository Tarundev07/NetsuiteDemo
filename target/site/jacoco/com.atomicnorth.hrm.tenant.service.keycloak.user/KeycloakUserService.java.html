<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>KeycloakUserService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HR Management</a> &gt; <a href="index.source.html" class="el_package">com.atomicnorth.hrm.tenant.service.keycloak.user</a> &gt; <span class="el_source">KeycloakUserService.java</span></div><h1>KeycloakUserService.java</h1><pre class="source lang-java linenums">package com.atomicnorth.hrm.tenant.service.keycloak.user;

import com.atomicnorth.hrm.configuration.WebConfigurer;
import com.atomicnorth.hrm.tenant.domain.User;
import com.atomicnorth.hrm.tenant.repository.UserRepository;
import com.atomicnorth.hrm.tenant.service.UserService;
import com.atomicnorth.hrm.tenant.service.dto.keycloak.user.KeycloakUserRequestDTO;
import com.atomicnorth.hrm.tenant.service.dto.keycloak.user.KeycloakUserResponseDTO;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpHeaders;
import org.springframework.http.ResponseEntity;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.WebClientResponseException;
import reactor.core.publisher.Mono;

import java.lang.reflect.Field;
import java.util.Date;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class KeycloakUserService {

    private final WebClient webClient;
    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;

    private final UserService userService;
<span class="nc" id="L35">    private final Logger logger = LoggerFactory.getLogger(WebConfigurer.class);</span>


<span class="nc" id="L38">    public KeycloakUserService(WebClient.Builder webClientBuilder, UserRepository userRepository, PasswordEncoder passwordEncoder, UserService userService) {</span>
<span class="nc" id="L39">        this.webClient = webClientBuilder.baseUrl(&quot;http://103.16.222.73:809&quot;).build();</span>
<span class="nc" id="L40">        this.userRepository = userRepository;</span>
<span class="nc" id="L41">        this.passwordEncoder = passwordEncoder;</span>
<span class="nc" id="L42">        this.userService = userService;</span>
<span class="nc" id="L43">    }</span>


    public Mono&lt;List&lt;KeycloakUserResponseDTO&gt;&gt; getUsers(String realm, String accessToken) {
<span class="nc" id="L47">        String url = String.format(&quot;/admin/realms/%s/users&quot;, realm);</span>

<span class="nc" id="L49">        return webClient.get()</span>
<span class="nc" id="L50">                .uri(url)</span>
<span class="nc" id="L51">                .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L52">                .retrieve()</span>
<span class="nc" id="L53">                .bodyToFlux(KeycloakUserResponseDTO.class)</span>
<span class="nc" id="L54">                .collectList();</span>
    }


    public Mono&lt;List&lt;KeycloakUserResponseDTO&gt;&gt; getAllUsers(
            String realm, String accessToken, String searchColumn, String searchValue, String sortBy, String sortDir) {
<span class="nc" id="L60">        String url = String.format(&quot;/admin/realms/%s/users&quot;, realm);</span>

<span class="nc" id="L62">        return webClient.get()</span>
<span class="nc" id="L63">                .uri(url)</span>
<span class="nc" id="L64">                .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L65">                .retrieve()</span>
<span class="nc" id="L66">                .bodyToFlux(KeycloakUserResponseDTO.class)</span>
<span class="nc" id="L67">                .collectList()</span>
<span class="nc" id="L68">                .map(users -&gt; {</span>
                    // Filtering logic
<span class="nc bnc" id="L70" title="All 6 branches missed.">                    if (searchColumn != null &amp;&amp; searchValue != null &amp;&amp; !searchValue.isEmpty()) {</span>
<span class="nc" id="L71">                        users = users.stream()</span>
<span class="nc" id="L72">                                .filter(user -&gt; matchesSearchCriteria(user, searchColumn, searchValue))</span>
<span class="nc" id="L73">                                .collect(Collectors.toList());</span>
                    }

                    // Sorting logic
<span class="nc" id="L77">                    return users.stream()</span>
<span class="nc" id="L78">                            .sorted((u1, u2) -&gt; {</span>
                                try {
<span class="nc" id="L80">                                    Field field = KeycloakUserResponseDTO.class.getDeclaredField(sortBy);</span>
<span class="nc" id="L81">                                    field.setAccessible(true);</span>
<span class="nc" id="L82">                                    String value1 = String.valueOf(field.get(u1));</span>
<span class="nc" id="L83">                                    String value2 = String.valueOf(field.get(u2));</span>

<span class="nc bnc" id="L85" title="All 2 branches missed.">                                    return sortDir.equalsIgnoreCase(&quot;asc&quot;) ?</span>
<span class="nc" id="L86">                                            value1.compareToIgnoreCase(value2) :</span>
<span class="nc" id="L87">                                            value2.compareToIgnoreCase(value1);</span>
<span class="nc" id="L88">                                } catch (Exception e) {</span>
<span class="nc" id="L89">                                    return 0;</span>
                                }
                            })
<span class="nc" id="L92">                            .collect(Collectors.toList());</span>
                });
    }

    /*
     * Helper method to check if a user matches search criteria.
     */
    private boolean matchesSearchCriteria(KeycloakUserResponseDTO user, String searchColumn, String searchValue) {
<span class="nc bnc" id="L100" title="All 6 branches missed.">        switch (searchColumn.toLowerCase()) {</span>
            case &quot;id&quot;:
<span class="nc" id="L102">                return user.getId().equalsIgnoreCase(searchValue);</span>
            case &quot;username&quot;:
<span class="nc" id="L104">                return user.getUsername().toLowerCase().contains(searchValue.toLowerCase());</span>
            case &quot;email&quot;:
<span class="nc" id="L106">                return user.getEmail().toLowerCase().contains(searchValue.toLowerCase());</span>
            case &quot;firstname&quot;:
<span class="nc" id="L108">                return user.getFirstName().toLowerCase().contains(searchValue.toLowerCase());</span>
            case &quot;lastname&quot;:
<span class="nc" id="L110">                return user.getLastName().toLowerCase().contains(searchValue.toLowerCase());</span>
            default:
<span class="nc" id="L112">                return false;</span>
        }
    }


    @Transactional(rollbackFor = Exception.class)
    public String createUsers(String realm, KeycloakUserRequestDTO userRequest, String accessToken, boolean saveToDatabase) {
<span class="nc" id="L119">        String url = String.format(&quot;/admin/realms/%s/users&quot;, realm);</span>
<span class="nc" id="L120">        logger.info(&quot;Calling Keycloak API: {}&quot;, url);</span>

        try {
            //  Step 1: Keycloak Health Check
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (!isKeycloakUp(realm, accessToken)) {</span>
<span class="nc" id="L125">                throw new RuntimeException(&quot;Keycloak is down. Cannot create user.&quot;);</span>
            }

            //  Step 2: Create User in Keycloak
<span class="nc" id="L129">            ResponseEntity&lt;Void&gt; response = webClient.post()</span>
<span class="nc" id="L130">                    .uri(url)</span>
<span class="nc" id="L131">                    .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L132">                    .header(HttpHeaders.CONTENT_TYPE, &quot;application/json&quot;)</span>
<span class="nc" id="L133">                    .bodyValue(userRequest)</span>
<span class="nc" id="L134">                    .retrieve()</span>
<span class="nc" id="L135">                    .toBodilessEntity()</span>
<span class="nc" id="L136">                    .block();</span>

<span class="nc bnc" id="L138" title="All 2 branches missed.">            if (!response.getStatusCode().is2xxSuccessful()) {</span>
<span class="nc" id="L139">                throw new WebClientResponseException(response.getStatusCode().value(), &quot;Keycloak Error&quot;, null, null, null);</span>
            }

<span class="nc" id="L142">            logger.info(&quot;User created successfully in Keycloak&quot;);</span>

            //  Step 3: Fetch Keycloak User ID
<span class="nc" id="L145">            Thread.sleep(2000);</span>
<span class="nc" id="L146">            String keycloakId = getKeycloakUserIds(realm, userRequest.getUsername(), accessToken);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">            if (keycloakId == null) {</span>
<span class="nc" id="L148">                throw new RuntimeException(&quot;User created in Keycloak but failed to fetch Keycloak ID.&quot;);</span>
            }

            //  Step 4: Save User to Database (Only if Needed)
<span class="nc bnc" id="L152" title="All 2 branches missed.">            if (saveToDatabase) {</span>
<span class="nc" id="L153">                saveUserToDatabase(userRequest, keycloakId);</span>
            }

<span class="nc" id="L156">            return &quot;User created successfully in Keycloak and database&quot;;</span>
<span class="nc" id="L157">        } catch (WebClientResponseException e) {</span>
<span class="nc" id="L158">            logger.error(&quot;Keycloak API Error: {}&quot;, e.getMessage());</span>
<span class="nc" id="L159">            throw new RuntimeException(&quot;Failed to create user in Keycloak: &quot; + e.getMessage(), e);</span>
<span class="nc" id="L160">        } catch (InterruptedException e) {</span>
<span class="nc" id="L161">            Thread.currentThread().interrupt();</span>
<span class="nc" id="L162">            logger.error(&quot;Thread interrupted while waiting for Keycloak&quot;, e);</span>
<span class="nc" id="L163">            throw new RuntimeException(&quot;Thread interruption error&quot;, e);</span>
        }
    }

    private void saveUserToDatabase(KeycloakUserRequestDTO userRequest, String keycloakId) {
<span class="nc" id="L168">        User user = new User();</span>
<span class="nc" id="L169">        user.setEmail(userRequest.getEmail());</span>
<span class="nc" id="L170">        user.setDisplayName(userRequest.getFirstName() + &quot; &quot; + userRequest.getLastName());</span>
<span class="nc" id="L171">        user.setKeycloakId(keycloakId);</span>
<span class="nc" id="L172">        user.setKeycloakUserActivation(&quot;true&quot;); // Maintain activation status</span>
<span class="nc" id="L173">        user.setStartDate(new Date());</span>
<span class="nc" id="L174">        user.setEndDate(null);</span>
<span class="nc" id="L175">        user.setIsActive(&quot;Y&quot;);</span>
<span class="nc" id="L176">        user.setActivated(true);</span>

        //  Fix: Ensure Mobile Number Can Be Null
        // user.setMobileNumber(userRequest.getMobileNumber() != null ? userRequest.getMobileNumber() : null);

        //  Encrypt password before saving
<span class="nc bnc" id="L182" title="All 4 branches missed.">        if (userRequest.getCredentials() != null &amp;&amp; !userRequest.getCredentials().isEmpty()) {</span>
<span class="nc" id="L183">            user.setPassword(passwordEncoder.encode(userRequest.getCredentials().get(0).getValue()));</span>
        }

        //  Save user in the database
<span class="nc" id="L187">        userRepository.save(user);</span>
<span class="nc" id="L188">        logger.info(&quot;User saved successfully in the database with Keycloak ID: {}&quot;, keycloakId);</span>
<span class="nc" id="L189">    }</span>

    public boolean isKeycloakUp(String realm, String accessToken) {
<span class="nc" id="L192">        String healthCheckUrl = String.format(&quot;/admin/realms/%s&quot;, realm);</span>

        try {
<span class="nc" id="L195">            ResponseEntity&lt;Void&gt; response = webClient.get()</span>
<span class="nc" id="L196">                    .uri(healthCheckUrl)</span>
<span class="nc" id="L197">                    .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L198">                    .retrieve()</span>
<span class="nc" id="L199">                    .toBodilessEntity()</span>
<span class="nc" id="L200">                    .block();</span>

<span class="nc" id="L202">            return response.getStatusCode().is2xxSuccessful();</span>
<span class="nc" id="L203">        } catch (Exception e) {</span>
<span class="nc" id="L204">            logger.error(&quot;Keycloak health check failed: {}&quot;, e.getMessage());</span>
<span class="nc" id="L205">            return false;</span>
        }
    }

    private String getKeycloakUserIds(String realm, String username, String accessToken) {
<span class="nc" id="L210">        String url = String.format(&quot;/admin/realms/%s/users?username=%s&quot;, realm, username);</span>

        try {
<span class="nc" id="L213">            ResponseEntity&lt;String&gt; response = webClient.get()</span>
<span class="nc" id="L214">                    .uri(url)</span>
<span class="nc" id="L215">                    .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L216">                    .retrieve()</span>
<span class="nc" id="L217">                    .toEntity(String.class)</span>
<span class="nc" id="L218">                    .block();</span>

<span class="nc bnc" id="L220" title="All 2 branches missed.">            if (response.getStatusCode().is2xxSuccessful()) {</span>
<span class="nc" id="L221">                ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="nc" id="L222">                JsonNode jsonNode = objectMapper.readTree(response.getBody());</span>

<span class="nc bnc" id="L224" title="All 4 branches missed.">                if (jsonNode.isArray() &amp;&amp; jsonNode.size() &gt; 0) {</span>
<span class="nc" id="L225">                    return jsonNode.get(0).get(&quot;id&quot;).asText();</span>
                } else {
<span class="nc" id="L227">                    logger.error(&quot;Keycloak user list is empty. User might not have been created.&quot;);</span>
                }
            }
<span class="nc" id="L230">        } catch (Exception e) {</span>
<span class="nc" id="L231">            logger.error(&quot;Error fetching Keycloak user ID&quot;, e);</span>
<span class="nc" id="L232">        }</span>
<span class="nc" id="L233">        return null;</span>
    }


    @Transactional(rollbackFor = Exception.class)
    public String createUserAndUpdateLocalDB(String realm, KeycloakUserRequestDTO userRequest, String accessToken, Long localUserId) {
<span class="nc" id="L239">        String url = String.format(&quot;/admin/realms/%s/users&quot;, realm);</span>

        // Create user in Keycloak
<span class="nc" id="L242">        ResponseEntity&lt;Void&gt; response = webClient.post()</span>
<span class="nc" id="L243">                .uri(url)</span>
<span class="nc" id="L244">                .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L245">                .header(HttpHeaders.CONTENT_TYPE, &quot;application/json&quot;)</span>
<span class="nc" id="L246">                .bodyValue(userRequest)</span>
<span class="nc" id="L247">                .retrieve()</span>
<span class="nc" id="L248">                .toBodilessEntity()</span>
<span class="nc" id="L249">                .block();</span>

<span class="nc bnc" id="L251" title="All 2 branches missed.">        if (!response.getStatusCode().is2xxSuccessful()) {</span>
<span class="nc" id="L252">            throw new RuntimeException(&quot;Failed to create user in Keycloak&quot;);</span>
        }

        // Fetch Keycloak User ID
<span class="nc" id="L256">        String keycloakUserId = fetchKeycloakUserId(realm, userRequest.getUsername(), accessToken);</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (keycloakUserId == null) {</span>
<span class="nc" id="L258">            throw new RuntimeException(&quot;Failed to fetch Keycloak user ID&quot;);</span>
        }

        // Update local database
<span class="nc" id="L262">        User user = userRepository.findById(localUserId)</span>
<span class="nc" id="L263">                .orElseThrow(() -&gt; new RuntimeException(&quot;Local user not found&quot;));</span>
<span class="nc" id="L264">        user.setKeycloakId(keycloakUserId);</span>
<span class="nc" id="L265">        userRepository.save(user);</span>

        // Return Keycloak User ID
<span class="nc" id="L268">        return keycloakUserId;</span>
    }

    private String fetchKeycloakUserId(String realm, String username, String accessToken) {
<span class="nc" id="L272">        String url = String.format(&quot;/admin/realms/%s/users?username=%s&quot;, realm, username);</span>

<span class="nc" id="L274">        ResponseEntity&lt;String&gt; response = webClient.get()</span>
<span class="nc" id="L275">                .uri(url)</span>
<span class="nc" id="L276">                .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L277">                .retrieve()</span>
<span class="nc" id="L278">                .toEntity(String.class)</span>
<span class="nc" id="L279">                .block();</span>

        try {
<span class="nc" id="L282">            ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="nc" id="L283">            JsonNode jsonNode = objectMapper.readTree(response.getBody());</span>
<span class="nc bnc" id="L284" title="All 4 branches missed.">            if (jsonNode.isArray() &amp;&amp; jsonNode.size() &gt; 0) {</span>
<span class="nc" id="L285">                return jsonNode.get(0).get(&quot;id&quot;).asText();</span>
            }
<span class="nc" id="L287">        } catch (Exception e) {</span>
<span class="nc" id="L288">            throw new RuntimeException(&quot;Error parsing Keycloak response&quot;, e);</span>
<span class="nc" id="L289">        }</span>
<span class="nc" id="L290">        return null;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>
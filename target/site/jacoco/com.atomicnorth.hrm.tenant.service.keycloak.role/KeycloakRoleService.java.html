<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>KeycloakRoleService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HR Management</a> &gt; <a href="index.source.html" class="el_package">com.atomicnorth.hrm.tenant.service.keycloak.role</a> &gt; <span class="el_source">KeycloakRoleService.java</span></div><h1>KeycloakRoleService.java</h1><pre class="source lang-java linenums">package com.atomicnorth.hrm.tenant.service.keycloak.role;

import com.atomicnorth.hrm.configuration.WebConfigurer;
import com.atomicnorth.hrm.tenant.domain.roles.Role;
import com.atomicnorth.hrm.tenant.repository.roles.RoleRepository;
import com.atomicnorth.hrm.tenant.service.dto.keycloak.role.KeycloakRoleRequestDTO;
import com.atomicnorth.hrm.tenant.service.dto.keycloak.role.KeycloakRoleResponseDTO;
import com.atomicnorth.hrm.tenant.service.translation.SupraTranslationCommonServices;
import com.fasterxml.jackson.databind.JsonNode;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.WebClientResponseException;
import reactor.core.publisher.Mono;

import java.lang.reflect.Field;
import java.util.*;
import java.util.stream.Collectors;

@Service
<span class="nc" id="L30">@RequiredArgsConstructor</span>
<span class="nc" id="L31">@Slf4j</span>
public class KeycloakRoleService {

    private final WebClient webClient;
<span class="nc" id="L35">    private final Logger logger = LoggerFactory.getLogger(WebConfigurer.class);</span>
    @Autowired
    private SupraTranslationCommonServices supraTranslationCommonServices;
    @Autowired
    private RoleRepository roleRepository;


    @Autowired
<span class="nc" id="L43">    public KeycloakRoleService(WebClient.Builder webClientBuilder) {</span>
<span class="nc" id="L44">        this.webClient = webClientBuilder</span>
<span class="nc" id="L45">                .baseUrl(&quot;http://103.16.222.73:809&quot;)</span>
<span class="nc" id="L46">                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)</span>
<span class="nc" id="L47">                .build();</span>
<span class="nc" id="L48">    }</span>

    public String createRole(String realm, String clientId, KeycloakRoleRequestDTO roleRequest, String accessToken) {
<span class="nc" id="L51">        String url = String.format(&quot;/admin/realms/%s/clients/%s/roles&quot;, realm, clientId);</span>

<span class="nc" id="L53">        log.info(&quot;Calling Keycloak API: {}&quot;, &quot;http://103.16.222.73:809&quot; + url);</span>

        try {
<span class="nc" id="L56">            ResponseEntity&lt;String&gt; response = webClient.post()</span>
<span class="nc" id="L57">                    .uri(&quot;http://103.16.222.73:809&quot; + url)</span>
<span class="nc" id="L58">                    .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L59">                    .header(HttpHeaders.CONTENT_TYPE, &quot;application/json&quot;)</span>
<span class="nc" id="L60">                    .bodyValue(roleRequest)</span>
<span class="nc" id="L61">                    .retrieve()</span>
<span class="nc" id="L62">                    .toEntity(String.class)</span>
<span class="nc" id="L63">                    .block();</span>

<span class="nc" id="L65">            log.info(&quot;Keycloak API Response: {}&quot;, response);</span>

<span class="nc bnc" id="L67" title="All 4 branches missed.">            if (response != null &amp;&amp; response.getStatusCode().is2xxSuccessful()) {</span>
<span class="nc" id="L68">                return &quot;Role created successfully&quot;;</span>
<span class="nc bnc" id="L69" title="All 4 branches missed.">            } else if (response != null &amp;&amp; response.getStatusCode() == HttpStatus.CONFLICT) {</span>
<span class="nc" id="L70">                throw new WebClientResponseException(HttpStatus.CONFLICT.value(), &quot;Role already exists&quot;, null, null, null);</span>
            } else {
<span class="nc bnc" id="L72" title="All 2 branches missed.">                String errorBody = response != null ? response.getBody() : &quot;Unknown error&quot;;</span>
<span class="nc" id="L73">                throw new WebClientResponseException(</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">                        response != null ? response.getStatusCode().value() : 500,</span>
                        &quot;Keycloak Error&quot;,
                        null,
<span class="nc" id="L77">                        errorBody.getBytes(),</span>
                        null
                );
            }
<span class="nc" id="L81">        } catch (WebClientResponseException e) {</span>
<span class="nc" id="L82">            log.error(&quot;Keycloak API Error: {}&quot;, e.getMessage());</span>
<span class="nc" id="L83">            throw e;</span>
        }
    }

    public Mono&lt;List&lt;KeycloakRoleResponseDTO&gt;&gt; getAllRoles(
            String realm, String clientId, String accessToken, String searchColumn, String searchValue, String sortBy, String sortDir) {

<span class="nc" id="L90">        String url = String.format(&quot;/admin/realms/%s/clients/%s/roles&quot;, realm, clientId);</span>

<span class="nc" id="L92">        return webClient.get()</span>
<span class="nc" id="L93">                .uri(url)</span>
<span class="nc" id="L94">                .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L95">                .retrieve()</span>
<span class="nc" id="L96">                .bodyToFlux(KeycloakRoleResponseDTO.class)</span>
<span class="nc" id="L97">                .collectList()</span>
<span class="nc" id="L98">                .map(roles -&gt; {</span>
                    // Filtering logic
<span class="nc bnc" id="L100" title="All 6 branches missed.">                    if (searchColumn != null &amp;&amp; searchValue != null &amp;&amp; !searchValue.isEmpty()) {</span>
<span class="nc" id="L101">                        roles = roles.stream()</span>
<span class="nc" id="L102">                                .filter(role -&gt; matchesSearchCriteria(role, searchColumn, searchValue))</span>
<span class="nc" id="L103">                                .collect(Collectors.toList());</span>
                    }

                    // Sorting logic
<span class="nc" id="L107">                    return roles.stream()</span>
<span class="nc" id="L108">                            .sorted((r1, r2) -&gt; {</span>
                                try {
<span class="nc" id="L110">                                    Field field = KeycloakRoleResponseDTO.class.getDeclaredField(sortBy);</span>
<span class="nc" id="L111">                                    field.setAccessible(true);</span>
<span class="nc" id="L112">                                    String value1 = String.valueOf(field.get(r1));</span>
<span class="nc" id="L113">                                    String value2 = String.valueOf(field.get(r2));</span>

<span class="nc bnc" id="L115" title="All 2 branches missed.">                                    return sortDir.equalsIgnoreCase(&quot;asc&quot;) ?</span>
<span class="nc" id="L116">                                            value1.compareToIgnoreCase(value2) :</span>
<span class="nc" id="L117">                                            value2.compareToIgnoreCase(value1);</span>
<span class="nc" id="L118">                                } catch (Exception e) {</span>
<span class="nc" id="L119">                                    return 0;</span>
                                }
                            })
<span class="nc" id="L122">                            .collect(Collectors.toList());</span>
                });
    }


    private boolean matchesSearchCriteria(KeycloakRoleResponseDTO role, String searchColumn, String searchValue) {
<span class="nc bnc" id="L128" title="All 7 branches missed.">        switch (searchColumn.toLowerCase()) {</span>
            case &quot;id&quot;:
<span class="nc" id="L130">                return role.getId().equalsIgnoreCase(searchValue);</span>
            case &quot;name&quot;:
<span class="nc" id="L132">                return role.getName().toLowerCase().contains(searchValue.toLowerCase());</span>
            case &quot;description&quot;:
<span class="nc bnc" id="L134" title="All 4 branches missed.">                return role.getDescription() != null &amp;&amp; role.getDescription().toLowerCase().contains(searchValue.toLowerCase());</span>
            case &quot;composite&quot;:
<span class="nc" id="L136">                return Boolean.toString(role.isComposite()).equalsIgnoreCase(searchValue);</span>
            case &quot;clientrole&quot;:
<span class="nc" id="L138">                return Boolean.toString(role.isClientRole()).equalsIgnoreCase(searchValue);</span>
            case &quot;containerid&quot;:
<span class="nc" id="L140">                return role.getContainerId().equalsIgnoreCase(searchValue);</span>
            default:
<span class="nc" id="L142">                return false;</span>
        }
    }


    /*TEST */


    @Transactional(rollbackFor = Exception.class) //  Full rollback if Keycloak or DB fails
    public String createRealmRoleTest(String realm, KeycloakRoleRequestDTO roleRequest, String accessToken) {
<span class="nc" id="L152">        String keycloakUrl = String.format(&quot;http://103.16.222.73:809/admin/realms/%s/roles&quot;, realm);</span>
<span class="nc" id="L153">        log.info(&quot;Calling Keycloak API: {}&quot;, keycloakUrl);</span>

        try {
<span class="nc" id="L156">            ResponseEntity&lt;String&gt; response = webClient.post()</span>
<span class="nc" id="L157">                    .uri(keycloakUrl)</span>
<span class="nc" id="L158">                    .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L159">                    .header(HttpHeaders.CONTENT_TYPE, &quot;application/json&quot;)</span>
<span class="nc" id="L160">                    .bodyValue(roleRequest)</span>
<span class="nc" id="L161">                    .retrieve()</span>
<span class="nc" id="L162">                    .toEntity(String.class)</span>
<span class="nc" id="L163">                    .block();</span>

<span class="nc bnc" id="L165" title="All 4 branches missed.">            if (response != null &amp;&amp; response.getStatusCode().is2xxSuccessful()) {</span>
                //  Step 1: Fetch Role ID from Keycloak
<span class="nc" id="L167">                String roleId = fetchRoleIdFromKeycloak(realm, roleRequest.getName(), accessToken);</span>

                //  Step 2: Generate Clean &amp; Unique Codes
<span class="nc" id="L170">                String baseRoleName = roleRequest.getName().trim().replaceAll(&quot;\\s+&quot;, &quot;_&quot;).toUpperCase();</span>
<span class="nc" id="L171">                String shortUUID = UUID.randomUUID().toString().substring(0, 8).toUpperCase(); // Short Unique Key</span>
<span class="nc" id="L172">                String generatedCode = baseRoleName + &quot;_SSO_&quot; + shortUUID;</span>
<span class="nc" id="L173">                String generatedDescriptionCode = baseRoleName + &quot;_DESC_&quot; + shortUUID;</span>

                //  Step 3: Save Role in DB
<span class="nc" id="L176">                Role role = new Role();</span>
<span class="nc" id="L177">                role.setRoleCode(baseRoleName);</span>
<span class="nc" id="L178">                role.setRoleNameCode(generatedCode);</span>
<span class="nc" id="L179">                role.setRoleDescriptionCode(generatedDescriptionCode);</span>
<span class="nc" id="L180">                role.setSso_role_unique_key(roleId);</span>
<span class="nc" id="L181">                role.setSso_role_activation(&quot;ACTIVE&quot;);</span>
<span class="nc" id="L182">                role.setCreatedBy(&quot;System&quot;);</span>
<span class="nc" id="L183">                role.setCreationDate(new Date());</span>

                //  Step 4: Insert Translation Data
<span class="nc" id="L186">                Map&lt;String, String&gt; translationDataMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L187">                translationDataMap.put(generatedCode, roleRequest.getName().trim());</span>
<span class="nc" id="L188">                translationDataMap.put(generatedDescriptionCode, roleRequest.getDescription().trim());</span>

<span class="nc" id="L190">                boolean translationSuccess = supraTranslationCommonServices.saveTranslationData(translationDataMap);</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">                if (!translationSuccess) {</span>
<span class="nc" id="L192">                    throw new RuntimeException(&quot;Translation failed&quot;);</span>
                }

<span class="nc" id="L195">                log.info(&quot;Saving role to database: {}&quot;, role);</span>
<span class="nc" id="L196">                Role savedRole = roleRepository.save(role);</span>

<span class="nc bnc" id="L198" title="All 2 branches missed.">                if (savedRole.getRoleId() == null) {</span>
<span class="nc" id="L199">                    throw new RuntimeException(&quot;Failed to save role in the database.&quot;);</span>
                }

<span class="nc" id="L202">                return &quot;Role created successfully in Keycloak and stored in DB.&quot;;</span>
<span class="nc bnc" id="L203" title="All 4 branches missed.">            } else if (response != null &amp;&amp; response.getStatusCode() == HttpStatus.CONFLICT) {</span>
<span class="nc" id="L204">                throw new WebClientResponseException(HttpStatus.CONFLICT.value(), &quot;Role already exists&quot;, null, null, null);</span>
            } else {
<span class="nc" id="L206">                throw new WebClientResponseException(</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">                        response != null ? response.getStatusCode().value() : 500,</span>
                        &quot;Keycloak Error&quot;,
                        null,
<span class="nc bnc" id="L210" title="All 2 branches missed.">                        response != null ? response.getBody().getBytes() : new byte[0],</span>
                        null
                );
            }
<span class="nc" id="L214">        } catch (WebClientResponseException e) {</span>
<span class="nc" id="L215">            log.error(&quot;Keycloak API Error: {}&quot;, e.getMessage());</span>
<span class="nc" id="L216">            throw e;</span>
<span class="nc" id="L217">        } catch (Exception e) {</span>
<span class="nc" id="L218">            log.error(&quot;Unexpected Error: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L219">            throw new RuntimeException(&quot;Error creating role: &quot; + e.getMessage());</span>
        }
    }


    //  Fetch Role ID from Keycloak
    private String fetchRoleIdFromKeycloak(String realm, String roleName, String accessToken) {
<span class="nc" id="L226">        String roleUrl = String.format(&quot;http://103.16.222.73:809/admin/realms/%s/roles/%s&quot;, realm, roleName);</span>

<span class="nc" id="L228">        ResponseEntity&lt;JsonNode&gt; response = webClient.get()</span>
<span class="nc" id="L229">                .uri(roleUrl)</span>
<span class="nc" id="L230">                .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L231">                .retrieve()</span>
<span class="nc" id="L232">                .toEntity(JsonNode.class)</span>
<span class="nc" id="L233">                .block();</span>

<span class="nc bnc" id="L235" title="All 6 branches missed.">        if (response != null &amp;&amp; response.getStatusCode().is2xxSuccessful() &amp;&amp; response.getBody() != null) {</span>
<span class="nc" id="L236">            return response.getBody().get(&quot;id&quot;).asText();</span>
        }

<span class="nc" id="L239">        throw new WebClientResponseException(HttpStatus.NOT_FOUND.value(), &quot;Role ID not found in Keycloak&quot;, null, null, null);</span>
    }


    @Transactional(rollbackFor = Exception.class)
    public String createRoleInKeycloak(String realm, String clientId, KeycloakRoleRequestDTO roleRequest, String accessToken, boolean saveToDatabase) {
<span class="nc" id="L245">        String keycloakUrl = String.format(&quot;http://103.16.222.73:809/admin/realms/%s/clients/%s/roles&quot;, realm, clientId);</span>

        //  First, check if Keycloak's Create Role API is UP
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (!isKeycloakServiceAvailableForCreteRole(realm, clientId, accessToken)) {</span>
<span class="nc" id="L249">            return &quot;Keycloak Create Role service is DOWN. Please try again later.&quot;;</span>
        }

        //  Call Keycloak API to Create Role
<span class="nc" id="L253">        ResponseEntity&lt;String&gt; response = webClient.post()</span>
<span class="nc" id="L254">                .uri(keycloakUrl)</span>
<span class="nc" id="L255">                .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L256">                .header(HttpHeaders.CONTENT_TYPE, &quot;application/json&quot;)</span>
<span class="nc" id="L257">                .bodyValue(roleRequest)</span>
<span class="nc" id="L258">                .retrieve()</span>
<span class="nc" id="L259">                .toEntity(String.class)</span>
<span class="nc" id="L260">                .block();</span>

<span class="nc bnc" id="L262" title="All 4 branches missed.">        if (response == null || !response.getStatusCode().is2xxSuccessful()) {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">            throw new RuntimeException(&quot;Failed to create role in Keycloak. Response: &quot; + (response != null ? response.getBody() : &quot;No response&quot;));</span>
        }

        //  Fetch Role ID from Keycloak
<span class="nc" id="L267">        String roleId = fetchRoleIdFromKeycloak(realm, clientId, roleRequest.getName(), accessToken);</span>

        //  If saveToDatabase = true, store role locally
<span class="nc bnc" id="L270" title="All 2 branches missed.">        if (saveToDatabase) {</span>
<span class="nc" id="L271">            String baseRoleName = roleRequest.getName().trim().replaceAll(&quot;\\s+&quot;, &quot;_&quot;).toUpperCase();</span>
<span class="nc" id="L272">            String shortUUID = UUID.randomUUID().toString().substring(0, 8).toUpperCase();</span>
<span class="nc" id="L273">            String generatedCode = baseRoleName + &quot;_SSO_&quot; + shortUUID;</span>
<span class="nc" id="L274">            String generatedDescriptionCode = baseRoleName + &quot;_DESC_&quot; + shortUUID;</span>

<span class="nc" id="L276">            Role role = new Role();</span>
<span class="nc" id="L277">            role.setRoleCode(baseRoleName);</span>
<span class="nc" id="L278">            role.setRoleNameCode(generatedCode);</span>
<span class="nc" id="L279">            role.setRoleDescriptionCode(generatedDescriptionCode);</span>
<span class="nc" id="L280">            role.setSso_role_unique_key(roleId);</span>
<span class="nc" id="L281">            role.setSso_role_activation(&quot;ACTIVE&quot;);</span>
<span class="nc" id="L282">            role.setCreatedBy(&quot;System&quot;);</span>
<span class="nc" id="L283">            role.setCreationDate(new Date());</span>

            //  Save translations
<span class="nc" id="L286">            Map&lt;String, String&gt; translationDataMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L287">            translationDataMap.put(generatedCode, roleRequest.getName().trim());</span>
<span class="nc" id="L288">            translationDataMap.put(generatedDescriptionCode, roleRequest.getDescription().trim());</span>

<span class="nc" id="L290">            boolean translationSuccess = supraTranslationCommonServices.saveTranslationData(translationDataMap);</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">            if (!translationSuccess) {</span>
<span class="nc" id="L292">                throw new RuntimeException(&quot;Translation failed&quot;);</span>
            }

            //  Save Role in DB
<span class="nc" id="L296">            Role savedRole = roleRepository.save(role);</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">            if (savedRole.getRoleId() == null) {</span>
<span class="nc" id="L298">                throw new RuntimeException(&quot;Failed to save role in database.&quot;);</span>
            }
        }

<span class="nc bnc" id="L302" title="All 2 branches missed.">        return &quot;Role created successfully in Keycloak&quot; + (saveToDatabase ? &quot; and stored in DB.&quot; : &quot;.&quot;);</span>
    }


    private String fetchRoleIdFromKeycloak(String realm, String clientId, String roleName, String accessToken) {
<span class="nc" id="L307">        String roleUrl = String.format(&quot;http://103.16.222.73:809/admin/realms/%s/clients/%s/roles/%s&quot;, realm, clientId, roleName);</span>

<span class="nc" id="L309">        ResponseEntity&lt;JsonNode&gt; response = webClient.get()</span>
<span class="nc" id="L310">                .uri(roleUrl)</span>
<span class="nc" id="L311">                .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L312">                .retrieve()</span>
<span class="nc" id="L313">                .toEntity(JsonNode.class)</span>
<span class="nc" id="L314">                .block();</span>

<span class="nc bnc" id="L316" title="All 6 branches missed.">        if (response != null &amp;&amp; response.getStatusCode().is2xxSuccessful() &amp;&amp; response.getBody() != null) {</span>
<span class="nc" id="L317">            return response.getBody().get(&quot;id&quot;).asText();</span>
        }

<span class="nc" id="L320">        throw new WebClientResponseException(HttpStatus.NOT_FOUND.value(), &quot;Role ID not found in Keycloak&quot;, null, null, null);</span>
    }

    public boolean isKeycloakServiceAvailableForCreteRole(String realm, String clientId, String accessToken) {
<span class="nc" id="L324">        String keycloakUrl = String.format(&quot;http://103.16.222.73:809/admin/realms/%s/clients/%s/roles&quot;, realm, clientId);</span>

        //  Ensure the token has &quot;Bearer &quot; prefix
<span class="nc bnc" id="L327" title="All 2 branches missed.">        if (!accessToken.startsWith(&quot;Bearer &quot;)) {</span>
<span class="nc" id="L328">            accessToken = &quot;Bearer &quot; + accessToken;</span>
        }

        try {
<span class="nc" id="L332">            ResponseEntity&lt;String&gt; response = webClient.get()</span>
<span class="nc" id="L333">                    .uri(keycloakUrl)</span>
<span class="nc" id="L334">                    .header(HttpHeaders.AUTHORIZATION, accessToken) //  Ensure token is set</span>
<span class="nc" id="L335">                    .retrieve()</span>
<span class="nc" id="L336">                    .toEntity(String.class)</span>
<span class="nc" id="L337">                    .block();</span>

            //  If response is 200, service is UP
<span class="nc bnc" id="L340" title="All 4 branches missed.">            return response != null &amp;&amp; response.getStatusCode().is2xxSuccessful();</span>
<span class="nc" id="L341">        } catch (WebClientResponseException ex) {</span>
<span class="nc" id="L342">            System.out.println(&quot;Keycloak Service Down: &quot; + ex.getMessage());</span>
<span class="nc" id="L343">            return false; //  Service is down or unauthorized</span>
<span class="nc" id="L344">        } catch (Exception e) {</span>
<span class="nc" id="L345">            System.out.println(&quot;Unexpected Error Checking Keycloak Service: &quot; + e.getMessage());</span>
<span class="nc" id="L346">            return false; //  Unexpected error</span>
        }
    }


    /*test*/

    @Transactional(rollbackFor = Exception.class)
    public String createRoleTest(String realm, String clientId, KeycloakRoleRequestDTO roleRequest, String accessToken, boolean saveToDatabase, Long localRoleId) {
<span class="nc" id="L355">        String keycloakUrl = String.format(&quot;http://103.16.222.73:809/admin/realms/%s/clients/%s/roles&quot;, realm, clientId);</span>

        // Step 1: Call Keycloak API to Create Role
<span class="nc" id="L358">        ResponseEntity&lt;String&gt; response = webClient.post()</span>
<span class="nc" id="L359">                .uri(keycloakUrl)</span>
<span class="nc" id="L360">                .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L361">                .header(HttpHeaders.CONTENT_TYPE, &quot;application/json&quot;)</span>
<span class="nc" id="L362">                .bodyValue(roleRequest)</span>
<span class="nc" id="L363">                .retrieve()</span>
<span class="nc" id="L364">                .toEntity(String.class)</span>
<span class="nc" id="L365">                .block();</span>

<span class="nc bnc" id="L367" title="All 4 branches missed.">        if (response == null || !response.getStatusCode().is2xxSuccessful()) {</span>
<span class="nc" id="L368">            throw new RuntimeException(&quot;Failed to create role in Keycloak.&quot;);</span>
        }

        // Step 2: Fetch Keycloak Role ID
<span class="nc" id="L372">        String keycloakRoleId = fetchRoleIdFromKeycloaks(realm, clientId, roleRequest.getName(), accessToken);</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">        if (keycloakRoleId == null) {</span>
<span class="nc" id="L374">            throw new RuntimeException(&quot;Role created in Keycloak but failed to fetch Role ID.&quot;);</span>
        }

        // Step 3: Update Local Database if needed
<span class="nc bnc" id="L378" title="All 4 branches missed.">        if (saveToDatabase &amp;&amp; localRoleId != null) {</span>
<span class="nc" id="L379">            Long localRoleId1 = localRoleId;</span>
<span class="nc" id="L380">            Optional&lt;Role&gt; roleOptional = roleRepository.findById(Math.toIntExact(localRoleId1));</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">            if (roleOptional.isPresent()) {</span>
<span class="nc" id="L382">                Role role = roleOptional.get();</span>
<span class="nc" id="L383">                role.setSso_role_unique_key(keycloakRoleId);</span>
<span class="nc" id="L384">                roleRepository.save(role);</span>
<span class="nc" id="L385">                return &quot;Role created in Keycloak and local DB updated.&quot;;</span>
            } else {
<span class="nc" id="L387">                throw new RuntimeException(&quot;Local Role ID not found in database.&quot;);</span>
            }
        }

<span class="nc" id="L391">        return &quot;Role created successfully in Keycloak.&quot;;</span>
    }

    private String fetchRoleIdFromKeycloaks(String realm, String clientId, String roleName, String accessToken) {
<span class="nc" id="L395">        String roleUrl = String.format(&quot;http://103.16.222.73:809/admin/realms/%s/clients/%s/roles/%s&quot;, realm, clientId, roleName);</span>

<span class="nc" id="L397">        ResponseEntity&lt;JsonNode&gt; response = webClient.get()</span>
<span class="nc" id="L398">                .uri(roleUrl)</span>
<span class="nc" id="L399">                .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L400">                .retrieve()</span>
<span class="nc" id="L401">                .toEntity(JsonNode.class)</span>
<span class="nc" id="L402">                .block();</span>

<span class="nc bnc" id="L404" title="All 6 branches missed.">        if (response != null &amp;&amp; response.getStatusCode().is2xxSuccessful() &amp;&amp; response.getBody() != null) {</span>
<span class="nc" id="L405">            return response.getBody().get(&quot;id&quot;).asText();</span>
        }

<span class="nc" id="L408">        throw new RuntimeException(&quot;Role ID not found in Keycloak.&quot;);</span>
    }

    public boolean isKeycloakServiceAvailable(String realm, String clientId, String accessToken) {
<span class="nc" id="L412">        String keycloakUrl = String.format(&quot;http://103.16.222.73:809/admin/realms/%s/clients/%s/roles&quot;, realm, clientId);</span>

        try {
<span class="nc" id="L415">            ResponseEntity&lt;String&gt; response = webClient.get()</span>
<span class="nc" id="L416">                    .uri(keycloakUrl)</span>
<span class="nc" id="L417">                    .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + accessToken)</span>
<span class="nc" id="L418">                    .retrieve()</span>
<span class="nc" id="L419">                    .toEntity(String.class)</span>
<span class="nc" id="L420">                    .block();</span>

<span class="nc bnc" id="L422" title="All 4 branches missed.">            return response != null &amp;&amp; response.getStatusCode().is2xxSuccessful();</span>
<span class="nc" id="L423">        } catch (Exception e) {</span>
<span class="nc" id="L424">            return false;</span>
        }
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>
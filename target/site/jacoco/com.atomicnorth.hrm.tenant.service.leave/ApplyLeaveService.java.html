<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApplyLeaveService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HR Management</a> &gt; <a href="index.source.html" class="el_package">com.atomicnorth.hrm.tenant.service.leave</a> &gt; <span class="el_source">ApplyLeaveService.java</span></div><h1>ApplyLeaveService.java</h1><pre class="source lang-java linenums">package com.atomicnorth.hrm.tenant.service.leave;

import com.atomicnorth.hrm.tenant.domain.Employee;
import com.atomicnorth.hrm.tenant.domain.LeaveAllocation;
import com.atomicnorth.hrm.tenant.domain.LeaveAllocationDetails;
import com.atomicnorth.hrm.tenant.domain.LeaveRequest;
import com.atomicnorth.hrm.tenant.domain.attendance.SupraShiftDetailEntity;
import com.atomicnorth.hrm.tenant.domain.branch.LeaveTypes;
import com.atomicnorth.hrm.tenant.domain.holiday.HolidaysCalendarDay;
import com.atomicnorth.hrm.tenant.domain.leave.LeaveLedgerEntity;
import com.atomicnorth.hrm.tenant.helper.Constant;
import com.atomicnorth.hrm.tenant.helper.SessionHolder;
import com.atomicnorth.hrm.tenant.repository.EmployeeRepository;
import com.atomicnorth.hrm.tenant.repository.LeaveAllocationRepository;
import com.atomicnorth.hrm.tenant.repository.LeaveRequestRepository;
import com.atomicnorth.hrm.tenant.repository.LeaveTypeRepository;
import com.atomicnorth.hrm.tenant.repository.leave.LeaveLedgerRepository;
import com.atomicnorth.hrm.tenant.service.EmployeeService;
import com.atomicnorth.hrm.tenant.service.SequenceGeneratorService;
import com.atomicnorth.hrm.tenant.service.approvalflow.ApprovalFlowService;
import com.atomicnorth.hrm.tenant.service.attendance.ShiftAssignmentsServices;
import com.atomicnorth.hrm.tenant.service.dto.leave.LeaveLedgerDTO;
import com.atomicnorth.hrm.tenant.service.dto.leave.LeaveRequestDTO;
import com.atomicnorth.hrm.tenant.service.project.ProjectService;
import com.atomicnorth.hrm.tenant.service.roles.RoleAndPermissionsService;
import com.atomicnorth.hrm.util.Enum.SequenceType;
import lombok.AllArgsConstructor;
import org.modelmapper.ModelMapper;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

import javax.persistence.EntityNotFoundException;
import java.time.Instant;
import java.time.LocalDate;
import java.time.ZoneId;
import java.time.temporal.ChronoUnit;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.stream.Collectors;

@Service
<span class="nc" id="L51">@AllArgsConstructor</span>
public class ApplyLeaveService {

    private final LeaveRequestRepository leaveRequestRepository;
    private final LeaveAllocationRepository allocationRepository;
    private final ModelMapper modelMapper;
    private final ProjectService projectService;
    private final EmployeeService employeeService;
    private final ShiftAssignmentsServices shiftAssignmentsServices;
    private final LeaveTypeRepository leaveTypeRepository;
    private final LeaveLedgerRepository ledgerRepository;
    private final EmployeeRepository employeeRepository;
    private final SequenceGeneratorService sequenceGeneratorService;
    private final ApprovalFlowService approvalFlowService;
    private final RoleAndPermissionsService roleAndPermissionsService;

    public String getRequestNumber(Integer empId) {
<span class="nc" id="L68">        return sequenceGeneratorService.previewNewRequest(SequenceType.LEAVE.toString(), null);</span>
    }

    @Transactional
    public LeaveRequest applyLeave(LeaveRequestDTO dto) {
<span class="nc" id="L73">        Integer empId = getOrSetEmployeeId(dto);</span>
<span class="nc" id="L74">        validateRequestNumberUniqueness(dto.getRequestNumber());</span>
<span class="nc" id="L75">        validateDateRange(dto.getStartDate(), dto.getEndDate());</span>
<span class="nc" id="L76">        validateOverlappingLeaves(dto);</span>

<span class="nc" id="L78">        LeaveAllocation allocation = getActiveAllocation(empId, dto.getLeaveCode());</span>
<span class="nc" id="L79">        LeaveAllocationDetails details = getValidLeaveDetails(allocation, dto.getLeaveCode());</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (details.getEffectiveEndDate() != null) {</span>
<span class="nc" id="L81">            LocalDate effectiveEndDate = ((java.sql.Date) details.getEffectiveEndDate()).toLocalDate();</span>
<span class="nc bnc" id="L82" title="All 4 branches missed.">            if (effectiveEndDate != null &amp;&amp; dto.getEndDate().isAfter(effectiveEndDate)) {</span>
<span class="nc" id="L83">                throw new IllegalArgumentException(&quot;Leave cannot be applied beyond its validity period (expires on: &quot; + effectiveEndDate + &quot;).&quot;);</span>
            }
        }

<span class="nc" id="L87">        Date from = Date.from(dto.getStartDate().atStartOfDay(ZoneId.systemDefault()).toInstant());</span>
<span class="nc" id="L88">        Date to = Date.from(dto.getEndDate().atStartOfDay(ZoneId.systemDefault()).toInstant());</span>
<span class="nc" id="L89">        Map&lt;LocalDate, HolidaysCalendarDay&gt; holidayList = projectService.getHolidayList(empId, from, to);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (holidayList == null) {</span>
<span class="nc" id="L91">            holidayList = employeeService.getHolidayList(empId);</span>
        }

<span class="nc" id="L94">        Map&lt;String, SupraShiftDetailEntity&gt; weekOffList = shiftAssignmentsServices.getWeekOffList(empId, from, to);</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (weekOffList.isEmpty()) {</span>
<span class="nc" id="L96">            weekOffList = shiftAssignmentsServices.getDefaultWeekOffs();</span>
        }
<span class="nc" id="L98">        List&lt;LocalDate&gt; appliedDates = getLeaveAppliedDates(dto.getStartDate(), dto.getEndDate());</span>

<span class="nc" id="L100">        boolean isLwp = &quot;LWP&quot;.equalsIgnoreCase(dto.getLeaveCode());</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (!isLwp) {</span>
<span class="nc" id="L102">            validateRHLeave(dto, holidayList);</span>
<span class="nc" id="L103">            validateAgainstRHLeaveForOthers(dto, appliedDates, holidayList);</span>
<span class="nc" id="L104">            validateAgainstMHAndWeekOffs(appliedDates, holidayList, weekOffList);</span>
        }

<span class="nc" id="L107">        validateLeaveOptions(dto.getStartDate(), dto.getEndDate(), dto.getStartOption(), dto.getEndOption());</span>

<span class="nc" id="L109">        double daysRequested = calculateDaysRequested(dto.getStartDate(), dto.getEndDate(), dto.getStartOption(), dto.getEndOption());</span>

<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (details.getLeaveBalance() &lt; daysRequested) {</span>
<span class="nc" id="L112">            throw new IllegalArgumentException(&quot;Insufficient leave balance. Required: &quot; + daysRequested +</span>
<span class="nc" id="L113">                    &quot;, Available: &quot; + details.getLeaveBalance());</span>
        }

<span class="nc" id="L116">        deductLeaveBalance(details, daysRequested);</span>
<span class="nc" id="L117">        LeaveRequest saved = saveLeaveRequest(dto, daysRequested);</span>
<span class="nc" id="L118">        insertIntoLedgerTbl(saved, daysRequested);</span>
<span class="nc" id="L119">        allocationRepository.save(allocation);</span>
<span class="nc" id="L120">        sequenceGeneratorService.generateSequenceWithYear(SequenceType.LEAVE.toString(), null);</span>
<span class="nc" id="L121">        int functionId = roleAndPermissionsService.fetchFunctionId(Constant.FUNCTION_LEAVE_APPROVAL);</span>
<span class="nc" id="L122">        approvalFlowService.addRequest(functionId, empId, saved.getRequestNumber());</span>
<span class="nc" id="L123">        return saved;</span>
    }

    private Integer getOrSetEmployeeId(LeaveRequestDTO dto) {
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (dto.getEmpId() == null) {</span>
<span class="nc" id="L128">            dto.setEmpId(SessionHolder.getUserLoginDetail().getEmpId());</span>
        }
<span class="nc" id="L130">        return dto.getEmpId();</span>
    }

    private void validateRequestNumberUniqueness(String requestNumber) {
<span class="nc bnc" id="L134" title="All 4 branches missed.">        if (requestNumber != null &amp;&amp; leaveRequestRepository.existsByRequestNumber(requestNumber)) {</span>
<span class="nc" id="L135">            throw new IllegalArgumentException(&quot;Leave request number must be unique. This number already exists.&quot;);</span>
        }
<span class="nc" id="L137">    }</span>

    private void validateDateRange(LocalDate startDate, LocalDate endDate) {
<span class="nc bnc" id="L140" title="All 4 branches missed.">        if (startDate == null || endDate == null) {</span>
<span class="nc" id="L141">            throw new IllegalArgumentException(&quot;Start date and end date must not be null.&quot;);</span>
        }
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (startDate.isAfter(endDate)) {</span>
<span class="nc" id="L144">            throw new IllegalArgumentException(&quot;Start date must be before or equal to end date.&quot;);</span>
        }
<span class="nc" id="L146">    }</span>


    private void validateOverlappingLeaves(LeaveRequestDTO dto) {
<span class="nc" id="L150">        List&lt;LeaveRequest&gt; existingLeaves = leaveRequestRepository.findByEmpIdAndStatusIn(</span>
<span class="nc" id="L151">                dto.getEmpId(), List.of(&quot;PENDING&quot;, &quot;APPROVED&quot;));</span>

<span class="nc" id="L153">        Set&lt;String&gt; requestedSlots = expandLeaveIntoDateSlots(dto.getStartDate(), dto.getEndDate(), dto.getStartOption(), dto.getEndOption());</span>

<span class="nc bnc" id="L155" title="All 2 branches missed.">        for (LeaveRequest existing : existingLeaves) {</span>
<span class="nc" id="L156">            Set&lt;String&gt; existingSlots = expandLeaveIntoDateSlots(existing.getStartDate(), existing.getEndDate(), existing.getStartOption(), existing.getEndOption());</span>

<span class="nc bnc" id="L158" title="All 2 branches missed.">            for (String slot : requestedSlots) {</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">                if (existingSlots.contains(slot)) {</span>
<span class="nc" id="L160">                    throw new IllegalArgumentException(&quot;Leave already applied for overlapping date or slot: &quot; + slot);</span>
                }
<span class="nc" id="L162">            }</span>
<span class="nc" id="L163">        }</span>
<span class="nc" id="L164">    }</span>

    private Set&lt;String&gt; expandLeaveIntoDateSlots(LocalDate startDate, LocalDate endDate, String startOption, String endOption) {
<span class="nc" id="L167">        Set&lt;String&gt; slots = new HashSet&lt;&gt;();</span>

<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (startDate.equals(endDate)) {</span>
<span class="nc bnc" id="L170" title="All 4 branches missed.">            if (startOption.equals(&quot;FD&quot;) || endOption.equals(&quot;FD&quot;)) {</span>
<span class="nc" id="L171">                slots.add(startDate + &quot;_FH&quot;);</span>
<span class="nc" id="L172">                slots.add(startDate + &quot;_SH&quot;);</span>
            } else {
<span class="nc" id="L174">                slots.add(startDate + &quot;_&quot; + startOption);</span>
<span class="nc" id="L175">                slots.add(startDate + &quot;_&quot; + endOption);</span>
            }
        } else {
            // First day
<span class="nc bnc" id="L179" title="All 2 branches missed.">            if (startOption.equals(&quot;FD&quot;)) {</span>
<span class="nc" id="L180">                slots.add(startDate + &quot;_FH&quot;);</span>
<span class="nc" id="L181">                slots.add(startDate + &quot;_SH&quot;);</span>
            } else {
<span class="nc" id="L183">                slots.add(startDate + &quot;_&quot; + startOption);</span>
            }

            // Middle days
<span class="nc" id="L187">            LocalDate current = startDate.plusDays(1);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">            while (current.isBefore(endDate)) {</span>
<span class="nc" id="L189">                slots.add(current + &quot;_FH&quot;);</span>
<span class="nc" id="L190">                slots.add(current + &quot;_SH&quot;);</span>
<span class="nc" id="L191">                current = current.plusDays(1);</span>
            }

            // Last day
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (endOption.equals(&quot;FD&quot;)) {</span>
<span class="nc" id="L196">                slots.add(endDate + &quot;_FH&quot;);</span>
<span class="nc" id="L197">                slots.add(endDate + &quot;_SH&quot;);</span>
            } else {
<span class="nc" id="L199">                slots.add(endDate + &quot;_&quot; + endOption);</span>
            }
        }
<span class="nc" id="L202">        return slots;</span>
    }

    private LeaveAllocation getActiveAllocation(Integer empId, String leaveCode) {
<span class="nc" id="L206">        return allocationRepository</span>
<span class="nc" id="L207">                .findByEmpIdAndIsActiveAndLeaveAllocationDetails_LeaveCode(empId, &quot;A&quot;, leaveCode)</span>
<span class="nc" id="L208">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;No active leave allocation found for employee and leave type.&quot;));</span>
    }

    private LeaveAllocationDetails getValidLeaveDetails(LeaveAllocation allocation, String leaveCode) {
<span class="nc" id="L212">        return allocation.getLeaveAllocationDetails().stream()</span>
<span class="nc bnc" id="L213" title="All 4 branches missed.">                .filter(d -&gt; leaveCode.equals(d.getLeaveCode()) &amp;&amp; &quot;A&quot;.equals(d.getIsActive()))</span>
<span class="nc" id="L214">                .findFirst()</span>
<span class="nc" id="L215">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Leave type not allocated or inactive.&quot;));</span>
    }

    private List&lt;LocalDate&gt; getLeaveAppliedDates(LocalDate startDate, LocalDate endDate) {
<span class="nc" id="L219">        List&lt;LocalDate&gt; dates = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (startDate.equals(endDate)) {</span>
<span class="nc" id="L222">            dates.add(startDate);</span>
<span class="nc" id="L223">            return dates;</span>
        }

<span class="nc" id="L226">        LocalDate current = startDate;</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">        while (!current.isAfter(endDate)) {</span>
<span class="nc" id="L228">            dates.add(current);</span>
<span class="nc" id="L229">            current = current.plusDays(1);</span>
        }

<span class="nc" id="L232">        return dates;</span>
    }

    private void validateRHLeave(LeaveRequestDTO dto, Map&lt;LocalDate, HolidaysCalendarDay&gt; holidayList) {
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (!&quot;RH&quot;.equalsIgnoreCase(dto.getLeaveCode())) return;</span>

<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (!dto.getStartDate().equals(dto.getEndDate())) {</span>
<span class="nc" id="L239">            throw new IllegalArgumentException(&quot;RH leave can only be applied for one day.&quot;);</span>
        }

<span class="nc" id="L242">        HolidaysCalendarDay holiday = holidayList.get(dto.getStartDate());</span>
<span class="nc bnc" id="L243" title="All 4 branches missed.">        if (holiday == null || !&quot;RH&quot;.equalsIgnoreCase(holiday.getHolidayType())) {</span>
<span class="nc" id="L244">            throw new IllegalArgumentException(&quot;RH leave can only be applied on a restricted holiday as per holiday calendar.&quot;);</span>
        }
<span class="nc" id="L246">    }</span>

    private void validateAgainstRHLeaveForOthers(LeaveRequestDTO dto, List&lt;LocalDate&gt; appliedDates, Map&lt;LocalDate, HolidaysCalendarDay&gt; holidayList) {
<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (&quot;RH&quot;.equalsIgnoreCase(dto.getLeaveCode())) return;</span>

<span class="nc bnc" id="L251" title="All 2 branches missed.">        for (LocalDate date : appliedDates) {</span>
<span class="nc" id="L252">            HolidaysCalendarDay holiday = holidayList.get(date);</span>
<span class="nc bnc" id="L253" title="All 4 branches missed.">            if (holiday != null &amp;&amp; &quot;RH&quot;.equalsIgnoreCase(holiday.getHolidayType())) {</span>
<span class="nc" id="L254">                throw new IllegalArgumentException(&quot;Leave cannot be applied on Restricted Holiday (RH): &quot; + date);</span>
            }
<span class="nc" id="L256">        }</span>
<span class="nc" id="L257">    }</span>

    private void validateAgainstMHAndWeekOffs(List&lt;LocalDate&gt; dates, Map&lt;LocalDate, HolidaysCalendarDay&gt; holidayList, Map&lt;String, SupraShiftDetailEntity&gt; weekOffList) {
<span class="nc bnc" id="L260" title="All 2 branches missed.">        for (LocalDate date : dates) {</span>
<span class="nc" id="L261">            HolidaysCalendarDay holiday = holidayList.get(date);</span>
<span class="nc" id="L262">            String dayName = date.getDayOfWeek().toString();</span>
<span class="nc" id="L263">            SupraShiftDetailEntity weekOff = weekOffList.get(dayName);</span>

<span class="nc bnc" id="L265" title="All 6 branches missed.">            if ((holiday != null &amp;&amp; &quot;MH&quot;.equalsIgnoreCase(holiday.getHolidayType())) || weekOff != null) {</span>
<span class="nc" id="L266">                throw new IllegalArgumentException(&quot;Leave cannot be applied on holiday/week off: &quot; + date);</span>
            }
<span class="nc" id="L268">        }</span>
<span class="nc" id="L269">    }</span>

    private void validateLeaveOptions(LocalDate startDate, LocalDate endDate, String startOption, String endOption) {
<span class="nc bnc" id="L272" title="All 4 branches missed.">        if (startOption == null || endOption == null) {</span>
<span class="nc" id="L273">            throw new IllegalArgumentException(&quot;Start and End options must be provided.&quot;);</span>
        }

<span class="nc" id="L276">        boolean isSameDay = startDate.equals(endDate);</span>

<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (isSameDay) {</span>
<span class="nc bnc" id="L279" title="All 4 branches missed.">            if ((startOption.equals(&quot;FH&quot;) &amp;&amp; endOption.equals(&quot;FH&quot;)) ||</span>
<span class="nc bnc" id="L280" title="All 4 branches missed.">                    (startOption.equals(&quot;SH&quot;) &amp;&amp; endOption.equals(&quot;SH&quot;))) {</span>
<span class="nc" id="L281">                return; // Half-day leave</span>
            }

<span class="nc bnc" id="L284" title="All 4 branches missed.">            if ((startOption.equals(&quot;FH&quot;) &amp;&amp; endOption.equals(&quot;SH&quot;)) ||</span>
<span class="nc bnc" id="L285" title="All 4 branches missed.">                    (startOption.equals(&quot;SH&quot;) &amp;&amp; endOption.equals(&quot;FH&quot;)) ||</span>
<span class="nc bnc" id="L286" title="All 4 branches missed.">                    (startOption.equals(&quot;FD&quot;) &amp;&amp; endOption.equals(&quot;FD&quot;))) {</span>
<span class="nc" id="L287">                return; // Valid full-day</span>
            }

<span class="nc" id="L290">            throw new IllegalArgumentException(&quot;Invalid half-day combination for same day.&quot;);</span>
        }

<span class="nc bnc" id="L293" title="All 4 branches missed.">        if ((startOption.equals(&quot;FD&quot;) &amp;&amp; endOption.equals(&quot;FH&quot;)) ||</span>
<span class="nc bnc" id="L294" title="All 4 branches missed.">                (startOption.equals(&quot;SH&quot;) &amp;&amp; endOption.equals(&quot;FD&quot;))) {</span>
<span class="nc" id="L295">            return; // Valid consecutive 1.5/2.5/3.5 leave</span>
        }

<span class="nc bnc" id="L298" title="All 6 branches missed.">        if (startOption.equals(&quot;FD&quot;) &amp;&amp; (endOption.equals(&quot;FD&quot;) || endOption.equals(&quot;FH&quot;))) {</span>
<span class="nc" id="L299">            return; // Full days or ends with half-day</span>
        }

<span class="nc" id="L302">        throw new IllegalArgumentException(&quot;Invalid leave combination across multiple days. Leaves should be in consecutive manner.&quot;);</span>
    }

    private double calculateDaysRequested(LocalDate startDate, LocalDate endDate, String startOption, String endOption) {
<span class="nc" id="L306">        boolean isSameDay = startDate.equals(endDate);</span>
<span class="nc" id="L307">        long totalDays = ChronoUnit.DAYS.between(startDate, endDate);</span>

<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (isSameDay) {</span>
<span class="nc bnc" id="L310" title="All 4 branches missed.">            if ((startOption.equals(&quot;FH&quot;) &amp;&amp; endOption.equals(&quot;FH&quot;)) ||</span>
<span class="nc bnc" id="L311" title="All 4 branches missed.">                    (startOption.equals(&quot;SH&quot;) &amp;&amp; endOption.equals(&quot;SH&quot;))) {</span>
<span class="nc" id="L312">                return 0.5;</span>
            }

<span class="nc bnc" id="L315" title="All 4 branches missed.">            if ((startOption.equals(&quot;FH&quot;) &amp;&amp; endOption.equals(&quot;SH&quot;)) ||</span>
<span class="nc bnc" id="L316" title="All 4 branches missed.">                    (startOption.equals(&quot;SH&quot;) &amp;&amp; endOption.equals(&quot;FH&quot;)) ||</span>
<span class="nc bnc" id="L317" title="All 4 branches missed.">                    (startOption.equals(&quot;FD&quot;) &amp;&amp; endOption.equals(&quot;FD&quot;))) {</span>
<span class="nc" id="L318">                return 1.0;</span>
            }

<span class="nc" id="L321">            throw new IllegalArgumentException(&quot;Invalid half-day combination for the same day.&quot;);</span>
        }

        // Cross-day patterns
<span class="nc bnc" id="L325" title="All 4 branches missed.">        if (startOption.equals(&quot;FD&quot;) &amp;&amp; endOption.equals(&quot;FH&quot;)) {</span>
<span class="nc" id="L326">            return totalDays + 0.5; // e.g., FD + FD + FH = 2.5</span>
        }

<span class="nc bnc" id="L329" title="All 4 branches missed.">        if (startOption.equals(&quot;SH&quot;) &amp;&amp; endOption.equals(&quot;FD&quot;)) {</span>
<span class="nc" id="L330">            return totalDays + 0.5; // e.g., SH + FD + FD = 2.5</span>
        }

<span class="nc bnc" id="L333" title="All 4 branches missed.">        if (startOption.equals(&quot;FD&quot;) &amp;&amp; endOption.equals(&quot;FD&quot;)) {</span>
<span class="nc" id="L334">            return totalDays + 1.0;</span>
        }

<span class="nc" id="L337">        throw new IllegalArgumentException(&quot;Invalid leave combination. Only Full-Day to Half-Day or Second-Halfâ†’Full-Day allowed for fractional leaves.&quot;);</span>
    }


    private void deductLeaveBalance(LeaveAllocationDetails detail, double daysRequested) {
<span class="nc" id="L342">        detail.setLeaveBalance(detail.getLeaveBalance() - daysRequested);</span>
<span class="nc" id="L343">        detail.setLastUpdatedBy(String.valueOf(SessionHolder.getUserLoginDetail().getUsername()));</span>
<span class="nc" id="L344">        detail.setLastUpdatedDate(Instant.now());</span>
<span class="nc" id="L345">    }</span>

    private LeaveRequest saveLeaveRequest(LeaveRequestDTO dto, double daysRequested) {
<span class="nc" id="L348">        LeaveRequest entity = modelMapper.map(dto, LeaveRequest.class);</span>
<span class="nc" id="L349">        entity.setStatus(&quot;PENDING&quot;);</span>
<span class="nc" id="L350">        entity.setTotalDays(daysRequested);</span>
<span class="nc" id="L351">        entity.setCreatedBy(String.valueOf(SessionHolder.getUserLoginDetail().getUsername()));</span>
<span class="nc" id="L352">        entity.setCreatedDate(Instant.now());</span>
<span class="nc" id="L353">        entity.setLastUpdatedBy(String.valueOf(SessionHolder.getUserLoginDetail().getUsername()));</span>
<span class="nc" id="L354">        entity.setLastUpdatedDate(Instant.now());</span>
<span class="nc" id="L355">        return leaveRequestRepository.save(entity);</span>
    }

    private void insertIntoLedgerTbl(LeaveRequest leaveRequest, double daysRequested) {
<span class="nc" id="L359">        LeaveLedgerEntity ledgerEntity = new LeaveLedgerEntity();</span>
<span class="nc" id="L360">        ledgerEntity.setEmpId(leaveRequest.getEmpId());</span>
<span class="nc" id="L361">        ledgerEntity.setLeaveCode(leaveRequest.getLeaveCode());</span>
<span class="nc" id="L362">        ledgerEntity.setRemark(leaveRequest.getPurpose());</span>
<span class="nc" id="L363">        ledgerEntity.setTransactionType(&quot;DEBIT&quot;);</span>
<span class="nc" id="L364">        ledgerEntity.setTransactionBalance(daysRequested);</span>
<span class="nc" id="L365">        ledgerEntity.setCreatedBy(String.valueOf(SessionHolder.getUserLoginDetail().getEmpId()));</span>
<span class="nc" id="L366">        ledgerEntity.setCreatedDate(Instant.now());</span>
<span class="nc" id="L367">        ledgerEntity.setLastUpdatedBy(String.valueOf(SessionHolder.getUserLoginDetail().getEmpId()));</span>
<span class="nc" id="L368">        ledgerEntity.setLastUpdatedDate(Instant.now());</span>
<span class="nc" id="L369">        ledgerRepository.save(ledgerEntity);</span>
<span class="nc" id="L370">    }</span>

    @Transactional
    public Map&lt;String, Double&gt; getLeaveBalance(Integer empId) {
<span class="nc bnc" id="L374" title="All 2 branches missed.">        if (empId == null) {</span>
<span class="nc" id="L375">            empId = SessionHolder.getUserLoginDetail().getEmpId();</span>
        }

<span class="nc" id="L378">        LeaveAllocation leaveAllocation = allocationRepository.findByEmpId(empId).orElse(null);</span>
<span class="nc" id="L379">        Map&lt;String, String&gt; leaveTypeMap = leaveTypeRepository.findAll().stream()</span>
<span class="nc bnc" id="L380" title="All 4 branches missed.">                .filter(leave -&gt; leave.getLeaveCode() != null &amp;&amp; leave.getLeaveName() != null)</span>
<span class="nc" id="L381">                .collect(Collectors.toMap(</span>
<span class="nc" id="L382">                        leave -&gt; leave.getLeaveCode().toUpperCase(),</span>
                        LeaveTypes::getLeaveName
                ));
<span class="nc bnc" id="L385" title="All 2 branches missed.">        if (leaveAllocation != null) {</span>
<span class="nc" id="L386">            return leaveAllocation.getLeaveAllocationDetails().stream()</span>
<span class="nc" id="L387">                    .collect(Collectors.groupingBy(</span>
                            detail -&gt; {
<span class="nc" id="L389">                                String leaveCode = detail.getLeaveCode().toUpperCase();</span>
<span class="nc" id="L390">                                return leaveTypeMap.getOrDefault(leaveCode, leaveCode);</span>
                            },
<span class="nc" id="L392">                            Collectors.summingDouble(LeaveAllocationDetails::getLeaveBalance)</span>
                    ));
        }
<span class="nc" id="L395">        return new HashMap&lt;&gt;();</span>
    }

    public Map&lt;String, Object&gt; getLedgerDetails(Integer empId, String sortBy, String sortDir, String searchField, String searchKeyword, Pageable pageable) {
<span class="nc bnc" id="L399" title="All 2 branches missed.">        if (empId == null) {</span>
<span class="nc" id="L400">            empId = SessionHolder.getUserLoginDetail().getEmpId();</span>
        }

<span class="nc" id="L403">        List&lt;LeaveLedgerEntity&gt; ledgerList = ledgerRepository.findByEmpId(empId);</span>
<span class="nc" id="L404">        Map&lt;String, String&gt; leaveTypeMap = leaveTypeRepository.findAll().stream()</span>
<span class="nc bnc" id="L405" title="All 4 branches missed.">                .filter(leave -&gt; leave.getLeaveCode() != null &amp;&amp; leave.getLeaveName() != null)</span>
<span class="nc" id="L406">                .collect(Collectors.toMap(</span>
<span class="nc" id="L407">                        leave -&gt; leave.getLeaveCode().toUpperCase(),</span>
                        LeaveTypes::getLeaveName
                ));
<span class="nc" id="L410">        Map&lt;Integer, String&gt; employeeMap = employeeRepository.findAll().stream().collect(Collectors.toMap(</span>
                Employee::getEmployeeId,
                Employee::getFullName
        ));

<span class="nc" id="L415">        List&lt;LeaveLedgerDTO&gt; dtoList = ledgerList.stream()</span>
<span class="nc" id="L416">                .map(x -&gt; mapToLedgerDTO(x, leaveTypeMap, employeeMap))</span>
<span class="nc" id="L417">                .collect(Collectors.toList());</span>

<span class="nc" id="L419">        List&lt;LeaveLedgerDTO&gt; filteredList = applyLedgerSearch(dtoList, searchField, searchKeyword);</span>

<span class="nc" id="L421">        Comparator&lt;LeaveLedgerDTO&gt; comparator = getLedgerComparator(sortBy, sortDir);</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">        if (comparator != null) {</span>
<span class="nc" id="L423">            filteredList.sort(comparator);</span>
        }

<span class="nc" id="L426">        int totalItems = filteredList.size();</span>
<span class="nc" id="L427">        int currentPage = pageable.getPageNumber();</span>
<span class="nc" id="L428">        int pageSize = pageable.getPageSize();</span>
<span class="nc" id="L429">        int totalPages = (int) Math.ceil((double) totalItems / pageSize);</span>

<span class="nc" id="L431">        int startIndex = currentPage * pageSize;</span>
<span class="nc" id="L432">        int endIndex = Math.min(startIndex + pageSize, totalItems);</span>

<span class="nc bnc" id="L434" title="All 2 branches missed.">        List&lt;LeaveLedgerDTO&gt; paginatedResult = startIndex &lt; totalItems</span>
<span class="nc" id="L435">                ? filteredList.subList(startIndex, endIndex)</span>
<span class="nc" id="L436">                : Collections.emptyList();</span>

<span class="nc" id="L438">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L439">        response.put(&quot;result&quot;, paginatedResult);</span>
<span class="nc" id="L440">        response.put(&quot;currentPage&quot;, currentPage + 1);</span>
<span class="nc" id="L441">        response.put(&quot;pageSize&quot;, pageSize);</span>
<span class="nc" id="L442">        response.put(&quot;totalItems&quot;, totalItems);</span>
<span class="nc" id="L443">        response.put(&quot;totalPages&quot;, totalPages);</span>
<span class="nc" id="L444">        return response;</span>
    }

    private LeaveLedgerDTO mapToLedgerDTO(LeaveLedgerEntity ledgerEntity, Map&lt;String, String&gt; leaveTypeMap, Map&lt;Integer, String&gt; employeeMap) {
<span class="nc" id="L448">        LeaveLedgerDTO ledgerDTO = modelMapper.map(ledgerEntity, LeaveLedgerDTO.class);</span>
<span class="nc" id="L449">        ledgerDTO.setLeaveCode(leaveTypeMap.getOrDefault(ledgerEntity.getLeaveCode(), ledgerEntity.getLeaveCode()));</span>
<span class="nc" id="L450">        ledgerDTO.setEmployeeName(employeeMap.getOrDefault(ledgerEntity.getEmpId(), &quot;Unknown&quot;));</span>
<span class="nc bnc" id="L451" title="All 4 branches missed.">        if (ledgerEntity.getCreatedBy() != null &amp;&amp; !ledgerEntity.getCreatedBy().isEmpty()) {</span>
<span class="nc" id="L452">            ledgerDTO.setActionBy(employeeMap.getOrDefault(Integer.parseInt(ledgerEntity.getCreatedBy()), &quot;Unknown&quot;));</span>
        } else {
<span class="nc" id="L454">            ledgerDTO.setActionBy(&quot;Unknown&quot;);</span>
        }
<span class="nc bnc" id="L456" title="All 2 branches missed.">        if (ledgerEntity.getLastUpdatedDate() != null) {</span>
<span class="nc" id="L457">            ledgerDTO.setLastUpdatedDate(ledgerEntity.getLastUpdatedDate().atZone(ZoneId.systemDefault()).toLocalDate());</span>
        }
<span class="nc" id="L459">        return ledgerDTO;</span>
    }

    private List&lt;LeaveLedgerDTO&gt; applyLedgerSearch(List&lt;LeaveLedgerDTO&gt; dtoList, String searchField, String searchKeyword) {
<span class="nc bnc" id="L463" title="All 4 branches missed.">        if (!StringUtils.hasText(searchKeyword) || !StringUtils.hasText(searchField)) {</span>
<span class="nc" id="L464">            return dtoList;</span>
        }

<span class="nc" id="L467">        String keyword = searchKeyword.toLowerCase();</span>

<span class="nc" id="L469">        return dtoList.stream()</span>
<span class="nc" id="L470">                .filter(dto -&gt; {</span>
<span class="nc bnc" id="L471" title="All 7 branches missed.">                    switch (searchField.toLowerCase()) {</span>
                        case &quot;leavecode&quot;:
<span class="nc bnc" id="L473" title="All 4 branches missed.">                            return dto.getLeaveCode() != null &amp;&amp; dto.getLeaveCode().toLowerCase().contains(keyword);</span>
                        case &quot;employeeid&quot;:
<span class="nc bnc" id="L475" title="All 4 branches missed.">                            return dto.getEmpId() != null &amp;&amp; String.valueOf(dto.getEmpId()).contains(keyword);</span>
                        case &quot;employeename&quot;:
<span class="nc bnc" id="L477" title="All 4 branches missed.">                            return dto.getEmployeeName() != null &amp;&amp; dto.getEmployeeName().toLowerCase().contains(keyword);</span>
                        case &quot;remark&quot;:
<span class="nc bnc" id="L479" title="All 4 branches missed.">                            return dto.getRemark() != null &amp;&amp; dto.getRemark().toLowerCase().contains(keyword);</span>
                        case &quot;actionby&quot;:
<span class="nc bnc" id="L481" title="All 4 branches missed.">                            return dto.getActionBy() != null &amp;&amp; dto.getActionBy().toLowerCase().contains(keyword);</span>
                        case &quot;transactiontype&quot;:
<span class="nc bnc" id="L483" title="All 4 branches missed.">                            return dto.getTransactionType() != null &amp;&amp; dto.getTransactionType().toLowerCase().contains(keyword);</span>
                        default:
<span class="nc" id="L485">                            return true;</span>
                    }
                })
<span class="nc" id="L488">                .collect(Collectors.toList());</span>
    }

    private Comparator&lt;LeaveLedgerDTO&gt; getLedgerComparator(String field, String direction) {
        Comparator&lt;LeaveLedgerDTO&gt; comparator;

<span class="nc bnc" id="L494" title="All 6 branches missed.">        switch (field.toLowerCase()) {</span>
            case &quot;leavecode&quot;:
<span class="nc" id="L496">                comparator = Comparator.comparing(LeaveLedgerDTO::getLeaveCode, Comparator.nullsLast(String::compareToIgnoreCase));</span>
<span class="nc" id="L497">                break;</span>
            case &quot;employeeid&quot;:
<span class="nc" id="L499">                comparator = Comparator.comparing(LeaveLedgerDTO::getEmpId, Comparator.nullsLast(Integer::compareTo));</span>
<span class="nc" id="L500">                break;</span>
            case &quot;actionby&quot;:
<span class="nc" id="L502">                comparator = Comparator.comparing(LeaveLedgerDTO::getActionBy, Comparator.nullsLast(String::compareToIgnoreCase));</span>
<span class="nc" id="L503">                break;</span>
            case &quot;employeename&quot;:
<span class="nc" id="L505">                comparator = Comparator.comparing(LeaveLedgerDTO::getEmployeeName, Comparator.nullsLast(String::compareToIgnoreCase));</span>
<span class="nc" id="L506">                break;</span>
            case &quot;transactiontype&quot;:
<span class="nc" id="L508">                comparator = Comparator.comparing(LeaveLedgerDTO::getTransactionType, Comparator.nullsLast(String::compareToIgnoreCase));</span>
<span class="nc" id="L509">                break;</span>
            default:
<span class="nc" id="L511">                comparator = Comparator.comparing(LeaveLedgerDTO::getLedgerId, Comparator.nullsLast(Integer::compareTo));</span>
        }

<span class="nc bnc" id="L514" title="All 2 branches missed.">        if (&quot;desc&quot;.equalsIgnoreCase(direction)) {</span>
<span class="nc" id="L515">            comparator = comparator.reversed();</span>
        }

<span class="nc" id="L518">        return comparator;</span>
    }

    public boolean isLeaveAppliedForDateRange(Integer employeeId, LocalDate startDate, LocalDate endDate, String status) {
<span class="nc" id="L522">        List&lt;LeaveRequest&gt; leaveRequests = leaveRequestRepository.findByEmpIdAndStartDateLessThanEqualAndEndDateGreaterThanEqualAndStatus(employeeId, endDate, startDate, status);</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">        return !leaveRequests.isEmpty();</span>
    }

    public Map&lt;LocalDate, Map&lt;String, String&gt;&gt; leaveAppliedOnDate(Integer employeeId, LocalDate date) {
<span class="nc" id="L527">        List&lt;LeaveRequest&gt; leaveRequests = leaveRequestRepository.findByEmpIdAndStartDateLessThanEqualAndEndDateGreaterThanEqual(employeeId, date, date);</span>

<span class="nc" id="L529">        Map&lt;LocalDate, Map&lt;String, String&gt;&gt; result = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">        for (LeaveRequest leave : leaveRequests) {</span>
<span class="nc" id="L531">            Set&lt;String&gt; slots = expandLeaveIntoDateSlots(leave.getStartDate(), leave.getEndDate(), leave.getStartOption(), leave.getEndOption());</span>

<span class="nc" id="L533">            boolean fh = slots.contains(date + &quot;_FH&quot;);</span>
<span class="nc" id="L534">            boolean sh = slots.contains(date + &quot;_SH&quot;);</span>

            String type;
<span class="nc bnc" id="L537" title="All 4 branches missed.">            if (fh &amp;&amp; sh) {</span>
<span class="nc" id="L538">                type = &quot;FD&quot;;</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">            } else if (fh) {</span>
<span class="nc" id="L540">                type = &quot;FH&quot;;</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">            } else if (sh) {</span>
<span class="nc" id="L542">                type = &quot;SH&quot;;</span>
            } else {
                continue;
            }
<span class="nc" id="L546">            Map&lt;String, String&gt; details = new HashMap&lt;&gt;();</span>
<span class="nc" id="L547">            details.put(&quot;type&quot;, type);</span>
<span class="nc" id="L548">            details.put(&quot;status&quot;, leave.getStatus());</span>

<span class="nc" id="L550">            result.put(date, details);</span>
<span class="nc" id="L551">        }</span>
<span class="nc" id="L552">        return result;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserManageService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HR Management</a> &gt; <a href="index.source.html" class="el_package">com.atomicnorth.hrm.tenant.service.manageColumn</a> &gt; <span class="el_source">UserManageService.java</span></div><h1>UserManageService.java</h1><pre class="source lang-java linenums">package com.atomicnorth.hrm.tenant.service.manageColumn;

import com.atomicnorth.hrm.exception.BadApiRequestException;
import com.atomicnorth.hrm.tenant.domain.manageColumn.SesM00UserManageColumns;
import com.atomicnorth.hrm.tenant.domain.manageColumn.SesM01UserManageColumnDetails;
import com.atomicnorth.hrm.tenant.repository.manageColumn.SesM00UserManageColumnsRepository;
import com.atomicnorth.hrm.tenant.repository.manageColumn.SesM01UserManageColumnDetailsRepository;
import com.atomicnorth.hrm.tenant.service.dto.manageColumn.SesM00UserManageColumnsDTO;
import com.atomicnorth.hrm.tenant.service.dto.manageColumn.SesM00UserManageColumnsResponseDTO;
import com.atomicnorth.hrm.tenant.service.dto.manageColumn.SesM01UserManageColumnDetailsDTO;
import com.atomicnorth.hrm.tenant.service.dto.manageColumn.SesM01UserManageColumnDetailsResponseDTO;
import com.atomicnorth.hrm.tenant.service.dto.manageColumn.get_data_dto.SesM00UserManageColumnsGetResponseDTO;
import com.atomicnorth.hrm.tenant.service.dto.manageColumn.get_data_dto.UserManageColumnDetailsGetDTO;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.ResultSet;
import java.util.*;
import java.util.stream.Collectors;

@Service
<span class="nc" id="L26">public class UserManageService {</span>
    @Autowired
    private SesM00UserManageColumnsRepository userManageColumnsRepository;

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Autowired
    private SesM01UserManageColumnDetailsRepository columnDetailsRepository;

    public boolean isExisting(Integer userId, String pageKey) {
<span class="nc" id="L37">        return userManageColumnsRepository.findByUserIdAndPageKey(userId, pageKey).isPresent();</span>
    }

    @Transactional
    public SesM00UserManageColumnsResponseDTO createUserManageColumns(SesM00UserManageColumnsDTO userManageColumnsDTO) {
        // Convert DTO to entity and set DISPLAY_SNO before saving
<span class="nc" id="L43">        SesM00UserManageColumns userManageColumns = convertToEntity(userManageColumnsDTO);</span>

        // Set DISPLAY_SNO for the columnDetails BEFORE saving the parent entity
<span class="nc" id="L46">        List&lt;SesM01UserManageColumnDetails&gt; columnDetails = userManageColumns.getColumnDetails();</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">        for (int i = 0; i &lt; columnDetails.size(); i++) {</span>
<span class="nc" id="L48">            SesM01UserManageColumnDetails details = columnDetails.get(i);</span>
<span class="nc" id="L49">            details.setDisplaySno(i + 1); // Set sequential DISPLAY_SNO starting from 1</span>
<span class="nc" id="L50">            details.setUserManageColumn(userManageColumns); // Associate the child with the parent</span>
        }

        // Now save the parent entity along with its child details
<span class="nc" id="L54">        SesM00UserManageColumns savedUserManageColumns = userManageColumnsRepository.save(userManageColumns);</span>

        // Convert entity to response DTO and return
<span class="nc" id="L57">        return convertToResponseDTO(savedUserManageColumns);</span>
    }

    // Convert DTO to Entity
    private SesM00UserManageColumns convertToEntity(SesM00UserManageColumnsDTO dto) {
<span class="nc" id="L62">        SesM00UserManageColumns entity = new SesM00UserManageColumns();</span>
<span class="nc" id="L63">        entity.setUserId(dto.getUserId());</span>
<span class="nc" id="L64">        entity.setModuleId(dto.getModuleId());</span>
<span class="nc" id="L65">        entity.setModuleFeatureId(dto.getModuleFeatureId());</span>
<span class="nc" id="L66">        entity.setPageKey(dto.getPageKey());</span>
<span class="nc" id="L67">        entity.setIsPublic(dto.getIsPublic());</span>
<span class="nc" id="L68">        entity.setCreationDate(dto.getCreationDate());</span>
<span class="nc" id="L69">        entity.setLastUpdateDate(dto.getLastUpdateDate());</span>
<span class="nc" id="L70">        entity.setCreatedBy(dto.getCreatedBy());</span>
<span class="nc" id="L71">        entity.setLastUpdatedBy(dto.getLastUpdatedBy());</span>
<span class="nc" id="L72">        entity.setOperationSource(dto.getOperationSource());</span>
<span class="nc" id="L73">        entity.setPageSection(dto.getPageSection());</span>

        // Convert columnDetails and set DISPLAY_SNO sequentially
<span class="nc" id="L76">        List&lt;SesM01UserManageColumnDetails&gt; details = dto.getColumnDetails().stream()</span>
<span class="nc" id="L77">                .map(detailDto -&gt; {</span>
<span class="nc" id="L78">                    SesM01UserManageColumnDetails detail = new SesM01UserManageColumnDetails();</span>
<span class="nc" id="L79">                    detail.setColumnLookupCode(detailDto.getColumnLookupCode());</span>
<span class="nc" id="L80">                    detail.setCreationDate(detailDto.getCreationDate());</span>
<span class="nc" id="L81">                    detail.setLastUpdateDate(detailDto.getLastUpdateDate());</span>
<span class="nc" id="L82">                    detail.setCreatedBy(detailDto.getCreatedBy());</span>
<span class="nc" id="L83">                    detail.setLastUpdatedBy(detailDto.getLastUpdatedBy());</span>
<span class="nc" id="L84">                    detail.setOperationSource(detailDto.getOperationSource());</span>
<span class="nc" id="L85">                    detail.setIsLocked(detailDto.getIsLocked());</span>
<span class="nc" id="L86">                    return detail;</span>
<span class="nc" id="L87">                }).collect(Collectors.toList());</span>
<span class="nc" id="L88">        entity.setColumnDetails(details);</span>

<span class="nc" id="L90">        return entity;</span>
    }

    @Transactional
    public SesM00UserManageColumnsResponseDTO updateUserManageColumns(Integer userId, String pageKey, SesM00UserManageColumnsDTO userManageColumnsDTO) {
        // Fetch the existing user manage columns
<span class="nc" id="L96">        SesM00UserManageColumns existingManageColumn = userManageColumnsRepository.findByUserIdAndPageKey(userId, pageKey)</span>
<span class="nc" id="L97">                .orElseThrow(() -&gt; new BadApiRequestException(&quot;User manage column not found.&quot;));</span>

        // Update the existing user manage columns
<span class="nc" id="L100">        updateExistingManageColumn(existingManageColumn, userManageColumnsDTO);</span>

        // Update column details and collect the updated details
<span class="nc" id="L103">        List&lt;SesM01UserManageColumnDetailsResponseDTO&gt; updatedColumnDetails = updateColumnDetails(existingManageColumn, userManageColumnsDTO.getColumnDetails());</span>

        // Save updated parent entity
<span class="nc" id="L106">        SesM00UserManageColumns updatedManageColumn = userManageColumnsRepository.save(existingManageColumn);</span>

        // Convert entity to response DTO and set the updated column details
<span class="nc" id="L109">        SesM00UserManageColumnsResponseDTO responseDTO = convertToResponseDTO(updatedManageColumn);</span>
<span class="nc" id="L110">        responseDTO.setColumnDetails(updatedColumnDetails); // Set updated column details in response</span>

<span class="nc" id="L112">        return responseDTO;</span>
    }

    private void updateExistingManageColumn(SesM00UserManageColumns existingManageColumn, SesM00UserManageColumnsDTO dto) {
<span class="nc" id="L116">        existingManageColumn.setModuleId(dto.getModuleId());</span>
<span class="nc" id="L117">        existingManageColumn.setModuleFeatureId(dto.getModuleFeatureId());</span>
<span class="nc" id="L118">        existingManageColumn.setIsPublic(dto.getIsPublic());</span>
<span class="nc" id="L119">        existingManageColumn.setLastUpdateDate(dto.getLastUpdateDate());</span>
<span class="nc" id="L120">        existingManageColumn.setLastUpdatedBy(dto.getLastUpdatedBy());</span>
<span class="nc" id="L121">        existingManageColumn.setOperationSource(dto.getOperationSource());</span>
<span class="nc" id="L122">        existingManageColumn.setCreatedBy(dto.getCreatedBy());</span>
<span class="nc" id="L123">        existingManageColumn.setLastUpdateDate(dto.getLastUpdateDate());</span>
<span class="nc" id="L124">        existingManageColumn.setPageSection(dto.getPageSection());</span>
        // Do not update userId and pageKey as per your requirements
<span class="nc" id="L126">    }</span>

    private List&lt;SesM01UserManageColumnDetailsResponseDTO&gt; updateColumnDetails(SesM00UserManageColumns existingManageColumn, List&lt;SesM01UserManageColumnDetailsDTO&gt; columnDetailsDTOList) {
<span class="nc" id="L129">        List&lt;SesM01UserManageColumnDetails&gt; existingDetails = existingManageColumn.getColumnDetails();</span>

        // Create a map for existing column lookup codes for quick access
<span class="nc" id="L132">        Map&lt;String, SesM01UserManageColumnDetails&gt; existingDetailMap = existingDetails.stream()</span>
<span class="nc" id="L133">                .collect(Collectors.toMap(SesM01UserManageColumnDetails::getColumnLookupCode, detail -&gt; detail));</span>

        // Create a set to keep track of processed column lookup codes
<span class="nc" id="L136">        Set&lt;String&gt; processedCodes = new HashSet&lt;&gt;();</span>

        // Loop through incoming column details
<span class="nc bnc" id="L139" title="All 2 branches missed.">        for (SesM01UserManageColumnDetailsDTO columnDetailsDTO : columnDetailsDTOList) {</span>
<span class="nc" id="L140">            processedCodes.add(columnDetailsDTO.getColumnLookupCode()); // Mark this code as processed</span>

            // Check if the column detail already exists
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if (existingDetailMap.containsKey(columnDetailsDTO.getColumnLookupCode())) {</span>
                // Update existing detail
<span class="nc" id="L145">                SesM01UserManageColumnDetails existingDetail = existingDetailMap.get(columnDetailsDTO.getColumnLookupCode());</span>

                // Update isLocked and displaySno based on conditions
<span class="nc bnc" id="L148" title="All 4 branches missed.">                existingDetail.setIsLocked(columnDetailsDTO.getDisplaySno() == 1 || columnDetailsDTO.getDisplaySno() == 2 ? &quot;true&quot; : columnDetailsDTO.getIsLocked());</span>

                // Update displaySno only if it's specified
<span class="nc bnc" id="L151" title="All 2 branches missed.">                if (columnDetailsDTO.getDisplaySno() != null) {</span>
<span class="nc" id="L152">                    existingDetail.setDisplaySno(columnDetailsDTO.getDisplaySno());</span>
                }

                // Always update creationDate, lastUpdateDate, createdBy, lastUpdatedBy, operationSource
<span class="nc" id="L156">                existingDetail.setCreationDate(columnDetailsDTO.getCreationDate());</span>
<span class="nc" id="L157">                existingDetail.setLastUpdateDate(columnDetailsDTO.getLastUpdateDate());</span>
<span class="nc" id="L158">                existingDetail.setCreatedBy(columnDetailsDTO.getCreatedBy());</span>
<span class="nc" id="L159">                existingDetail.setLastUpdatedBy(columnDetailsDTO.getLastUpdatedBy());</span>
<span class="nc" id="L160">                existingDetail.setOperationSource(columnDetailsDTO.getOperationSource());</span>

<span class="nc" id="L162">                columnDetailsRepository.save(existingDetail);</span>
<span class="nc" id="L163">            } else {</span>
                // Create new detail if not found
<span class="nc" id="L165">                SesM01UserManageColumnDetails newDetail = new SesM01UserManageColumnDetails();</span>
<span class="nc" id="L166">                newDetail.setUserManageColumn(existingManageColumn); // Associate with parent</span>
<span class="nc" id="L167">                newDetail.setColumnLookupCode(columnDetailsDTO.getColumnLookupCode());</span>
<span class="nc" id="L168">                newDetail.setDisplaySno(columnDetailsDTO.getDisplaySno()); // Set displaySno from incoming request</span>
<span class="nc" id="L169">                newDetail.setCreationDate(columnDetailsDTO.getCreationDate());</span>
<span class="nc" id="L170">                newDetail.setLastUpdateDate(columnDetailsDTO.getLastUpdateDate());</span>
<span class="nc" id="L171">                newDetail.setCreatedBy(columnDetailsDTO.getCreatedBy());</span>
<span class="nc" id="L172">                newDetail.setLastUpdatedBy(columnDetailsDTO.getLastUpdatedBy());</span>
<span class="nc" id="L173">                newDetail.setIsLocked(&quot;true&quot;); // New records are always locked</span>
<span class="nc" id="L174">                newDetail.setOperationSource(columnDetailsDTO.getOperationSource());</span>
<span class="nc" id="L175">                columnDetailsRepository.save(newDetail);</span>
            }
<span class="nc" id="L177">        }</span>

        // Update isLocked to false for existing details not in the incoming list
<span class="nc bnc" id="L180" title="All 2 branches missed.">        for (SesM01UserManageColumnDetails existingDetail : existingDetails) {</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">            if (!processedCodes.contains(existingDetail.getColumnLookupCode())) {</span>
<span class="nc" id="L182">                existingDetail.setIsLocked(&quot;false&quot;); // Set to false for those not included in the incoming details</span>
<span class="nc" id="L183">                columnDetailsRepository.save(existingDetail);</span>
            }
<span class="nc" id="L185">        }</span>

        // Collect all details (existing and new) to respond
<span class="nc" id="L188">        List&lt;SesM01UserManageColumnDetailsResponseDTO&gt; detailsResponse = existingDetails.stream()</span>
<span class="nc" id="L189">                .map(this::convertToResponseDTO)</span>
<span class="nc" id="L190">                .collect(Collectors.toList());</span>

        // Add newly created details to the response, ensuring no duplicates
<span class="nc bnc" id="L193" title="All 2 branches missed.">        for (SesM01UserManageColumnDetailsDTO columnDetailsDTO : columnDetailsDTOList) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            if (!existingDetailMap.containsKey(columnDetailsDTO.getColumnLookupCode())) {</span>
<span class="nc" id="L195">                SesM01UserManageColumnDetailsResponseDTO newDetailResponse = new SesM01UserManageColumnDetailsResponseDTO();</span>
<span class="nc" id="L196">                newDetailResponse.setColumnLookupCode(columnDetailsDTO.getColumnLookupCode());</span>
<span class="nc" id="L197">                newDetailResponse.setDisplaySno(columnDetailsDTO.getDisplaySno());</span>
<span class="nc" id="L198">                newDetailResponse.setCreationDate(columnDetailsDTO.getCreationDate());</span>
<span class="nc" id="L199">                newDetailResponse.setLastUpdateDate(columnDetailsDTO.getLastUpdateDate());</span>
<span class="nc" id="L200">                newDetailResponse.setCreatedBy(columnDetailsDTO.getCreatedBy());</span>
<span class="nc" id="L201">                newDetailResponse.setLastUpdatedBy(columnDetailsDTO.getLastUpdatedBy());</span>
<span class="nc" id="L202">                newDetailResponse.setIsLocked(&quot;true&quot;); // New records are always locked</span>
<span class="nc" id="L203">                newDetailResponse.setOperationSource(columnDetailsDTO.getOperationSource());</span>
<span class="nc" id="L204">                detailsResponse.add(newDetailResponse);</span>
            }
<span class="nc" id="L206">        }</span>

<span class="nc" id="L208">        return detailsResponse;</span>
    }

    // Convert column details to response DTO with formatted header
    private SesM01UserManageColumnDetailsResponseDTO convertToResponseDTO(SesM01UserManageColumnDetails entity) {
<span class="nc" id="L213">        SesM01UserManageColumnDetailsResponseDTO detailResponseDTO = new SesM01UserManageColumnDetailsResponseDTO();</span>
<span class="nc" id="L214">        detailResponseDTO.setUserManageColumnDetailsId(entity.getUserManageColumnDetailsId());</span>
<span class="nc" id="L215">        detailResponseDTO.setColumnLookupCode(entity.getColumnLookupCode());</span>

        // Use the helper method to format the column lookup code into a proper header
<span class="nc" id="L218">        detailResponseDTO.setColumnLookupCodeHeader(formatColumnLookupCodeHeader(entity.getColumnLookupCode()));</span>

<span class="nc" id="L220">        detailResponseDTO.setDisplaySno(entity.getDisplaySno());</span>
<span class="nc" id="L221">        detailResponseDTO.setCreationDate(entity.getCreationDate());</span>
<span class="nc" id="L222">        detailResponseDTO.setLastUpdateDate(entity.getLastUpdateDate());</span>
<span class="nc" id="L223">        detailResponseDTO.setCreatedBy(entity.getCreatedBy());</span>
<span class="nc" id="L224">        detailResponseDTO.setLastUpdatedBy(entity.getLastUpdatedBy());</span>
<span class="nc" id="L225">        detailResponseDTO.setOperationSource(entity.getOperationSource());</span>
<span class="nc" id="L226">        detailResponseDTO.setIsLocked(entity.getIsLocked());</span>

<span class="nc" id="L228">        return detailResponseDTO;</span>
    }

    // Convert entity to response DTO
    private SesM00UserManageColumnsResponseDTO convertToResponseDTO(SesM00UserManageColumns entity) {
<span class="nc" id="L233">        SesM00UserManageColumnsResponseDTO responseDTO = new SesM00UserManageColumnsResponseDTO();</span>
<span class="nc" id="L234">        responseDTO.setUserManageColumnId(entity.getUserManageColumnId());</span>
<span class="nc" id="L235">        responseDTO.setUserId(entity.getUserId());</span>
<span class="nc" id="L236">        responseDTO.setModuleId(entity.getModuleId());</span>
<span class="nc" id="L237">        responseDTO.setModuleFeatureId(entity.getModuleFeatureId());</span>
<span class="nc" id="L238">        responseDTO.setPageKey(entity.getPageKey());</span>
<span class="nc" id="L239">        responseDTO.setIsPublic(entity.getIsPublic());</span>
<span class="nc" id="L240">        responseDTO.setCreationDate(entity.getCreationDate());</span>
<span class="nc" id="L241">        responseDTO.setLastUpdateDate(entity.getLastUpdateDate());</span>
<span class="nc" id="L242">        responseDTO.setCreatedBy(entity.getCreatedBy());</span>
<span class="nc" id="L243">        responseDTO.setLastUpdatedBy(entity.getLastUpdatedBy());</span>
<span class="nc" id="L244">        responseDTO.setPageSection(entity.getPageSection());</span>
<span class="nc" id="L245">        responseDTO.setOperationSource(entity.getOperationSource());</span>
<span class="nc" id="L246">        responseDTO.setColumnDetails(entity.getColumnDetails().stream()</span>
<span class="nc" id="L247">                .map(this::convertToResponseDTO)</span>
<span class="nc" id="L248">                .collect(Collectors.toList()));</span>

<span class="nc" id="L250">        return responseDTO;</span>
    }

    private String formatColumnLookupCodeHeader(String columnLookupCode) {
        // Replace underscores, hyphens, and digits with spaces
<span class="nc" id="L255">        String formatted = columnLookupCode.replaceAll(&quot;[-_]&quot;, &quot; &quot;);</span>
<span class="nc" id="L256">        formatted = formatted.replaceAll(&quot;\\d&quot;, &quot;&quot;); // Remove digits</span>

        // Add space before any uppercase letter that is not at the start of the string
<span class="nc" id="L259">        formatted = formatted.replaceAll(&quot;([a-z])([A-Z])&quot;, &quot;$1 $2&quot;);</span>

        // Capitalize the first letter of each word
<span class="nc" id="L262">        formatted = Arrays.stream(formatted.split(&quot;\\s+&quot;))</span>
<span class="nc" id="L263">                .map(word -&gt; word.substring(0, 1).toUpperCase() + word.substring(1).toLowerCase())</span>
<span class="nc" id="L264">                .collect(Collectors.joining(&quot; &quot;));</span>

<span class="nc" id="L266">        return formatted.trim(); // Return with leading and trailing spaces removed</span>
    }

    public SesM00UserManageColumnsGetResponseDTO getUserManageColumnsByUserIdAndPageKey(Integer userId, String pageKey) {
        // Fetch the entity from the repository
<span class="nc" id="L271">        SesM00UserManageColumns entity = userManageColumnsRepository</span>
<span class="nc" id="L272">                .findByUserIdAndPageKey(userId, pageKey)</span>
<span class="nc" id="L273">                .orElseThrow(() -&gt; new NoSuchElementException(&quot;No user manage columns found&quot;));</span>

        // Map the entity to DTO
<span class="nc" id="L276">        return new SesM00UserManageColumnsGetResponseDTO(</span>
<span class="nc" id="L277">                entity.getUserManageColumnId(),</span>
<span class="nc" id="L278">                entity.getUserId(),</span>
<span class="nc" id="L279">                entity.getPageKey(),</span>
<span class="nc" id="L280">                entity.getIsPublic(),</span>
<span class="nc" id="L281">                entity.getCreationDate(),</span>
<span class="nc" id="L282">                entity.getLastUpdateDate(),</span>
<span class="nc" id="L283">                entity.getCreatedBy(),</span>
<span class="nc" id="L284">                entity.getLastUpdatedBy(),</span>
<span class="nc" id="L285">                entity.getOperationSource(),</span>
<span class="nc" id="L286">                entity.getPageSection()</span>
        );
    }

    public List&lt;UserManageColumnDetailsGetDTO&gt; getUserManageColumnDetailsByUserManageColumnId(Integer userManageColumnId) {
<span class="nc" id="L291">        List&lt;SesM01UserManageColumnDetails&gt; detailsList = columnDetailsRepository.findAll()</span>
<span class="nc" id="L292">                .stream()</span>
<span class="nc" id="L293">                .filter(detail -&gt; detail.getUserManageColumn().getUserManageColumnId().equals(userManageColumnId))</span>
<span class="nc" id="L294">                .collect(Collectors.toList());</span>

        // Map to DTOs
<span class="nc" id="L297">        return detailsList.stream()</span>
<span class="nc" id="L298">                .map(detail -&gt; new UserManageColumnDetailsGetDTO(</span>
<span class="nc" id="L299">                        detail.getUserManageColumnDetailsId(),</span>
<span class="nc" id="L300">                        detail.getColumnLookupCode(),</span>
<span class="nc" id="L301">                        detail.getDisplaySno(),</span>
<span class="nc" id="L302">                        detail.getCreationDate(),</span>
<span class="nc" id="L303">                        detail.getLastUpdateDate(),</span>
<span class="nc" id="L304">                        detail.getCreatedBy(),</span>
<span class="nc" id="L305">                        detail.getLastUpdatedBy(),</span>
<span class="nc" id="L306">                        detail.getOperationSource(),</span>
<span class="nc" id="L307">                        detail.getIsLocked()</span>
                ))
<span class="nc" id="L309">                .collect(Collectors.toList());</span>
    }

    public List&lt;Map&lt;String, Object&gt;&gt; getManageColumnDetails(int userId, String pageKey, String schemaName) throws Exception {
        //String schemaName = &quot;anpl&quot;; // Replace with your schema name
<span class="nc" id="L314">        String procedureName = schemaName + &quot;.GetManageColumnDetails&quot;;</span>

<span class="nc" id="L316">        List&lt;Map&lt;String, Object&gt;&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L317">        try (Connection connection = jdbcTemplate.getDataSource().getConnection();</span>
<span class="nc" id="L318">             CallableStatement callableStatement = connection.prepareCall(&quot;{CALL &quot; + procedureName + &quot;(?, ?)}&quot;)) {</span>

<span class="nc" id="L320">            callableStatement.setInt(1, userId);</span>
<span class="nc" id="L321">            callableStatement.setString(2, pageKey);</span>

<span class="nc" id="L323">            boolean hasResults = callableStatement.execute();</span>

<span class="nc bnc" id="L325" title="All 2 branches missed.">            while (hasResults) {</span>
<span class="nc" id="L326">                try (ResultSet resultSet = callableStatement.getResultSet()) {</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">                    while (resultSet.next()) {</span>
<span class="nc" id="L328">                        Map&lt;String, Object&gt; row = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">                        for (int i = 1; i &lt;= resultSet.getMetaData().getColumnCount(); i++) {</span>
<span class="nc" id="L330">                            row.put(resultSet.getMetaData().getColumnName(i), resultSet.getObject(i));</span>
                        }
<span class="nc" id="L332">                        result.add(row);</span>
<span class="nc" id="L333">                    }</span>
                }
<span class="nc" id="L335">                hasResults = callableStatement.getMoreResults();</span>
            }
        }
<span class="nc" id="L338">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>
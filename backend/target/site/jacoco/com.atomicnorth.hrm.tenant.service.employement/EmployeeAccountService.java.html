<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmployeeAccountService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HR Management</a> &gt; <a href="index.source.html" class="el_package">com.atomicnorth.hrm.tenant.service.employement</a> &gt; <span class="el_source">EmployeeAccountService.java</span></div><h1>EmployeeAccountService.java</h1><pre class="source lang-java linenums">package com.atomicnorth.hrm.tenant.service.employement;

import com.atomicnorth.hrm.tenant.domain.Employee;
import com.atomicnorth.hrm.tenant.domain.employement.EmployeeAccountEntity;
import com.atomicnorth.hrm.tenant.domain.lookup.LookupCode;
import com.atomicnorth.hrm.tenant.helper.SessionHolder;
import com.atomicnorth.hrm.tenant.helper.UserLoginDetail;
import com.atomicnorth.hrm.tenant.repository.LookupCodeRepository;
import com.atomicnorth.hrm.tenant.repository.employement.EmployeeAccountRepo;
import com.atomicnorth.hrm.tenant.service.dto.employement.EmployeeAccountsDTO;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;

import javax.persistence.EntityNotFoundException;
import javax.persistence.criteria.Expression;
import javax.persistence.criteria.Join;
import javax.persistence.criteria.JoinType;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

@Service
<span class="nc" id="L33">public class EmployeeAccountService {</span>

<span class="nc" id="L35">    private final Logger log = LoggerFactory.getLogger(EmployeeAccountService.class);</span>
    @Autowired
    private EmployeeAccountRepo employeeAccountRepo;
    @Autowired
    private LookupCodeRepository lookupCodeRepository;

    public List&lt;EmployeeAccountsDTO&gt; saveOrUpdate(List&lt;EmployeeAccountsDTO&gt; employeeAccountsDTOS) {
<span class="nc" id="L42">        UserLoginDetail tokenHolder = SessionHolder.getUserLoginDetail();</span>
<span class="nc" id="L43">        List&lt;EmployeeAccountsDTO&gt; updatedDTOs = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L45" title="All 2 branches missed.">        for (EmployeeAccountsDTO dto : employeeAccountsDTOS) {</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">            EmployeeAccountEntity employeeAccount = dto.getAccountId() != null</span>
<span class="nc" id="L47">                    ? employeeAccountRepo.findById(dto.getAccountId()).orElse(new EmployeeAccountEntity())</span>
<span class="nc" id="L48">                    : new EmployeeAccountEntity();</span>

<span class="nc" id="L50">            mapToEntity(dto, employeeAccount);</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">            if (employeeAccount.getAccountId() == null) {</span>
<span class="nc" id="L52">                employeeAccount.setCreatedBy(String.valueOf(tokenHolder.getUsername()));</span>
<span class="nc" id="L53">                employeeAccount.setCreationDate(LocalDate.now());</span>
            }
<span class="nc" id="L55">            employeeAccount.setLastUpdatedBy(String.valueOf(tokenHolder.getUsername()));</span>
<span class="nc" id="L56">            employeeAccount.setLastUpdateDate(LocalDate.now());</span>
<span class="nc" id="L57">            EmployeeAccountEntity savedEntity = employeeAccountRepo.save(employeeAccount);</span>
<span class="nc" id="L58">            dto.setAccountId(savedEntity.getAccountId());</span>
<span class="nc" id="L59">            updatedDTOs.add(dto);</span>
<span class="nc" id="L60">        }</span>
<span class="nc" id="L61">        return updatedDTOs;</span>
    }

    private void mapToEntity(EmployeeAccountsDTO dto, EmployeeAccountEntity entity) {
<span class="nc" id="L65">        entity.setAccountId(dto.getAccountId());</span>
<span class="nc" id="L66">        entity.setEmployeeId(dto.getEmployeeId());</span>
<span class="nc" id="L67">        entity.setOrgId(dto.getOrgId());</span>
<span class="nc" id="L68">        entity.setAccountTypeCode(dto.getAccountTypeCode());</span>
<span class="nc" id="L69">        entity.setAccountNumber(dto.getAccountNumber());</span>
<span class="nc" id="L70">        entity.setAccountHolderName(dto.getAccountHolderName());</span>
<span class="nc" id="L71">        entity.setAccountDescription(dto.getAccountDescription());</span>
<span class="nc" id="L72">        entity.setBankName(dto.getBankName());</span>
<span class="nc" id="L73">        entity.setIfscCode(dto.getIfscCode());</span>
<span class="nc" id="L74">        entity.setIsDeleted(dto.getIsDeleted());</span>
<span class="nc" id="L75">        entity.setAssignmentId(dto.getAssignmentId());</span>
<span class="nc" id="L76">        entity.setEntityId(dto.getEntityId());</span>
<span class="nc" id="L77">        entity.setClientId(dto.getClientId());</span>
<span class="nc" id="L78">        entity.setLastUpdateSessionId(dto.getLastUpdateSessionId());</span>
<span class="nc" id="L79">        entity.setLastUpdatedBy(dto.getLastUpdatedBy());</span>
<span class="nc" id="L80">        entity.setLastUpdateDate(dto.getLastUpdateDate());</span>
<span class="nc" id="L81">        entity.setCreatedBy(dto.getCreatedBy());</span>
<span class="nc" id="L82">        entity.setCreationDate(dto.getCreationDate());</span>
<span class="nc" id="L83">        entity.setRecordInfo(dto.getRecordInfo());</span>
<span class="nc" id="L84">    }</span>

    public List&lt;EmployeeAccountsDTO&gt; getEmployeeDataByEmployeeId(Integer employeeId) {
<span class="nc" id="L87">        List&lt;EmployeeAccountEntity&gt; employeeAccountList = employeeAccountRepo.findByEmployeeId(employeeId);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (employeeAccountList.isEmpty()) {</span>
<span class="nc" id="L89">            log.warn(&quot;No Employee Accounts found for Employee ID: {}&quot;, employeeId);</span>
<span class="nc" id="L90">            return Collections.emptyList();</span>
        }
<span class="nc" id="L92">        log.info(&quot;Retrieved {} Employee Account(s) for Employee ID: {}&quot;, employeeAccountList.size(), employeeId);</span>
<span class="nc" id="L93">        return employeeAccountList.stream()</span>
<span class="nc" id="L94">                .map(this::mapToDTO)</span>
<span class="nc" id="L95">                .collect(Collectors.toList());</span>
    }

    public Optional&lt;EmployeeAccountsDTO&gt; getEmployeeAccountById(Integer accountId) {
<span class="nc" id="L99">        EmployeeAccountEntity employeeAccount = employeeAccountRepo.findById(accountId)</span>
<span class="nc" id="L100">                .orElseThrow(() -&gt; new RuntimeException(&quot;Employee Account with ID &quot; + accountId + &quot; not found.&quot;));</span>
<span class="nc" id="L101">        log.info(&quot;Employee Account with ID {} retrieved&quot;, employeeAccount.getAccountId());</span>
<span class="nc" id="L102">        return Optional.of(mapToDTO(employeeAccount));</span>
    }

    public Page&lt;EmployeeAccountsDTO&gt; getEmployeeAccounts(int page, int size, String sortBy, String sortDir, String searchKeyword, String searchField) {
        // Default sorting field validation
<span class="nc" id="L107">        List&lt;String&gt; validFields = List.of(&quot;accountId&quot;, &quot;employeeId&quot;, &quot;accountTypeCode&quot;, &quot;accountNumber&quot;, &quot;accountName&quot;, &quot;accountDescription&quot;, &quot;bankName&quot;, &quot;ifscCode&quot;, &quot;employeeFullName&quot;, &quot;creationDate&quot;, &quot;createdBy&quot;);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (!validFields.contains(sortBy)) {</span>
<span class="nc" id="L109">            sortBy = &quot;accountId&quot;; // Fallback to a default sorting field</span>
        }
<span class="nc" id="L111">        Pageable pageable = PageRequest.of(page - 1, size,</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                sortDir.equalsIgnoreCase(&quot;desc&quot;) ? Sort.by(sortBy).descending() : Sort.by(sortBy).ascending());</span>
<span class="nc" id="L113">        Specification&lt;EmployeeAccountEntity&gt; spec = (root, query, criteriaBuilder) -&gt; {</span>
            // Exclude soft-deleted records
<span class="nc" id="L115">            var predicate = criteriaBuilder.equal(root.get(&quot;isDeleted&quot;), &quot;N&quot;);</span>
<span class="nc bnc" id="L116" title="All 4 branches missed.">            if (searchKeyword != null &amp;&amp; !searchKeyword.trim().isEmpty()) {</span>
                Expression&lt;String&gt; searchExpression;
<span class="nc bnc" id="L118" title="All 2 branches missed.">                if (&quot;employeeFullName&quot;.equals(searchField)) {</span>
<span class="nc" id="L119">                    Join&lt;EmployeeAccountEntity, Employee&gt; employeeJoin = root.join(&quot;employee&quot;, JoinType.LEFT);</span>
<span class="nc" id="L120">                    searchExpression = criteriaBuilder.lower(criteriaBuilder.concat(</span>
<span class="nc" id="L121">                            criteriaBuilder.concat(employeeJoin.get(&quot;firstName&quot;), &quot; &quot;),</span>
<span class="nc" id="L122">                            employeeJoin.get(&quot;lastName&quot;)</span>
                    ));
<span class="nc bnc" id="L124" title="All 2 branches missed.">                } else if (&quot;orgName&quot;.equals(searchField)) {</span>
<span class="nc" id="L125">                    Join&lt;EmployeeAccountEntity, LookupCode&gt; orgJoin = root.join(&quot;organization&quot;, JoinType.LEFT);</span>
<span class="nc" id="L126">                    searchExpression = criteriaBuilder.lower(orgJoin.get(&quot;meaning&quot;));</span>
<span class="nc" id="L127">                } else {</span>
<span class="nc" id="L128">                    searchExpression = root.get(searchField).as(String.class);</span>
                }
<span class="nc" id="L130">                predicate = criteriaBuilder.and(predicate, criteriaBuilder.like(</span>
<span class="nc" id="L131">                        criteriaBuilder.lower(searchExpression), &quot;%&quot; + searchKeyword.toLowerCase() + &quot;%&quot;));</span>
            }
<span class="nc" id="L133">            return predicate;</span>
        };
<span class="nc" id="L135">        Page&lt;EmployeeAccountEntity&gt; employeeAccountPage = employeeAccountRepo.findAll(spec, pageable);</span>
<span class="nc" id="L136">        return employeeAccountPage.map(this::mapToDTO);</span>
    }

    public EmployeeAccountsDTO mapToDTO(EmployeeAccountEntity entity) {
<span class="nc" id="L140">        EmployeeAccountsDTO dto = new EmployeeAccountsDTO();</span>
<span class="nc" id="L141">        dto.setAccountId(entity.getAccountId());</span>
<span class="nc" id="L142">        dto.setEmployeeId(entity.getEmployeeId());</span>
<span class="nc" id="L143">        dto.setOrgId(entity.getOrgId());</span>
<span class="nc" id="L144">        dto.setAccountTypeCode(entity.getAccountTypeCode());</span>
<span class="nc" id="L145">        dto.setAccountNumber(entity.getAccountNumber());</span>
<span class="nc" id="L146">        dto.setAccountHolderName(entity.getAccountHolderName());</span>
<span class="nc" id="L147">        dto.setAccountDescription(entity.getAccountDescription());</span>
<span class="nc" id="L148">        dto.setBankName(entity.getBankName());</span>
<span class="nc" id="L149">        dto.setIfscCode(entity.getIfscCode());</span>
<span class="nc" id="L150">        dto.setIsDeleted(entity.getIsDeleted());</span>
<span class="nc" id="L151">        dto.setAssignmentId(entity.getAssignmentId());</span>
<span class="nc" id="L152">        dto.setEntityId(entity.getEntityId());</span>
<span class="nc" id="L153">        dto.setClientId(entity.getClientId());</span>
<span class="nc" id="L154">        dto.setLastUpdateSessionId(entity.getLastUpdateSessionId());</span>
<span class="nc" id="L155">        dto.setLastUpdatedBy(entity.getLastUpdatedBy());</span>
<span class="nc" id="L156">        dto.setLastUpdateDate(entity.getLastUpdateDate());</span>
<span class="nc" id="L157">        dto.setCreatedBy(entity.getCreatedBy());</span>
<span class="nc" id="L158">        dto.setCreationDate(entity.getCreationDate());</span>
<span class="nc" id="L159">        dto.setRecordInfo(entity.getRecordInfo());</span>
        // Fetch employee full name
<span class="nc bnc" id="L161" title="All 2 branches missed.">        dto.setEmployeeFullName(entity.getEmployee() != null ? entity.getEmployee().getFirstName() + &quot; &quot; + entity.getEmployee().getLastName() : &quot;Unknown Employee&quot;);</span>
        // Fetch orgName from LookupCode based on LOOKUP_TYPE = 'ORGANIZATION_NAME' and LOOKUP_CODE = orgId
<span class="nc" id="L163">        dto.setOrgName(lookupCodeRepository.findMeaningByLookupTypeAndLookupCode(&quot;ORGANIZATION_NAME&quot;, entity.getOrgId()).orElse(&quot;Unknown Organization&quot;));</span>
<span class="nc" id="L164">        return dto;</span>
    }

    public void deleteEmployeeAccountById(Integer accountId) {
<span class="nc" id="L168">        EmployeeAccountEntity employeeAccount = employeeAccountRepo.findById(accountId)</span>
<span class="nc" id="L169">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Employee Account with ID &quot; + accountId + &quot; not found&quot;));</span>
        // Soft delete Employee account
<span class="nc" id="L171">        employeeAccount.setIsDeleted(&quot;Y&quot;);</span>
<span class="nc" id="L172">        this.employeeAccountRepo.save(employeeAccount);</span>
<span class="nc" id="L173">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>
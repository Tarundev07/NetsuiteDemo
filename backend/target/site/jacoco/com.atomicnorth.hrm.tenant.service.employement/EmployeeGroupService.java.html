<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmployeeGroupService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HR Management</a> &gt; <a href="index.source.html" class="el_package">com.atomicnorth.hrm.tenant.service.employement</a> &gt; <span class="el_source">EmployeeGroupService.java</span></div><h1>EmployeeGroupService.java</h1><pre class="source lang-java linenums">package com.atomicnorth.hrm.tenant.service.employement;

import com.atomicnorth.hrm.exception.ResourceNotFoundException;
import com.atomicnorth.hrm.tenant.domain.Group;
import com.atomicnorth.hrm.tenant.domain.employement.EmployeeGroup;
import com.atomicnorth.hrm.tenant.helper.SessionHolder;
import com.atomicnorth.hrm.tenant.helper.UserLoginDetail;
import com.atomicnorth.hrm.tenant.repository.GroupRepo;
import com.atomicnorth.hrm.tenant.repository.employement.EmployeeGroupRepo;
import com.atomicnorth.hrm.tenant.service.EmployeeService;
import com.atomicnorth.hrm.tenant.service.SequenceGeneratorService;
import com.atomicnorth.hrm.tenant.service.dto.employement.EmployeeGroupDTO;
import com.atomicnorth.hrm.tenant.service.dto.employement.Response.EmployeeResponseDTO;
import com.atomicnorth.hrm.tenant.service.dto.employement.viewDTO.GroupDTO;
import com.atomicnorth.hrm.util.Enum.Active;
import com.atomicnorth.hrm.util.Enum.SequenceType;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;

import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.TypedQuery;
import javax.transaction.Transactional;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
<span class="nc" id="L35">public class EmployeeGroupService {</span>

    @Autowired
    private EmployeeGroupRepo employeeGroupRepo;

    @Autowired
    private GroupRepo groupRepo;

    @Autowired
    private EmployeeService employeeService;

    @PersistenceContext
    private EntityManager entityManager;

    @Autowired
    private SequenceGeneratorService sequenceGeneratorService;

    @Transactional
    public EmployeeGroupDTO createEmpGrp(EmployeeGroupDTO empGrpDTO) {
<span class="nc" id="L54">        UserLoginDetail token = SessionHolder.getUserLoginDetail();</span>
<span class="nc" id="L55">        Group grp = new Group();</span>
<span class="nc" id="L56">        grp.setGroupCode(sequenceGeneratorService.generateSequence(String.valueOf(SequenceType.GROUP), null));</span>
<span class="nc" id="L57">        grp.setGroupName(empGrpDTO.getGroupName());</span>
<span class="nc" id="L58">        grp.setIsActive(Active.valueOf(empGrpDTO.getIsActive()));</span>
<span class="nc" id="L59">        grp.setCreatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L60">        grp.setLastUpdatedBy(String.valueOf(token.getUsername()));</span>

<span class="nc" id="L62">        Group saveGrp = groupRepo.save(grp);</span>
<span class="nc" id="L63">        List&lt;GroupDTO&gt; grpDto = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">        for (GroupDTO emp : empGrpDTO.getEmpIds()) {</span>
<span class="nc" id="L65">            EmployeeGroup empGrp = new EmployeeGroup();</span>
<span class="nc" id="L66">            empGrp.setGroupId(saveGrp.getId());</span>
<span class="nc" id="L67">            empGrp.setEmpId(emp.getEmpId());</span>
<span class="nc" id="L68">            empGrp.setIsActive(Active.valueOf(emp.getIsActive()));</span>
<span class="nc" id="L69">            empGrp.setCreatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L70">            empGrp.setLastUpdatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L71">            EmployeeGroup saveEmpGrp = employeeGroupRepo.save(empGrp);</span>
<span class="nc" id="L72">            grpDto.add(new GroupDTO(saveEmpGrp));</span>
<span class="nc" id="L73">        }</span>
<span class="nc" id="L74">        return new EmployeeGroupDTO(saveGrp, grpDto);</span>
    }

    public EmployeeGroupDTO updateEmpGrp(EmployeeGroupDTO empGrpDTO, Long id) {
<span class="nc" id="L78">        UserLoginDetail token = SessionHolder.getUserLoginDetail();</span>
<span class="nc" id="L79">        Group existingGroup = groupRepo.findById(id)</span>
<span class="nc" id="L80">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Employee Grade with id &quot; + id + &quot; not found.&quot;));</span>

<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (empGrpDTO.getGroupName() != null) existingGroup.setGroupName(empGrpDTO.getGroupName());</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        if (empGrpDTO.getGroupCode() != null) existingGroup.setGroupCode(empGrpDTO.getGroupCode());</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (empGrpDTO.getIsActive() != null) existingGroup.setIsActive(Active.valueOf(empGrpDTO.getIsActive()));</span>
<span class="nc" id="L85">        existingGroup.setLastUpdatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc" id="L86">        Group save = groupRepo.save(existingGroup);</span>

<span class="nc" id="L88">        List&lt;GroupDTO&gt; grp = empGrpDTO.getEmpIds();</span>
<span class="nc" id="L89">        List&lt;GroupDTO&gt; grpDto = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L90" title="All 4 branches missed.">        if (grp != null &amp;&amp; !grp.isEmpty()) {</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">            for (GroupDTO emp : grp) {</span>
<span class="nc" id="L92">                EmployeeGroup empGrp = employeeGroupRepo.findByGroupIdAndEmpId(id, emp.getEmpId()).orElse(new EmployeeGroup());</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">                empGrp.setEmpId(emp.getEmpId() != null ? emp.getEmpId() : empGrp.getEmpId());</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">                empGrp.setIsActive(emp.getIsActive() != null ? Active.valueOf(emp.getIsActive()) : empGrp.getIsActive());</span>
<span class="nc" id="L95">                empGrp.setLastUpdatedBy(String.valueOf(token.getUsername()));</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                empGrp.setCreatedBy(emp.getCreatedBy() != null ? emp.getCreatedBy() : String.valueOf(token.getUsername()));</span>
<span class="nc" id="L97">                empGrp.setGroupId(save.getId());</span>
<span class="nc" id="L98">                EmployeeGroup saveEmpGrp = employeeGroupRepo.save(empGrp);</span>
<span class="nc" id="L99">                grpDto.add(new GroupDTO(saveEmpGrp));</span>
<span class="nc" id="L100">            }</span>
        }
<span class="nc" id="L102">        return new EmployeeGroupDTO(save, grpDto);</span>
    }

    public Map&lt;String, Object&gt; getPaginatedEmployeeGroups(Pageable pageable, String searchColumn, String searchValue) {
        Page&lt;Group&gt; groups;
<span class="nc bnc" id="L107" title="All 4 branches missed.">        if (searchColumn != null &amp;&amp; searchValue != null) {</span>
<span class="nc" id="L108">            String normalizedSearchValue = searchValue.trim().toLowerCase();</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">            if (&quot;isActive&quot;.equalsIgnoreCase(searchColumn)) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                if (&quot;active&quot;.contains(normalizedSearchValue)) {</span>
<span class="nc" id="L111">                    normalizedSearchValue = &quot;Y&quot;;</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                } else if (&quot;inactive&quot;.contains(normalizedSearchValue)) {</span>
<span class="nc" id="L113">                    normalizedSearchValue = &quot;N&quot;;</span>
                }
            }
<span class="nc" id="L116">            final String finalSearchValue = normalizedSearchValue;</span>
<span class="nc" id="L117">            groups = searchByColumn(searchColumn, finalSearchValue, pageable);</span>
<span class="nc" id="L118">        } else {</span>
<span class="nc" id="L119">            groups = groupRepo.findAll(pageable);</span>
        }
<span class="nc" id="L121">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L122">        response.put(&quot;result&quot;, groups.getContent());</span>
<span class="nc" id="L123">        response.put(&quot;currentPage&quot;, pageable.getPageNumber() + 1); // Ensure correct page number</span>
<span class="nc" id="L124">        response.put(&quot;pageSize&quot;, pageable.getPageSize()); // Add page size for additional context</span>
<span class="nc" id="L125">        response.put(&quot;totalItems&quot;, groups.getTotalElements());</span>
<span class="nc" id="L126">        response.put(&quot;totalPages&quot;, groups.getTotalPages());</span>
<span class="nc" id="L127">        return response;</span>
    }

    public Page&lt;Group&gt; searchByColumn(String column, String value, Pageable pageable) {
<span class="nc" id="L131">        String baseQuery = &quot;FROM Group l WHERE LOWER(l.&quot; + column + &quot;) LIKE LOWER(:value)&quot;;</span>
<span class="nc" id="L132">        String orderByClause = &quot;&quot;;</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (pageable.getSort().isSorted()) {</span>
<span class="nc" id="L134">            orderByClause = &quot; ORDER BY &quot; + pageable.getSort().stream()</span>
<span class="nc" id="L135">                    .map(order -&gt; &quot;l.&quot; + order.getProperty() + &quot; &quot; + order.getDirection().name())</span>
<span class="nc" id="L136">                    .collect(Collectors.joining(&quot;, &quot;));</span>
        }

<span class="nc" id="L139">        String queryString = &quot;SELECT l &quot; + baseQuery + orderByClause;</span>
<span class="nc" id="L140">        String countQueryString = &quot;SELECT COUNT(l) &quot; + baseQuery;</span>
<span class="nc" id="L141">        TypedQuery&lt;Group&gt; query = entityManager.createQuery(queryString, Group.class);</span>
<span class="nc" id="L142">        TypedQuery&lt;Long&gt; countQuery = entityManager.createQuery(countQueryString, Long.class);</span>
<span class="nc" id="L143">        query.setParameter(&quot;value&quot;, &quot;%&quot; + value + &quot;%&quot;);</span>
<span class="nc" id="L144">        countQuery.setParameter(&quot;value&quot;, &quot;%&quot; + value + &quot;%&quot;);</span>
<span class="nc" id="L145">        query.setFirstResult((int) pageable.getOffset());</span>
<span class="nc" id="L146">        query.setMaxResults(pageable.getPageSize());</span>
<span class="nc" id="L147">        List&lt;Group&gt; resultList = query.getResultList();</span>
<span class="nc" id="L148">        Long totalCount = countQuery.getSingleResult();</span>
<span class="nc" id="L149">        return new PageImpl&lt;&gt;(resultList, pageable, totalCount);</span>
    }

    public Map&lt;String, Object&gt; getEmployeeIdsByGroupId(Long groupId) {
<span class="nc" id="L153">        List&lt;EmployeeGroup&gt; employeeGroups = employeeGroupRepo.findByGroupId(groupId);</span>
<span class="nc" id="L154">        List&lt;String&gt; empIds = employeeGroups.stream()</span>
<span class="nc" id="L155">                .map(EmployeeGroup::getEmpId)</span>
<span class="nc" id="L156">                .collect(Collectors.toList());</span>

<span class="nc" id="L158">        List&lt;EmployeeResponseDTO&gt; employeeData = employeeService.getEmployessName(empIds);</span>

<span class="nc bnc" id="L160" title="All 4 branches missed.">        if (employeeData == null || employeeData.isEmpty()) {</span>
<span class="nc" id="L161">            return Collections.singletonMap(&quot;result&quot;, Collections.emptyMap());</span>
        }

<span class="nc" id="L164">        Map&lt;String, EmployeeResponseDTO&gt; employeeMap = employeeData.stream()</span>
<span class="nc" id="L165">                .collect(Collectors.toMap(EmployeeResponseDTO::getEmployeeNumber, emp -&gt; emp));</span>

<span class="nc" id="L167">        List&lt;Map&gt; employeNames = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">        for (EmployeeGroup empGrp : employeeGroups) {</span>
<span class="nc" id="L169">            EmployeeResponseDTO empData = employeeMap.get(empGrp.getEmpId());</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (empData != null) {</span>
<span class="nc" id="L171">                Map&lt;String, String&gt; empIdWithName = new HashMap&lt;&gt;();</span>
<span class="nc" id="L172">                String empName = empData.getFirstName() + &quot; &quot; + empData.getLastName();</span>
<span class="nc" id="L173">                empIdWithName.put(&quot;empId&quot;, empData.getEmployeeNumber());</span>
<span class="nc" id="L174">                empIdWithName.put(&quot;fullName&quot;, empName);</span>
<span class="nc" id="L175">                empIdWithName.put(&quot;isActive&quot;, String.valueOf(empGrp.getIsActive()));</span>
<span class="nc" id="L176">                employeNames.add(empIdWithName);</span>
            }
<span class="nc" id="L178">        }</span>
<span class="nc" id="L179">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L180">        response.put(&quot;result&quot;, employeNames);</span>
<span class="nc" id="L181">        return response;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>
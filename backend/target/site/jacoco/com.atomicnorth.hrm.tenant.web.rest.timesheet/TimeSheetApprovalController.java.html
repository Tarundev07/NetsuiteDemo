<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TimeSheetApprovalController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HR Management</a> &gt; <a href="index.source.html" class="el_package">com.atomicnorth.hrm.tenant.web.rest.timesheet</a> &gt; <span class="el_source">TimeSheetApprovalController.java</span></div><h1>TimeSheetApprovalController.java</h1><pre class="source lang-java linenums">package com.atomicnorth.hrm.tenant.web.rest.timesheet;

import com.atomicnorth.hrm.tenant.service.dto.timeSheetDTO.UserTimesheetDTO;
import com.atomicnorth.hrm.tenant.service.timesheet.TimeSheetApprovalService;
import com.atomicnorth.hrm.util.commonClass.ApiResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.dao.DataAccessException;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@RestController
@RequestMapping(&quot;api/timesheetApproval&quot;)
<span class="nc" id="L36">public class TimeSheetApprovalController {</span>
<span class="nc" id="L37">    private final Logger log = LoggerFactory.getLogger(TimeSheetApprovalController.class);</span>
    @Autowired
    private ObjectMapper objectMapper;
    @Autowired
    private TimeSheetApprovalService timeSheetApprovalService;

    @GetMapping(&quot;/fetchTimeDataBasedPrjctUser&quot;)
    public ResponseEntity&lt;ApiResponse&lt;List&lt;Map&lt;String, Object&gt;&gt;&gt;&gt; getTimesheetDataPrjctUser(
            @RequestParam(value = &quot;strtDate&quot;) String strtDate,
            @RequestParam(value = &quot;endDate&quot;) String endDate,
            @RequestParam(value = &quot;username&quot;) String username) {

        try {
<span class="nc" id="L50">            List&lt;Map&lt;String, Object&gt;&gt; timesheetData = timeSheetApprovalService.getDataByPrjctUser(</span>
                    strtDate, endDate, username);

<span class="nc" id="L53">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(timesheetData, true, &quot;ATMCMN_TIMESHEET_FETCHED&quot;, &quot;SUCCESS&quot;));</span>

<span class="nc" id="L55">        } catch (DataAccessException e) {</span>
<span class="nc" id="L56">            log.error(&quot;Database error while fetching timesheet data&quot;, e);</span>
<span class="nc" id="L57">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L58">                    .body(new ApiResponse&lt;&gt;(null, false, &quot;ATMCMN_DATABASE_ERROR&quot;, &quot;FAILURE&quot;,</span>
<span class="nc" id="L59">                            Collections.singletonList(&quot;Database error occurred while fetching timesheet data&quot;)));</span>

<span class="nc" id="L61">        } catch (Exception e) {</span>
<span class="nc" id="L62">            log.error(&quot;Unexpected error while fetching timesheet data&quot;, e);</span>
<span class="nc" id="L63">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L64">                    .body(new ApiResponse&lt;&gt;(null, false, &quot;ATMCMN_FETCH_ERROR&quot;, &quot;FAILURE&quot;,</span>
<span class="nc" id="L65">                            Collections.singletonList(&quot;An unexpected error occurred while fetching timesheet data&quot;)));</span>
        }
    }

    @PutMapping(&quot;/updateTimesheetStatus&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Boolean&gt;&gt; updateTimesheetStatus(
            @RequestParam(value = &quot;startDate&quot;) String startDate,
            @RequestParam(value = &quot;endDate&quot;) String endDate,
            @RequestParam(value = &quot;username&quot;) String username,
            @RequestParam(value = &quot;result&quot;) boolean result,
            @RequestParam(value = &quot;appRmrk&quot;) String appRmrk) {

        try {
<span class="nc" id="L78">            boolean status = timeSheetApprovalService.updateTimesheetStatusUser(startDate, endDate, result, username, appRmrk);</span>
<span class="nc bnc" id="L79" title="All 4 branches missed.">            if (status &amp;&amp; !result) {</span>
<span class="nc" id="L80">                Thread t = new Thread(() -&gt; {</span>
                    try {
<span class="nc" id="L82">                        timeSheetApprovalService.removeSourceTSAttendanceLog(startDate, endDate, username);</span>
<span class="nc" id="L83">                    } catch (Exception e) {</span>
<span class="nc" id="L84">                        log.error(&quot;Error while removing attendance log&quot;, e);</span>
<span class="nc" id="L85">                    }</span>
<span class="nc" id="L86">                });</span>
<span class="nc" id="L87">                t.start();</span>
            }
<span class="nc" id="L89">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(status, true, &quot;ATMCMN_TIMESHEET_STATUS_UPDATED&quot;, &quot;SUCCESS&quot;));</span>
<span class="nc" id="L90">        } catch (DataAccessException e) {</span>
<span class="nc" id="L91">            log.error(&quot;Database error while updating timesheet status&quot;, e);</span>
<span class="nc" id="L92">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L93">                    .body(new ApiResponse&lt;&gt;(false, false, &quot;ATMCMN_DATABASE_ERROR&quot;, &quot;FAILURE&quot;,</span>
<span class="nc" id="L94">                            Collections.singletonList(&quot;Database error occurred while updating timesheet status&quot;)));</span>

<span class="nc" id="L96">        } catch (Exception e) {</span>
<span class="nc" id="L97">            log.error(&quot;Unexpected error while updating timesheet status&quot;, e);</span>
<span class="nc" id="L98">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L99">                    .body(new ApiResponse&lt;&gt;(false, false, &quot;ATMCMN_UPDATE_ERROR&quot;, &quot;FAILURE&quot;,</span>
<span class="nc" id="L100">                            Collections.singletonList(e.getMessage())));</span>
        }
    }

    @PutMapping(&quot;/submitBulkTimesheet&quot;)
    public ResponseEntity&lt;ApiResponse&lt;ObjectNode&gt;&gt; submitBulkTimesheet(@RequestBody UserTimesheetDTO timesheetBean) {
        try {
<span class="nc bnc" id="L107" title="All 4 branches missed.">            if (timesheetBean.getBulkRequest() == null || timesheetBean.getBulkRequest().isEmpty()) {</span>
<span class="nc" id="L108">                return ResponseEntity.badRequest().body(</span>
<span class="nc" id="L109">                        new ApiResponse&lt;&gt;(null, false, &quot;TIMESHEET_ROWS_NULL&quot;, &quot;FAILURE&quot;, List.of(&quot;Timesheet rows cannot be null or empty.&quot;))</span>
                );
            }
<span class="nc" id="L112">            String result = timeSheetApprovalService.saveUserTimesheet(timesheetBean);</span>
<span class="nc" id="L113">            ObjectNode responseData = objectMapper.createObjectNode();</span>
<span class="nc" id="L114">            responseData.put(&quot;message&quot;, result);</span>
<span class="nc" id="L115">            return ResponseEntity.ok(</span>
                    new ApiResponse&lt;&gt;(responseData, true, &quot;TIMESHEET_SUBMITTED&quot;, &quot;SUCCESS&quot;)
            );
<span class="nc" id="L118">        } catch (Exception e) {</span>
<span class="nc" id="L119">            log.error(&quot;Error occurred while submitting bulk timesheet&quot;, e);</span>
<span class="nc" id="L120">            return ResponseEntity.status(HttpStatus.OK).body(</span>
<span class="nc" id="L121">                    new ApiResponse&lt;&gt;(null, false, &quot;TIMESHEET_SUBMISSION_ERROR&quot;, &quot;FAILURE&quot;, List.of(e.getMessage()))</span>
            );
        }
    }

    @GetMapping(&quot;/getTimesheetData&quot;)
    public ResponseEntity&lt;ApiResponse&lt;ObjectNode&gt;&gt; getTimesheetData(
            @RequestParam(value = &quot;userId&quot;, required = false) String userId,
            @RequestParam(value = &quot;startDate&quot;, required = true) String startDate,
            @RequestParam(value = &quot;endDate&quot;, required = true) String endDate,
            @RequestParam(value = &quot;filterVar&quot;, required = false) String filterVar,
            @RequestParam(value = &quot;allReporteeFlag&quot;, required = false) String allReporteeFlag,
            @RequestParam(value = &quot;departments&quot;, required = false) String departments,
            @RequestParam(value = &quot;divisions&quot;, required = false) String divisions,
            @RequestParam(value = &quot;reportingmanagers&quot;, required = false) String reportingmanagers,
            @RequestParam(value = &quot;sortBy&quot;, defaultValue = &quot;user_name&quot;, required = false) String sortBy,
            @RequestParam(value = &quot;sortDir&quot;, defaultValue = &quot;desc&quot;, required = false) String sortDir,
            @RequestParam(value = &quot;searchKeyword&quot;, required = false) String searchKeyword,
            @RequestParam(value = &quot;searchField&quot;, required = false) String searchField,
            @RequestParam(defaultValue = &quot;1&quot;) int page,
            @RequestParam(defaultValue = &quot;10&quot;) int size) {

        try {
            // Adjust start and end date to the week range
<span class="nc" id="L145">            LocalDate startDateObj = LocalDate.parse(startDate);</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">            while (!startDateObj.getDayOfWeek().toString().equalsIgnoreCase(&quot;SUNDAY&quot;)) {</span>
<span class="nc" id="L147">                startDateObj = startDateObj.minusDays(1);</span>
            }
<span class="nc" id="L149">            LocalDate endDateObj = LocalDate.parse(endDate);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">            while (!endDateObj.getDayOfWeek().toString().equalsIgnoreCase(&quot;SATURDAY&quot;)) {</span>
<span class="nc" id="L151">                endDateObj = endDateObj.plusDays(1);</span>
            }

<span class="nc" id="L154">            Pageable pageable = PageRequest.of(page - 1, size, Sort.Direction.fromString(sortDir), sortBy);</span>

            // Fetch paginated data from service
<span class="nc" id="L157">            Page&lt;Map&lt;String, Object&gt;&gt; userPage = timeSheetApprovalService.getUsersDataUnderReportee(</span>
                    userId,
<span class="nc" id="L159">                    startDateObj.format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;)),</span>
<span class="nc" id="L160">                    endDateObj.format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;)),</span>
                    filterVar,
                    allReporteeFlag,
                    departments,
                    divisions,
                    reportingmanagers,
                    pageable);

            // Apply search if provided
<span class="nc" id="L169">            List&lt;Map&lt;String, Object&gt;&gt; fullData = userPage.getContent();</span>
<span class="nc bnc" id="L170" title="All 8 branches missed.">            if (searchKeyword != null &amp;&amp; !searchKeyword.isEmpty() &amp;&amp; searchField != null &amp;&amp; !searchField.isEmpty()) {</span>
<span class="nc" id="L171">                fullData = fullData.stream()</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                        .filter(data -&gt; data.containsKey(searchField) &amp;&amp;</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">                                data.get(searchField) != null &amp;&amp;</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">                                data.get(searchField).toString().toLowerCase().contains(searchKeyword.toLowerCase()))</span>
<span class="nc" id="L175">                        .collect(Collectors.toList());</span>
            }

            // Build the response data
<span class="nc" id="L179">            ObjectNode responseData = objectMapper.createObjectNode();</span>
<span class="nc" id="L180">            responseData.set(&quot;result&quot;, objectMapper.valueToTree(fullData));</span>
<span class="nc" id="L181">            responseData.put(&quot;totalItems&quot;, userPage.getTotalElements());</span>
<span class="nc" id="L182">            responseData.put(&quot;totalPages&quot;, userPage.getTotalPages());</span>
<span class="nc" id="L183">            responseData.put(&quot;pageSize&quot;, size);</span>
<span class="nc" id="L184">            responseData.put(&quot;currentPage&quot;, page);</span>

            // Build and return the API response
<span class="nc" id="L187">            ApiResponse&lt;ObjectNode&gt; apiResponse = new ApiResponse&lt;&gt;(responseData, true, &quot;TIMESHEET_DATA_FETCHED&quot;, &quot;SUCCESS&quot;);</span>
<span class="nc" id="L188">            return ResponseEntity.ok(apiResponse);</span>
<span class="nc" id="L189">        } catch (Exception e) {</span>
<span class="nc" id="L190">            log.error(&quot;Error occurred while fetching timesheet data&quot;, e);</span>
<span class="nc" id="L191">            ApiResponse&lt;ObjectNode&gt; errorResponse = new ApiResponse&lt;&gt;(null, false, &quot;TIMESHEET_FETCH_ERROR&quot;, &quot;FAILURE&quot;,</span>
<span class="nc" id="L192">                    Collections.singletonList(e.getMessage()));</span>
<span class="nc" id="L193">            return new ResponseEntity&lt;&gt;(errorResponse, HttpStatus.INTERNAL_SERVER_ERROR);</span>
        }
    }

    @GetMapping(&quot;getTSDataByProject&quot;)
    public HttpEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; getTSDataByProject(
            @RequestParam(value = &quot;projectId&quot;) Integer projectId,
            @RequestParam(value = &quot;startDate&quot;) String startDate,
            @RequestParam(value = &quot;endDate&quot;) String endDate,
            @RequestParam(value = &quot;status&quot;, required = false) String status,
            @RequestParam(value = &quot;sortBy&quot;, defaultValue = &quot;user_name&quot;, required = false) String sortBy,
            @RequestParam(value = &quot;sortDir&quot;, defaultValue = &quot;desc&quot;, required = false) String sortDir,
            @RequestParam(value = &quot;searchKeyword&quot;, required = false) String searchKeyword,
            @RequestParam(value = &quot;searchField&quot;, required = false) String searchField,
            @RequestParam(defaultValue = &quot;1&quot;) int page,
            @RequestParam(defaultValue = &quot;10&quot;) int size
    ) {
        try {
<span class="nc bnc" id="L211" title="All 4 branches missed.">            if (StringUtils.isEmpty(startDate) || StringUtils.isEmpty(endDate)) {</span>
<span class="nc" id="L212">                return new ResponseEntity&lt;&gt;(new ApiResponse&lt;&gt;(null, false, &quot;TIMESHEET_SUMMARY_FETCHED_ERROR&quot;, &quot;ERROR&quot;, Collections.singletonList(&quot;Start Date and End Date are mandatory.&quot;)), HttpStatus.BAD_REQUEST);</span>
            }
<span class="nc" id="L214">            Pageable pageable = PageRequest.of(page - 1, size, Sort.Direction.fromString(sortDir), sortBy);</span>
<span class="nc" id="L215">            Map&lt;String, Object&gt; summaries = timeSheetApprovalService.getTSByProject(projectId, startDate, endDate, status, sortBy, sortDir, searchField, searchKeyword, pageable);</span>
<span class="nc" id="L216">            return ResponseEntity.ok(new ApiResponse&lt;&gt;(summaries, true, &quot;TIMESHEET_SUMMARY_FETCHED_SUCCESS&quot;, &quot;SUCCESS&quot;));</span>
<span class="nc" id="L217">        } catch (Exception e) {</span>
<span class="nc" id="L218">            return new ResponseEntity&lt;&gt;(new ApiResponse&lt;&gt;(null, false, &quot;TIMESHEET_SUMMARY_FETCHED_ERROR&quot;, &quot;ERROR&quot;, Collections.singletonList(e.getMessage())), HttpStatus.OK);</span>
        }

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>
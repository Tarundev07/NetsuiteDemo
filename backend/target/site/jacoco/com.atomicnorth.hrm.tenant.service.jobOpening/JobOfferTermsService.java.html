<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JobOfferTermsService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HR Management</a> &gt; <a href="index.source.html" class="el_package">com.atomicnorth.hrm.tenant.service.jobOpening</a> &gt; <span class="el_source">JobOfferTermsService.java</span></div><h1>JobOfferTermsService.java</h1><pre class="source lang-java linenums">package com.atomicnorth.hrm.tenant.service.jobOpening;

import com.atomicnorth.hrm.configuration.multitenant.TenantContextHolder;
import com.atomicnorth.hrm.tenant.domain.jobOpening.JobOfferTermsTemplate;
import com.atomicnorth.hrm.tenant.domain.jobOpening.OfferTermMaster;
import com.atomicnorth.hrm.tenant.domain.jobOpening.TermConditionDepartmentMapping;
import com.atomicnorth.hrm.tenant.domain.jobOpening.TermsCondition;
import com.atomicnorth.hrm.tenant.helper.SessionHolder;
import com.atomicnorth.hrm.tenant.helper.UserLoginDetail;
import com.atomicnorth.hrm.tenant.repository.DepartmentRepository;
import com.atomicnorth.hrm.tenant.repository.jobOpening.JobOfferTermsRepository;
import com.atomicnorth.hrm.tenant.repository.jobOpening.OfferTermMasterRepository;
import com.atomicnorth.hrm.tenant.repository.jobOpening.TermConditionDepartmentMappingRepository;
import com.atomicnorth.hrm.tenant.repository.jobOpening.TermsConditionRepository;
import com.atomicnorth.hrm.tenant.service.dto.jobOpening.JobOfferTermMasterDto;
import com.atomicnorth.hrm.tenant.service.dto.jobOpening.JobOfferTermsTemplateDto;
import com.atomicnorth.hrm.tenant.service.dto.jobOpening.TermsConditionDepartmentDTO;
import com.atomicnorth.hrm.tenant.service.dto.jobOpening.TermsConditionDto;
import com.atomicnorth.hrm.util.commonClass.PaginatedResponse;
import org.modelmapper.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;

import javax.transaction.Transactional;
import java.lang.reflect.Field;
import java.sql.ResultSet;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
public class JobOfferTermsService {

    private final JobOfferTermsRepository jobOfferTermsRepository;
    private final TermsConditionRepository termsConditionRepository;
    private final OfferTermMasterRepository offerTermMasterRepository;
    private final TermConditionDepartmentMappingRepository termConditionDepartmentMappingRepository;
    private final JdbcTemplate jdbcTemplate;

    @Autowired
    private ModelMapper modelMapper;
    @Autowired
    private DepartmentRepository departmentRepository;


<span class="nc" id="L54">    public JobOfferTermsService(JobOfferTermsRepository jobOfferTermsRepository, JdbcTemplate jdbcTemplate, TermsConditionRepository termsConditionRepository, OfferTermMasterRepository offerTermMasterRepository, TermConditionDepartmentMappingRepository termConditionDepartmentMappingRepository) {</span>
<span class="nc" id="L55">        this.jobOfferTermsRepository = jobOfferTermsRepository;</span>
<span class="nc" id="L56">        this.jdbcTemplate = jdbcTemplate;</span>
<span class="nc" id="L57">        this.termsConditionRepository = termsConditionRepository;</span>
<span class="nc" id="L58">        this.offerTermMasterRepository = offerTermMasterRepository;</span>
<span class="nc" id="L59">        this.termConditionDepartmentMappingRepository = termConditionDepartmentMappingRepository;</span>
<span class="nc" id="L60">    }</span>

    @Transactional
    public List&lt;JobOfferTermsTemplate&gt; saveOrUpdateJobOfferTermsTemplate(JobOfferTermsTemplateDto jobOfferTermsTemplateDto) {
<span class="nc" id="L64">        UserLoginDetail token = SessionHolder.getUserLoginDetail();</span>
<span class="nc" id="L65">        String username = String.valueOf(token.getUsername());</span>
<span class="nc" id="L66">        List&lt;JobOfferTermsTemplate&gt; jobOfferTermsTemplateList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L67" title="All 4 branches missed.">        if (jobOfferTermsTemplateDto.getJobTerms() != null &amp;&amp; !jobOfferTermsTemplateDto.getJobTerms().isEmpty()) {</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">            for (JobOfferTermMasterDto jobTermRequest : jobOfferTermsTemplateDto.getJobTerms()) {</span>
                JobOfferTermsTemplate jobOfferTermsTemplate;
<span class="nc bnc" id="L70" title="All 4 branches missed.">                switch (jobTermRequest.getFlag()) {</span>
                    case &quot;A&quot;:
<span class="nc" id="L72">                        jobOfferTermsTemplate = new JobOfferTermsTemplate();</span>
<span class="nc" id="L73">                        jobOfferTermsTemplate.setTitle(jobOfferTermsTemplateDto.getTitle());</span>
<span class="nc" id="L74">                        jobOfferTermsTemplate.setDescription(jobOfferTermsTemplateDto.getDescription());</span>
<span class="nc" id="L75">                        jobOfferTermsTemplate.setStartDate(jobOfferTermsTemplateDto.getStartDate());</span>
<span class="nc" id="L76">                        jobOfferTermsTemplate.setEndDate(jobOfferTermsTemplateDto.getEndDate());</span>
<span class="nc" id="L77">                        jobOfferTermsTemplate.setIsActive(jobTermRequest.getIsActive());</span>
<span class="nc" id="L78">                        jobOfferTermsTemplate.setOfferTermMasterId(jobTermRequest.getOfferTermMasterId());</span>
<span class="nc" id="L79">                        jobOfferTermsTemplate.setCreatedBy(username);</span>
<span class="nc" id="L80">                        jobOfferTermsTemplate.setLastUpdatedBy(username);</span>
<span class="nc" id="L81">                        jobOfferTermsTemplateList.add(jobOfferTermsTemplate);</span>
<span class="nc" id="L82">                        break;</span>
                    case &quot;E&quot;:
<span class="nc" id="L84">                        jobOfferTermsTemplate = jobOfferTermsRepository.findById(jobTermRequest.getJobOfferTemplateId())</span>
<span class="nc" id="L85">                                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;JobOfferTerm not found for update: &quot; + jobTermRequest.getJobOfferTemplateId()));</span>
<span class="nc" id="L86">                        jobOfferTermsTemplate.setTitle(jobOfferTermsTemplateDto.getTitle());</span>
<span class="nc" id="L87">                        jobOfferTermsTemplate.setDescription(jobOfferTermsTemplateDto.getDescription());</span>
<span class="nc" id="L88">                        jobOfferTermsTemplate.setStartDate(jobOfferTermsTemplateDto.getStartDate());</span>
<span class="nc" id="L89">                        jobOfferTermsTemplate.setEndDate(jobOfferTermsTemplateDto.getEndDate());</span>
<span class="nc" id="L90">                        jobOfferTermsTemplate.setIsActive(jobTermRequest.getIsActive());</span>
<span class="nc" id="L91">                        jobOfferTermsTemplate.setOfferTermMasterId(jobTermRequest.getOfferTermMasterId());</span>
<span class="nc" id="L92">                        jobOfferTermsTemplate.setCreatedBy(username);</span>
<span class="nc" id="L93">                        jobOfferTermsTemplate.setLastUpdatedBy(username);</span>
<span class="nc" id="L94">                        jobOfferTermsTemplateList.add(jobOfferTermsTemplate);</span>
<span class="nc" id="L95">                        break;</span>
                    case &quot;D&quot;:
<span class="nc" id="L97">                        jobOfferTermsTemplate = jobOfferTermsRepository.findById(jobTermRequest.getJobOfferTemplateId())</span>
<span class="nc" id="L98">                                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;JobOfferTerm not found for delete: &quot; + jobTermRequest.getJobOfferTemplateId()));</span>
<span class="nc" id="L99">                        jobOfferTermsTemplate.setIsActive(&quot;N&quot;);</span>
<span class="nc" id="L100">                        jobOfferTermsTemplate.setCreatedBy(username);</span>
<span class="nc" id="L101">                        jobOfferTermsTemplate.setLastUpdatedBy(username);</span>
<span class="nc" id="L102">                        jobOfferTermsTemplateList.add(jobOfferTermsTemplate);</span>
<span class="nc" id="L103">                        break;</span>
                    default:
<span class="nc" id="L105">                        throw new IllegalArgumentException(&quot;Invalid flag: &quot; + jobOfferTermsTemplateDto.getFlag());</span>
                }
<span class="nc" id="L107">            }</span>
        }
<span class="nc" id="L109">        return jobOfferTermsRepository.saveAll(jobOfferTermsTemplateList);</span>
    }

    public PaginatedResponse&lt;JobOfferTermsTemplateDto&gt; getJobOfferTermMapping(
            int pageNumber, int pageSize, String searchColumn, String searchValue, String sortBy, String sortOrder) {

<span class="nc" id="L115">        String schemaName = TenantContextHolder.getTenant();</span>
<span class="nc" id="L116">        String procedureName = &quot;JOB_OFFER_TERMS_TEMPLATE&quot;;</span>
<span class="nc" id="L117">        String sql = &quot;CALL &quot; + schemaName + &quot;.&quot; + procedureName + &quot;()&quot;;</span>

<span class="nc" id="L119">        List&lt;JobOfferTermsTemplateDto&gt; allData = jdbcTemplate.query(sql, (ResultSet rs) -&gt; {</span>
<span class="nc" id="L120">            Map&lt;String, JobOfferTermsTemplateDto&gt; jobOfferMap = new LinkedHashMap&lt;&gt;();</span>

<span class="nc bnc" id="L122" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L123">                String title = rs.getString(&quot;TITLE&quot;);</span>
<span class="nc" id="L124">                JobOfferTermsTemplateDto jobOfferDto = jobOfferMap.get(title);</span>

<span class="nc bnc" id="L126" title="All 2 branches missed.">                if (jobOfferDto == null) {</span>
<span class="nc" id="L127">                    jobOfferDto = new JobOfferTermsTemplateDto();</span>
<span class="nc" id="L128">                    jobOfferDto.setJobOfferTemplateId(rs.getInt(&quot;JOB_OFFER_TEMPLATE_ID&quot;));</span>
<span class="nc" id="L129">                    jobOfferDto.setTitle(title);</span>
<span class="nc" id="L130">                    jobOfferDto.setDescription(rs.getString(&quot;DESCRIPTION&quot;));</span>
<span class="nc" id="L131">                    jobOfferDto.setStartDate(rs.getDate(&quot;START_DATE&quot;));</span>
<span class="nc" id="L132">                    jobOfferDto.setEndDate(rs.getDate(&quot;END_DATE&quot;));</span>
<span class="nc" id="L133">                    jobOfferDto.setIsActive(rs.getString(&quot;IS_ACTIVE&quot;));</span>
<span class="nc" id="L134">                    jobOfferDto.setFullName(rs.getString(&quot;FULLNAME&quot;));</span>
<span class="nc" id="L135">                    jobOfferDto.setJobTerms(new ArrayList&lt;&gt;());</span>
<span class="nc" id="L136">                    jobOfferMap.put(title, jobOfferDto);</span>
                }

<span class="nc" id="L139">                JobOfferTermMasterDto jobTermDto = new JobOfferTermMasterDto();</span>
<span class="nc" id="L140">                jobTermDto.setJobOfferTemplateId(rs.getInt(&quot;JOB_OFFER_TEMPLATE_ID&quot;));</span>
<span class="nc" id="L141">                jobTermDto.setOfferTermMasterId(rs.getInt(&quot;OFFER_TERMS_MASTER_ID&quot;));</span>
<span class="nc" id="L142">                jobTermDto.setTitle(rs.getString(&quot;JOB_OFFER_TERM_MASTER_TITLE&quot;));</span>
<span class="nc" id="L143">                jobTermDto.setType(rs.getString(&quot;TYPE&quot;));</span>
<span class="nc" id="L144">                jobTermDto.setIsActive(rs.getString(&quot;IS_ACTIVE&quot;));</span>
<span class="nc" id="L145">                jobTermDto.setValue(rs.getString(&quot;VALUE&quot;));</span>

<span class="nc" id="L147">                jobOfferDto.getJobTerms().add(jobTermDto);</span>
<span class="nc" id="L148">            }</span>

<span class="nc" id="L150">            return new ArrayList&lt;&gt;(jobOfferMap.values());</span>
        });

<span class="nc" id="L153">        allData = applySearchFilter(allData, searchColumn, searchValue);</span>

<span class="nc" id="L155">        int totalElements = allData.size();</span>

<span class="nc" id="L157">        allData = applySorting(allData, sortBy, sortOrder);</span>

<span class="nc" id="L159">        int fromIndex = Math.min((pageNumber - 1) * pageSize, totalElements);</span>
<span class="nc" id="L160">        int toIndex = Math.min(fromIndex + pageSize, totalElements);</span>
<span class="nc" id="L161">        List&lt;JobOfferTermsTemplateDto&gt; paginatedData = allData.subList(fromIndex, toIndex);</span>

<span class="nc" id="L163">        int totalPages = (int) Math.ceil((double) totalElements / pageSize);</span>

<span class="nc" id="L165">        PaginatedResponse&lt;JobOfferTermsTemplateDto&gt; paginatedResponse = new PaginatedResponse&lt;&gt;();</span>
<span class="nc" id="L166">        paginatedResponse.setPaginationData(paginatedData);</span>
<span class="nc" id="L167">        paginatedResponse.setTotalPages(totalPages);</span>
<span class="nc" id="L168">        paginatedResponse.setTotalElements(totalElements);</span>
<span class="nc" id="L169">        paginatedResponse.setPageSize(pageSize);</span>
<span class="nc" id="L170">        paginatedResponse.setCurrentPage(pageNumber);</span>

<span class="nc" id="L172">        return paginatedResponse;</span>
    }

    private List&lt;JobOfferTermsTemplateDto&gt; applySearchFilter(
            List&lt;JobOfferTermsTemplateDto&gt; data, String searchColumn, String searchValue) {

<span class="nc bnc" id="L178" title="All 6 branches missed.">        if (searchColumn == null || searchValue == null || searchValue.isEmpty()) {</span>
<span class="nc" id="L179">            return data;</span>
        }

<span class="nc" id="L182">        return data.stream()</span>
<span class="nc" id="L183">                .filter(dto -&gt; {</span>
                    try {
<span class="nc" id="L185">                        Field field = dto.getClass().getDeclaredField(searchColumn);</span>
<span class="nc" id="L186">                        field.setAccessible(true);</span>
<span class="nc" id="L187">                        Object fieldValue = field.get(dto);</span>

<span class="nc bnc" id="L189" title="All 2 branches missed.">                        if (fieldValue == null) {</span>
<span class="nc" id="L190">                            return false;</span>
                        }

<span class="nc bnc" id="L193" title="All 2 branches missed.">                        if (fieldValue instanceof LocalDate) {</span>
<span class="nc" id="L194">                            LocalDate searchDate = LocalDate.parse(searchValue, DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;));</span>
<span class="nc" id="L195">                            return ((LocalDate) fieldValue).isEqual(searchDate);</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                        } else if (fieldValue instanceof LocalDateTime) {</span>
<span class="nc" id="L197">                            LocalDateTime searchDateTime = LocalDateTime.parse(searchValue, DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;));</span>
<span class="nc" id="L198">                            return ((LocalDateTime) fieldValue).toLocalDate().isEqual(searchDateTime.toLocalDate());</span>
                        }

<span class="nc" id="L201">                        return fieldValue.toString().toLowerCase().contains(searchValue.toLowerCase());</span>
<span class="nc" id="L202">                    } catch (NoSuchFieldException | IllegalAccessException | DateTimeParseException e) {</span>
<span class="nc" id="L203">                        return false;</span>
                    }
                })
<span class="nc" id="L206">                .collect(Collectors.toList());</span>
    }

    private List&lt;JobOfferTermsTemplateDto&gt; applySorting(
            List&lt;JobOfferTermsTemplateDto&gt; data, String sortBy, String sortOrder) {

<span class="nc bnc" id="L212" title="All 4 branches missed.">        if (sortBy == null || sortBy.isEmpty()) {</span>
<span class="nc" id="L213">            return data;</span>
        }

        Comparator&lt;JobOfferTermsTemplateDto&gt; comparator;
        try {
<span class="nc" id="L218">            Field field = JobOfferTermsTemplateDto.class.getDeclaredField(sortBy);</span>
<span class="nc" id="L219">            field.setAccessible(true);</span>

<span class="nc" id="L221">            comparator = Comparator.comparing(dto -&gt; {</span>
                try {
<span class="nc" id="L223">                    Object value = field.get(dto);</span>

<span class="nc bnc" id="L225" title="All 2 branches missed.">                    if (value == null) {</span>
<span class="nc" id="L226">                        return null;</span>
                    }

<span class="nc bnc" id="L229" title="All 2 branches missed.">                    if (value instanceof LocalDate) {</span>
<span class="nc" id="L230">                        return (Comparable) value;</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">                    } else if (value instanceof LocalDateTime) {</span>
<span class="nc" id="L232">                        return (Comparable) ((LocalDateTime) value).toLocalDate();</span>
                    }

<span class="nc" id="L235">                    return (Comparable) value;</span>
<span class="nc" id="L236">                } catch (IllegalAccessException e) {</span>
<span class="nc" id="L237">                    return null;</span>
                }
<span class="nc" id="L239">            }, Comparator.nullsLast(Comparator.naturalOrder()));</span>

<span class="nc" id="L241">        } catch (NoSuchFieldException e) {</span>
<span class="nc" id="L242">            return data;</span>
<span class="nc" id="L243">        }</span>

<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (&quot;desc&quot;.equalsIgnoreCase(sortOrder)) {</span>
<span class="nc" id="L246">            comparator = comparator.reversed();</span>
        }

<span class="nc" id="L249">        return data.stream().sorted(comparator).collect(Collectors.toList());</span>
    }

    @Transactional
    public TermsCondition saveOrUpdateTermsCondition(TermsConditionDto termsConditionDto) {
<span class="nc bnc" id="L254" title="All 2 branches missed.">        if (termsConditionDto == null) {</span>
<span class="nc" id="L255">            throw new IllegalArgumentException(&quot;TermsConditionDto cannot be null.&quot;);</span>
        }
<span class="nc" id="L257">        UserLoginDetail token = SessionHolder.getUserLoginDetail();</span>
<span class="nc" id="L258">        String username = String.valueOf(token.getUsername());</span>
        TermsCondition termsCondition;
<span class="nc bnc" id="L260" title="All 2 branches missed.">        if (termsConditionDto.getTermsConditionId() == null) {</span>
<span class="nc" id="L261">            termsCondition = new TermsCondition();</span>
<span class="nc" id="L262">            termsCondition.setCreatedBy(username);</span>
<span class="nc" id="L263">            termsCondition.setLastUpdatedBy(username);</span>
        } else {
<span class="nc" id="L265">            termsCondition = termsConditionRepository.findById(termsConditionDto.getTermsConditionId())</span>
<span class="nc" id="L266">                    .orElseThrow(() -&gt; new IllegalArgumentException(</span>
<span class="nc" id="L267">                            &quot;TermsCondition not found with ID: &quot; + termsConditionDto.getTermsConditionId()));</span>
<span class="nc" id="L268">            termsCondition.setLastUpdatedBy(username);</span>
        }
<span class="nc" id="L270">        termsCondition.setTitle(termsConditionDto.getTitle());</span>
<span class="nc" id="L271">        termsCondition.setDescription(termsConditionDto.getDescription());</span>
<span class="nc" id="L272">        termsCondition.setStartDate(termsConditionDto.getStartDate());</span>
<span class="nc" id="L273">        termsCondition.setEndDate(termsConditionDto.getEndDate());</span>
<span class="nc" id="L274">        termsCondition.setIsActive(termsConditionDto.getIsActive());</span>
<span class="nc" id="L275">        termsCondition = termsConditionRepository.save(termsCondition);</span>
<span class="nc" id="L276">        saveOrUpdateMappings(termsCondition, termsConditionDto.getTermsConditionDepartmentDTO(), username, termsConditionDto.getFlag());</span>
<span class="nc" id="L277">        return termsCondition;</span>
    }

    @Transactional
    private void saveOrUpdateMappings(TermsCondition termsCondition, List&lt;TermsConditionDepartmentDTO&gt; termsConditionDepartmentDTOS, String username, String flag) {
<span class="nc bnc" id="L282" title="All 4 branches missed.">        if (termsConditionDepartmentDTOS == null || termsConditionDepartmentDTOS.isEmpty()) {</span>
<span class="nc" id="L283">            throw new IllegalArgumentException(&quot;Department list cannot be null or empty.&quot;);</span>
        }
<span class="nc" id="L285">        List&lt;TermConditionDepartmentMapping&gt; mappings = termsConditionDepartmentDTOS.stream()</span>
<span class="nc" id="L286">                .map(departmentDTO -&gt; {</span>
                    TermConditionDepartmentMapping mapping;
<span class="nc bnc" id="L288" title="All 2 branches missed.">                    if (departmentDTO.getId() != null) {</span>
<span class="nc" id="L289">                        System.out.println(&quot;Id &quot; + departmentDTO.getId());</span>
<span class="nc" id="L290">                        mapping = termConditionDepartmentMappingRepository.findById(departmentDTO.getId())</span>
<span class="nc" id="L291">                                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Mapping not found with ID: &quot; + departmentDTO.getId()));</span>
<span class="nc" id="L292">                        mapping.setDepartmentId(departmentDTO.getDepartmentId());</span>
<span class="nc" id="L293">                        mapping.setIsActive(departmentDTO.getIsActive());// Update departmentId</span>
                    } else {
<span class="nc" id="L295">                        mapping = new TermConditionDepartmentMapping();</span>
<span class="nc" id="L296">                        mapping.setTermsConditionId(termsCondition.getTermsConditionId());</span>
<span class="nc" id="L297">                        mapping.setDepartmentId(departmentDTO.getDepartmentId());</span>
<span class="nc" id="L298">                        mapping.setCreatedBy(username);</span>
<span class="nc" id="L299">                        mapping.setLastUpdatedBy(username);</span>
<span class="nc" id="L300">                        mapping.setIsActive(departmentDTO.getIsActive());</span>
                    }
<span class="nc" id="L302">                    return mapping;</span>
                })
<span class="nc" id="L304">                .collect(Collectors.toList());</span>
<span class="nc" id="L305">        termConditionDepartmentMappingRepository.saveAll(mappings);</span>
<span class="nc" id="L306">    }</span>

    public List&lt;TermsConditionDto&gt; getTermsConditions() {
<span class="nc" id="L309">        List&lt;TermsCondition&gt; termsConditions = termsConditionRepository.findAll();</span>
<span class="nc" id="L310">        List&lt;TermsConditionDto&gt; termsConditionDtos = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">        for (TermsCondition termsCondition : termsConditions) {</span>
<span class="nc" id="L312">            TermsConditionDto termsConditionDto = modelMapper.map(termsCondition, TermsConditionDto.class);</span>
<span class="nc" id="L313">            List&lt;TermsConditionDepartmentDTO&gt; departmentDTOs = getDepartmentsForTermsCondition(termsCondition.getTermsConditionId());</span>
<span class="nc" id="L314">            termsConditionDto.setTermsConditionDepartmentDTO(departmentDTOs);</span>
<span class="nc" id="L315">            termsConditionDtos.add(termsConditionDto);</span>
<span class="nc" id="L316">        }</span>

        // Return the list of DTOs
<span class="nc" id="L319">        return termsConditionDtos;</span>
    }

    private List&lt;TermsConditionDepartmentDTO&gt; getDepartmentsForTermsCondition(Integer termsConditionId) {
<span class="nc" id="L323">        Map&lt;Integer, String&gt; departmentNames = departmentRepository.findAllDepartmentIdAndName().stream()</span>
<span class="nc" id="L324">                .collect(Collectors.toMap(</span>
<span class="nc" id="L325">                        obj -&gt; ((Number) obj[0]).intValue(),</span>
<span class="nc" id="L326">                        obj -&gt; (String) obj[1]</span>
                ));

<span class="nc" id="L329">        List&lt;TermConditionDepartmentMapping&gt; entities = termConditionDepartmentMappingRepository.findByTermsConditionId(termsConditionId);</span>

<span class="nc" id="L331">        return entities.stream().map(entity -&gt; {</span>
<span class="nc" id="L332">            TermsConditionDepartmentDTO dto = new TermsConditionDepartmentDTO();</span>
<span class="nc" id="L333">            dto.setId(entity.getId());</span>
<span class="nc" id="L334">            dto.setTermConditionId(entity.getTermsConditionId());</span>
<span class="nc" id="L335">            dto.setDepartmentId(entity.getDepartmentId());</span>
<span class="nc" id="L336">            dto.setIsActive(entity.getIsActive());</span>

<span class="nc" id="L338">            String departmentName = departmentNames.get(entity.getDepartmentId());</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">            dto.setDepartmentName(departmentName != null ? departmentName : &quot;Unknown&quot;);</span>

<span class="nc" id="L341">            return dto;</span>
<span class="nc" id="L342">        }).collect(Collectors.toList());</span>
    }

    public List&lt;Map&lt;String, Object&gt;&gt; offerTermsDropdownList() {
<span class="nc" id="L346">        Map&lt;Integer, OfferTermMaster&gt; offerTermMasterMap = offerTermMasterRepository.findAll().stream()</span>
<span class="nc" id="L347">                .collect(Collectors.toMap(</span>
<span class="nc" id="L348">                        d -&gt; Math.toIntExact(d.getId()),</span>
<span class="nc" id="L349">                        d -&gt; d,</span>
<span class="nc" id="L350">                        (oldValue, newValue) -&gt; oldValue</span>
                ));

<span class="nc" id="L353">        Map&lt;String, List&lt;JobOfferTermsTemplate&gt;&gt; grouped = jobOfferTermsRepository.findAll().stream()</span>
<span class="nc" id="L354">                .filter(offerTerms -&gt; &quot;Y&quot;.equalsIgnoreCase(offerTerms.getIsActive()))</span>
<span class="nc" id="L355">                .collect(Collectors.groupingBy(JobOfferTermsTemplate::getTitle));</span>

<span class="nc" id="L357">        return grouped.entrySet().stream().map(entry -&gt; {</span>
<span class="nc" id="L358">            String title = entry.getKey();</span>
<span class="nc" id="L359">            List&lt;JobOfferTermsTemplate&gt; termsList = entry.getValue();</span>

<span class="nc" id="L361">            Map&lt;String, Object&gt; result = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L362">            result.put(&quot;title&quot;, title);</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">            if (!termsList.isEmpty()) {</span>
<span class="nc" id="L364">                result.put(&quot;jobOfferTemplateId&quot;, termsList.get(0).getJobOfferTemplateId());</span>
            }

<span class="nc" id="L367">            List&lt;Map&lt;String, Object&gt;&gt; jobTermsList = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L369" title="All 2 branches missed.">            for (JobOfferTermsTemplate offerTerms : termsList) {</span>
<span class="nc" id="L370">                OfferTermMaster offerTermMaster = offerTermMasterMap.get(offerTerms.getOfferTermMasterId());</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">                if (offerTermMaster != null) {</span>
<span class="nc" id="L372">                    Map&lt;String, Object&gt; jobTerm = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L373">                    jobTerm.put(&quot;offerTermMasterId&quot;, offerTermMaster.getId());</span>
<span class="nc" id="L374">                    jobTerm.put(&quot;title&quot;, offerTermMaster.getTitle());</span>
<span class="nc" id="L375">                    jobTerm.put(&quot;type&quot;, offerTermMaster.getType());</span>
<span class="nc" id="L376">                    jobTerm.put(&quot;value&quot;, offerTermMaster.getValue());</span>
<span class="nc" id="L377">                    jobTerm.put(&quot;jobOfferTemplateId&quot;, offerTerms.getJobOfferTemplateId());</span>
<span class="nc" id="L378">                    jobTermsList.add(jobTerm);</span>
                }
<span class="nc" id="L380">            }</span>

<span class="nc" id="L382">            result.put(&quot;jobTerms&quot;, jobTermsList);</span>
<span class="nc" id="L383">            return result;</span>
<span class="nc" id="L384">        }).collect(Collectors.toList());</span>
    }

    public List&lt;Map&lt;String, Object&gt;&gt; termsConditionDropdownList() {
<span class="nc" id="L388">        return termsConditionRepository.findAll().stream()</span>
<span class="nc" id="L389">                .filter(termsCondition -&gt; &quot;Y&quot;.equals(termsCondition.getIsActive()))</span>
<span class="nc" id="L390">                .map(termsCondition -&gt; {</span>
<span class="nc" id="L391">                    Map&lt;String, Object&gt; result = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L392">                    result.put(&quot;termsConditionId&quot;, termsCondition.getTermsConditionId());</span>
<span class="nc" id="L393">                    result.put(&quot;termsConditionName&quot;, termsCondition.getTitle());</span>
<span class="nc" id="L394">                    return result;</span>
<span class="nc" id="L395">                }).collect(Collectors.toList());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>